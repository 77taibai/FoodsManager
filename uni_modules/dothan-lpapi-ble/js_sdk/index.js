class t$1{static formatDate(t,e){let i=t||"yyyy-MM-dd HH:mm:ss.SSS";const r={"y+":(e=e||new Date).getFullYear(),"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),"S+":e.getMilliseconds()};let s;for(const t in r)if(s=new RegExp(`(${t})`).exec(i)){const e=`${r[t]}`,n=`00${e}`,a=s[1].length>n.length?0:n.length-s[1].length;i=i.replace(s[1],1===s[1].length?e:n.substring(a));}return i}static createRect(t,e,i,r){return {x:t||0,y:e||0,width:i,height:r}}static parseRect(t){if(!t)return;t=t.trim();const e=/^\[?\(?\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*\)?]?$/.exec(t);return e?{x:parseFloat(e[1]),y:parseFloat(e[2]),width:parseFloat(e[3]),height:parseFloat(e[4])}:void 0}static isInnerRect(t,e){return t.x>=e.x&&t.x+t.width<=e.x+e.width&&t.y>=e.y&&t.y+t.height<=e.y+e.height}static hasIntersection(t,e){return t.x<e.x+e.width&&e.x<t.x+t.width&&t.y<e.y+e.height&&e.y<t.y+t.height}static getUnionRect(t,e){const i=Math.min(t.x,e.x),r=Math.min(t.y,e.y);return {x:i,y:r,width:Math.max(t.x+t.width,e.x+e.width)-i,height:Math.max(t.y+t.height,e.y+e.height)-r}}}var e$1,i$1,r$1,s$1,n$1,a$1,o$1,h$1,c$1;!function(t){t[t.NONE=0]="NONE",t[t.ERROR=1]="ERROR",t[t.WARN=2]="WARN",t[t.INFO=3]="INFO",t[t.LOG=4]="LOG";}(e$1||(e$1={}));class l$1{static innerLog(t){this.output?this.output.log(t):console.log(t);}static innerWarn(t){this.output?this.output.warn(t):console.warn(t);}static innerError(t){this.output?this.output.error(t):console.error(t);}static setLevel(t){this.logRecords.push(this.logLevel),this.logLevel=t;}static setLogOutput(t){this.output=t;}static restorePrev(){const t=this.logRecords.shift();void 0!==t&&(this.logLevel=t);}static log(i,r){if(this.logLevel>=e$1.LOG){const e=t$1.formatDate("HH:mm:ss.SSS");"object"==typeof i||r?(l$1.innerLog(`【LOG  】[${e}]: ${r||""}`),l$1.innerLog(i)):l$1.innerLog(`【LOG  】[${e}]: ${i}`);}}static info(i,r){if(this.logLevel>=e$1.INFO){const e=t$1.formatDate("HH:mm:ss.SSS");"object"==typeof i||r?(l$1.innerLog(`【INFO 】[${e}]: ${r||""}`),l$1.innerLog(i)):l$1.innerLog(`【INFO 】[${e}]: ${i}`);}}static warn(i,r){if(this.logLevel>=e$1.WARN){const e=t$1.formatDate("HH:mm:ss.SSS");"object"==typeof i||r?(l$1.innerWarn(`【WARN 】[${e}]: ${r||""}`),l$1.innerWarn(i)):l$1.innerWarn(`【WARN 】[${e}]: ${i}`);}}static error(i,r){if(this.logLevel>=e$1.ERROR){const e=t$1.formatDate("HH:mm:ss.SSS");"object"==typeof i||r?(l$1.innerError(`【ERROR】[${e}]: ${r||""}`),l$1.innerError(i)):l$1.innerError(`【ERROR】[${e}]: ${i}`);}}}l$1.logRecords=[],l$1.logLevel=e$1.WARN,function(t){t[t.Top=0]="Top",t[t.Bottom=1]="Bottom",t[t.Left=2]="Left",t[t.Right=3]="Right";}(i$1||(i$1={})),function(t){t[t.None=0]="None",t[t.UnderLine=1]="UnderLine",t[t.ThroughLine=2]="ThroughLine",t[t.OverLine=3]="OverLine";}(r$1||(r$1={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.BOLD=1]="BOLD",t[t.ITALIC=2]="ITALIC",t[t.UNDERLINE=4]="UNDERLINE",t[t.STRIKEOUT=8]="STRIKEOUT";}(s$1||(s$1={})),function(t){t[t.Unset=255]="Unset",t[t.Start=0]="Start",t[t.Center=1]="Center",t[t.End=2]="End",t[t.Stretch=3]="Stretch";}(n$1||(n$1={})),function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.HInner=2]="HInner",t[t.Right=4]="Right",t[t.HOuter=8]="HOuter",t[t.Top=16]="Top",t[t.VInner=32]="VInner",t[t.Bottom=64]="Bottom",t[t.VOuter=128]="VOuter",t[t.Inner=34]="Inner",t[t.Outer=136]="Outer";}(a$1||(a$1={})),function(t){t[t.None=0]="None",t[t.Char=1]="Char",t[t.Word=2]="Word";}(o$1||(o$1={})),function(t){t[t.Auto=0]="Auto",t[t.MM=1]="MM",t[t.Pix=2]="Pix";}(h$1||(h$1={})),function(t){t[t.LineSpace_Custom=0]="LineSpace_Custom",t[t.LineSpace_1_0=1]="LineSpace_1_0",t[t.LineSpace_1_2=1.2]="LineSpace_1_2",t[t.LineSpace_1_5=1.5]="LineSpace_1_5",t[t.LineSpace_2_0=2]="LineSpace_2_0";}(c$1||(c$1={}));class d$1{static getLineMode(t){switch(t=t||""){case d$1.LineSpace_1_0:return c$1.LineSpace_1_0;case d$1.LineSpace_1_2:return c$1.LineSpace_1_2;case d$1.LineSpace_1_5:return c$1.LineSpace_1_5;case d$1.LineSpace_2_0:return c$1.LineSpace_2_0;default:return t?c$1.LineSpace_Custom:c$1.LineSpace_1_0}}static toString(t,e){switch(t){case c$1.LineSpace_1_0:return d$1.LineSpace_1_0;case c$1.LineSpace_1_2:return d$1.LineSpace_1_2;case c$1.LineSpace_1_5:return d$1.LineSpace_1_5;case c$1.LineSpace_2_0:return d$1.LineSpace_2_0;case c$1.LineSpace_Custom:return "number"==typeof e?String(e):""}}static getModeValue(t,e){switch(t){case c$1.LineSpace_1_2:return .2*e;case c$1.LineSpace_1_5:return .5*e;case c$1.LineSpace_2_0:return 1*e;case c$1.LineSpace_1_0:case c$1.LineSpace_Custom:return 0;default:return t>1?e*(t-1):0}}static valueOf(t,e){if("string"==typeof t){const i=this.getLineMode(t);return i===c$1.LineSpace_Custom?Number.parseFloat(t):this.getModeValue(i,e)}return this.getModeValue(t,e)}}d$1.LineSpace_1_0="1_0",d$1.LineSpace_1_2="1_2",d$1.LineSpace_1_5="1_5",d$1.LineSpace_2_0="2_0";class g$1{static isNull(t){return null==t}static isTransparent(t){return "transparent"===(t=(t||"").toLowerCase())||t.match(/^#[0-9a-f]{3}0$/i)||t.match(/^#[0-9a-f]{6}00$/i)}static isHorizontal(t){switch(t){case 0:case 2:case 180:return !0;default:return !1}}static isPortrait(t){switch(t){case 1:case 3:case 90:case 270:return !0;default:return !1}}static validateColorStr(t){return t?/^[0-9A-Fa-f]+$/.exec(t)?`#${t}`:/^#([0-9A-Fa-f]+)$/.exec(t)?t:/^0[xX]([0-9A-Fa-f]+)$/.exec(t)?`#${t.substring(2)}`:t:t}get supportLineDash(){return this.supports("setLineDash")}get Canvas(){return this._canvas||this.setCanvas(this.createCanvas()),this._canvas}setCanvas(t){if(!t)return;this._canvas=t,this.initOptions.position&&this._canvas.style&&(this._canvas.style.position=this.initOptions.position);const e=!!this.IsApiMode;this.ctx=this._canvas.getContext("2d",{willReadFrequently:e}),this.setTextBaseline(g$1.TEXT_BASELINE_DEFAULT),this.setTextAlign("left");}get Context(){return this.ctx}get Width(){return this.width}get Height(){return this.height}get Orientation(){return this.orientation}get BorderAlign(){return this._borderAlign}set BorderAlign(t){this._borderAlign=t;}get ModulePixels(){return this._modulePixels}set ModulePixels(t){t>0&&(this._modulePixels=t);}get DashLen(){return this._dashLen||[]}set DashLen(t){this._dashLen=t;}get IsApiMode(){return this._apiMode||!1}set IsApiMode(t){this._apiMode=t;}get PixPerUnit(){return this._pixPerUnit}get B1DTextAlign(){return this._barcodeTextAlign}set B1DTextAlign(t){this._barcodeTextAlign="number"==typeof t?t:n$1.Unset;}get HorizontalAlign(){return this._horizontalAlign}set HorizontalAlign(t){this._horizontalAlign="number"==typeof t?t:n$1.Unset;}get VerticalAlign(){return this._verticalAlign}set VerticalAlign(t){this._verticalAlign="number"==typeof t?t:n$1.Unset;}get ItemOrientation(){return this._rotation||0}set ItemOrientation(t){this._rotation=t;}get LineWidth(){return this._lineWidth>0?this._lineWidth:g$1.LINE_WIDTH}set LineWidth(t){t>=0&&(this._lineWidth=t);}get Foreground(){return this._foreground||g$1.COLOR_FG_DEFAULT}set Foreground(t){this._foreground=t;}get Background(){return this._background||g$1.COLOR_BG_DEFAULT}set Background(t){this._background=t;}get AutoReturn(){return this._autoReturn}set AutoReturn(t){this._autoReturn=t;}get FontName(){return this.fontName}set FontName(t){this.fontName=t;}get FontHeight(){return this.fontHeight}set FontHeight(t){t>=0&&(this.fontHeight=t);}get FontStyle(){return this.fontStyle}set FontStyle(t){t>=0&&(this.fontStyle=t);}get LineSpace(){return this._lineSpace}set LineSpace(t){this._lineSpace=t;}get CharSpace(){return this._charSpace}set CharSpace(t){this._charSpace=t;}constructor(t){this.fontName=g$1.FONT_NAME,this.fontStyle=0,this.fontHeight=0,this.width=0,this.height=0,this.orientation=0,this.jobName="",this._modulePixels=2,this._lineWidth=0,this._dashLen=[],this._foreground=g$1.COLOR_FG_DEFAULT,this._rotation=0,this._barcodeTextAlign=n$1.Unset,this._horizontalAlign=n$1.Unset,this._verticalAlign=n$1.Unset,this._autoReturn=o$1.Char,this._charSpace=0,this._lineSpace=0,this._borderAlign=a$1.Inner,this._pixPerUnit=1;const e=t||{};this.initOptions=e,this._canvasCreator=e.creator,this._canvasClearAction=e.onCanvasClear,this._apiMode=e.apiMode,e.background&&(this._background=e.background),e.foreground&&(this._foreground=e.foreground),e.canvas&&this.setCanvas(e.canvas);}createCanvas(){return this._canvasCreator?this._canvasCreator():document&&void 0!==document.createElement?document.createElement("canvas"):void 0}getReturnMode(t){return void 0!==t?t:this.AutoReturn}getLineSpace(t,e,i){if(void 0===t&&"string"==typeof i){i.match(/^[0-9]+.?[0-9]*$/)?i=Number(i):(t=i,i=this.LineSpace);}const r="string"==typeof t?d$1.getLineMode(t):t;return void 0===r||r===c$1.LineSpace_Custom?i||this.LineSpace:d$1.valueOf(r,e)}setTextBaseline(t){const e=this.ctx;void 0!==this.ctx.textBaseline&&(this.ctx.textBaseline=t),"function"==typeof e.setTextBaseline&&e.setTextBaseline(g$1.TEXT_BASELINE_DEFAULT);}setTextAlign(t){const e=this.ctx;void 0!==this.ctx.textAlign&&(this.ctx.textAlign=t),"function"==typeof e.setTextAlign&&e.setTextAlign(t);}appendTo(t){return t instanceof Element&&(t.innerHTML="",t.appendChild(this.Canvas),!0)}supports(t){switch(t){case"getImageData":return void 0!==this.ctx.getImageData;case"setLineDash":return void 0!==this.ctx.setLineDash;case"toDataURL":return void 0!==this.Canvas.toDataURL;case"toDataURLWithQuality":try{return this.Canvas.toDataURL("image/jpeg",0),!0}catch(t){return !1}case"measureText":return void 0!==this.ctx.measureText;default:return !1}}clearAll(){this.ctx.clearRect(0,0,this.Canvas.width,this.Canvas.height),this._background&&(this.ctx.fillStyle=g$1.validateColorStr(this.Background),this.ctx.fillRect(0,0,this.Canvas.width,this.Canvas.height)),"function"==typeof this._canvasClearAction&&this._canvasClearAction(this.Canvas,this.ctx);}getLineWidth(t){return t&&t>0?t:this.LineWidth}getDashLen(t){return t||this.DashLen}setFont(t,e,i){const r=Math.round(t||this.fontHeight),n=e||this.fontStyle,a=i||this.fontName||g$1.FONT_NAME,o=n&s$1.ITALIC?"italic":"normal",h=n&s$1.BOLD?"bold":"normal";this.ctx.font=`${o} normal ${h} ${r}px ${a}`;}processPaddings(t,e){const i=e[0]||0,r=e.length>1?e[1]:i,s=e.length>2?e[2]:i,n=e.length>3?e[3]:r;t.x=t.x||0,t.y=t.y||0,t.x+=n,"number"==typeof t.width&&(t.width-=n+r),t.y+=i,"number"==typeof t.height&&(t.height-=i+s);}processPadding(t){return Array.isArray(t.padding)&&t.padding.length>0?this.processPaddings(t,t.padding):"number"==typeof t.padding?this.processPaddings(t,[t.padding]):t}getHorizontalAlignment(t){return "number"==typeof t?t:this._horizontalAlign}getVerticalAlignment(t){return "number"==typeof t?t:this._verticalAlign}getB1DTextAlignment(t){return "number"==typeof t?t:this.B1DTextAlign}getItemRotation(t){let e="number"==typeof t?t:this.ItemOrientation;return e>=360&&(e%=360),e>0&&e<4&&(e*=90),e}startJob(t){if("number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),t.width<=0&&t.printerWidth>0&&(t.width=t.printerWidth),!(t.width<=0&&t.height<=0))return t.canvas&&this.setCanvas(t.canvas),this.width=Math.round(t.width||t.height||0),this.height=Math.round(t.height||t.width),this.orientation=t.orientation||0,t.jobName&&(this.jobName=t.jobName),this.Canvas.width=this.width,this.Canvas.height=this.height,t.printMode?(this._background=g$1.COLOR_BG_DEFAULT,this._foreground=g$1.COLOR_FG_DEFAULT):(t.backgroundColor&&(this._background=t.backgroundColor),t.color&&(this._foreground=t.color)),this.clearAll(),!t.printMode&&t.backgroundImage&&this.drawImage({image:t.backgroundImage,width:t.width,height:t.height}),this.Canvas;l$1.warn("---- 未指定标签大小！");}commitJob(){return this.Canvas}setRotation(t,e,i){if((t=(t||0)%360)>0){const r=e||{x:0,y:0},s=i||{width:0,height:0};r.x=Math.round(r.x+.5*s.width)+.5,r.y=Math.round(r.y+.5*s.height)+.5,this.ctx.translate(r.x,r.y),this.ctx.rotate(t*Math.PI/180),this.ctx.translate(-r.x,-r.y);}}drawLine(t){let e=t.x1||0,i=t.y1||0,r="number"==typeof t.x2?t.x2:e,s="number"==typeof t.y2?t.y2:i;const n="number"==typeof t.x?t.x:e,a="number"==typeof t.y?t.y:i;if(e===r&&i===s){const o=t.width||0,h=t.height||0;if(o>0||h>0){const c=Math.min(o,h);c>0&&(t.lineWidth=c),o>h?(t.x1=e=n,t.x2=r=n+o,t.y1=i=a+.5*h,t.y2=s=i):(t.x1=e=n+.5*o,t.x2=r=e,t.y1=i=a,t.y2=s=a+h);}else t.x1=e=n,t.x2=r=n+this.width,t.y1=i=a,t.y2=s=a;}else i===s?"number"!=typeof t.y1&&"number"!=typeof t.y2&&"number"==typeof t.y&&(t.y1=i=t.y,t.y2=s=t.y):e===r&&"number"!=typeof t.x1&&"number"!=typeof t.x2&&"number"==typeof t.x&&(t.x1=e=t.x,t.x2=r=t.x);this.ctx.save();const o=this.getItemRotation(t.orientation);this.setRotation(o,{x:.5*(e+r),y:.5*(i+s)});const h=this._drawLine(t);return this.ctx.restore(),h}_drawLine(t){const e=Math.floor(t.x1||0)+.5,i=Math.floor(t.y1||0)+.5,r="number"==typeof t.x2?Math.floor(t.x2)+.5:e,s="number"==typeof t.y2?Math.floor(t.y2)+.5:i;this.ctx.strokeStyle=g$1.validateColorStr(t.color||this.Foreground),this.ctx.lineWidth=Math.ceil(this.getLineWidth(t.lineWidth)),this.ctx.beginPath();let n=t.dashLens;return (!n||n.length<=0)&&(n=(t.dashLen||"").split(",").map((t=>+t))),this.supportLineDash&&this.ctx.setLineDash(n||[]),this.ctx.moveTo(e,i),this.ctx.lineTo(r,s),this.ctx.stroke(),this.supportLineDash&&this.ctx.setLineDash([]),!0}drawRect(t){const e=t.x||0,i=t.y||0,r=t.width||0,s=t.height||0;if(t.cornerWidth&&t.cornerWidth>0||t.cornerHeight&&t.cornerHeight>0)return this.drawRoundRect(t);if(r>0&&s>0){this.ctx.save();const n=this.getItemRotation(t.orientation);return this.setRotation(n,{x:e,y:i},{width:r,height:s}),this._drawRect(t),this.ctx.restore(),!0}return !1}_drawRect(e){const i=g$1.validateColorStr(e.color||this.Foreground);let r=e.x||0,s=e.y||0,n=e.width||e.height||0,a=e.height||e.width||0;if(n<=0)return !1;if(i&&g$1.isTransparent(i))return !0;if(e.fill){const e=this.adjustRect(t$1.createRect(r,s,n,a),this.BorderAlign);this.ctx.fillStyle=i,this.ctx.fillRect(e.x,e.y,e.width,e.height);}else {let o=this.getLineWidth(e.lineWidth),h=e.dashLens;(!h||h.length<=0)&&(h=(e.dashLen||"").split(",").map((t=>+t))),o=Math.ceil(o),r+=.5*o,s+=.5*o,n-=o,a-=o;const c=this.adjustRect(t$1.createRect(r,s,n,a),this.BorderAlign);this.ctx.lineWidth=o||this.LineWidth,this.ctx.strokeStyle=i,this.supportLineDash&&h.length>0&&this.ctx.setLineDash(h),this.ctx.strokeRect(c.x,c.y,c.width,c.height),this.supportLineDash&&this.ctx.setLineDash([]);}return !0}adjustRect(t,e){let i=t.x,r=t.y,s=t.x+t.width,n=t.y+t.height;const o=240&e;switch(15&e){case a$1.Left:i=Math.floor(i),s=Math.floor(s);break;case a$1.HInner:i=Math.ceil(i),s=Math.floor(s);break;case a$1.Right:i=Math.ceil(i),s=Math.ceil(s);break;case a$1.HOuter:i=Math.floor(i),s=Math.ceil(s);break;default:i=Math.round(i),s=Math.round(s);}switch(o){case a$1.Top:r=Math.floor(r),n=Math.floor(n);break;case a$1.VInner:r=Math.ceil(r),n=Math.floor(n);break;case a$1.Bottom:r=Math.ceil(r),n=Math.ceil(n);break;case a$1.VOuter:r=Math.floor(r),n=Math.ceil(n);break;default:r=Math.round(r),n=Math.round(n);}const h=s-i,c=n-r;return {x:i,y:r,width:h>0?h:1,height:c>0?c:1}}drawRoundRect(t){let e=t.x||0,i=t.y||0,r=t.width||0,s=t.height||0;const n=t.cornerWidth||t.cornerHeight||0;if(r<=0&&s<=0)return !1;if(n<=0)return this.drawRect(t);const a=.5*Math.min(r,s),o=g$1.validateColorStr(t.color||this.Foreground);let h=this.getLineWidth(t.lineWidth);t.fill||(h>a&&(h=a),e+=.5*h,i+=.5*h,r-=h,s-=h),this.ctx.save();const c=this.getItemRotation(t.orientation);return this.setRotation(c,{x:e,y:i},{width:r,height:s}),this.ctx.translate(e,i),this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.drawRoundRectPath(r,s,n),t.fill?this.ctx.fill():(this.ctx.lineWidth=h,this.ctx.stroke()),this.ctx.restore(),!0}drawRoundRectPath(t,e,i){i=Math.min(i,.5*t,.5*e),this.ctx.beginPath(),this.ctx.arc(t-i,e-i,i,0,Math.PI/2),this.ctx.lineTo(i,e),this.ctx.arc(i,e-i,i,Math.PI/2,Math.PI),this.ctx.lineTo(0,i),this.ctx.arc(i,i,i,Math.PI,3*Math.PI/2),this.ctx.lineTo(t-i,0),this.ctx.arc(t-i,i,i,3*Math.PI/2,2*Math.PI),this.ctx.lineTo(t,e-i),this.ctx.closePath();}drawEllipse(t){let e=t.x||0,i=t.y||0,r=t.width||t.height||0,s=t.height||t.width||0;if(r<=0&&s<=0)return !1;if(r===s)return this.drawCircle(t);const n=g$1.validateColorStr(t.color||this.Foreground),a=this.getLineWidth(t.lineWidth);e+=.5*a,i+=.5*a,r-=a,s-=a;const o=.5*r,h=.5*s;e+=o,i+=h;const c=this.getItemRotation(t.orientation);if(this.ctx.save(),this.setRotation(c,{x:e,y:i}),this.ctx.lineWidth=a,this.ctx.fillStyle=n,this.ctx.strokeStyle=n,this.ctx.ellipse)this.ctx.beginPath(),this.ctx.ellipse(e,i,o,h,0,0,2*Math.PI);else {const t=.5*o,r=.6*h;this.ctx.translate(e,i),this.ctx.beginPath(),this.ctx.moveTo(0,h),this.ctx.bezierCurveTo(t,h,o,r,o,0),this.ctx.bezierCurveTo(o,-r,t,-h,0,-h),this.ctx.bezierCurveTo(-t,-h,-o,-r,-o,0),this.ctx.bezierCurveTo(-o,r,-t,h,0,h),this.ctx.closePath();}return t.fill?this.ctx.fill():this.ctx.stroke(),this.ctx.restore(),!0}drawCircle(t){let e=t.x||0,i=t.y||0,r=t.radius||0;if(r<=0){const s=t.width||0,n=t.height||0;if(s>0&&n>0)r=.5*Math.min(s,n),e+=.5*s,i+=.5*n;else if(s>0)r=.5*s,e+=r;else {if(!(n>0))return !1;r=.5*n,i+=r;}}const s=g$1.validateColorStr(t.color||this.Foreground),n=this.getLineWidth(t.lineWidth);return r-=.5*n,this.ctx.lineWidth=n,this.ctx.fillStyle=s,this.ctx.strokeStyle=s,this.ctx.beginPath(),this.ctx.arc(e,i,r,0,2*Math.PI),this.ctx.closePath(),t.fill?this.ctx.fill():this.ctx.stroke(),!0}drawText(t){this.processPadding(t);const e=this.getItemRotation(t.orientation);if(e>0){const i=t.x||0,r=t.y||0;let s=t.width||0,n=t.height||0;if((s<=0||n<=0)&&void 0!==this.ctx.measureText){const e=this.measureTextExt(t);s<=0&&(s=e.width),n<=0&&(n=e.height);}if(s<=0||n<=0)return !1;const a=i+.5*s,o=r+.5*n;if(this._apiMode&&g$1.isPortrait(e)){("boolean"!=typeof t.fixedSize||t.fixedSize)&&(t.width=n,t.height=s,t.x=a-.5*n,t.y=o-.5*s);}this.ctx.save(),this.setRotation(e,{x:a,y:o});const h=this._drawText(t);return this.ctx.restore(),h}return this._drawText(t)}_drawText(t){if(null==t.text||null==t.text){if(void 0===t.content)return !1;t.text=t.content;}const e=this.getReturnMode(t.autoReturn),i="boolean"!=typeof t.autoShrink||t.autoShrink,r=t.x||0;let s=t.y||0;const a=t.width||0;let h=t.height||0;(!t.texts||t.texts.length<=0)&&(t.texts=Array.isArray(t.text)?t.text:[String(t.text)]);const c=t.texts||[],l=t.fontHeight||h||this.fontHeight;let d=this.getHorizontalAlignment(t.horizontalAlignment),u=this.getVerticalAlignment(t.verticalAlignment);if(l<=0)return !1;(d>n$1.Stretch||d<n$1.Start)&&(d=n$1.Start),(u>n$1.Stretch||u<n$1.Start)&&(u=n$1.Start),"number"!=typeof t.charSpace&&(t.charSpace=this.CharSpace);const f=t.charSpace>0?t.charSpace:0;this.ctx.fillStyle=g$1.validateColorStr(t.color||this.Foreground),this.setFont(l,t.fontStyle,t.fontName),this.ctx.textBaseline=g$1.TEXT_BASELINE_DEFAULT;let p=[];for(let t of c)"string"!=typeof t?p.push(String(t)):(t=t.replace("\t",""),p.push(...t.split("\n")));e!==o$1.None&&a>0&&(p=this.splitText(Object.assign(Object.assign({},t),{text:p,width:a,fontHeight:l,autoReturn:e})));let m=this.getLineSpace(t.lineSpaceMode,l,t.lineSpace);if(p.length>0){const e=l*p.length,o=e+(p.length-1)*m;h<=0&&(h=o),o<=h||!i||l<7?(u===n$1.Stretch?m=(h-e)/(p.length-1):u===n$1.End?s+=h-o:u===n$1.Center&&(s+=.5*(h-o)),this.drawTextList1({texts:p,x:r,y:s,width:a,fontHeight:l,lineSpace:m,charSpace:f,horizontalAlignment:d,fontStyle:t.fontStyle||this.fontStyle,color:t.color})):this._drawText(Object.assign(t,{text:c,width:a,height:h,fontHeight:.95*l}));}return !0}drawTextList1(t){const e=t.lineSpace>0?t.lineSpace:0;let i=0;for(const r of t.texts)this._drawSingleLineText(r,t.x,t.y+i,t.width,t.fontHeight,t.horizontalAlignment,t.charSpace,t.fontStyle,t.color),i+=t.fontHeight+e;}_drawSingleLineText(t,e,i,r,a,o,h,c,l){t=String(t);const d=.14*a,g=a-d,u=void 0!==this.ctx.measureText?this.ctx.measureText(t):{width:0},f="number"==typeof u.actualBoundingBoxAscent?u.actualBoundingBoxAscent:g,p="number"==typeof u.actualBoundingBoxDescent?u.actualBoundingBoxDescent:d,m=t.length>1&&h>0?(t.length-1)*h:0,x=o||n$1.Start;let w=(null==u?void 0:u.width)||0,b=.05*a;b<1&&(b=1);const y=i+g,C=f+p;if(u&&x===n$1.Stretch&&r>u.width)h=(r-u.width)/(t.length-1),1===t.length?this.ctx.fillText(t,e+.5*(r-u.width),y):this.fillCharSpaceText(t,e,y,h),w=r;else {const i=u?u.width+m:0;(r=u?r:0)>i&&(x===n$1.End?e=e+r-i:x===n$1.Center&&(e+=.5*(r-i))),r>0&&r<i?(this.fillCharSpaceText(t,e,y,h,r),w=r):(this.fillCharSpaceText(t,e,y,h),w=i);}c&s$1.STRIKEOUT&&this._drawRect({x:e,y:y-f+.5*(C-b),width:w,height:b,color:l,fill:!0}),c&s$1.UNDERLINE&&this._drawRect({x:e,y:i+a-.5*b,width:w,height:b,color:l,fill:!0});}fillCharSpaceText(t,e,i,r,s){if(t.length<=0)return;const n=void 0!==this.ctx.measureText?this.ctx.measureText(t):void 0,a=t.length>1?(t.length-1)*r:0;if(n&&r>0){const o=n.width+a,h=s&&s<o?s/o:1;let c=e;for(const e of t){const t=this.ctx.measureText(e).width;this.ctx.fillText(e,c,i,t*h),c+=(t+r)*h;}}else s&&s>0?this.ctx.fillText(t,e,i,s):this.ctx.fillText(t,e,i);}drawArcText(t){let e=t.x||0,i=t.y||0;const r=t.width||0,s=t.height||0,n=t.lineWidth||0,a="number"==typeof t.padding?t.padding:0;let o=t.radius||0;if(o<=0){if(!(r>0||s>0))return !1;{const n=r>0&&s>0?Math.min(r,s):r>0?r:s;t.radius=o=.5*n,r>0&&(t.x=e+=.5*r),s>0&&(t.y=i+=.5*s);}}n>0&&(this.drawCircle(t),o-=n);const h=String(null===t.text||void 0===t.text?t.content||"":t.text),c=t.fontHeight;o-=c,a>0&&a<o&&(o-=a);const l=void 0!==this.ctx.measureText,d=2*Math.PI*o,u=(l?this.measureText({text:h,fontHeight:c}).width:0)/d*Math.PI*2;this.setFont(c),this.ctx.fillStyle=g$1.validateColorStr(t.color||this.Foreground),this.ctx.save();const f=this.getItemRotation(t.orientation);this.setRotation(f,{x:e,y:i}),this.ctx.translate(e,i),this.ctx.rotate(.5*-Math.PI);const p=this.ctx.textBaseline;return this.ctx.textBaseline="bottom",h.split("").forEach(((t,e)=>{const i=l?this.ctx.measureText(t).width:c,r=i/d*Math.PI*2;0===e?this.ctx.rotate(.5*-u+.5*r):this.ctx.rotate(r),this.ctx.save(),this.ctx.rotate(Math.PI/2),this.ctx.translate(.5*-i,-o),this.ctx.fillText(t,0,0),this.ctx.restore();})),this.ctx.textBaseline=p,this.ctx.restore(),!0}getTextWidths(t){const e=[];if(!t||void 0===this.ctx.measureText)return e;for(const i of t)e.push(this.ctx.measureText(i).width);return e}draw1DBarcode(t){const e=t.datas,i=t.x||0,r=t.y||0;let s=t.width||0,h=t.height||0,c="number"==typeof t.textHeight&&t.textHeight>0?t.textHeight:0,l=this.getHorizontalAlignment(t.horizontalAlignment);const d="number"==typeof t.autoScaleLevel?t.autoScaleLevel:g$1.AUTO_SCALE_LEVEL,u="number"!=typeof t.textFlag||t.topText?2:t.textFlag;c=u?c:0;let f=t.topText?c:0;const p=t.datas.map((t=>t.data||"")).join(""),m=p.length*this.PixPerUnit;s=s<m?m:s,(l>n$1.Stretch||l<n$1.Start)&&(l=n$1.Center);let x=s,w=0,b=x/p.length;if(d>0&&b/this.PixPerUnit<d&&l<=n$1.End)switch(b=1*this.PixPerUnit,x=p.length*b,l){case n$1.Start:break;case n$1.End:w=s-x;break;default:w=.5*(s-x);}const y=c>0?g$1.BarTextMargin*b:0;let C=g$1.MinBarHeight;c>0&&t.topText?C=2*(c+y)+g$1.MinBarHeight:c&&(C=c+y+g$1.MinBarHeight),h<=0?(c<=0&&(c=25),h=3*c):h<C&&(h=C);const A=this.getItemRotation(t.orientation);this.ctx.save(),this.setRotation(A,{x:i,y:r},{width:s,height:h});const v=c+y,S=.5*c+y+1,E="number"==typeof t.textAlign?t.textAlign:t.textAlignment,L=b;let M=i+w,_=r+f+y,B=_,I=r;if(t.topText&&e.length>=7){const s=e.slice(1,6).map((t=>t.data)).join("").length*L;f+=y,this._drawText({text:t.topText,x:i+e[0].data.length*L,y:r,width:s,height:c,fontHeight:c,fontStyle:t.fontStyle,fontName:t.fontName,color:t.color,autoReturn:o$1.None,horizontalAlignment:"number"==typeof E?E:n$1.Center,charSpace:t.charSpace});}for(const i of e){if(h>v){const e=i.text?v:v-S,s=h-e-f;1===u?(B=r,_=B+e):(_=r+f,B=_+s,I=B+y),this.BorderAlign=a$1.None;for(let n=0;n<i.data.length;n++,M+=L)"1"===i.data[n]?(t.bgColor&&this._drawRect({x:M,y:B,width:L,height:e,color:t.bgColor,fill:!0}),this._drawRect({x:M,y:_,width:L,height:s,color:t.color,fill:!0})):t.bgColor&&this._drawRect({x:M,y:r,width:L,height:h,color:t.bgColor,fill:!0});}if(i.text){const r=e.length>2&&i.text.length>1?g$1.DockCharMargin*L:0,s=i.data.length*L;this._drawText({text:i.text,x:M-s+r,y:I,width:s-2*r,height:c,fontHeight:c,fontStyle:t.fontStyle,fontName:t.fontName,color:t.color,autoReturn:o$1.None,horizontalAlignment:"number"==typeof E?E:n$1.Center,charSpace:t.charSpace});}}return this.ctx.restore(),!0}drawQrcode(e){const i=e.data;let r=e.x||0,s=e.y||0,o=e.width||0,h=e.height||o;const c=e.zoneSize||0,l="number"==typeof e.autoScaleLevel?e.autoScaleLevel:g$1.AUTO_SCALE_LEVEL,d=e.data.cols||0,u=d+2*c,f=u*this.PixPerUnit;o<=0?o=d*this.ModulePixels:o<f&&(o=f),h<=0?h=o:h<f&&(h=f);const p=this.getItemRotation(e.orientation);this.ctx.save(),this.setRotation(p,{x:r,y:s},{width:o,height:h});let m=Math.min(o,h),x=Math.floor(m/u*.4);x=x<1?1:x,c<=0&&(r+=x,s+=x,o-=2*x,h-=2*x),m=Math.min(o,h);let w=m/(u*this.PixPerUnit),b=m/u;l>0&&w<l&&(w=w<1?1:Math.floor(w),b=w*this.PixPerUnit,m=b*u);let y=this.getHorizontalAlignment(e.horizontalAlignment),C=this.getVerticalAlignment(e.verticalAlignment);(y>n$1.Stretch||y<n$1.Start)&&(y=n$1.Center),(C>n$1.Stretch||C<n$1.Start)&&(C=n$1.Center);let A=0,v=0;switch(y){case n$1.Start:break;case n$1.End:A=Math.round(o-m);break;default:A=Math.round(.5*(o-m));}switch(C){case n$1.Start:break;case n$1.End:v=Math.round(h-m);break;default:v=Math.round(.5*(h-m));}let S=c*b;const E=b,L=t$1.createRect(Math.floor(r+A),Math.floor(s+v),Math.ceil(m),Math.ceil(m));S<=0&&(S=x,L.x+=x,L.y+=x,L.width-=2*x,L.height-=2*x),this.BorderAlign=a$1.None,e.bgColor&&this._drawRect({x:L.x,y:L.y,width:L.width,height:L.height,color:e.bgColor,fill:!0});const M=Math.floor(S);L.x-=M,L.y-=M,L.width+=2*M,L.height+=2*M;for(let t=0,r=L.y;t<d;t++,r+=E)for(let s=0,n=L.x;s<d;s++,n+=E)i.data[t*d+s]?this._drawRect({x:n,y:r,width:E,height:E,color:e.color,fill:!0}):e.bgColor&&this._drawRect({x:n,y:r,width:E,height:E,color:e.bgColor,fill:!0});this.ctx.restore();}draw2DBarcode(t){const e=t.data,i=t.x||0,r=t.y||0;let s=t.width||0,o=t.height||s;const h=t.zoneSize||0,c=t.barPixels||this.ModulePixels,l="number"==typeof t.autoScaleLevel?t.autoScaleLevel:g$1.AUTO_SCALE_LEVEL,d=e.rows||0,u=e.cols||0;if(d<=0||u<=0)return !1;const f=d+2*h,p=u+2*h,m=p*this.PixPerUnit,x=f*this.PixPerUnit;let w=this.getHorizontalAlignment(t.horizontalAlignment),b=this.getVerticalAlignment(t.verticalAlignment),y=0,C=0;(w>n$1.Stretch||w<n$1.Start)&&(w=n$1.Center),(b>n$1.Stretch||b<n$1.Start)&&(b=n$1.Center),s<=0?(y=c*this.PixPerUnit,s=y*p):s<=m?(y=this.PixPerUnit,s=m):y=s/p,o<=0?(C=c*this.PixPerUnit,o=C*f):o<=x?(C=this.PixPerUnit,o=x):C=o/f;const A=this.getItemRotation(t.orientation);this.ctx.save(),this.setRotation(A,{x:i,y:r},{width:s,height:o}),w<n$1.Stretch&&(y=Math.min(y,C),y<l*this.PixPerUnit&&(y=Math.floor(y/this.PixPerUnit)*this.PixPerUnit)),b<n$1.Stretch&&(C=Math.min(y,C),C<l*this.PixPerUnit&&(C=Math.floor(C/this.PixPerUnit)*this.PixPerUnit));const v=p*y,S=f*C;let E=0,L=0;switch(w){case n$1.Start:break;case n$1.End:E=Math.round(s-v);break;default:E=Math.round(.5*(s-v));}switch(b){case n$1.Start:break;case n$1.End:L=Math.round(o-S);break;default:L=Math.round(.5*(o-S));}const M=Math.floor(i+E),_=Math.floor(r+L);this.BorderAlign=a$1.None,t.bgColor&&h>0&&(this._drawRect({x:M,y:_,width:Math.round(v),height:Math.round(C*h),color:t.bgColor,fill:!0}),this._drawRect({x:M,y:Math.round(_+(d+h)*C),width:Math.round(v),height:Math.round(h*C),color:t.bgColor,fill:!0}),this._drawRect({x:M,y:_,width:Math.round(y*h),height:Math.round(S),color:t.bgColor,fill:!0}),this._drawRect({x:Math.round(M+(u+h)*y),y:_,width:Math.round(h*y),height:Math.round(S),color:t.bgColor,fill:!0}));for(let i=0,r=_+C*h;i<d;i++,r+=C)for(let s=0,n=M+y*h;s<u;s++,n+=y)e.data[i*(e.cols||0)+s]?this._drawRect({x:n,y:r,width:y,height:C,color:t.color,fill:!0}):t.bgColor&&this._drawRect({x:n,y:r,width:y,height:C,color:t.bgColor,fill:!0});return this.ctx.restore(),!0}drawImage(t){const e=t.image||t.img,i=e?e.dzSrc||e:void 0;if(!i)return !1;const r=Math.ceil(t.x||0),s=Math.ceil(t.y||0),n=Math.floor(t.width||0)||i.width,a=Math.floor(t.height||0)||i.height;this.ctx.save();const o=this.getItemRotation(t.orientation);return this.setRotation(o,{x:r,y:s},{width:n,height:a}),t.swidth&&t.sheight?this.ctx.drawImage(i,t.sx||0,t.sy||0,t.swidth,t.sheight,r,s,n,a):t.width||t.height?this.ctx.drawImage(i,r||0,s||0,n,a):this.ctx.drawImage(i,r,s),this.ctx.restore(),!0}drawImageResizeLabel(t,e){if(!t.img||this.width<=0||this.height<=0)return;const i=t.img,r=i.width||t.imageWidth||0,s=i.height||t.imageHeight||0;let n=0,a=0,o=0;if(r<=0||s<=0)return void l$1.warn("---- drawImageResizeLabel: 无法获取 img 对象的像素大小，所以无法对目标图片进行分割绘制！");r/s<this.width/this.height?(o=this.height,a=r*this.height/r,n=this.height/s):(a=this.width,o=this.width*s/r,n=this.width/r);let h=n;t.fullOfLabel?h=n:t.relativeScale&&t.relativeScale>0?h=t.relativeScale*n:e&&(h=e);const c=Math.floor(t.left),d=Math.floor(t.top),g=Math.ceil(t.right),u=Math.ceil(t.bottom),f=g-c,p=u-d,m=r-g,x=s-u,w=a/(c+m+1),b=o/(d+x+1),y=Math.min(w,b);h>y&&(h=t.relativeScale&&t.relativeScale>0?y:n);const C=Math.floor(c*h),A=Math.floor(d*h),v=Math.floor(m*h),S=Math.floor(x*h),E=this.width-v,L=this.height-S;if(this.ctx.drawImage(i,0,0,c,d,0,0,C,A),this.ctx.drawImage(i,g,0,m,d,E,0,v,A),this.ctx.drawImage(i,g,u,m,x,E,L,v,S),this.ctx.drawImage(i,0,u,c,x,0,L,C,S),t.tileMode){const t=a-C-v,e=o-A-S;let r=t,s=e,n=f,h=p;if(t>0)for(let e=C;e<E;e+=t)E-e<t?(r=E-e,n=f*r/t):(r=t,n=f),this.ctx.drawImage(i,c,0,n,d,e,0,r,A),this.ctx.drawImage(i,c,u,n,x,e,L,r,S);if(e>0)for(let t=A;t<L;t+=e)L-t<e?(s=L-t,h=p*s/e):(s=e,h=p),this.ctx.drawImage(i,0,d,c,h,0,t,C,s),this.ctx.drawImage(i,g,d,m,h,E,t,v,s);}else {const t=E-C,e=L-A;this.ctx.drawImage(i,c,0,f,d,C,0,t,A),this.ctx.drawImage(i,g,d,m,p,E,A,v,e),this.ctx.drawImage(i,c,u,f,x,C,L,t,S),this.ctx.drawImage(i,0,d,c,p,0,A,C,e);}}measureText(t){return (t.fontHeight||t.fontStyle||t.fontName)&&this.setFont(t.fontHeight,t.fontStyle,t.fontName),void 0!==this.ctx.measureText?this.ctx.measureText(t.text||""):{width:0}}measureTextExt(t){const e=t.fontHeight||this.fontHeight;let i=t.width||0;const r=this.splitText(Object.assign(t,{text:t.text||""})),s=t.lineSpace||0,n=t.charSpace||0,a=r.length>1?(r.length-1)*s:0;if(i<=0&&void 0!==this.ctx.measureText)for(let t=0;t<r.length;t++)if(r[t].length>0){const e=this.ctx.measureText(r[t]).width+(r[t].length-1)*n;e>i&&(i=e);}return {width:i,height:e*r.length+a}}measureFontSize(t){const e=t.text||"",i=t.width||0,r=t.minFontSize||16;if(i<=0||e.length<=0||void 0===this.ctx.measureText)return t.fontHeight||0;let s,n=t.fontHeight||this.fontHeight;do{if(s=this.measureText({text:e,fontHeight:n,fontStyle:t.fontStyle,fontName:t.fontName}),s.width<=i)return n;n*=.95;}while(n<=r);return r}findSplitPosition(t,e,i,r){if(t.length<=1)return t.length;const s=r||0;let n=1,a=this.ctx.measureText(t.substring(0,n)).width;if(a>=e)return n;let o=0,h=0;if(s>0)for(;h<e&&o<t.length;)o+s>t.length?o=t.length:(h>a&&(n=o,a=h),o+=s),h=this.ctx.measureText(t.substring(0,o)).width+(o-1)*i;else o=t.length,h=this.ctx.measureText(t).width+(o-1)*i;if(h<=e)return o;for(;n<o&&o!==n+1;){const r=n+Math.floor((o-n)/2),s=this.ctx.measureText(t.substring(0,r)).width+(r-1)*i;if(s>e)o=r,h=s;else if(n=r,a=s,s>=e)break}return n}findWordSplitPos(t,e){let i=0;if(e>=t.length||/\W/.exec(t.charAt(e)))return e;for(i=e-1;i>=0&&!/\W/.exec(t.charAt(i));i--);return i+1}splitText(t){if(g$1.isNull(t.text))return [];"number"!=typeof t.charSpace&&(t.charSpace=this.CharSpace);const e=t.charSpace>0?t.charSpace:0,i=Array.isArray(t.text)?t.text:[String(t.text)],r=[],s=void 0!==this.ctx.measureText;for(const t of i)r.push(...t.split("\n"));let n=0,a=0;const h=[];this.setFont(t.fontHeight,t.fontStyle,t.fontName);for(const i of r)if(t.autoReturn&&t.width&&t.width>0&&s){let r=i;for(;r.length>0;)n=this.findSplitPosition(r,t.width,e,t.measureOptimizeStep),t.autoReturn===o$1.Word&&(a=this.findWordSplitPos(r,n),a>0&&a<n&&(n=a)),h.push(r.substring(0,n)),r=n<r.length?r.substring(n):"";}else h.push(i);return h}inverseColors(){const t=this.ctx,e=this.getImageData();if(e){const i=e.data;for(let t=0;t<i.length;t+=4)i[t]=255-i[t],i[t+1]=255-i[t+1],i[t+2]=255-i[t+2];return t.putImageData(e,0,0),!0}return !1}horizontalFlip(){const t=this.ctx,e=this.getImageData(),i=t.createImageData(this.Canvas.width,this.Canvas.height);if(e&&i){const r=e.width,s=e.height;for(let t=0;t<s;t++)for(let s=0;s<r;s++)i.data[t*r*4+4*s+0]=e.data[t*r*4+4*(r-s)+0],i.data[t*r*4+4*s+1]=e.data[t*r*4+4*(r-s)+1],i.data[t*r*4+4*s+2]=e.data[t*r*4+4*(r-s)+2],i.data[t*r*4+4*s+3]=e.data[t*r*4+4*(r-s)+3];return t.putImageData(i,0,0),!0}return !1}getImageData(){return "function"==typeof this.ctx.getImageData?this.ctx.getImageData(0,0,this.Canvas.width,this.Canvas.height):void l$1.info("---- 当前绘制环境不支持函数：getImageData")}processCanvasPixels(t){if(this.ctx){const e=this.ctx.createImageData(this.Canvas.width,this.Canvas.height),i=e.data,r=this.ctx.getImageData(0,0,this.Canvas.width,this.Canvas.height).data;let s=0;for(let e=0;e<r.length;e+=4)s=t(r[e],r[e+1],r[e+2],r[0]),i[e]=i[e+1]=i[e+2]=s,i[e+3]=r[e+3];this.ctx.putImageData(e,0,0);}}toGray256(){this.processCanvasPixels(((t,e,i,r)=>Math.round(.3*t+.59*e+.11*i)));}toBlackWhite(t){const e=t||128;this.processCanvasPixels(((t,i,r,s)=>Math.round(.3*t+.59*i+.11*r)<=e?0:255));}}g$1.NO_START_STOP=4,g$1.MinBarHeight=2,g$1.BarTextMargin=1,g$1.DockHorizMargin=7,g$1.DockCharMargin=1,g$1.BarIsbnMargin=0,g$1.AUTO_SCALE_LEVEL=2,g$1.COLOR_FG_DEFAULT="#000",g$1.COLOR_BG_DEFAULT="#fff",g$1.LINE_WIDTH=28,g$1.FONT_NAME="黑体",g$1.TEXT_BASELINE_DEFAULT="alphabetic";class u$1{constructor(t){this._dpi=203,this._dpm=203/25.4,this._offsetX=0,this._offsetY=0,this.cvs=new g$1(t);}get Base(){return this.cvs}get ScaleUnit(){return this._scaleUnit||h$1.Auto}get Dpi(){return this._dpi}set Dpi(t){t&&t>0&&(this._dpi=t,this._dpm=t/25.4);}get DPM(){return this._dpm}set DPM(t){t>0&&(this._dpm=t,this._dpi=25.4*t);}get OffsetX(){return this._offsetX}set OffsetX(t){this._offsetX=t;}get OffsetY(){return this._offsetY}set OffsetY(t){this._offsetY=t;}get Width(){return this.cvs.Width/this.DPM}get Height(){return this.cvs.Height/this.DPM}get CanvasWidth(){return this.cvs.Canvas.width}get CanvasHeight(){return this.cvs.Canvas.height}get Foreground(){return this.cvs.Foreground}set Foreground(t){this.cvs.Foreground=t;}setFontName(t){this.cvs.FontName=t;}getFontHeight(){return this.invertCvt(this.cvs.FontHeight)}setFontHeight(t){this.cvs.FontHeight=this.cvt(t);}setLineSpace(t){this.cvs.LineSpace=this.cvt(t);}setCharSpace(t){this.cvs.CharSpace=this.cvt(t);}getLineWidth(){return this.invertCvt(this.cvs.LineWidth)}setLineWidth(t){this.cvs.LineWidth=this.cvt(t);}setRotation(t,e,i){return e&&(e.x=this.cvt(e.x),e.y=this.cvt(e.y)),i&&(i.width=this.cvt(i.width),i.height=this.cvt(i.height)),this.cvs.setRotation(t,e,i)}supports(t){return this.cvs.supports(t)}startJob(t){return this._scaleUnit=t.scaleUnit,t.dpi&&(this.Dpi=t.dpi),this.cvs.startJob(this.cvtDrawOptions(t))?this.cvs:void 0}commitJob(){return this.cvs.commitJob()?this.cvs:void 0}drawLine(t){return this.cvs.drawLine(this.cvtDrawOptions(t))}drawRect(t){return this.cvs.drawRect(this.cvtDrawOptions(t))}drawRoundRect(t){return this.cvs.drawRoundRect(this.cvtDrawOptions(t))}drawEllipse(t){return this.cvs.drawEllipse(this.cvtDrawOptions(t))}drawCircle(t){return this.cvs.drawCircle(this.cvtDrawOptions(t))}drawText(t){return this.cvs.drawText(this.cvtDrawOptions(t))}drawArcText(t){return this.cvs.drawArcText(this.cvtDrawOptions(t))}draw1DBarcode(t){return (t=this.cvtDrawOptions(t)).textHeight=this.cvt(t.textHeight),this.cvs.draw1DBarcode(t)}drawQrcode(t){return this.cvs.drawQrcode(this.cvtDrawOptions(t))}draw2DBarcode(t){return this.cvs.draw2DBarcode(this.cvtDrawOptions(t))}drawImage(t){return this.cvs.drawImage(this.cvtDrawOptions(t))}drawImageResizeLabel(t){return this.cvs.drawImageResizeLabel(t,this.DPM/20)}splitText(t){return this.cvs.splitText(this.cvtDrawOptions(t))}measureText(t){return t.fontHeight=this.cvt(t.fontHeight),this.cvs.measureText(t)}measureFontSize(t){(t=this.cvtDrawOptions(t)).minFontSize=this.cvt(t.minFontSize);const e=this.cvs.measureFontSize(t);return this.invertCvt(e)}cvt(t){return "number"==typeof t?t*this._dpm:t}invertCvt(t){return "number"==typeof t?t/this._dpm:t}cvtArray(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]=this.cvt(t[e]);return t}cvtDrawOptions(t){if(this.ScaleUnit===h$1.Pix)return t;(t=Object.assign({},t)).x&&(t.x=this.cvt(t.x+this.OffsetX)),t.y&&(t.y=this.cvt(t.y+this.OffsetY)),t.width&&(t.width=this.cvt(t.width)),t.height&&(t.height=this.cvt(t.height)),"number"==typeof t.margin?t.margin=this.cvt(t.margin):this.cvtArray(t.margin),"number"==typeof t.padding?t.padding=this.cvt(t.padding):this.cvtArray(t.padding);const e=t;e.lineWidth&&(e.lineWidth=this.cvt(e.lineWidth)),e.radius&&(e.radius=this.cvt(e.radius));const i=t;i.cornerWidth&&(i.cornerWidth=this.cvt(i.cornerWidth)),i.cornerHeight&&(i.cornerHeight=this.cvt(i.cornerHeight));const r=t;r.x1&&(r.x1=this.cvt(r.x1+this.OffsetX)),r.y1&&(r.y1=this.cvt(r.y1+this.OffsetY)),r.x2&&(r.x2=this.cvt(r.x2+this.OffsetX)),r.y2&&(r.y2=this.cvt(r.y2+this.OffsetY)),r.dashLens&&(r.dashLens=r.dashLens.map((t=>this.cvt(t)))),r.dashLen&&(r.dashLen=r.dashLen.split(",").map((t=>this.cvt(+t))).join(","));const s=t;return s.fontHeight&&(s.fontHeight=this.cvt(s.fontHeight)),s.lineSpace&&"number"==typeof s.lineSpace&&(s.lineSpace=this.cvt(s.lineSpace)),s.charSpace&&(s.charSpace=this.cvt(s.charSpace)),t}inverseColors(){return this.cvs.inverseColors()}horizontalFlip(){return this.cvs.horizontalFlip()}getImageData(){return this.cvs.getImageData()}}function f$1(t,e,i,r){return new(i||(i=Promise))((function(s,n){function a(t){try{h(r.next(t));}catch(t){n(t);}}function o(t){try{h(r.throw(t));}catch(t){n(t);}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e);}))).then(a,o);}h((r=r.apply(t,e||[])).next());}))}u$1.BORDER_DPM_DEFAULT=8,"function"==typeof SuppressedError&&SuppressedError;class p$1{constructor(t,e){this.cols=t||0,this.rows=e||0,this.data=new Uint8Array(this.rows*this.cols);}get reservedBit(){return this._reservedBit||(this._reservedBit=new Uint8Array(this.data.length)),this._reservedBit}set(t,e,i,r){const s=t*this.cols+e;this.data[s]="number"==typeof i?i:i?1:0,r&&(this.reservedBit[s]=1);}get(t,e){return this.data[t*this.cols+e]}getRowData(t){const e=(t||0)*this.cols;return this.data.slice(e,e+this.cols)}getColData(t){return this.data.filter(((e,i)=>i%this.cols===t))}xor(t,e,i){this.data[t*this.cols+e]^=i?1:0;}fill(t,e,i,r){const s=(e||0)*this.cols+(i||0);let n=0;n="number"==typeof r?r>0?s+r:this.data.length+r:this.data.length,this.data.fill(t,s,n);}setArray(t,e,i){const r=(e||0)*this.cols+(i||0);this.data.set(t,r);}addRow(t,e,i){e>=this.data.length?console.error(`offset: ${e} 越界`):(i&&i<t.length&&(t=t.slice(0,i)),this.data.set(t,e));}isReserved(t,e){return this._reservedBit?this._reservedBit[t*this.cols+e]:0}}const m$1=Object.freeze({nullCharacter:0,maxAsciiCharacter:127,lineFeed:10,LF:10,carriageReturn:13,CR:13,lineSeparator:8232,paragraphSeparator:8233,nextLine:133,space:32,nonBreakingSpace:160,enQuad:8192,emQuad:8193,enSpace:8194,emSpace:8195,threePerEmSpace:8196,fourPerEmSpace:8197,sixPerEmSpace:8198,figureSpace:8199,punctuationSpace:8200,thinSpace:8201,hairSpace:8202,zeroWidthSpace:8203,narrowNoBreakSpace:8239,ideographicSpace:12288,mathematicalSpace:8287,ogham:5760,_:95,$:36,num_0:48,num_9:57,a:97,z:122,A:65,Z:90,ampersand:38,asterisk:42,at:64,backslash:92,backtick:96,bar:124,caret:94,closeBrace:125,closeBracket:93,closeParen:41,colon:58,comma:44,dot:46,doubleQuote:34,equals:61,exclamation:33,greaterThan:62,hash:35,lessThan:60,minus:45,openBrace:123,openBracket:91,openParen:40,percent:37,plus:43,question:63,semicolon:59,singleQuote:39,slash:47,tilde:126,backspace:8,formFeed:12,byteOrderMark:65279,tab:9,verticalTab:11});class x$1{static isDigit(t){return "number"==typeof t?t>=m$1.num_0&&t<=m$1.num_9:t>="0"&&t<="9"}static isDigits(t,e,i){const r=e||0,s=i?r+i:t.length;return !(s>t.length)&&t.substring(r,s).match(/^[0-9]+$/)}static isUpper(t){return "number"==typeof t?t>=m$1.A&&t<=m$1.Z:t>="A"&&t<="Z"}static isLower(t){return "number"==typeof t?t>=m$1.a&&t<=m$1.z:t>="a"&&t<="z"}static ctoi(t){const e="string"==typeof t?t.charCodeAt(0):t;return e>=m$1.num_0&&e<=m$1.num_9?e-m$1.num_0:e>=m$1.A&&e<=m$1.Z?e-m$1.A+10:e>=m$1.a&&e<=m$1.z?e-m$1.a+10:-1}static itoc(t){return t>=0&&t<=9?`${t}`:String.fromCharCode(t-10+m$1.A)}static repeatChar(t,e){const i=[];for(let r=0;r<e;r++)i.push(t);return i.join("")}static preFillChar(t,e,i){return t.length<e?Array(e-t.length+1).join(i)+t:t}}class w$1{static isISO_8859_1(t){if(!t)return !1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)>255)return !1;return !0}static getCharCodes(t){t=t||"";const e=[];for(let i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e}static getCharCodeArrayString(t){return t.map((t=>String.fromCharCode(t))).join("")}static encodeUtf8(t){const e=[];for(let i=0;i<t.length;i++){let r=t.charCodeAt(i);if(r>=55296&&r<=56319&&t.length>i+1){const e=t.charCodeAt(i+1);e>=56320&&e<=57343&&(r=1024*(r-55296)+e-56320+65536,i+=1);}r<128?e.push(r):r<2048?(e.push(r>>6|192),e.push(63&r|128)):r<55296||r>=57344&&r<65536?(e.push(224|r>>12),e.push(128|r>>6&63),e.push(128|63&r)):r>=65536&&r<=1114111?(e.push(240|r>>18),e.push(128|r>>12&63),e.push(128|r>>6&63),e.push(128|63&r)):e.push(239,191,189);}return new Uint8Array(e)}static getBytes_Utf8(t){try{return (new TextEncoder).encode(t)}catch(e){return console.log("DzTextEncoder.encode: TextEncoder is not defined"),this.encodeUtf8(t)}}static getBytes_ISO8859_1(t){return t=unescape(encodeURIComponent(t)),Uint8Array.from(this.getCharCodes(t))}static getBytes_Unicode(t){return Uint8Array.from(this.getCharCodes(t))}static getBytes(t,e){return t=t||"",e?w$1.getBytes_Utf8(t):w$1.getBytes_Unicode(t)}static hasBase256Chars(t){const e="string"==typeof t?t.split("").map((t=>t.charCodeAt(0))):t;if((null==e?void 0:e.length)>0)for(const t of e)if(t>=128)return !0;return !1}static encodeUnicodeFromUtf8(t){let e=0,i=0,r=0;const s=[];do{if(t[i]<=127)s[r]=t[i],e=i+1,r++;else {if(t[i]>=128&&t[i]<=191)return;if(t[i]>=192&&t[i]<=193)return;if(t[i]>=194&&t[i]<=223)s[r]=((31&t[i])<<6)+(63&t[i+1]),e=i+2,r++;else if(t[i]>=224&&t[i]<=239)s[r]=((15&t[i])<<12)+((63&t[i+1])<<6)+(63&t[i+2]),e=i+3,r++;else if(t[i]>=240)return}i=e;}while(i<t.length);return s}}var b$1;!function(t){t[t.UPC_A=20]="UPC_A",t[t.UPC_E=21]="UPC_E",t[t.EAN13=22]="EAN13",t[t.EAN8=23]="EAN8",t[t.CODE39=24]="CODE39",t[t.ITF25=25]="ITF25",t[t.CODABAR=26]="CODABAR",t[t.CODE93=27]="CODE93",t[t.CODE128=28]="CODE128",t[t.ISBN=29]="ISBN",t[t.ECODE39=30]="ECODE39",t[t.ITF14=31]="ITF14",t[t.ChinaPost=32]="ChinaPost",t[t.Matrix25=33]="Matrix25",t[t.Industrial25=34]="Industrial25",t[t.GS1_128=35]="GS1_128",t[t.EAN128=35]="EAN128",t[t.AUTO=60]="AUTO";}(b$1||(b$1={}));class y$1{constructor(t,e){this.data=t||"",this.text=e.text||t||"",this.options=e;}encode(t,e){return {}}}const C$1=103,A$1=104,v$1=105,S$1={[C$1]:0,[A$1]:1,[v$1]:2},E$1={101:0,100:1,99:2},L$1=String.fromCharCode(208),M$1=String.fromCharCode(209),_$1=String.fromCharCode(210),B$1="[\0-_È-Ï]",I$1="[ -È-Ï]",D$1=[11011001100,11001101100,11001100110,10010011e3,10010001100,10001001100,10011001e3,10011000100,10001100100,11001001e3,11001000100,11000100100,10110011100,10011011100,10011001110,10111001100,10011101100,10011100110,11001110010,11001011100,11001001110,11011100100,11001110100,11101101110,11101001100,11100101100,11100100110,11101100100,11100110100,11100110010,11011011e3,11011000110,11000110110,10100011e3,10001011e3,10001000110,10110001e3,10001101e3,10001100010,11010001e3,11000101e3,11000100010,10110111e3,10110001110,10001101110,10111011e3,10111000110,10001110110,11101110110,11010001110,11000101110,11011101e3,11011100010,11011101110,11101011e3,11101000110,11100010110,11101101e3,11101100010,11100011010,11101111010,11001000010,11110001010,1010011e4,10100001100,1001011e4,10010000110,10000101100,10000100110,1011001e4,10110000100,1001101e4,10011000010,10000110100,10000110010,11000010010,1100101e4,11110111010,11000010100,10001111010,10100111100,10010111100,10010011110,10111100100,10011110100,10011110010,11110100100,11110010100,11110010010,11011011110,11011110110,11110110110,10101111e3,10100011110,10001011110,10111101e3,10111100010,11110101e3,11110100010,10111011110,10111101110,11101011110,11110101110,11010000100,1101001e4,11010011100,1100011101011];class T$1 extends y$1{constructor(t,e){super(t.substring(1),e),this.bytes=t.split("").map((t=>t.charCodeAt(0)));}valid(){return /^[\x00-\x7F\xC8-\xD3]+$/.test(this.data)}encode(){const t=this.bytes,e=(t.shift()||0)-105,i=S$1[e];if(void 0===i)throw new RangeError("The encoding does not start with a start character.");this.shouldEncodeAsEan128()&&t.unshift(207);const r=T$1.next(t,1,i);return {items:[{text:this.text===this.data?this.text.replace(/[^\x20-\x7E]/g,""):this.text,data:T$1.getBar(e)+r.result+T$1.getBar((r.checksum+e)%103)+T$1.getBar(106)}],text:this.text,options:this.options}}shouldEncodeAsEan128(){return this.options.ean128}static getBar(t){return D$1[t]?D$1[t].toString():""}static correctIndex(t,e){if(0===e){const e=t.shift()||0;return e<32?e+64:e-32}return 1===e?(t.shift()||0)-32:10*((t.shift()||0)-48)+(t.shift()||0)-48}static next(t,e,i){if(!t.length)return {result:"",checksum:0};let r,s;if(t[0]>=200){s=(t.shift()||0)-105;const n=E$1[s]||0;void 0!==n?r=T$1.next(t,e+1,n):(0!==i&&1!==i||98!==s||(t[0]=0===i?t[0]>95?t[0]-96:t[0]:t[0]<32?t[0]+96:t[0]),r=T$1.next(t,e+1,i));}else s=T$1.correctIndex(t,i),r=T$1.next(t,e+1,i);const n=s*e;return {result:T$1.getBar(s)+r.result,checksum:n+r.checksum}}}const R$1=t=>{const e=t.match(new RegExp(`^${B$1}*`));return e?e[0].length:0},P$1=t=>{const e=t.match(new RegExp(`^${I$1}*`));return e?e[0].length:0},O$1=t=>{const e=t.match(new RegExp("^(Ï*[0-9]{2}Ï*)*"));return e?e[0]:""};function N$1(t,e){const i=e?B$1:I$1,r=t.match(new RegExp(`^(${i}+?)(([0-9]{2}){2,})([^0-9]|$)`));if(r)return r[1]+String.fromCharCode(204)+U$1(t.substring(r[1].length));const s=t.match(new RegExp(`^${i}+`)),n=s?s[0]:"";return n.length===t.length?t:n+String.fromCharCode(e?205:206)+N$1(t.substring(n.length),!e)}function U$1(t){const e=O$1(t),i=e.length;if(i===t.length)return t;t=t.substring(i);const r=R$1(t)>=P$1(t);return e+String.fromCharCode(r?206:205)+N$1(t,r)}class W$1 extends T$1{constructor(t,e){if(/^[\x00-\x7F\xC8-\xD3]+$/.test(t)){let i;if(O$1(t).length>=2)i=_$1+U$1(t);else {const e=R$1(t)>P$1(t);i=(e?L$1:M$1)+N$1(t,e);}super(i.replace(/[\xCD\xCE]([^])[\xCD\xCE]/,((t,e)=>String.fromCharCode(203)+e)),e);}else super(t,e);}}const H$1={L:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],G:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],R:["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],O:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],E:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"]},k$1=(t,e,i)=>{let r=t.split("").map(((t,i)=>H$1[e[i]])).map(((e,i)=>e?e[t[i]]:""));if(i){const e=t.length-1;r=r.map(((t,r)=>r<e?t+i:t));}return r.join("")};let F$1=class t extends y$1{constructor(t,e){super(t,e),this.quietZones=0,this.guardWhitespace=!1,this.quietZones=e.quietZones||0,this.guardWhitespace=e.guardWhitespace||!1;}encode(){const t=this.options.flat?this.encodeFlat():this.encodeGuarded();return {options:this.options,items:t,text:this.text}}leftText(t,e){return this.text.substr(t,e)}leftEncode(t,e){return k$1(t||"",e||"")}rightText(t,e){return this.text.substr(t,e)}rightEncode(t,e){return k$1(t||"",e||"")}encodeGuarded(){const e=[{data:t.SIDE_BIN,text:""},{data:this.leftEncode(),text:this.leftText(0)},{data:t.MIDDLE_BIN,text:""},{data:this.rightEncode(),text:this.rightText()},{data:t.SIDE_BIN,text:""}];if(this.quietZones>0){const t=Array(this.quietZones).fill("0").join("");e.unshift({data:t,text:this.guardWhitespace?"< ":""}),e.push({data:t,text:this.guardWhitespace?" >":""});}return e}encodeFlat(){return [{data:[t.SIDE_BIN,this.leftEncode(),t.MIDDLE_BIN,this.rightEncode(),t.SIDE_BIN].join(""),text:this.text}]}};F$1.SIDE_BIN="101",F$1.MIDDLE_BIN="01010";class j$1 extends y$1{constructor(t,e){super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{2}$/)}encode(){const t=j$1.EAN2_STRUCTURE[parseInt(this.data)%4],e={data:"1011"+k$1(this.data,t,"01"),text:this.text};return {options:this.options,items:[e],text:this.text}}}j$1.EAN2_STRUCTURE=["LL","LG","GL","GG"];class $$1 extends y$1{static checksum(t){return t.split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+9*e:t+3*e),0)%10}constructor(t,e){super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{5}$/)}encode(){const t=$$1.EAN5_STRUCTURE[$$1.checksum(this.data)];return {items:[{data:"1011"+k$1(this.data,t,"01"),text:this.text}],text:this.text,options:this.options}}}$$1.EAN5_STRUCTURE=["GGLLL","GLGLL","GLLGL","GLLLG","LGGLL","LLGGL","LLLGG","LGLGL","LGLLG","LLGLG"];class z$1 extends F$1{static checksum(t){return (10-t.substring(0,7).split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+e:t+3*e),0)%10)%10}constructor(t,e){-1!==t.search(/^[0-9]{7}$/)&&(t+=z$1.checksum(t)),super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{8}$/)&&+this.data[7]===z$1.checksum(this.data)}leftText(){return super.leftText(0,4)}leftEncode(){const t=this.data.substring(0,4);return super.leftEncode(t,"LLLL")}rightText(){return super.rightText(4,4)}rightEncode(){const t=this.data.substring(4,8);return super.rightEncode(t,"RRRR")}}let G$1=class t extends F$1{static checksum(t){return (10-t.substring(0,12).split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+3*e:t+e),0)%10)%10}constructor(e,i){-1!==e.search(/^[0-9]{12}$/)&&(e+=t.checksum(e)),super(e,i);}valid(){return -1!==this.data.search(/^[0-9]{13}$/)&&+this.data[12]===t.checksum(this.data)}leftText(){return super.leftText(1,6)}leftEncode(){const e=this.data.substring(1,7),i=t.EAN13_STRUCTURE[Number(this.data[0])];return super.leftEncode(e,i)}rightText(){return super.rightText(7,6)}rightEncode(){const t=this.data.substring(7,13);return super.rightEncode(t,"RRRRRR")}encodeGuarded(){const t=super.encodeGuarded();return this.quietZones>0?t[0].text=this.text[0]:t.unshift({data:"00000",text:this.text[0]}),t}};G$1.EAN13_STRUCTURE=["LLLLLL","LLGLGG","LLGGLG","LLGGGL","LGLLGG","LGGLLG","LGGGLL","LGLGLG","LGLGGL","LGGLGL"];class V$1 extends y$1{static checksum(t){let e,i=0;for(e=1;e<11;e+=2)i+=parseInt(t[e]);for(e=0;e<11;e+=2)i+=3*parseInt(t[e]);return (10-i%10)%10}constructor(t,e){-1!==t.search(/^[0-9]{11}$/)&&(t+=V$1.checksum(t)),super(t,e),this.displayValue=e.displayValue;}valid(){if(-1!==this.data.search(/^[0-9]{12}$/)){return parseInt(this.data[11])===V$1.checksum(this.data)}return !1}encode(){return {items:this.options.flat?this.flatEncoding():this.guardedEncoding(),text:this.text,options:this.options}}flatEncoding(){let t="";t+="101",t+=k$1(this.data.substring(0,6),"LLLLLL"),t+="01010",t+=k$1(this.data.substring(6,6),"RRRRRR"),t+="101";return [{data:t,text:this.text}]}guardedEncoding(){const t=[],e="number"==typeof this.options.quietZones&&this.options.quietZones>2?this.options.quietZones:2,i=Array(e).fill("0").join("");return t.push({data:i,text:this.text.substring(0,1)}),t.push({data:"101"+k$1(this.data[0],"L")}),t.push({data:k$1(this.data.substring(1,6),"LLLLL"),text:this.text.substring(1,6)}),t.push({data:"01010"}),t.push({data:k$1(this.data.substring(6,11),"RRRRR"),text:this.text.substring(6,11)}),t.push({data:k$1(this.data[11],"R")+"101"}),t.push({data:i,text:this.text.substring(11,12)}),t}}const J$1=["XX00000XXX","XX10000XXX","XX20000XXX","XXX00000XX","XXXX00000X","XXXXX00005","XXXXX00006","XXXXX00007","XXXXX00008","XXXXX00009"],X$1=[["EEEOOO","OOOEEE"],["EEOEOO","OOEOEE"],["EEOOEO","OOEEOE"],["EEOOOE","OOEEEO"],["EOEEOO","OEOOEE"],["EOOEEO","OEEOOE"],["EOOOEE","OEEEOO"],["EOEOEO","OEOEOE"],["EOEOOE","OEOEEO"],["EOOEOE","OEEOEO"]];class K$1 extends y$1{static expandToUPCA(t,e){const i=parseInt(t[t.length-1]),r=J$1[i];let s="",n=0;for(let e=0;e<r.length;e++){const i=r[e];s+="X"===i?t[n++]:i;}return s=`${e}${s}`,`${s}${V$1.checksum(s)}`}constructor(t,e){if(super(t,e),this.middleDigits="",this.upcA="",this.isValid=!1,-1!==t.search(/^[0-9]{6}$/))this.middleDigits=t,this.upcA=K$1.expandToUPCA(t,"0"),this.text=e.text||`${this.upcA[0]}${t}${this.upcA[this.upcA.length-1]}`,this.isValid=!0;else {if(-1===t.search(/^[01][0-9]{7}$/))return;if(this.middleDigits=t.substring(1,t.length-1),this.upcA=K$1.expandToUPCA(this.middleDigits,t[0]),this.upcA[this.upcA.length-1]!==t[t.length-1])return;this.isValid=!0;}this.displayValue=e.displayValue;}valid(){return this.isValid}encode(){return {items:this.options.flat?this.flatEncoding():this.guardedEncoding(),text:this.text,options:this.options}}flatEncoding(){let t="";t+="101",t+=this.encodeMiddleDigits(),t+="010101";return [{data:t,text:this.text}]}guardedEncoding(){const t=[],e="number"==typeof this.options.quietZones&&this.options.quietZones>2?this.options.quietZones:2,i=Array(e).fill("0").join("");return t.push({data:i,text:this.text[0]}),t.push({data:"101",text:""}),t.push({data:this.encodeMiddleDigits(),text:this.text.substring(1,7)}),t.push({data:"010101",text:""}),t.push({data:i,text:this.text[7]}),t}encodeMiddleDigits(){const t=this.upcA[0],e=this.upcA[this.upcA.length-1],i=X$1[parseInt(e)][parseInt(t)];return k$1(this.middleDigits,i)}}class Z$1{constructor(){this.latch=!0,this.allEncodes="";}static getDigitText(t){return (t||"").replace(/\D/g,"")}static getInstance(){return this.instance||(this.instance=new Z$1)}static encode(t){return this.getInstance().init().expand(t)}static checkDigit(t,e){const i=e||t.length;let r=0,s=1&i?3:1;for(let e=0;e<i;e++)r+=s*parseInt(t[e]),s^=2;return String((10-r%10)%10)}init(){return this.latch=!0,this.allEncodes="",this}expand(t){let e="";for(let i=0,r=0;i<t.length;i++)r=parseInt(t[i]),e+=Array(r).fill(this.latch?"1":"0").join(""),this.latch=!this.latch;return this.allEncodes+=e,e}}const Y$1=["BBBAAA","BBABAA","BBAABA","BBAAAB","BABBAA","BAABBA","BAAABB","BABABA","BABAAB","BAABAB"],Q$1=["AAABBB","AABABB","AABBAB","AABBBA","ABAABB","ABBAAB","ABBBAA","ABABAB","ABABBA","ABBABA"],q$1=["AA","AB","BA","BB"],tt$2=["BBAAA","BABAA","BAABA","BAAAB","ABBAA","AABBA","AAABB","ABABA","ABAAB","AABAB"],et$1=["AAAAA","ABABB","ABBAB","ABBBA","BAABB","BBAAB","BBBAA","BABAB","BABBA","BBABA"],it$1=["3211","2221","2122","1411","1132","1231","1114","1312","1213","3112"],rt$1=["1123","1222","2212","1141","2311","1321","4111","2131","3121","2113"],st$1=["112211","211121","121121","221111","112121","212111","122111","111221","211211","121211"],nt$1=["1111212111","2111111121","1121111121","2121111111","1111211121","2111211111","1121211111","1111112121","2111112111","1121112111"],at$1=["11221","21112","12112","22111","11212","21211","12211","11122","21121","12121"],ot$1=["1111","211"],ht$1=["411111","41111"],ct$1=["212111","21112"],lt$1=["1111","211"];class dt$1 extends y$1{constructor(t,e){super(t=Z$1.getDigitText(t),e);}static gs1_check_digit(t,e){"number"==typeof e&&(e>t.length?t=t.padStart(e,"0"):e<t.length&&(t=t.substring(0,e)));let i=1&t.length?3:1,r=0;for(let e=0;e<t.length;e++)r+=i*parseInt(t[e]),i^=2;return `${10*Math.ceil(r/10)-r}`}static c25_common(t,e,i,r,s){t=Z$1.getDigitText(t),r&&r>0&&t.length>r&&(t=t.substring(0,r)),s.checkDigit&&(t+=dt$1.gs1_check_digit(t));const n=[];if(i)for(let e=0;e<t.length;e++)n.push(st$1[t.charCodeAt(e)-m$1.num_0]);else for(let e=0;e<t.length;e++)n.push(nt$1[t.charCodeAt(e)-m$1.num_0]);return {options:s,items:[{text:t,data:Z$1.encode([e[0],...n,e[1]].join(""))}],text:t}}static c25_inter_common(t,e){(t=Z$1.getDigitText(t)).length>125&&(t=t.substring(0,125)),(t.length%2==1&&!e.checkDigit||t.length%2==1&&e.checkDigit)&&(t="0"+t),e.checkDigit&&(t+=dt$1.gs1_check_digit(t));const i=[];for(let e=0;e<t.length;e+=2){const r=at$1[parseInt(t[e])],s=at$1[parseInt(t[e+1])];for(let t=0;t<5;t++)i.push(`${r[t]}${s[t]}`);}return {options:e,items:[{text:t,data:Z$1.encode([ot$1[0],...i,ot$1[1]].join(""))}],text:t}}encode(){return dt$1.c25_inter_common(this.data,this.options)}}class gt$1 extends dt$1{encode(){return dt$1.c25_common(this.data,ht$1,!0,80,this.options)}}class ut$1 extends dt$1{encode(){return dt$1.c25_common(this.data,ct$1,!1,45,this.options)}}class ft$1 extends dt$1{encode(){return dt$1.c25_common(this.data,lt$1,!0,80,this.options)}}class pt$1 extends dt$1{encode(){let t=this.data;t.length>13?t=t.substring(0,13):t.length<13&&(t=t.padStart(13,"0"));return t+=dt$1.gs1_check_digit(t),this.data=this.text=t,dt$1.c25_inter_common(t,this.options)}}class mt$1 extends y$1{constructor(t,e){0===t.search(/^[0-9\-\$\:\.\+\/]+$/)&&(t="A"+t+"A"),super(t.toUpperCase(),e),this.text=this.options.text||this.text.replace(/[A-D]/g,"");}valid(){return -1!==this.data.search(/^[A-D][0-9\-\$\:\.\+\/]+[A-D]$/)}encode(){const t=[],e=this.getEncodings();for(let i=0;i<this.data.length;i++)t.push(e[this.data.charAt(i)]),i!==this.data.length-1&&t.push("0");return {items:[{text:this.text,data:t.join("")}],text:this.text,options:this.options}}getEncodings(){return {0:"101010011",1:"101011001",2:"101001011",3:"110010101",4:"101101001",5:"110101001",6:"100101011",7:"100101101",8:"100110101",9:"110100101","-":"101001101",$:"101100101",":":"1101011011","/":"1101101011",".":"1101101101","+":"1011011011",A:"1011001001",B:"1001001011",C:"1010010011",D:"1010011001"}}}const xt$1="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%abcd",wt$1=["1112212111","2112111121","1122111121","2122111111","1112211121","2112211111","1122211111","1112112121","2112112111","1122112111","2111121121","1121121121","2121121111","1111221121","2111221111","1121221111","1111122121","2111122111","1121122111","1111222111","2111111221","1121111221","2121111211","1111211221","2111211211","1121211211","1111112221","2111112211","1121112211","1111212211","2211111121","1221111121","2221111111","1211211121","2211211111","1221211111","1211112121","2211112111","1221112111","1212121111","1212111211","1211121211","1112121211"],bt$1=["%U","$A","$B","$C","$D","$E","$F","$G","$H","$I","$J","$K","$L","$M","$N","$O","$P","$Q","$R","$S","$T","$U","$V","$W","$X","$Y","$Z","%A","%B","%C","%D","%E"," ","/A","/B","/C","/D","/E","/F","/G","/H","/I","/J","/K","/L","-",".","/O","0","1","2","3","4","5","6","7","8","9","/Z","%F","%G","%H","%I","%J","%V","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","%K","%L","%M","%N","%O","%W","+A","+B","+C","+D","+E","+F","+G","+H","+I","+J","+K","+L","+M","+N","+O","+P","+Q","+R","+S","+T","+U","+V","+W","+X","+Y","+Z","%P","%Q","%R","%S","%T"],yt$1=["bU","aA","aB","aC","aD","aE","aF","aG","aH","aI","aJ","aK","aL","aM","aN","aO","aP","aQ","aR","aS","aT","aU","aV","aW","aX","aY","aZ","bA","bB","bC","bD","bE"," ","cA","cB","cC","$","%","cF","cG","cH","cI","cJ","+","cL","-",".","/","0","1","2","3","4","5","6","7","8","9","cZ","bF","bG","bH","bI","bJ","bV","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bK","bL","bM","bN","bO","bW","dA","dB","dC","dD","dE","dF","dG","dH","dI","dJ","dK","dL","dM","dN","dO","dP","dQ","dR","dS","dT","dU","dV","dW","dX","dY","dZ","bP","bQ","bR","bS","bT"],Ct$1=["131112","111213","111312","111411","121113","121212","121311","111114","131211","141111","211113","211212","211311","221112","221211","231111","112113","112212","112311","122112","132111","111123","111222","111321","121122","131121","212112","212211","211122","211221","221121","222111","112122","112221","122121","123111","121131","311112","311211","321111","112131","113121","211131","121221","312111","311121","122211"];class At$1 extends y$1{constructor(t,e){const i=function(t){const e=[],i=[];let r=0,s=0;for(let n=0,a="",o="";n<t.length;n++)if(a=t[n],s=t.charCodeAt(n),o=yt$1[s],s>127)l$1.warn(`---- [encode with code93] invalid char: '${a}'[${s}]`);else {if(r+o.length>107){l$1.warn(`---- content too long, discarded content[${n} --\x3e ${t.length}]: "${t.substring(n)}"`);break}e.push(o),i.push(a>" "&&127!==s?a:" "),r+=o.length;}return {data:e.join(""),text:i.join("")}}(t);e.text=i.text,super(i.data,e);}encode(){const t=[],e=[];for(let e=0;e<this.data.length;e++)t.push(xt$1.indexOf(this.data[e]));let i=0,r=1;for(let e=this.data.length-1;e>=0;e--)i+=t[e]*r,r++,21==r&&(r=1);i%=47,t.push(i);let s=0;r=1;for(let e=this.data.length;e>=0;e--)s+=t[e]*r,r++,16==r&&(r=1);s%=47,t.push(s),e.push("111141");for(let i=0;i<t.length;i++)e.push(Ct$1[t[i]]);e.push("1111411");return {items:[{data:Z$1.encode(e.join("")),text:this.options.mod43?`${this.text}${xt$1[i]}${xt$1[s]}`:this.text}],text:this.text,options:this.options}}valid(){return -1!==this.data.search(/^[0-9A-Z\-\.\ \$\/\+\%]+$/)}}function vt$1(t){const e=t.charCodeAt(0);return bt$1[e]}class St$1 extends y$1{constructor(t,e){if(t=t.toUpperCase(),e.mod43){const i=e.text||t,r=function(t){const e=t.length%43;return xt$1[e]}(t);t+=r,e.text=i+r;}super(t,e);}encode(){const t=[],e=[],i=this.data;for(let e=0;e<i.length;e++){const r=xt$1.indexOf(i[e]);r>=0?t.push(r):l$1.warn(`---- 检测到无效字符[encode with code39]: '${i[e]}'`);}e.push("1211212111");for(let r=0;r<i.length;r++)e.push(wt$1[t[r]]);e.push("121121211");const r={data:Z$1.encode(e.join("")),text:this.options.showStartEndChar?`*${this.text}*`:this.text};return {options:this.options,items:[r],text:this.text}}}class Et$1 extends St$1{constructor(t,e){const i=function(t){const e=[],i=[];let r=0,s=0;for(let n=0,a="",o="";n<t.length;n++)if(a=t[n],s=t.charCodeAt(n),o=vt$1(a),s>127)l$1.warn(`---- [ECode39] invalidate char: '${a}'[${s}]`);else {if(r+o.length>85){l$1.warn(`---- discarded content[${n} --\x3e ${t.length}]: "${t.slice(n)}"`);break}i.push(a),e.push(o),r+=o.length;}return {data:e.join(""),text:i.join("")}}(t);e.text=i.text,super(i.data,e);}valid(){return -1!==this.data.search(/^[0-9A-Z\-\.\ \$\/\+\%]+$/)}}class Lt$1 extends y$1{static convertUPCE2UPCA(t){(t=Z$1.getDigitText(t)).length>7?t=t.substring(0,7):t.length<7&&(t=t.padStart(7,"0"));const e=t.substring(1),i=e[5],r=Array(11).fill("0");switch("1"==t[0]&&(r[0]="1"),r[1]=e[0],r[2]=e[1],i){case"0":case"1":case"2":r[3]=i,r[8]=e[2],r[9]=e[3],r[10]=e[4];break;case"3":r[3]=e[2],r[9]=e[3],r[10]=e[4],"0"!=e[2]&&"1"!=e[2]&&"2"!=e[2]||l$1.warn("271: Invalid UPC-E data, X3 shall not be equal to 0, 1 or ");break;case"4":r[3]=e[2],r[4]=e[3],r[10]=e[4],"0"==e[3]&&l$1.warn("272: Invalid UPC-E data, X4 shall not be equal to 0");break;case"5":case"6":case"7":case"8":case"9":r[3]=e[2],r[4]=e[3],r[5]=e[4],r[10]=i,"0"==e[4]&&l$1.warn("273: Invalid UPC-E data X5 shall not be equal to 0");}return r.join("")}static getUPCECheckCode(t){const e=Lt$1.convertUPCE2UPCA(t);return Z$1.checkDigit(e,11)}constructor(t,e){(t=Z$1.getDigitText(t)).length>7?t=t.substring(0,7):t.length<7&&(t=t.padStart(7,"0")),super(t,e);}encode(){let t=this.text;const e=Lt$1.convertUPCE2UPCA(this.text),i=Z$1.checkDigit(e,11);t+=i;let r="";r="1"==e[0]?Q$1[x$1.ctoi(i)]:Y$1[x$1.ctoi(i)];const s=[];for(let e=0;e<length;e++)switch(r[e]){case"A":s.push(it$1[t.charCodeAt(e)-m$1.num_0]);break;case"B":s.push(rt$1[t.charCodeAt(e)-m$1.num_0]);}const n=[],a=new Z$1;return n.push({text:"",data:a.expand("111")}),n.push({text:"",data:a.expand(s.join(""))}),n.push({text:"",data:a.expand("111111")}),{options:this.options,items:n,text:t}}}class Mt$1 extends y$1{constructor(t,e){super(t=Z$1.getDigitText(t),e);}encode(){let t=this.text,e="";if(t.length<2&&(t=t.padStart(2,"0")),t.length<=2){const i=10*x$1.ctoi(t[0])+x$1.ctoi(t[1]);e=q$1[i%4];}else {t.length<5&&(t=t.padStart(5,"0"));const i=[];for(let e=0;e<5;e++)i[e]=x$1.ctoi(t[e]);let r=3*(i[0]+i[2]+i[4]);r+=9*(i[1]+i[3]);e=tt$2[r%10];}const i=[];i.push("112");for(let r=0;r<t.length;r++){switch(e[r]){case"A":i.push(it$1[t.charCodeAt(r)-m$1.num_0]);break;case"B":i.push(rt$1[t.charCodeAt(r)-m$1.num_0]);}r!=length-1&&i.push("11");}const r=[{text:t,data:Z$1.encode(i.join(""))}];return {options:this.options,items:r,text:t}}}class _t$1 extends Mt$1{constructor(t,e){super(t=Z$1.getDigitText(t),e);}encode(){let t=this.text;t.length>13?t=t.substring(0,13):t.length<12&&(t=t.padStart(12,"0"));const e=Z$1.checkDigit(t,12);12==t.length?t+=e:e!==t[12]&&(t=t.substring(0,12)+e);const i=et$1[t.charCodeAt(0)-m$1.num_0],r=[],s=[];for(let e=1;e<t.length;e++)e>1&&e<7&&"B"==i[e-2]?e<7?r.push(rt$1[t.charCodeAt(e)-m$1.num_0]):s.push(rt$1[t.charCodeAt(e)-m$1.num_0]):e<7?r.push(it$1[t.charCodeAt(e)-m$1.num_0]):s.push(it$1[t.charCodeAt(e)-m$1.num_0]);const n=this.options.quietZones||0,a=[],o=new Z$1,h=Array(n>2?n:2).fill("0").join("");return a.push({text:t[0],data:h}),a.push({text:"",data:o.expand("111")}),a.push({text:t.substring(1,7),data:o.expand(r.join(""))}),a.push({text:"",data:o.expand("11111")}),a.push({text:t.substring(7),data:o.expand(s.join(""))}),a.push({text:"",data:o.expand("111")}),a.push({text:this.options.guardWhitespace?" >":"",data:h}),{items:a,text:t,options:this.options}}}class Bt$1 extends _t$1{static getCheckCode(t,e){let i=0,r=1;const s=e||t.length;for(let e=0;e<s;e++)i+=x$1.ctoi(t[e])*r,r++;const n=i%11;let a=x$1.itoc(n);return 10==n&&(a="X"),a}static filterText(t){const e=[];t=t.toUpperCase();for(let i=0;i<t.length&&!(e.length>13);i++)if(x$1.isDigit(t.charCodeAt(i)))e.push(t[i]);else if("X"===t[i]&&9===e.length&&i===t.length-1){e.push(t[i]);break}return e.join("")}constructor(t,e){if(super(t,e),(t=Bt$1.filterText(t)).length>13&&(t=t.substring(0,13)),13==t.length){const e=t.substring(0,3);"978"!==e&&"979"!==e&&(t="978"+t.substring(3));const i=Z$1.checkDigit(t,12);t[12]!=i&&(t=t.substring(0,12)+i);}else t.length>10&&(t=t.substring(0,10)),t.length<9&&(t=t.padStart(9,"0")),t=`978${t.substring(0,9)}`;this.data=this.text=t;}}class It$1{static registerEncoder(t,e){this.registedEncoderMap.set(t,e);}static getEncoder(t){const e=t.type||b$1.AUTO,i=t.text||"",r=this.registedEncoderMap.get(e);if(r&&"function"==typeof r.encode)return r;switch(e){case b$1.UPC_A:return new V$1(i,t);case b$1.UPC_E:return new K$1(i,t);case b$1.EAN13:return new G$1(i,t);case b$1.EAN8:return new z$1(i,t);case b$1.CODE39:return new St$1(i,t);case b$1.ITF25:return new dt$1(i,t);case b$1.CODABAR:return new mt$1(i,t);case b$1.CODE93:return new At$1(i,t);case b$1.ISBN:return new Bt$1(i,t);case b$1.ECODE39:return new Et$1(i,t);case b$1.ITF14:return new pt$1(i,t);case b$1.ChinaPost:return new ft$1(i,t);case b$1.Matrix25:return new gt$1(i,t);case b$1.Industrial25:return new ut$1(i,t);case b$1.CODE128:default:return new W$1(i,t)}}static encode(t){"boolean"!=typeof t.displayValue&&(t.displayValue=!0);const e=this.getEncoder(t),i=e.encode(t.text||"",t);return i.data||(i.data=i.items.map((t=>t.data)).join("")),i.options||(i.options=e.options),i}}It$1.registedEncoderMap=new Map;class Dt$1{static registerBarcodeCreator(t,e){It$1.registerEncoder(t,e);}static IsProductType(t){switch(t){case b$1.EAN13:case b$1.EAN8:case b$1.UPC_A:case b$1.UPC_E:case b$1.ISBN:return !0;default:return !1}}static create1DBarcode(t){const e=t;let i=b$1.AUTO;"number"==typeof t.barcodeType?i=t.barcodeType:"number"==typeof e.type&&(i=e.type);let r="number"==typeof t.text?`${t.text}`:(t.text||"").trim();if(r||(r=void 0===t.content||null===t.content?"":String(t.content)),r){r=this.normalize(r,i);try{let e=0;switch(i){case b$1.EAN13:case b$1.UPC_A:case b$1.UPC_E:case b$1.ISBN:e=Dt$1.DockHorMargin;}return It$1.encode({text:r,type:i,quietZones:e,showStartEndChar:t.showStartEnd})}catch(t){return void l$1.warn(t)}}}static normalize(t,e){if(e===b$1.CODE39||e===b$1.CODE93)t=this.normalizeLength(t,107,(t=>t>=0&&t<128),"?");else {if(e===b$1.CODABAR){const e="0123456789-$:/.+ABCD";let i,r;if(t.length>=2){const e="ABCD",s="TN*E";i=t.charAt(0).toUpperCase(),r=t.charAt(t.length-1).toUpperCase();const n=e.indexOf(i)>=0&&e.indexOf(r)>=0,a=s.indexOf(i)>=0&&s.indexOf(r)>=0;n||a?t=t.substring(1,t.length-1):i=r="A";}else i=r="A";return i+(t=this.normalizeLength(t,0,(t=>e.indexOf(String.fromCharCode(t))>=0),"0"))+r}if(e===b$1.EAN13)t=this.normalizeDigitLength(t,12),t+=this.getEAN13CheckCode(t);else if(e===b$1.EAN8)t=this.normalizeDigitLength(t,7),t+=this.getEAN8CheckCode(t);else if(e===b$1.UPC_A)t=this.normalizeDigitLength(t,11),t+=Z$1.checkDigit(t);else if(e===b$1.UPC_E){const e=(t=this.normalizeDigitLength(t,7)).charAt(0);"0"!==e&&"1"!==e&&(t="0"+t.substring(1)),t+=Lt$1.getUPCECheckCode(t);}else if(e===b$1.ITF14)t=this.normalizeDigitLength(t,13),t+=this.getITD14CheckCode(t);else {if(e===b$1.ITF25)return (t=this.normalizeLength(t,80,(t=>x$1.isDigit(t)),"0")).length%2!=0?"0"+t:t;if(e===b$1.GS1_128)if("("===t[0]){if(t.indexOf(")")<0){const e=t.indexOf("]");e>0&&(t=t.substring(0,e)+")"+t.substring(e+1));}}else if("["===t[0]){if(t.indexOf("]")<0){const e=t.indexOf(")");e>0&&(t=t.substring(0,e)+"]"+t.substring(e+1));}}else t.length<2&&(t="0"+t),t=t.length<=20?"(10)"+t:t.length<=30?"(90)"+t:"(91)"+t;else t=this.normalizeLength(t,80,(t=>t>=32&&t<=126),"?");}}return t}static normalizeDigitLength(t,e){return (t=this.normalizeLength(t,e,(t=>x$1.isDigit(t)),"0")).length<e&&(t=x$1.preFillChar(t,e,"0")),t}static normalizeLength(t,e,i,r){if(e>0&&t.length>e&&(t=t.substring(0,e)),i&&r){const e=[];for(let s=0;s<t.length;s++)i(t.charCodeAt(s))?e.push(t.charAt(s)):e.push(r);t=e.join("");}return t}static getEAN13CheckCode(t){let e=0,i=0;for(i=0;i<t.length;++i){const r=t.charCodeAt(i)-m$1.num_0;if(r<0||r>9)throw "检测到非发字符";e+=(1&i?3:1)*r;}return e=10-e%10,10==e&&(e=0),String(e)}static getEAN8CheckCode(t){return Z$1.checkDigit(t)}static getITD14CheckCode(t){return Z$1.checkDigit(t)}}var Tt$1;Dt$1.DockHorMargin=7,function(t){t[t.Low=0]="Low",t[t.Middle=1]="Middle",t[t.Quality=2]="Quality",t[t.High=3]="High";}(Tt$1||(Tt$1={}));const Rt$1=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];class Pt$1{static getSymbolSize(t){if(!t)throw new Error('"version" cannot be null or undefined');if(t<1||t>40)throw new Error('"version" should be in range from 1 to 40');return 4*t+17}static getSymbolTotalCodewords(t){return Rt$1[t]}static getBCHDigit(t){let e=0;for(;0!==t;)e++,t>>>=1;return e}static calcWaterMarkSeed(t){if("number"==typeof t)return t;if("string"==typeof t){if(!t)return 1024;let e=4660;const i=w$1.getBytes_Utf8(t);for(let t=0;t<i.length;++t)e+=e>>>5,e+=(255&i[t])*(2&t?5:3),e+=1&t?13:11;return 1025+(1048575&e)}return 0}static hasWaterMarkSeed(t,e,i){if(!e||e.length<3)return !1;let r,s;if((255&e[0])>>>4==5)if(9==(15&e[0])){if(e.length<4)return !1;if((255&e[1])>>>4!=3)return !1;if(13!=(15&e[1]))return !1;r=(255&e[2])>>>6&3,s=(63&e[2])<<4|(255&e[3])>>>4;}else {if(3!=(15&e[0]))return !1;if((255&e[1])>>>4!=13)return !1;r=(255&e[1])>>>2&3,s=(3&e[1])<<8|255&e[2];}else {if((255&e[0])>>>4!=3)return !1;if(13!=(15&e[0]))return !1;r=(255&e[1])>>>6&3,s=(63&e[1])<<4|(255&e[2])>>>4;}if(1022==s)return !0;return s==this.calcDtCheckSum(r,i,t)}static calcDtCheckSum(t,e,i){"string"==typeof e&&(e=this.calcWaterMarkSeed(e));let r=this.sDtWaterMarkCheckSums[3&t];if(r=r+e&1048575,i&&i.length>0){const t=w$1.getBytes_Utf8(i);for(let e=0;e<t.length;++e)r+=r>>>5,r+=(255&t[e])*(2&e?5:3),r+=1&e?13:11;}return r%1019+3}}Pt$1.sDtWaterMarkCheckSums=[197,257,571,991];class Ot$1{static getRowColCoords(t){if(1===t)return [];const e=Math.floor(t/7)+2,i=Pt$1.getSymbolSize(t),r=145===i?26:2*Math.ceil((i-13)/(2*e-2)),s=[i-7];for(let t=1;t<e-1;t++)s[t]=s[t-1]-r;return s.push(6),s.reverse()}static getPositions(t){const e=[],i=Ot$1.getRowColCoords(t),r=i.length;for(let t=0;t<r;t++)for(let s=0;s<r;s++)0===t&&0===s||0===t&&s===r-1||t===r-1&&0===s||e.push([i[t],i[s]]);return e}}class Nt$1{constructor(){this.mBuffer=[],this.mLength=0;}get buffer(){return this.mBuffer}get length(){return this.mLength}get(t){const e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)}put(t,e){for(let i=0;i<e;i++)this.putBit(1==(t>>>e-i-1&1));}getLengthInBits(){return this.length}putBit(t){const e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.mLength++;}}const Ut$1=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],Wt$1=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];class Ht$1{static getBlocksCount(t,e){switch(e){case Tt$1.Low:return Ut$1[4*(t-1)+0];case Tt$1.Middle:return Ut$1[4*(t-1)+1];case Tt$1.Quality:return Ut$1[4*(t-1)+2];case Tt$1.High:return Ut$1[4*(t-1)+3];default:return}}static getTotalCodewordsCount(t,e){switch(e){case Tt$1.Low:return Wt$1[4*(t-1)+0];case Tt$1.Middle:return Wt$1[4*(t-1)+1];case Tt$1.Quality:return Wt$1[4*(t-1)+2];case Tt$1.High:return Wt$1[4*(t-1)+3];default:return}}}const kt$1=Pt$1.getBCHDigit(1335);class Ft$1{static getEccBit(t){switch(t){case Tt$1.Low:return 1;default:case Tt$1.Middle:return 0;case Tt$1.Quality:return 3;case Tt$1.High:return 2}}static getEncodedBits(t,e){const i=Ft$1.getEccBit(t)<<3|e;let r=i<<10;for(;Pt$1.getBCHDigit(r)-kt$1>=0;)r^=1335<<Pt$1.getBCHDigit(r)-kt$1;return 21522^(i<<10|r)}}const jt$1=3,$t$1=3,zt$1=40,Gt$1=10;class Vt$1{static isValid(t){return t&&!isNaN(t)&&t>=0&&t<=7}static getPenaltyN1(t){const e=t.cols;let i=0,r=0,s=0,n=null,a=null;for(let o=0;o<e;o++){r=s=0,n=a=null;for(let h=0;h<e;h++){let e=t.get(o,h);e===n?r++:(r>=5&&(i+=jt$1+(r-5)),n=e,r=1),e=t.get(h,o),e===a?s++:(s>=5&&(i+=jt$1+(s-5)),a=e,s=1);}r>=5&&(i+=jt$1+(r-5)),s>=5&&(i+=jt$1+(s-5));}return i}static getPenaltyN2(t){const e=t.cols;let i=0;for(let r=0;r<e-1;r++)for(let s=0;s<e-1;s++){const e=t.get(r,s)+t.get(r,s+1)+t.get(r+1,s)+t.get(r+1,s+1);4!==e&&0!==e||i++;}return i*$t$1}static getPenaltyN3(t){const e=t.cols;let i=0,r=0,s=0;for(let n=0;n<e;n++){r=s=0;for(let a=0;a<e;a++)r=r<<1&2047|t.get(n,a),a>=10&&(1488===r||93===r)&&i++,s=s<<1&2047|t.get(a,n),a>=10&&(1488===s||93===s)&&i++;}return i*zt$1}static getPenaltyN4(t){let e=0;const i=t.data.length;for(let r=0;r<i;r++)e+=t.data[r];return Math.abs(Math.ceil(100*e/i/5)-10)*Gt$1}static getMaskAt(t,e,i){switch(t){case this.Patterns.PATTERN000:return (e+i)%2==0;case this.Patterns.PATTERN001:return e%2==0;case this.Patterns.PATTERN010:return i%3==0;case this.Patterns.PATTERN011:return (e+i)%3==0;case this.Patterns.PATTERN100:return (Math.floor(e/2)+Math.floor(i/3))%2==0;case this.Patterns.PATTERN101:return e*i%2+e*i%3==0;case this.Patterns.PATTERN110:return (e*i%2+e*i%3)%2==0;case this.Patterns.PATTERN111:return (e*i%3+(e+i)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}}static applyMask(t,e){const i=e.cols;for(let r=0;r<i;r++)for(let s=0;s<i;s++)e.isReserved(s,r)||e.xor(s,r,this.getMaskAt(t,s,r));}static getBestMask(t,e){const i=Object.keys(this.Patterns).length;let r=0,s=1/0;for(let n=0;n<i;n++){e(n),this.applyMask(n,t);const i=this.getPenaltyN1(t)+this.getPenaltyN2(t)+this.getPenaltyN3(t)+this.getPenaltyN4(t);this.applyMask(n,t),i<s&&(s=i,r=n);}return r}}Vt$1.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const Jt$1="[0-9]+";let Xt$1="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";Xt$1=Xt$1.replace(/u/g,"\\u");const Kt$1="(?:(?![A-Z0-9 $%*+\\-./:]|"+Xt$1+")(?:.|[\r\n]))+",Zt$1=new RegExp("^"+Xt$1+"$"),Yt$1=new RegExp("^"+Jt$1+"$"),Qt$1=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");class qt$1{static testKanji(t){return Zt$1.test(t)}static testNumeric(t){return Yt$1.test(t)}static testAlphanumeric(t){return Qt$1.test(t)}}qt$1.KANJI=new RegExp(Xt$1,"g"),qt$1.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),qt$1.BYTE=new RegExp(Kt$1,"g"),qt$1.NUMERIC=new RegExp(Jt$1,"g"),qt$1.ALPHANUMERIC=new RegExp("[A-Z $%*+\\-./:]+","g");class te$1{static isValid(t){return !isNaN(t)&&t>=1&&t<=40}}class ee$1{static getCharCountIndicator(t,e){if(!t.ccBits)throw new Error("Invalid mode: "+t);if(!te$1.isValid(e))throw new Error("Invalid version: "+e);return e>=1&&e<10?t.ccBits[0]:e<27?t.ccBits[1]:t.ccBits[2]}static getBestModeForData(t){return qt$1.testNumeric(t)?this.NUMERIC:qt$1.testAlphanumeric(t)?this.ALPHANUMERIC:qt$1.testKanji(t)?this.KANJI:this.BYTE}static toString(t){if(t&&t.id)return t.id;throw new Error("Invalid mode")}static isValid(t){return "string"!=typeof t&&(t&&t.bit&&t.ccBits)}static fromString(t){if("string"!=typeof t)throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return this.NUMERIC;case"alphanumeric":return this.ALPHANUMERIC;case"kanji":return this.KANJI;case"byte":return this.BYTE;default:throw new Error("Unknown mode: "+t)}}static from(t,e){if(this.isValid(t))return t;try{return this.fromString(t)}catch(t){return e}}}ee$1.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},ee$1.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},ee$1.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},ee$1.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},ee$1.MIXED={id:"",bit:-1,ccBits:[]},ee$1.STRUCTURED={id:"Structured",bit:3,ccBits:[0,0,0]};const ie$1=new Uint8Array(512),re$1=new Uint8Array(256);!function(){let t=1;for(let e=0;e<255;e++)ie$1[e]=t,re$1[t]=e,t<<=1,256&t&&(t^=285);for(let t=255;t<512;t++)ie$1[t]=ie$1[t-255];}();class se$1{static log(t){if(t<1)throw new Error("log("+t+")");return re$1[t]}static exp(t){return ie$1[t]}static mul(t,e){return 0===t||0===e?0:ie$1[re$1[t]+re$1[e]]}}class ne$1{static mul(t,e){const i=new Uint8Array(t.length+e.length-1);for(let r=0;r<t.length;r++)for(let s=0;s<e.length;s++)i[r+s]^=se$1.mul(t[r],e[s]);return i}static mod(t,e){let i=new Uint8Array(t);for(;i.length-e.length>=0;){const t=i[0];for(let r=0;r<e.length;r++)i[r]^=se$1.mul(e[r],t);let r=0;for(;r<i.length&&0===i[r];)r++;i=i.slice(r);}return i}static generateECPolynomial(t){let e=new Uint8Array([1]);for(let i=0;i<t;i++)e=this.mul(e,new Uint8Array([1,se$1.exp(i)]));return e}}class ae$1{constructor(t){this.degree=t,this.degree&&this.initialize(this.degree);}initialize(t){this.degree=t,this.genPoly=ne$1.generateECPolynomial(this.degree);}encode(t){if(!this.genPoly)throw new Error("Encoder not initialized");const e=new Uint8Array(t.length+this.degree);e.set(t);const i=ne$1.mod(e,this.genPoly),r=this.degree-i.length;if(r>0){const t=new Uint8Array(this.degree);return t.set(i,r),t}return i}}const oe$1="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:".split("");class he$1{get mode(){return this.mMode}get data(){return this.mData}constructor(t,e){this.mMode=t,this.mData=e||"";}getLength(){return this.mData.length}getBitsLength(){return 0}write(t){}}class ce$1 extends he$1{constructor(t){super(ee$1.ALPHANUMERIC,t);}static getBitsLength(t){return 11*Math.floor(t/2)+t%2*6}getBitsLength(){return ce$1.getBitsLength(this.mData.length)}write(t){let e;for(e=0;e+2<=this.mData.length;e+=2){let i=45*oe$1.indexOf(this.mData[e]);i+=oe$1.indexOf(this.mData[e+1]),t.put(i,11);}this.mData.length%2&&t.put(oe$1.indexOf(this.mData[e]),6);}}class le$1 extends he$1{constructor(t){super(ee$1.NUMERIC,t);}static getBitsLength(t){return 10*Math.floor(t/3)+(t%3?t%3*3+1:0)}getBitsLength(){return le$1.getBitsLength(this.getLength())}write(t){let e,i,r;for(e=0;e+3<=this.mData.length;e+=3)i=this.mData.substr(e,3),r=parseInt(i,10),t.put(r,10);const s=this.mData.length-e;s>0&&(i=this.mData.substr(e),r=parseInt(i,10),t.put(r,3*s+1));}}class de$1 extends he$1{constructor(t){super(ee$1.BYTE,t),this.bytes=w$1.getBytes_Utf8(t);}static getBitsLength(t){return 8*t}getLength(){return this.bytes.length}getBitsLength(){return 8*this.bytes.length}write(t){for(let e=0,i=this.bytes.length;e<i;e++)t.put(this.bytes[e],8);}}class ge$1 extends he$1{constructor(t){super(ee$1.KANJI,t);}static getBitsLength(t){return 13*t}getBitsLength(){return ge$1.getBitsLength(this.getLength())}write(t){let e;for(e=0;e<this.mData.length;e++){let i=Pt$1.toSJISFunction?Pt$1.toSJISFunction(this.mData[e]):this.mData.charCodeAt(e);if(i>=33088&&i<=40956)i-=33088;else {if(!(i>=57408&&i<=60351))throw new Error("Invalid SJIS character: "+this.mData[e]+"\nMake sure your charset is UTF-8");i-=49472;}i=192*(i>>>8&255)+(255&i),t.put(i,13);}}}const ue$1={queue:[],sorter:null,make:function(t){const e=ue$1,i={};t=t||{};for(const t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i.queue=[],i.sorter=t.sorter||e.default_sorter,i},default_sorter:(t,e)=>t.cost-e.cost,push(t,e){this.queue.push({value:t,cost:e}),this.queue.sort(this.sorter);},pop(){return this.queue.shift()},empty(){return 0===this.queue.length}},fe$1={single_source_shortest_paths:function(t,e,i){const r={},s={};s[e]=0;const n=fe$1.PriorityQueue.make();let a,o,h,c,l,d,g,u,f;for(n.push(e,0);!n.empty();)for(h in a=n.pop(),o=null==a?void 0:a.value,c=null==a?void 0:a.cost,l=t[o]||{},l)l.hasOwnProperty(h)&&(d=l[h],g=c+d,u=s[h],f=void 0===s[h],(f||u>g)&&(s[h]=g,n.push(h,g),r[h]=o));if(void 0!==i&&void 0===s[i]){const t=["Could not find a path from ",e," to ",i,"."].join("");throw new Error(t)}return r},extract_shortest_path_from_predecessor_list:function(t,e){const i=[];let r=e;for(;r;)i.push(r),t[r],r=t[r];return i.reverse(),i},find_path:function(t,e,i){const r=fe$1.single_source_shortest_paths(t,e,i);return fe$1.extract_shortest_path_from_predecessor_list(r,i)},PriorityQueue:ue$1};class pe$1{static getStringByteLength(t){return unescape(encodeURIComponent(t)).length}static getSegments(t,e,i){const r=[];let s;for(;s=t.exec(i);)r.push({data:s[0],index:s.index,mode:e,length:s[0].length});return r}static getSegmentsFromString(t){const e=this.getSegments(qt$1.NUMERIC,ee$1.NUMERIC,t),i=this.getSegments(qt$1.ALPHANUMERIC,ee$1.ALPHANUMERIC,t);let r,s;"function"==typeof Pt$1.toSJISFunction?(r=this.getSegments(qt$1.BYTE,ee$1.BYTE,t),s=this.getSegments(qt$1.KANJI,ee$1.KANJI,t)):(r=this.getSegments(qt$1.BYTE_KANJI,ee$1.BYTE,t),s=[]);return e.concat(i,r,s).sort((function(t,e){return t.index-e.index})).map((function(t){return {data:t.data,mode:t.mode,length:t.length,index:0}}))}static getSegmentBitsLength(t,e){switch(e){case ee$1.NUMERIC:return le$1.getBitsLength(t);case ee$1.ALPHANUMERIC:return ce$1.getBitsLength(t);case ee$1.KANJI:return ge$1.getBitsLength(t);case ee$1.BYTE:default:return de$1.getBitsLength(t)}}static mergeSegments(t){return t.reduce((function(t,e){const i=t.length-1>=0?t[t.length-1]:null;return i&&i.mode===e.mode?(t[t.length-1].data+=e.data,t):(t.push(e),t)}),[])}static buildNodes(t){const e=[];for(let i=0;i<t.length;i++){const r=t[i];switch(r.mode){case ee$1.NUMERIC:e.push([r,{data:r.data,mode:ee$1.ALPHANUMERIC,length:r.length},{data:r.data,mode:ee$1.BYTE,length:r.length}]);break;case ee$1.ALPHANUMERIC:e.push([r,{data:r.data,mode:ee$1.BYTE,length:r.length}]);break;case ee$1.KANJI:e.push([r,{data:r.data,mode:ee$1.BYTE,length:this.getStringByteLength(r.data)}]);break;case ee$1.BYTE:e.push([{data:r.data,mode:ee$1.BYTE,length:this.getStringByteLength(r.data)}]);}}return e}static buildGraph(t,e){const i={},r={start:{}};let s=["start"];for(let n=0;n<t.length;n++){const a=t[n],o=[];for(let t=0;t<a.length;t++){const h=a[t],c=""+n+t;o.push(c),i[c]={node:h,lastCount:0},r[c]={};for(let t=0;t<s.length;t++){const n=s[t];i[n]&&i[n].node.mode===h.mode?(r[n][c]=this.getSegmentBitsLength(i[n].lastCount+h.length,h.mode)-this.getSegmentBitsLength(i[n].lastCount,h.mode),i[n].lastCount+=h.length):(i[n]&&(i[n].lastCount=h.length),r[n][c]=this.getSegmentBitsLength(h.length,h.mode)+4+ee$1.getCharCountIndicator(h.mode,e));}}s=o;}for(let t=0;t<s.length;t++)r[s[t]].end=0;return {map:r,table:i}}static buildSingleSegment(t,e){let i;const r=ee$1.getBestModeForData(t);if(i=ee$1.from(e||"",r),!i||i!==ee$1.BYTE&&(null==i?void 0:i.bit)<r.bit)throw new Error('"'+t+'" cannot be encoded with mode '+ee$1.toString(i)+".\n Suggested mode is: "+ee$1.toString(r));switch(i===ee$1.KANJI&&"function"!=typeof Pt$1.toSJISFunction&&(i=ee$1.BYTE),i){case ee$1.NUMERIC:return new le$1(t);case ee$1.ALPHANUMERIC:return new ce$1(t);case ee$1.KANJI:return new ge$1(t);case ee$1.BYTE:return new de$1(t)}}static fromArray(t){return t.reduce(((t,e)=>{if("string"==typeof e){const i=pe$1.buildSingleSegment(e);i&&t.push(i);}else if(e.data){const i=pe$1.buildSingleSegment(e.data,e.mode);i&&t.push(i);}return t}),[])}static fromString(t,e){const i=this.getSegmentsFromString(t),r=this.buildNodes(i),s=this.buildGraph(r,e),n=fe$1.find_path(s.map,"start","end"),a=[];for(let t=1;t<n.length-1;t++)a.push(s.table[n[t]].node);return this.fromArray(this.mergeSegments(a))}static rawSplit(t){return this.fromArray(this.getSegmentsFromString(t))}}const me$1=Pt$1.getBCHDigit(7973);class xe$1{static getBestVersionForDataLength(t,e,i){for(let r=1;r<=40;r++)if(e<=this.getCapacity(r,i,t))return r}static getReservedBitsCount(t,e){return ee$1.getCharCountIndicator(t,e)+4}static getTotalBitsFromDataArray(t,e){let i=0;return t.forEach((function(t){const r=xe$1.getReservedBitsCount(t.mode,e);i+=r+t.getBitsLength();})),i}static getBestVersionForMixedData(t,e,i){const r=t&&t.length>0?t.length:0;for(let t=1;t<=40;t++){if(this.getTotalBitsFromDataArray(e,t)+r<=this.getCapacity(t,i,ee$1.MIXED))return t}}static isValid(t){return !isNaN(t)&&t>=1&&t<=40}static getCapacity(t,e,i){if(!xe$1.isValid(t))throw new Error("Invalid QR Code version");void 0===i&&(i=ee$1.BYTE);const r=8*(Pt$1.getSymbolTotalCodewords(t)-(Ht$1.getTotalCodewordsCount(t,e)||0));if(i===ee$1.MIXED)return r;const s=r-this.getReservedBitsCount(i,t);switch(i){case ee$1.NUMERIC:return Math.floor(s/10*3);case ee$1.ALPHANUMERIC:return Math.floor(s/11*2);case ee$1.KANJI:return Math.floor(s/13);case ee$1.BYTE:default:return Math.floor(s/8)}}static getBestVersionForData(t,e,i){let r;if(Array.isArray(e)){if(e.length>1)return this.getBestVersionForMixedData(t,e,i);if(0===e.length)return 1;r=e[0];}else r=e;const s=t?Math.ceil(t.length/8):0;return this.getBestVersionForDataLength(r.mode,r.getLength()+s,i)}static getEncodedBits(t){if(!xe$1.isValid(t)||t<7)throw new Error("Invalid QR Code version");let e=t<<12;for(;Pt$1.getBCHDigit(e)-me$1>=0;)e^=7973<<Pt$1.getBCHDigit(e)-me$1;return t<<12|e}}class we$1{static getPositions(t){const e=Pt$1.getSymbolSize(t);return [[0,0],[e-7,0],[0,e-7]]}}class be$1{static setupFinderPattern(t,e){const i=t.cols,r=we$1.getPositions(e);for(let e=0;e<r.length;e++){const s=r[e][0],n=r[e][1];for(let e=-1;e<=7;e++)if(!(s+e<=-1||i<=s+e))for(let r=-1;r<=7;r++)n+r<=-1||i<=n+r||(e>=0&&e<=6&&(0===r||6===r)||r>=0&&r<=6&&(0===e||6===e)||e>=2&&e<=4&&r>=2&&r<=4?t.set(s+e,n+r,!0,!0):t.set(s+e,n+r,!1,!0));}}static setupTimingPattern(t){const e=t.cols;for(let i=8;i<e-8;i++){const e=i%2==0;t.set(i,6,e,!0),t.set(6,i,e,!0);}}static setupAlignmentPattern(t,e){const i=Ot$1.getPositions(e);for(let e=0;e<i.length;e++){const r=i[e][0],s=i[e][1];for(let e=-2;e<=2;e++)for(let i=-2;i<=2;i++)-2===e||2===e||-2===i||2===i||0===e&&0===i?t.set(r+e,s+i,!0,!0):t.set(r+e,s+i,!1,!0);}}static setupVersionInfo(t,e){const i=t.cols,r=xe$1.getEncodedBits(e);let s,n,a;for(let e=0;e<18;e++)s=Math.floor(e/3),n=e%3+i-8-3,a=1==(r>>e&1),t.set(s,n,a,!0),t.set(n,s,a,!0);}static setupFormatInfo(t,e,i){const r=t.cols,s=Ft$1.getEncodedBits(e,i);let n=!1;for(let e=0;e<15;e++)n=1==(s>>e&1),e<6?t.set(e,8,n,!0):e<8?t.set(e+1,8,n,!0):t.set(r-15+e,8,n,!0),e<8?t.set(8,r-e-1,n,!0):e<9?t.set(8,15-e-1+1,n,!0):t.set(8,15-e-1,n,!0);t.set(r-8,8,1,!0);}static setupData(t,e){const i=t.cols;let r=-1,s=i-1,n=7,a=0;for(let o=i-1;o>0;o-=2)for(6===o&&o--;;){for(let i=0;i<2;i++)if(!t.isReserved(s,o-i)){let r=!1;a<e.length&&(r=1==(e[a]>>>n&1)),t.set(s,o-i,r),n--,-1===n&&(a++,n=7);}if(s+=r,s<0||i<=s){s-=r,r=-r;break}}}static createData(t,e,i,r){i||(i=new Nt$1),r.forEach((function(e){i.put(e.mode.bit,4),i.put(e.getLength(),ee$1.getCharCountIndicator(e.mode,t)),e.write(i);}));const s=8*(Pt$1.getSymbolTotalCodewords(t)-(Ht$1.getTotalCodewordsCount(t,e)||0));for(i.getLengthInBits()+4<=s&&i.put(0,4);i.getLengthInBits()%8!=0;)i.putBit(0);const n=(s-i.getLengthInBits())/8;for(let t=0;t<n;t++)i.put(t%2?17:236,8);return this.createCodewords(i,t,e)}static createCodewords(t,e,i){const r=Pt$1.getSymbolTotalCodewords(e),s=Ht$1.getTotalCodewordsCount(e,i);if(!s)return;const n=r-s,a=Ht$1.getBlocksCount(e,i);if(!a)return;const o=a-r%a,h=Math.floor(r/a),c=Math.floor(n/a),l=c+1,d=h-c,g=new ae$1(d);let u=0;const f=new Array(a),p=new Array(a);let m=0;const x=new Uint8Array(t.buffer);for(let t=0;t<a;t++){const e=t<o?c:l;f[t]=x.slice(u,u+e),p[t]=g.encode(f[t]),u+=e,m=Math.max(m,e);}const w=new Uint8Array(r);let b,y,C=0;for(b=0;b<m;b++)for(y=0;y<a;y++)b<f[y].length&&(w[C++]=f[y][b]);for(b=0;b<d;b++)for(y=0;y<a;y++)w[C++]=p[y][b];return w}static create(t){let e=null===t.text||void 0===t.text?t.content:t.text;if(null==e||""===e)return;e=String(e);const i="number"==typeof t.eccLevel?t.eccLevel:Tt$1.Middle;let r="number"==typeof t.version?t.version:0,s="number"==typeof t.qrMask?t.qrMask:0;"function"==typeof t.toSJISFunc&&(Pt$1.toSJISFunction=t.toSJISFunc);const n=new Nt$1;let a="number"==typeof t.waterMarkMode?t.waterMarkMode:-1;const o=t.waterMarkSeed||0;if(a>=0){a=a>3?3&Date.now():a;const t=this.getWaterSeedCheckSum(e,a,o);this.appendDtWaterMark(a,t,n);}let h=r;if(r<=0){const t=pe$1.rawSplit(e);h=xe$1.getBestVersionForData(n,t,i)||0;}const c=pe$1.fromString(e,h||40),l=xe$1.getBestVersionForData(n,c,i);if(!l)throw new Error("The amount of data is too big to be stored in a QR Code");if(r<=0)r=l;else if(r<l)throw new Error("\nThe chosen QR Code version cannot contain this amount of data.\nMinimum version required to store current data is: "+l+".\n");const d=this.createData(r,i,n,c);if(!d)return;const g=Pt$1.getSymbolSize(r),u=new p$1(g,g);return this.setupFinderPattern(u,r),this.setupTimingPattern(u),this.setupAlignmentPattern(u,r),this.setupFormatInfo(u,i,0),r>=7&&this.setupVersionInfo(u,r),this.setupData(u,d),s<=0&&(s=Vt$1.getBestMask(u,this.setupFormatInfo.bind(null,u,i))),Vt$1.applyMask(s,u),this.setupFormatInfo(u,i,s),u}static getWaterSeedCheckSum(t,e,i){const r=3&e;let s=this.sDtWaterMarkCheckSums[r];s=s+(i=Pt$1.calcWaterMarkSeed(i))&1048575;const n=w$1.getBytes_Utf8(t);for(let t=0;t<n.length;++t)s+=s>>>5,s+=(255&n[t])*(2&t?5:3),s+=1&t?13:11;return s=s%1019+3,s}static appendDtWaterMark(t,e,i){e=53248|(3&t)<<10|1023&e,this.appendStructuredAppend(e>>>8,255&e,i);}static appendStructuredAppend(t,e,i){this.appendModeInfo(ee$1.STRUCTURED,i),i.put(t,8),i.put(e,8);}static appendModeInfo(t,e){e.put(t.bit,4);}}be$1.sDtWaterMarkCheckSums=[197,257,571,991];const ye$1=Object.freeze({Auto:"auto",QRCode:"qrcode",PDF417:"pdf417",DMCode:"dataMatrix",GMCode:"gridMatrix"});class Ce$1{static getEncoder(t){if(!t)return;t=t.toUpperCase();const e=this.barcodeCreatorMap[t];return l$1.log(`---- getBarcode2DEncoder[${t}]: ${!!e}`),e}static setEncoder(t,e){return !(!t||!e||"function"!=typeof e.encode)&&(t=t.toUpperCase(),l$1.log(`---- setBarcode2DEncoder[${t}]:`),this.barcodeCreatorMap[t]=e,!0)}static checkAndRegisterEncodeModule(t){if(!t||!window)return;const e=window;let i;if((t=t.toUpperCase())===ye$1.PDF417.toUpperCase()?i=e.DzPdf417:t===ye$1.DMCode.toUpperCase()?i=e.DzDataMatrix:t===ye$1.GMCode.toUpperCase()&&(i=e.DzGridMatrix),i){if("function"==typeof i.getInstance){const e=i.getInstance();return this.setEncoder(t,e),e}return "function"==typeof i.register?(i.register(this.getInstance()),this.getEncoder(t)):void 0}}static getInstance(){return this._instance||(this._instance=new Ce$1)}static createQRCode(t){return be$1.create(t)}static create2DBarcode(t){const e=t.barcodeType||t.type;let i;return e&&(i=this.getEncoder(e),i||(i=this.checkAndRegisterEncodeModule(e))),null!==t.text&&void 0!==t.text||(t.text=t.content),i?i.encode(t):be$1.create(t)}static createPDF417(t){return t.barcodeType||(t.barcodeType=ye$1.PDF417),this.create2DBarcode(t)}static createDataMatrix(t){return t.barcodeType||(t.barcodeType=ye$1.DMCode),this.create2DBarcode(t)}static createGridMatrix(t){return t.barcodeType||(t.barcodeType=ye$1.GMCode),this.create2DBarcode(t)}static drawQrcode(t,e){const i=be$1.create(Object.assign(Object.assign({},e),{eccLevel:Tt$1.Middle})),r=e.width||t.width;if(i){const e=new g$1({canvas:t});e.startJob({width:r}),e.drawQrcode({data:i,width:r});}}register(t){return !!t&&Ce$1.setEncoder(t.barcodeType,t)}}Ce$1.barcodeCreatorMap={};class Ae$1{constructor(t,e,i){if(this.contentLeft="",this._currValue=0,this.currLength=0,this.contentRight="",this.degreeOffset=0,this.maxDegreeValue=0,!t)return;e=e||1,i=i||0;let r=-1,s=-1;for(s=t.length-1;s>=0&&!x$1.isDigit(t.charCodeAt(s));s--);if(!(s<0)){for(r=s-1;r>=0&&x$1.isDigit(t.charCodeAt(r))&&!(s-r>=Ae$1.MaxDegreeLength);r--);r++,this._currValue=parseInt(t.substring(r,s+1)),this.maxDegreeValue=Number.MAX_VALUE,this.contentLeft=t.substring(0,r),this.contentRight=t.substring(s+1),this.currLength=i>0?i:s-r+1,this.degreeOffset=e||0;}}get IsValid(){return 0!=this.degreeOffset}get CurrValue(){return this._currValue}set CurrValue(t){t>Ae$1.MaxDegreeValue?this._currValue=Ae$1.MaxDegreeValue:this._currValue=t<0?0:t;}step(t){return this.CurrValue+=this.degreeOffset*t,this.toString()}get ShownDegree(){if(this.IsValid){let t=this.CurrValue||0;const e=t<0?"-":"";t=Math.abs(t);const i=t.toFixed();return `${e}${i.length<this.currLength?x$1.repeatChar("0",this.currLength-i.length):""}${i}`}return ""}toString(){return this.IsValid?this.contentLeft+this.ShownDegree+this.contentRight:""}}Ae$1.MaxDegreeLength=15,Ae$1.MaxDegreeValue=Math.pow(10,Ae$1.MaxDegreeLength)-1,Ae$1.MaxDegreeOffset=Math.pow(10,Ae$1.MaxDegreeLength-1);class ve$1{get Text(){return this.text}constructor(){this.keyGroup=[],this.text="";}setKeyWordAction(t){this.keyWordAction=t;}setKeys(t){if(!t)return;t=t.replace(/\\n/g,"\n"),this.text=t;const e=[];let i=0;for(let r=0,s=0,n=!1;r<t.length;r++){const a=t.charAt(r);"["===a?(n=!0,s=r):"]"===a&&n&&(n=!1,e.push({text:t.substring(i,s)}),e.push({text:t.substring(s+1,r),isKey:!0}),i=r+1);}i<t.length&&e.push({text:t.substr(i),isKey:e.length<1}),this.keyGroup=e;}hasKeyWord(){return !!this.keyGroup.find((t=>t.isKey))}toString(t){const e=[];let i=!1;if(!this.keyWordAction)return t||this.text;for(const t of this.keyGroup)if(t.isKey){const r=this.keyWordAction(t.text);void 0!==r&&(e.push(r||""),i=!0);}else e.push(t.text);return !i&&t?t:e.join("")}}const Se$1=Object.freeze({text:"text",barcode:"barcode",qrcode:"qrcode",pdf417:"pdf417",dataMatrix:"dataMatrix",data_matrix:"datamatrix",gridMatrix:"gridMatrix",grid_matrix:"gridmatrix",image:"image",rect:"rect",rectangle:"rectangle",ellipse:"ellipse",circle:"circle",line:"line",table:"table",arcText:"arcText",arc_text:"arctext",html:"html"});class Ee$1{static Pix2MM(t,e){return 25.4*t/e}static MM2Pix(t,e){return t*e/25.4}static isPreviewJobName(t){return !!t&&((t=t.toLowerCase()).startsWith(this.JOB_NAME_PREV.substring(0,7))||t.startsWith(this.JOB_NAME_TRANS.substring(0,8)))}static isTransPrevJob(t){return !!t&&t.toLowerCase().startsWith(this.JOB_NAME_TRANS.substring(0,8))}static isWhitePrevJob(t){return !!t&&t.toLowerCase().startsWith(this.JOB_NAME_PREV.substring(0,7))}static calcPageHeight(t,e){return ("number"!=typeof e||e<=0)&&(e=0),t.reduce(((t,e)=>{const i=(e.y||0)+(e.height||e.fontHeight||0);return i>t?i:t}),0)+(e>0?e:2)}static getJobStartOptions(e,i){const r=i||{};let s="number"==typeof r.printerDPI?r.printerDPI:e.printerDpi;"number"!=typeof s&&("number"==typeof e.dpi&&e.dpi>0?s=e.dpi:"number"==typeof e.printerDPI&&e.printerDPI>0&&(s=e.printerDPI));const n="number"==typeof r.printerWidth?r.printerWidth:e.printerWidth;return Object.assign(Object.assign({},e),{backgroundImage:e.background,borderImage:e.border,dpi:s,printerDpi:s,printerWidth:n,svgViewBox:"string"==typeof e.svgViewBox?t$1.parseRect(e.svgViewBox):e.svgViewBox,color:e.drawColor})}static loadImageSrc(t){l$1.log("#### 【DrawContext.loadImage】src:");const e="string"==typeof t?t:t.src;return l$1.log(e.length>100?e.substring(0,100)+"...":e),new Promise((t=>{try{if(e){const i=new Image;i.crossOrigin="anonymous",i.src=e,i.onload=()=>{t(i);},i.onerror=e=>{l$1.warn(e),t(null);};}else l$1.warn("【DrawContext.CreateImage: src不能为空!"),t(null);}catch(e){l$1.warn(e,"#### 【【DrawContext.loadImage.catch】 图片加载异常，error:"),t(null);}}))}static html2ImageSrc(t){return t?`data:image/svg+xml,\n<svg xmlns='http://www.w3.org/2000/svg'>\n<foreignObject width='100%' height='100%'>\n<div xmlns='http://www.w3.org/1999/xhtml' style='font-size:16px;font-family:Helvetica'>${t}</div>\n</foreignObject>\n</svg>`:t}static html2Image(t){const e=Ee$1.html2ImageSrc(t);return Ee$1.loadImageSrc(e)}static loadSvgContent(t){const e=new Blob([t],{type:"image/svg+xml"});return new Promise((i=>{const r=new FileReader;r.onload=t=>{var e;i(null===(e=t.target)||void 0===e?void 0:e.result);},r.onerror=e=>{l$1.warn(e,`---- failed to load svg: '${t.substring(0,50)}...'`),i(void 0);},r.readAsDataURL(e);}))}static getMargins(t){const e="number"==typeof t.margin&&t.margin>=0?t.margin:0,i="number"==typeof t.marginH&&t.marginH>=0?t.marginH:e,r="number"==typeof t.marginV&&t.marginV>=0?t.marginV:e,s=[];return s[0]="number"==typeof t.marginTop?t.marginTop:r,s[1]="number"==typeof t.marginRight?t.marginRight:i,s[2]="number"==typeof t.marginBottom?t.marginBottom:r,s[3]="number"==typeof t.marginLeft?t.marginLeft:i,s}get Context(){return this.cvs.Base.Context}get CanvasElement(){return this.cvs.Base.Canvas}get Canvas(){return this.cvs}get Dpi(){return this.cvs.Dpi}set Dpi(t){this.cvs.Dpi=t;}get IsPreviewMode(){return this.previewMode}get JobInfo(){return this.jobOptions}get Width(){return this.jobWidth}get Height(){return this.jobHeight}get Orientation(){return this.jobOrientation||0}get JobName(){var t;return null===(t=this.jobOptions)||void 0===t?void 0:t.jobName}get ZoomRate(){return this.Canvas.DPM}set ZoomRate(t){t<this.mMinZoomRate&&(t=this.mMinZoomRate),t>this.mMaxZoomRate&&(t=this.mMaxZoomRate);const e=this.Canvas.DPM;t!==e&&(this.Canvas.DPM=t,this.CanvasElement.style&&(this.CanvasElement.style.borderRadius=.5*t+"px"),this.onZoomRateChanged(t,e));}get PixWidth(){return this.Canvas.DPM*this.Width}get PixHeight(){return this.Canvas.DPM*this.Height}get Foreground(){return this.Canvas.Foreground}set Foreground(t){(t||"").match(/^([A-Fa-f0-9]{3}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/)&&(t=`#${t}`),this.Canvas.Foreground=t;}get Background(){return this.cvs.Base.Background}get IsApiMode(){return this.Canvas.Base.IsApiMode}set IsApiMode(t){this.Canvas.Base.IsApiMode=t;}constructor(t){this.previewMode=!0,this.jobWidth=0,this.jobHeight=0,this.jobOrientation=0,this.mMinZoomRate=.5,this.mMaxZoomRate=40;const e="boolean"==typeof t?{previewMode:t}:t||{};e.creator||(e.creator=()=>this.createCanvas()),"function"!=typeof e.onCanvasClear&&(e.onCanvasClear=(t,e)=>{this.onCanvasClear(t,e);}),this.cvs=new u$1(e),this.mKeyWordParser=new ve$1,"boolean"==typeof e.previewMode&&(this.previewMode=e.previewMode);}onZoomRateChanged(t,e){}createCanvas(){return l$1.log("---- DrawContext.createCanvas:"),null===document||void 0===document?void 0:document.createElement("canvas")}onCanvasClear(t,e){l$1.log("---- onCanvasClear:");}loadImage(t){return Ee$1.loadImageSrc(t)}loadHtml(t){const e=Ee$1.html2ImageSrc(t);return this.loadImage(e)}setMaxZoomRate(t){t>0&&(this.mMaxZoomRate=t);}setMinZoomRate(t){t>0&&(this.mMinZoomRate=t);}setOffset(t,e){switch(this.Orientation){case 1:case 90:this.Canvas.OffsetX=e,this.Canvas.OffsetY=-t;break;case 2:case 180:this.Canvas.OffsetX=-t,this.Canvas.OffsetY=-e;break;case 3:case 270:this.Canvas.OffsetX=-e,this.Canvas.OffsetY=t;break;default:this.Canvas.OffsetX=t,this.Canvas.OffsetY=e;}}save(){this.Canvas.Base.Context.save();}restore(){this.Canvas.Base.Context.restore();}setItemOrientation(t){return this.Canvas.Base.ItemOrientation=t,!0}setItemHorizontalAlignment(t){return this.Canvas.Base.HorizontalAlign=t,!0}setItemVerticalAlignment(t){return this.Canvas.Base.VerticalAlign=t,!0}setFontName(t){this.Canvas.setFontName(t);}setFontHeight(t){this.Canvas.setFontHeight(t);}setLineWidth(t){this.Canvas.setLineWidth(t);}setLineSpace(t){return this.Canvas.setLineSpace(t),!0}setCharSpace(t){return this.Canvas.setCharSpace(t),!0}setAutoTextLine(t){this.Canvas.Base.AutoReturn=t;}setRotation(t,e,i){return this.Canvas.setRotation(t>3?t:90*t,e,i),!0}setBorderAlign(t){this.Canvas.Base.BorderAlign=t;}resetJobInfo(t){"number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.dpi&&(t.dpi=t.printerDpi),"number"!=typeof t.dpi&&(t.dpi=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),this.jobOptions=t,this.jobWidth=t.width>0?t.width:0,this.jobWidth<=0&&t.dpi>0&&t.printerWidth>0&&(this.jobWidth=t.printerWidth/t.dpi*25.4),this.jobHeight=t.height>0?t.height:t.width,this.jobOrientation=t.orientation||0,this.Canvas.Base.ItemOrientation=0,this.Canvas.Base.HorizontalAlign=0,this.Canvas.Base.VerticalAlign=0;}poundToMm(t){return 25.4*t/72}mmToPound(t){return 72*t/25.4}isPrintJob(){return this.jobOptions&&this.jobOptions.printMode||!1}startJob(t){if((t=t||{}).width||(t.width=t.jobWidth||t.labelWidth),t.height||(t.height=t.jobHeight||t.labelHeight),"number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),t.width<=0&&t.printerWidth<=0)return;this.IsApiMode?("boolean"!=typeof t.printMode&&(t.printMode=!Ee$1.isPreviewJobName(t.jobName)),t.printMode||(t.backgroundColor||(Ee$1.isTransPrevJob(t.jobName)?t.backgroundColor=Ee$1.JOB_COLOR_TRANS:t.backgroundColor=Ee$1.JOB_COLOR_WHITE),t.color||(t.color=g$1.COLOR_FG_DEFAULT))):"boolean"!=typeof t.printMode&&(t.printMode=!this.previewMode),this.resetJobInfo(Object.assign({},t));const e=this.Canvas.startJob(t);return e?(t.borderImage&&("string"==typeof t.borderImage?this.drawImage({image:t.borderImage,width:t.width,height:t.height}):this.drawBorderImage({image:t.borderImage,svgElement:t.svgElement,borderScale:t.borderScale,tileMode:!t.svgElement,svgWidth:t.svgWidth,svgHeight:t.svgHeight,svgViewBox:t.svgViewBox})),Object.assign({},t,{canvas:e.Canvas,context:e.Context,isPreview:!t.printMode})):void 0}endJob(){const t=this.jobOptions;if(!t)return;const e=this.Canvas.commitJob();if(!e)return;const i=this.IsApiMode,r=Object.assign({},t,{canvas:e.Canvas,context:e.Context,isPreview:!t.printMode,apiMode:i});return i&&(t.printMode?(t.antiColor&&this.Canvas.inverseColors(),t.horizontalFlip&&this.Canvas.horizontalFlip(),r.imageData=e.getImageData(),r.dataUrl=t.withDataUrl?e.Canvas.toDataURL():""):(r.dataUrl=e.Canvas.toDataURL(),r.imageData=t.withImageData?e.getImageData():void 0)),r}commitJob(){return Promise.resolve(this.endJob())}drawLine(t){return "number"!=typeof t.lineWidth&&(t.lineWidth=Ee$1.LINE_WIDTH_MM),this.Canvas.drawLine(t)}drawLines(t,e,i,r,s,n,a){n=n||[],a=a||[];let o=0;this.drawLine({x1:t,y1:e,x2:i,y2:r,lineWidth:s});for(let a=0;a<n.length;a++)o+=n[a],this.drawLine({x1:t,y1:e+o,x2:i,y2:r+o,lineWidth:s});o=0;for(let n=0;n<a.length;n++)o+=a[n],this.drawLine({x1:t+o,y1:e,x2:i+o,y2:r,lineWidth:s});}drawRect(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Ee$1.LINE_WIDTH_MM),this.Canvas.drawRect(t)}drawRectangle(t){return this.drawRect(t)}fillRect(t){return this.Canvas.drawRect(Object.assign(Object.assign({},t),{fill:!0}))}drawRoundRect(t){t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Ee$1.LINE_WIDTH_MM),this.Canvas.drawRoundRect(t);}drawEllipse(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Ee$1.LINE_WIDTH_MM),this.Canvas.drawEllipse(t)}drawCircle(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Ee$1.LINE_WIDTH_MM),this.Canvas.drawCircle(t)}drawText(t){return !t.fontHeight&&t.fontSize&&(t.fontHeight=this.poundToMm(t.fontSize)),t.fontHeight||(t.fontHeight=this.Canvas.getFontHeight()),t.fontHeight<2&&(t.fontHeight=2),this.Canvas.drawText(t)}drawArcText(t){return !t.fontHeight&&t.fontSize&&(t.fontHeight=this.poundToMm(t.fontSize)),this.Canvas.drawArcText(t)}splitText(t){return this.Canvas.splitText(t)}measureText(t){return this.Canvas.measureText(t)}measureFontSize(t){return this.Canvas.measureFontSize(t)}draw1DMatrix(t){return !!t.datas&&this.Canvas.draw1DBarcode(t)}drawBarcode(t){return "string"==typeof t.barcodeType&&t.barcodeType?this.draw2DBarcode(t):this.draw1DBarcode(t)}draw1DBarcode(t){const e=Dt$1.create1DBarcode(t);return t.barcodeType===b$1.ISBN&&(t.textFlag=2),!!e&&this.draw1DMatrix(Object.assign(t,{datas:e.items}))}draw2DBarcode(t){const e=Ce$1.create2DBarcode(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e}))}draw2DMatrix(t){return !!t.data&&this.Canvas.draw2DBarcode(t)}drawQRCode(t){const e=Ce$1.create2DBarcode(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DQRCode(t){return this.drawQRCode(t)}drawPDF417(t){const e=Ce$1.createPDF417(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DPdf417(t){return this.drawPDF417(t)}drawDataMatrix(t){const e=Ce$1.createDataMatrix(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DDataMatrix(t){return this.drawDataMatrix(t)}drawGridMatrix(t){const e=Ce$1.createGridMatrix(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DGridMatrix(t){return this.drawGridMatrix(t)}drawImage(t){if(t.image){const e=t.image;return e.dzSrc&&(t.image=e.dzSrc),this.Canvas.drawImage(t)}return !1}drawImageResizeLabel(t){return this.Canvas.drawImageResizeLabel(t)}drawBorderImage(t){const e=t.image;if(!e||"string"==typeof e)return;const i=t.svgElement,r="boolean"==typeof t.svgMode?t.svgMode:!!i;let s=e.width||t.imageWidth||0,n=e.height||t.imageHeight||0;if(i){l$1.log("---- SVG 图片适配:");const i=t.svgViewBox,r=t.svgWidth,a=t.svgHeight,o=this.Canvas.CanvasWidth,h=this.Canvas.CanvasHeight;if(r&&r>0||a&&a>0)s||(s=r||a||0),n||(n=a||r||0);else {let t=s,r=n;i&&(t=i.width,r=i.height),t&&r?t/r>o/h?(s=o,n=o*r/t):(n=h,s=t*h/r):s=n=Math.min(o,h),"string"!=typeof e&&(e.width=s,e.height=n);}}if(!s||!n)return void l$1.warn("---- drawBorderImage.fail: [无法获取图片大小]！");const a=s/3,o=n/3;this.Canvas.drawImageResizeLabel({img:e.dzSrc||e,left:a,top:o,right:e.width-a,bottom:e.height-o,tileMode:!r&&t.tileMode,relativeScale:r?t.borderScale||1:void 0,imageWidth:s,imageHeight:n});}drawItem(t,e,i){const r=t;if(t.color){const e=this.JobInfo;this.IsApiMode&&(null==e?void 0:e.printMode)?t.color=void 0:this.IsPreviewMode||(t.color=void 0);}const s=t.type&&"string"==typeof t.type?t.type.toLowerCase():Se$1.text,n="number"==typeof r.contentType?r.contentType:e?2:0;if(2===n&&e){let t;!r.columnName&&r.dataColumnName&&(r.columnName=r.dataColumnName),r.columnName?(this.mKeyWordParser.setKeys(r.columnName),t=this.mKeyWordParser.hasKeyWord()?this.mKeyWordParser.toString(r.text):e[r.columnName]):r.text&&r.text.indexOf("[")>=0&&(this.mKeyWordParser.setKeys(r.text),this.mKeyWordParser.hasKeyWord()&&(t=this.mKeyWordParser.toString(r.text))),void 0!==t&&(r.text=t);}else if(1===n&&i&&i>0){const e=t;e.rawText||(e.rawText=e.text);const r=e.rawText||"",s=new Ae$1(r,e.degreeOffset,e.degreeLength);s.IsValid&&(e.text=s.step(i));}switch("number"==typeof t.horAlignment&&"number"!=typeof t.horizontalAlignment&&(t.horizontalAlignment=t.horAlignment),"number"==typeof t.verAlignment&&"number"!=typeof t.verticalAlignment&&(t.verticalAlignment=t.verAlignment),"boolean"==typeof t.filled&&"boolean"!=typeof t.fill&&(t.fill=t.filled),s){case Se$1.text:return this.drawText(t);case Se$1.barcode:return this.draw1DBarcode(t);case Se$1.qrcode:return this.drawQRCode(t);case Se$1.pdf417:return this.drawPDF417(t);case Se$1.data_matrix:return this.drawDataMatrix(t);case Se$1.grid_matrix:return this.drawGridMatrix(t);case Se$1.image:return this.drawImage(t);case Se$1.rect:case Se$1.rectangle:return this.drawRect(t);case Se$1.ellipse:return this.drawEllipse(t);case Se$1.circle:return this.drawCircle(t);case Se$1.arc_text:return this.drawArcText(t);case Se$1.line:return this.drawLine(t);case Se$1.table:return this.drawTable(t,e,i);default:return l$1.warn(`---- 不支持的 DrawType: ${t.type}`),!1}}static getUnionRectOfRelateRect(e,i,r){for(const s of i)s!==e?t$1.hasIntersection(e,s)&&(r&&r.push(s),e=t$1.getUnionRect(e,s)):r&&r.push(s);return e}static shrinkCellContent(t,e){return {x:t.x+e,y:t.y+e,width:t.width-2*e,height:t.height-2*e}}drawTableWithoutRotation(e,i,r){!e.tableRows&&Array.isArray(e.rows)&&(e.tableRows=e.rows);const s=e.width||0,n=e.height||0,a=e.tableRows||[];if(s<=0||n<=0||a.length<=0)return !1;"number"!=typeof e.lineWidth&&(e.lineWidth=Ee$1.LINE_WIDTH_MM);const o=e.lineWidth>0?e.lineWidth:0,h=e.cellPadding||0,c=.5*o,l="number"==typeof e.horizontalAlignment?e.horizontalAlignment:1,d="number"==typeof e.verticalAlignment?e.verticalAlignment:1,g=e.x||0,u=e.y||0;let f="number"==typeof e.rowCount&&e.rowCount>0?e.rowCount:0,p="number"==typeof e.columnCount&&e.columnCount>0?e.columnCount:0;f<=0&&(f="number"==typeof e.rows&&e.rows>0?e.rows:a.length),p<=0&&(p="number"==typeof e.columns&&e.columns>0?e.columns:a.reduce(((t,e)=>e&&e.length>t?e.length:t),0));let m=Array(p).fill(.5);e.columnWidths&&e.columnWidths.length>1?m=e.columnWidths:("string"==typeof e.colWidth&&e.colWidth&&(e.colWidth=e.colWidth.split(",")),Array.isArray(e.colWidth)&&e.colWidth.length>1&&(m=e.colWidth.map((t=>t?Number(t):0)))),m.length>p?m=m.slice(0,p):m.length<p&&(m=m.concat(Array(p-m.length).fill(m[m.length-1]))),m=m.map((t=>t>0?t:.5));const x=m.filter((t=>t>1)).reduce(((t,e)=>t+e),0),w=m.filter((t=>t<=1)).reduce(((t,e)=>t+e),0);w>0?m=m.map((t=>t>1?t:(s-x)/w*t)):x!==s&&(m=m.map((t=>t/x*s)));let b=Array(f).fill(.5);e.rowHeights&&e.rowHeights.length>1?b=e.rowHeights:("string"==typeof e.rowHeight&&e.rowHeight&&(e.rowHeight=e.rowHeight.split(",")),Array.isArray(e.rowHeight)&&e.rowHeight.length>1&&(b=e.rowHeight.map((t=>t?Number(t):0)))),b.length>f?b=b.slice(0,f):b.length<f&&(b=b.concat(Array(f-b.length).fill(b[b.length-1]))),b=b.map((t=>t>0?t:.5));const y=b.filter((t=>t>1)).reduce(((t,e)=>t+e),0),C=b.filter((t=>t<=1)).reduce(((t,e)=>t+e),0);C>0?b=b.map((t=>t>1?t:(n-y)/C*t)):y!==n&&(b=b.map((t=>t/y*n)));let A=e.groups||[];if("string"==typeof e.group&&(A=e.group.split(";").map((t=>{const e=t.split(",").map((t=>t[0]>="0"&&t[0]<="9"?Number(t):0));return e.length>3?{x:e.length>1?e[1]-1:0,y:e.length>0?e[0]-1:0,width:e.length>3?e[3]-e[1]+1:0,height:e.length>2?e[2]-e[0]+1:0}:void 0})).filter((t=>!!t))),a.forEach(((t,e)=>{for(let i=0;i<p;i++){const r=t[i];if("object"==typeof r){const t=r.rowSpan||0,s=r.columnSpan||r.colSpan||0;(t>1||s>1)&&A.push({x:i,y:e,width:s>1?s:1,height:t>1?t:1});}}})),A.length>1){const t=A.slice(0);A.splice(0);const e=[];for(const i of t){if(e.indexOf(i)>=0)continue;const r=Ee$1.getUnionRectOfRelateRect(i,t,e);A.push(r);}}o>0&&this.drawRect({x:e.x,y:e.y,width:e.width,height:e.height,lineWidth:o});for(let s=0,n=0;s<f;n+=b[s],s++){const x=a[s]||[];for(let a=0,w=0;a<p;w+=m[a],a++){const y={x:a,y:s,width:1,height:1},C=A.filter((e=>t$1.isInnerRect(y,e))).shift();if(C){if(y.x!==C.x||y.y!==C.y)continue;y.width=C.width,y.height=C.height;}const v=(t,e)=>(t||0)+e,S={x:g+w,y:u+n,width:y.width>0?m.slice(y.x,y.x+y.width).reduce(v,0):m[y.x],height:y.height>0?b.slice(y.y,y.y+y.height).reduce(v,0):b[y.y]};y.x>0&&o>0&&this.drawLine({x1:S.x,x2:S.x,y1:S.y+(y.y<=0?c:0),y2:S.y+S.height-(y.y+y.height>=f?c:0),lineWidth:o}),y.y>0&&o>0&&this.drawLine({x1:S.x+(y.x<1?c:0),x2:S.x+S.width-(y.x+y.width>=p?c:0),y1:S.y,y2:S.y,lineWidth:o});const E=x[a];if(void 0!==E){let t=E;"object"!=typeof E&&(t={type:Se$1.text,text:E}),t.type||(t.type=Se$1.text);const s=t;"number"!=typeof s.horizontalAlignment&&(s.horizontalAlignment="number"==typeof s.horAlignment?s.horAlignment:l),"number"!=typeof s.verticalAlignment&&(s.verticalAlignment="number"==typeof s.verAlignment?s.verAlignment:d);let n=c+h;if(t.type===Se$1.text){const i=t;i.fontHeight||(i.fontHeight=e.fontHeight||.3*S.height),!i.fontName&&e.fontName&&(i.fontName=e.fontName),"number"!=typeof i.fontStyle&&"number"==typeof e.fontStyle&&(i.fontStyle=e.fontStyle),h<=0&&(n=c+1);}else t.type===Se$1.qrcode&&h<=0&&(n=c+1);this.drawItem(Object.assign(t,Ee$1.shrinkCellContent(S,n)),i,r);}}}return !0}drawTable(t,e,i){let r=t.x||0,s=t.y||0,n=t.width||0,a=t.height||0;if(!this.jobOptions)return !1;let o=Array.isArray(t.margin)?t.margin[0]:t.margin,h=Array.isArray(t.margin)?t.margin[1]:o;if(n<=0){const e=this.jobWidth;o="number"==typeof o&&o>=0?o:.05*e,r=t.x="number"==typeof t.x?t.x:o,n=t.width=e-r-o;}if(a<=0){const e=this.jobHeight;h="number"==typeof h&&h>=0?h:.05*e,s=t.y="number"==typeof t.y?t.y:h,a=t.height=e-s-h;}const c=t.columnCount||t.columns||t.cols||0;if(t.Cells&&Array.isArray(t.Cells)&&!t.cells&&(t.cells=t.Cells,delete t.Cells),!t.tableRows)if(Array.isArray(t.rows))t.tableRows=t.rows;else if(t.cells&&c>0){t.tableRows=[];for(let e=0;e<t.cells.length;e+=c)t.tableRows.push(t.cells.slice(e,e+c));}if(!t.tableRows||t.tableRows.length<=0)return !1;t.fontSize&&!t.fontHeight&&(t.fontHeight=this.poundToMm(t.fontSize)),this.save(),this.setRotation(t.orientation||0,{x:r,y:s},{width:n,height:a});const l=this.drawTableWithoutRotation(t,e,i);return this.restore(),l}printPageGroup(t,e){const i=t.jobPages||[],r=t.jobArguments||[],s={printCopies:1,copyIndex:0,printPages:1,pageIndex:0},n=t.jobInfo||{},a=t.printerInfo||{},o=Ee$1.getJobStartOptions(n,a),h=n.jobHeight||0,c=Ee$1.getMargins(n);let l=0;const d=n.startPage&&n.startPage>0?n.startPage:0,g=n.printPages||0;if(r.length>0||g>1&&i.length<=1){const t=r.length>0?r.length:d+g;let n=t;g>0&&(n=d+g>t?t:d+g),h<=0&&(o.height=Ee$1.calcPageHeight(i[0],c[2]));for(let t=d;t<n;t++){const a=r[t];s.printPages=n,s.pageIndex=t;if(!this.startJob(Object.assign({},o)))break;this.mKeyWordParser.setKeyWordAction((t=>a[t]));for(const e of i[0])this.drawItem(e,a,t);const h=this.endJob();if(!h)break;const c=e(Object.assign(h,s));if("number"==typeof c&&(l=c),l>0)break;l<0&&t--;}}else {let t=i.length;g>0&&(t=d+g>i.length?i.length:d+g);for(let r=d;r<t;r++){s.printPages=t,s.pageIndex=r,h<=0&&(o.height=Ee$1.calcPageHeight(i[r],c[2]));const n=i[r];if(!this.startJob(Object.assign({},o)))break;for(const t of n)this.drawItem(t);const a=this.endJob();if(!a)break;const d=e(Object.assign(a,s));if("number"==typeof d&&(l=d),l>0)break;l<0&&r--;}}return l}printAsyncPageGroup(t,e){return f$1(this,void 0,void 0,(function*(){const i=t.jobPages||[],r=t.jobArguments||[],s={printCopies:1,copyIndex:0,printPages:1,pageIndex:0},n=t.jobInfo||{},a=t.printerInfo||{},o=Ee$1.getJobStartOptions(n,a),h=n.jobHeight||0,c=Ee$1.getMargins(n);let l=0,d=n.startPage&&n.startPage>0?n.startPage:0;const g=n.printPages||0;if(r.length>0||g>1&&i.length<=1){const t=r.length>0?r.length:d+g;let n=t;g>0&&(n=d+g>t?t:d+g),d>=n&&(d=n-1),h<=0&&(o.height=Ee$1.calcPageHeight(i[0],c[2]));for(let t=d;t<n;t++){const a=r[t];s.printPages=n,s.pageIndex=t,s.isEndPage=t+1>=n;if(!this.startJob(Object.assign({},o)))break;this.mKeyWordParser.setKeyWordAction((t=>a[t]));for(const e of i[0])this.drawItem(e,a,t);const h=yield this.commitJob();if(!h)break;const c=yield e(Object.assign(h,s));if("number"==typeof c&&(l=c),l>0)break;l<0&&t--;}}else {let t=i.length;g>0?t=d+g>i.length?i.length:d+g:i.length<=1&&d>0&&(d=0);for(let r=d;r<t;r++){s.printPages=i.length,s.pageIndex=r,s.isEndPage=r+1>=i.length,h<=0&&(o.height=Ee$1.calcPageHeight(i[r],c[2]));const t=i[r];if(!this.startJob(Object.assign({},o)))break;for(const e of t)this.drawItem(e);const n=yield this.commitJob();if(!n)break;const a=yield e(Object.assign(n,s));if("number"==typeof a&&(l=a),l>0)break;l<0&&r--;}}return l}))}drawJob(t){l$1.log("#### drawJob:"),t.jobPages||(t.jobPages=[]);const e=t.jobInfo||{},i=e.startCopy||0,r=e.remainCopies||0;let s=0;if(t.jobPages.length<=0&&t.jobPage&&t.jobPages.push(t.jobPage),t.jobPages.length<=0)return s=1,s;const n=e.printCopies&&e.printCopies>0?e.printCopies:1;if(n>1&&e.autoPage){for(let e=0;e<n&&(s=this.printPageGroup(t,(s=>t.onPageComplete?(s.printCopies=n+i+r,s.copyIndex=e+i,s.isEndCopy=e+1>=n,t.onPageComplete(s)||0):0)),0===s);e++);return s}return this.printPageGroup(t,(e=>(t.onPageComplete&&(s=t.onPageComplete(Object.assign(Object.assign({},e),{printCopies:n+i+r,copyIndex:i,isEndCopy:!0}))||0),s)))}drawAsyncJob(t){return f$1(this,void 0,void 0,(function*(){l$1.info("#### drawAsyncJob:"),t.jobPages||(t.jobPages=[]);const e=t.jobInfo||{},i=e.startCopy||0,r=e.remainCopies||0;let s=0;if(t.jobPages.length<=0&&t.jobPage&&t.jobPages.push(t.jobPage),t.jobPages.length<=0)return s=1,s;const n=e.printCopies&&e.printCopies>0?e.printCopies:1;if(n>1&&e.autoPage){for(let e=0;e<n&&(s=yield this.printAsyncPageGroup(t,(s=>{var a;return t.onPageComplete?(s.printCopies=n+i+r,s.copyIndex=e+i,s.isEndCopy=e+1>=n,Promise.resolve(null!==(a=t.onPageComplete(s))&&void 0!==a?a:0)):Promise.resolve(0)})),0===s);e++);return s}return yield this.printAsyncPageGroup(t,(e=>t.onPageComplete?Promise.resolve(t.onPageComplete(Object.assign(Object.assign({},e),{printCopies:n+i+r,copyIndex:i,isEndCopy:!0}))||0):Promise.resolve(0)))}))}autoLoadDrawItemImage(t){return f$1(this,void 0,void 0,(function*(){if(t.type===Se$1.image){const e=t;e&&"string"==typeof e.image&&(e.image=yield this.loadImage(e.image));}else if(t.type===Se$1.html){const e=t;"string"!=typeof e.html&&e.html&&(e.html=e.html.innerHTML),e.image=yield this.loadHtml(e.html);}else if(t.type===Se$1.table){const e=t;if(e.tableRows)for(const t of e.tableRows)for(const e of t||[])e&&"string"!=typeof e&&e.type&&(yield this.autoLoadDrawItemImage(e));else if(e.cells)for(const t of e.cells)t&&"string"!=typeof t&&t.type&&(yield this.autoLoadDrawItemImage(t));}return !0}))}autoLoadImage(t){return f$1(this,void 0,void 0,(function*(){const e=t.jobInfo;if(e){(this.IsApiMode?Ee$1.isPreviewJobName(e.jobName):this.IsPreviewMode)?e.background&&"string"==typeof e.background&&(e.background=yield this.loadImage(e.background)):e.background=void 0,e.border&&"string"==typeof e.border&&(e.border=yield this.loadImage({src:e.border,withSize:!0}));}t.jobPage&&(!t.jobPages||t.jobPages.length<=0)&&(t.jobPages=[t.jobPage]);const i=t.jobPages||[];for(const t of i)for(const e of t)yield this.autoLoadDrawItemImage(e);return t}))}}Ee$1.JOB_NAME_TRANS="#!#transparent#!#",Ee$1.JOB_NAME_PREV="#!#preview#!#",Ee$1.JOB_COLOR_WHITE="#fff",Ee$1.JOB_COLOR_TRANS="transparent",Ee$1.LINE_WIDTH_MM=.35;class Le$1{constructor(t){this._margin=[],this._radius=0,this.data=t.data,this.init(t);}get MarginTop(){return this._margin.length>0?this._margin[0]:0}get MarginRight(){return this._margin.length>1?this._margin[1]:0}get MarginLeft(){return this._margin.length>3?this._margin[3]:this.MarginRight}get MarginBottom(){return this._margin.length>2?this._margin[2]:this.MarginTop}get CornerRadius(){return this._radius}init(t){this._radius=t.radius||0,this._margin=t.margin||[],this._jobStartAction=t.onJobStart,1===this._margin.length&&this._margin.push(this._margin[0]),t.element&&this.attachTo({element:t.element});}createDrawContext(t){return new Ee$1(Object.assign(Object.assign({},t),{apiMode:!1,previewMode:!0,position:"relative"}))}attachTo(t){return f$1(this,void 0,void 0,(function*(){if(!t.element&&!t.canvas)return !1;if(!this.drawContext){const e=this.createDrawContext(t);if(!e)return !1;this.drawContext=e;}const e=t.element,i=t.canvas;if(e)return this.drawContext.Canvas.Base.appendTo(e),this.raiseViewChanged(e.offsetWidth,e.offsetHeight);{const e=t.viewWidth||i.width||0,r=t.viewHeight||i.height||0;return this.raiseViewChanged(e,r)}}))}raiseViewChanged(t,e){return f$1(this,void 0,void 0,(function*(){const i=this.data?this.data.jobInfo:void 0,r=(null==i?void 0:i.jobWidth)||0,s=(null==i?void 0:i.jobHeight)||0,n=this.drawContext;if(!i)return l$1.warn("---- 未检测到 jobInfo 相关信息！"),!1;if(r<=0||s<=0)return l$1.warn(`---- 纸张大小错误：{jobWidth: ${r}, jobHeight: ${s}}`),!1;if(!n)return l$1.warn("---- 未检测到绘制上下文！"),!1;if(t<=0||e<=0)return l$1.warn(`---- 参数错误：viewWidth = ${t}, viewHeight = ${e}`),!1;const a=e-2,o=t-2-this.MarginLeft-this.MarginRight,h=a-this.MarginTop-this.MarginBottom,c=o>0?o/r:0,d=h>0?h/s:0;return n.ZoomRate=Math.min(c,d),this.updateCanvasPosition(n),this.refreshView()}))}updateCanvasPosition(t){var e;if("absolute"!==(null===(e=t.CanvasElement.style)||void 0===e?void 0:e.position))return;const i=t.CanvasElement.parentElement;if(i){if(i.parentElement){const e=i.parentElement,r=e.offsetWidth-2,s=e.offsetHeight-2,n=this.MarginLeft+this.MarginRight+t.PixWidth,a=this.MarginTop+this.MarginBottom+t.PixHeight;i.style.width=`${n>r?n:r}px`,i.style.height=`${a>s?a:s}px`;}const e=i.offsetWidth,r=i.offsetHeight,s=.5*(e-t.PixWidth),n=this.MarginTop+.5*(r-this.MarginTop-this.MarginBottom-t.PixHeight);t.CanvasElement.style&&(t.CanvasElement.style.left=`${s}px`,t.CanvasElement.style.top=`${n}px`,t.CanvasElement.style.borderRadius=t.ZoomRate*this._radius+"px");}}refreshView(){return f$1(this,void 0,void 0,(function*(){const t=this.drawContext,e=this.data.jobInfo;if(!t||!e)return !1;const i=Ee$1.getJobStartOptions(e,this.data.printerInfo),r=t.startJob(i);return !!r&&(this._jobStartAction&&(yield Promise.resolve(this._jobStartAction(r))),yield t.autoLoadImage(this.data),t.drawAsyncJob(this.data).then((t=>0===t)))}))}}

function t(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{h(s.next(t));}catch(t){n(t);}}function o(t){try{h(s.throw(t));}catch(t){n(t);}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e);}))).then(a,o);}h((s=s.apply(t,e||[])).next());}))}"function"==typeof SuppressedError&&SuppressedError;class e{static formatDate(t,e){let i=t||"yyyy-MM-dd HH:mm:ss.SSS";const s={"y+":(e=e||new Date).getFullYear(),"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),"S+":e.getMilliseconds()};let r;for(const t in s)if(r=new RegExp(`(${t})`).exec(i)){const e=`${s[t]}`,n=`00${e}`,a=r[1].length>n.length?0:n.length-r[1].length;i=i.replace(r[1],1===r[1].length?e:n.substring(a));}return i}static createRect(t,e,i,s){return {x:t||0,y:e||0,width:i,height:s}}static parseRect(t){if(!t)return;t=t.trim();const e=/^\[?\(?\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*,\s*([0-9.+-]+)\s*\)?]?$/.exec(t);return e?{x:parseFloat(e[1]),y:parseFloat(e[2]),width:parseFloat(e[3]),height:parseFloat(e[4])}:void 0}static isInnerRect(t,e){return t.x>=e.x&&t.x+t.width<=e.x+e.width&&t.y>=e.y&&t.y+t.height<=e.y+e.height}static hasIntersection(t,e){return t.x<e.x+e.width&&e.x<t.x+t.width&&t.y<e.y+e.height&&e.y<t.y+t.height}static getUnionRect(t,e){const i=Math.min(t.x,e.x),s=Math.min(t.y,e.y);return {x:i,y:s,width:Math.max(t.x+t.width,e.x+e.width)-i,height:Math.max(t.y+t.height,e.y+e.height)-s}}}var i,s,r,n,a,o,h,c,l;!function(t){t[t.NONE=0]="NONE",t[t.ERROR=1]="ERROR",t[t.WARN=2]="WARN",t[t.INFO=3]="INFO",t[t.LOG=4]="LOG";}(i||(i={}));class d{static innerLog(t){this.output?this.output.log(t):console.log(t);}static innerWarn(t){this.output?this.output.warn(t):console.warn(t);}static innerError(t){this.output?this.output.error(t):console.error(t);}static setLevel(t){this.logRecords.push(this.logLevel),this.logLevel=t;}static setLogOutput(t){this.output=t;}static restorePrev(){const t=this.logRecords.shift();void 0!==t&&(this.logLevel=t);}static log(t,s){if(this.logLevel>=i.LOG){const i=e.formatDate("HH:mm:ss.SSS");"object"==typeof t||s?(d.innerLog(`【LOG  】[${i}]: ${s||""}`),d.innerLog(t)):d.innerLog(`【LOG  】[${i}]: ${t}`);}}static info(t,s){if(this.logLevel>=i.INFO){const i=e.formatDate("HH:mm:ss.SSS");"object"==typeof t||s?(d.innerLog(`【INFO 】[${i}]: ${s||""}`),d.innerLog(t)):d.innerLog(`【INFO 】[${i}]: ${t}`);}}static warn(t,s){if(this.logLevel>=i.WARN){const i=e.formatDate("HH:mm:ss.SSS");"object"==typeof t||s?(d.innerWarn(`【WARN 】[${i}]: ${s||""}`),d.innerWarn(t)):d.innerWarn(`【WARN 】[${i}]: ${t}`);}}static error(t,s){if(this.logLevel>=i.ERROR){const i=e.formatDate("HH:mm:ss.SSS");"object"==typeof t||s?(d.innerError(`【ERROR】[${i}]: ${s||""}`),d.innerError(t)):d.innerError(`【ERROR】[${i}]: ${t}`);}}}d.logRecords=[],d.logLevel=i.WARN,function(t){t[t.Top=0]="Top",t[t.Bottom=1]="Bottom",t[t.Left=2]="Left",t[t.Right=3]="Right";}(s||(s={})),function(t){t[t.None=0]="None",t[t.UnderLine=1]="UnderLine",t[t.ThroughLine=2]="ThroughLine",t[t.OverLine=3]="OverLine";}(r||(r={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.BOLD=1]="BOLD",t[t.ITALIC=2]="ITALIC",t[t.UNDERLINE=4]="UNDERLINE",t[t.STRIKEOUT=8]="STRIKEOUT";}(n||(n={})),function(t){t[t.Unset=255]="Unset",t[t.Start=0]="Start",t[t.Center=1]="Center",t[t.End=2]="End",t[t.Stretch=3]="Stretch";}(a||(a={})),function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.HInner=2]="HInner",t[t.Right=4]="Right",t[t.HOuter=8]="HOuter",t[t.Top=16]="Top",t[t.VInner=32]="VInner",t[t.Bottom=64]="Bottom",t[t.VOuter=128]="VOuter",t[t.Inner=34]="Inner",t[t.Outer=136]="Outer";}(o||(o={})),function(t){t[t.None=0]="None",t[t.Char=1]="Char",t[t.Word=2]="Word";}(h||(h={})),function(t){t[t.Auto=0]="Auto",t[t.MM=1]="MM",t[t.Pix=2]="Pix";}(c||(c={})),function(t){t[t.LineSpace_Custom=0]="LineSpace_Custom",t[t.LineSpace_1_0=1]="LineSpace_1_0",t[t.LineSpace_1_2=1.2]="LineSpace_1_2",t[t.LineSpace_1_5=1.5]="LineSpace_1_5",t[t.LineSpace_2_0=2]="LineSpace_2_0";}(l||(l={}));class u{static getLineMode(t){switch(t=t||""){case u.LineSpace_1_0:return l.LineSpace_1_0;case u.LineSpace_1_2:return l.LineSpace_1_2;case u.LineSpace_1_5:return l.LineSpace_1_5;case u.LineSpace_2_0:return l.LineSpace_2_0;default:return t?l.LineSpace_Custom:l.LineSpace_1_0}}static toString(t,e){switch(t){case l.LineSpace_1_0:return u.LineSpace_1_0;case l.LineSpace_1_2:return u.LineSpace_1_2;case l.LineSpace_1_5:return u.LineSpace_1_5;case l.LineSpace_2_0:return u.LineSpace_2_0;case l.LineSpace_Custom:return "number"==typeof e?String(e):""}}static getModeValue(t,e){switch(t){case l.LineSpace_1_2:return .2*e;case l.LineSpace_1_5:return .5*e;case l.LineSpace_2_0:return 1*e;case l.LineSpace_1_0:case l.LineSpace_Custom:return 0;default:return t>1?e*(t-1):0}}static valueOf(t,e){if("string"==typeof t){const i=this.getLineMode(t);return i===l.LineSpace_Custom?Number.parseFloat(t):this.getModeValue(i,e)}return this.getModeValue(t,e)}}u.LineSpace_1_0="1_0",u.LineSpace_1_2="1_2",u.LineSpace_1_5="1_5",u.LineSpace_2_0="2_0";class g{static isNull(t){return null==t}static isTransparent(t){return "transparent"===(t=(t||"").toLowerCase())||t.match(/^#[0-9a-f]{3}0$/i)||t.match(/^#[0-9a-f]{6}00$/i)}static isHorizontal(t){switch(t){case 0:case 2:case 180:return !0;default:return !1}}static isPortrait(t){switch(t){case 1:case 3:case 90:case 270:return !0;default:return !1}}static validateColorStr(t){return t?/^[0-9A-Fa-f]+$/.exec(t)?`#${t}`:/^#([0-9A-Fa-f]+)$/.exec(t)?t:/^0[xX]([0-9A-Fa-f]+)$/.exec(t)?`#${t.substring(2)}`:t:t}get supportLineDash(){return this.supports("setLineDash")}get Canvas(){return this._canvas||this.setCanvas(this.createCanvas()),this._canvas}setCanvas(t){if(!t)return;this._canvas=t,this.initOptions.position&&this._canvas.style&&(this._canvas.style.position=this.initOptions.position);const e=!!this.IsApiMode;this.ctx=this._canvas.getContext("2d",{willReadFrequently:e}),this.setTextBaseline(g.TEXT_BASELINE_DEFAULT),this.setTextAlign("left");}get Context(){return this.ctx}get Width(){return this.width}get Height(){return this.height}get Orientation(){return this.orientation}get BorderAlign(){return this._borderAlign}set BorderAlign(t){this._borderAlign=t;}get ModulePixels(){return this._modulePixels}set ModulePixels(t){t>0&&(this._modulePixels=t);}get DashLen(){return this._dashLen||[]}set DashLen(t){this._dashLen=t;}get IsApiMode(){return this._apiMode||!1}set IsApiMode(t){this._apiMode=t;}get PixPerUnit(){return this._pixPerUnit}get B1DTextAlign(){return this._barcodeTextAlign}set B1DTextAlign(t){this._barcodeTextAlign="number"==typeof t?t:a.Unset;}get HorizontalAlign(){return this._horizontalAlign}set HorizontalAlign(t){this._horizontalAlign="number"==typeof t?t:a.Unset;}get VerticalAlign(){return this._verticalAlign}set VerticalAlign(t){this._verticalAlign="number"==typeof t?t:a.Unset;}get ItemOrientation(){return this._rotation||0}set ItemOrientation(t){this._rotation=t;}get LineWidth(){return this._lineWidth>0?this._lineWidth:g.LINE_WIDTH}set LineWidth(t){t>=0&&(this._lineWidth=t);}get Foreground(){return this._foreground||g.COLOR_FG_DEFAULT}set Foreground(t){this._foreground=t;}get Background(){return this._background||g.COLOR_BG_DEFAULT}set Background(t){this._background=t;}get AutoReturn(){return this._autoReturn}set AutoReturn(t){this._autoReturn=t;}get FontName(){return this.fontName}set FontName(t){this.fontName=t;}get FontHeight(){return this.fontHeight}set FontHeight(t){t>=0&&(this.fontHeight=t);}get FontStyle(){return this.fontStyle}set FontStyle(t){t>=0&&(this.fontStyle=t);}get LineSpace(){return this._lineSpace}set LineSpace(t){this._lineSpace=t;}get CharSpace(){return this._charSpace}set CharSpace(t){this._charSpace=t;}constructor(t){this.fontName=g.FONT_NAME,this.fontStyle=0,this.fontHeight=0,this.width=0,this.height=0,this.orientation=0,this.jobName="",this._modulePixels=2,this._lineWidth=0,this._dashLen=[],this._foreground=g.COLOR_FG_DEFAULT,this._rotation=0,this._barcodeTextAlign=a.Unset,this._horizontalAlign=a.Unset,this._verticalAlign=a.Unset,this._autoReturn=h.Char,this._charSpace=0,this._lineSpace=0,this._borderAlign=o.Inner,this._pixPerUnit=1;const e=t||{};this.initOptions=e,this._canvasCreator=e.creator,this._canvasClearAction=e.onCanvasClear,this._apiMode=e.apiMode,e.background&&(this._background=e.background),e.foreground&&(this._foreground=e.foreground),e.canvas&&this.setCanvas(e.canvas);}createCanvas(){return this._canvasCreator?this._canvasCreator():document&&void 0!==document.createElement?document.createElement("canvas"):void 0}getReturnMode(t){return void 0!==t?t:this.AutoReturn}getLineSpace(t,e,i){void 0===t&&"string"==typeof i&&(i.match(/^[0-9]+.?[0-9]*$/)?i=Number(i):(t=i,i=this.LineSpace));const s="string"==typeof t?u.getLineMode(t):t;return void 0===s||s===l.LineSpace_Custom?i||this.LineSpace:u.valueOf(s,e)}setTextBaseline(t){const e=this.ctx;void 0!==this.ctx.textBaseline&&(this.ctx.textBaseline=t),"function"==typeof e.setTextBaseline&&e.setTextBaseline(g.TEXT_BASELINE_DEFAULT);}setTextAlign(t){const e=this.ctx;void 0!==this.ctx.textAlign&&(this.ctx.textAlign=t),"function"==typeof e.setTextAlign&&e.setTextAlign(t);}appendTo(t){return t instanceof Element&&(t.innerHTML="",t.appendChild(this.Canvas),!0)}supports(t){switch(t){case"getImageData":return void 0!==this.ctx.getImageData;case"setLineDash":return void 0!==this.ctx.setLineDash;case"toDataURL":return void 0!==this.Canvas.toDataURL;case"toDataURLWithQuality":try{return this.Canvas.toDataURL("image/jpeg",0),!0}catch(t){return !1}case"measureText":return void 0!==this.ctx.measureText;default:return !1}}clearAll(){this.ctx.clearRect(0,0,this.Canvas.width,this.Canvas.height),this._background&&(this.ctx.fillStyle=g.validateColorStr(this.Background),this.ctx.fillRect(0,0,this.Canvas.width,this.Canvas.height)),"function"==typeof this._canvasClearAction&&this._canvasClearAction(this.Canvas,this.ctx);}getLineWidth(t){return t&&t>0?t:this.LineWidth}getDashLen(t){return t||this.DashLen}setFont(t,e,i){const s=Math.round(t||this.fontHeight),r=e||this.fontStyle,a=i||this.fontName||g.FONT_NAME,o=r&n.ITALIC?"italic":"normal",h=r&n.BOLD?"bold":"normal";this.ctx.font=`${o} normal ${h} ${s}px ${a}`;}processPaddings(t,e){const i=e[0]||0,s=e.length>1?e[1]:i,r=e.length>2?e[2]:i,n=e.length>3?e[3]:s;t.x=t.x||0,t.y=t.y||0,t.x+=n,"number"==typeof t.width&&(t.width-=n+s),t.y+=i,"number"==typeof t.height&&(t.height-=i+r);}processPadding(t){return Array.isArray(t.padding)&&t.padding.length>0?this.processPaddings(t,t.padding):"number"==typeof t.padding?this.processPaddings(t,[t.padding]):t}getHorizontalAlignment(t){return "number"==typeof t?t:this._horizontalAlign}getVerticalAlignment(t){return "number"==typeof t?t:this._verticalAlign}getB1DTextAlignment(t){return "number"==typeof t?t:this.B1DTextAlign}getItemRotation(t){let e="number"==typeof t?t:this.ItemOrientation;return e>=360&&(e%=360),e>0&&e<4&&(e*=90),e}startJob(t){if("number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),t.width<=0&&t.printerWidth>0&&(t.width=t.printerWidth),!(t.width<=0&&t.height<=0))return t.canvas&&this.setCanvas(t.canvas),this.width=Math.round(t.width||t.height||0),this.height=Math.round(t.height||t.width),this.orientation=t.orientation||0,t.jobName&&(this.jobName=t.jobName),this.Canvas.width=this.width,this.Canvas.height=this.height,t.printMode?(this._background=g.COLOR_BG_DEFAULT,this._foreground=g.COLOR_FG_DEFAULT):(t.backgroundColor&&(this._background=t.backgroundColor),t.color&&(this._foreground=t.color)),this.clearAll(),!t.printMode&&t.backgroundImage&&this.drawImage({image:t.backgroundImage,width:t.width,height:t.height}),this.Canvas;d.warn("---- 未指定标签大小！");}commitJob(){return this.Canvas}setRotation(t,e,i){if((t=(t||0)%360)>0){const s=e||{x:0,y:0},r=i||{width:0,height:0};s.x=Math.round(s.x+.5*r.width)+.5,s.y=Math.round(s.y+.5*r.height)+.5,this.ctx.translate(s.x,s.y),this.ctx.rotate(t*Math.PI/180),this.ctx.translate(-s.x,-s.y);}}drawLine(t){let e=t.x1||0,i=t.y1||0,s="number"==typeof t.x2?t.x2:e,r="number"==typeof t.y2?t.y2:i;const n="number"==typeof t.x?t.x:e,a="number"==typeof t.y?t.y:i;if(e===s&&i===r){const o=t.width||0,h=t.height||0;if(o>0||h>0){const c=Math.min(o,h);c>0&&(t.lineWidth=c),o>h?(t.x1=e=n,t.x2=s=n+o,t.y1=i=a+.5*h,t.y2=r=i):(t.x1=e=n+.5*o,t.x2=s=e,t.y1=i=a,t.y2=r=a+h);}else t.x1=e=n,t.x2=s=n+this.width,t.y1=i=a,t.y2=r=a;}else i===r?"number"!=typeof t.y1&&"number"!=typeof t.y2&&"number"==typeof t.y&&(t.y1=i=t.y,t.y2=r=t.y):e===s&&"number"!=typeof t.x1&&"number"!=typeof t.x2&&"number"==typeof t.x&&(t.x1=e=t.x,t.x2=s=t.x);this.ctx.save();const o=this.getItemRotation(t.orientation);this.setRotation(o,{x:.5*(e+s),y:.5*(i+r)});const h=this._drawLine(t);return this.ctx.restore(),h}_drawLine(t){const e=Math.floor(t.x1||0)+.5,i=Math.floor(t.y1||0)+.5,s="number"==typeof t.x2?Math.floor(t.x2)+.5:e,r="number"==typeof t.y2?Math.floor(t.y2)+.5:i;this.ctx.strokeStyle=g.validateColorStr(t.color||this.Foreground),this.ctx.lineWidth=Math.ceil(this.getLineWidth(t.lineWidth)),this.ctx.beginPath();let n=t.dashLens;return (!n||n.length<=0)&&(n=(t.dashLen||"").split(",").map((t=>+t))),this.supportLineDash&&this.ctx.setLineDash(n||[]),this.ctx.moveTo(e,i),this.ctx.lineTo(s,r),this.ctx.stroke(),this.supportLineDash&&this.ctx.setLineDash([]),!0}drawRect(t){const e=t.x||0,i=t.y||0,s=t.width||0,r=t.height||0;if(t.cornerWidth&&t.cornerWidth>0||t.cornerHeight&&t.cornerHeight>0)return this.drawRoundRect(t);if(s>0&&r>0){this.ctx.save();const n=this.getItemRotation(t.orientation);return this.setRotation(n,{x:e,y:i},{width:s,height:r}),this._drawRect(t),this.ctx.restore(),!0}return !1}_drawRect(t){const i=g.validateColorStr(t.color||this.Foreground);let s=t.x||0,r=t.y||0,n=t.width||t.height||0,a=t.height||t.width||0;if(n<=0)return !1;if(i&&g.isTransparent(i))return !0;if(t.fill){const t=this.adjustRect(e.createRect(s,r,n,a),this.BorderAlign);this.ctx.fillStyle=i,this.ctx.fillRect(t.x,t.y,t.width,t.height);}else {let o=this.getLineWidth(t.lineWidth),h=t.dashLens;(!h||h.length<=0)&&(h=(t.dashLen||"").split(",").map((t=>+t))),o=Math.ceil(o),s+=.5*o,r+=.5*o,n-=o,a-=o;const c=this.adjustRect(e.createRect(s,r,n,a),this.BorderAlign);this.ctx.lineWidth=o||this.LineWidth,this.ctx.strokeStyle=i,this.supportLineDash&&h.length>0&&this.ctx.setLineDash(h),this.ctx.strokeRect(c.x,c.y,c.width,c.height),this.supportLineDash&&this.ctx.setLineDash([]);}return !0}adjustRect(t,e){let i=t.x,s=t.y,r=t.x+t.width,n=t.y+t.height;const a=240&e;switch(15&e){case o.Left:i=Math.floor(i),r=Math.floor(r);break;case o.HInner:i=Math.ceil(i),r=Math.floor(r);break;case o.Right:i=Math.ceil(i),r=Math.ceil(r);break;case o.HOuter:i=Math.floor(i),r=Math.ceil(r);break;default:i=Math.round(i),r=Math.round(r);}switch(a){case o.Top:s=Math.floor(s),n=Math.floor(n);break;case o.VInner:s=Math.ceil(s),n=Math.floor(n);break;case o.Bottom:s=Math.ceil(s),n=Math.ceil(n);break;case o.VOuter:s=Math.floor(s),n=Math.ceil(n);break;default:s=Math.round(s),n=Math.round(n);}const h=r-i,c=n-s;return {x:i,y:s,width:h>0?h:1,height:c>0?c:1}}drawRoundRect(t){let e=t.x||0,i=t.y||0,s=t.width||0,r=t.height||0;const n=t.cornerWidth||t.cornerHeight||0;if(s<=0&&r<=0)return !1;if(n<=0)return this.drawRect(t);const a=.5*Math.min(s,r),o=g.validateColorStr(t.color||this.Foreground);let h=this.getLineWidth(t.lineWidth);t.fill||(h>a&&(h=a),e+=.5*h,i+=.5*h,s-=h,r-=h),this.ctx.save();const c=this.getItemRotation(t.orientation);return this.setRotation(c,{x:e,y:i},{width:s,height:r}),this.ctx.translate(e,i),this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.drawRoundRectPath(s,r,n),t.fill?this.ctx.fill():(this.ctx.lineWidth=h,this.ctx.stroke()),this.ctx.restore(),!0}drawRoundRectPath(t,e,i){i=Math.min(i,.5*t,.5*e),this.ctx.beginPath(),this.ctx.arc(t-i,e-i,i,0,Math.PI/2),this.ctx.lineTo(i,e),this.ctx.arc(i,e-i,i,Math.PI/2,Math.PI),this.ctx.lineTo(0,i),this.ctx.arc(i,i,i,Math.PI,3*Math.PI/2),this.ctx.lineTo(t-i,0),this.ctx.arc(t-i,i,i,3*Math.PI/2,2*Math.PI),this.ctx.lineTo(t,e-i),this.ctx.closePath();}drawEllipse(t){let e=t.x||0,i=t.y||0,s=t.width||t.height||0,r=t.height||t.width||0;if(s<=0&&r<=0)return !1;if(s===r)return this.drawCircle(t);const n=g.validateColorStr(t.color||this.Foreground),a=this.getLineWidth(t.lineWidth);e+=.5*a,i+=.5*a,s-=a,r-=a;const o=.5*s,h=.5*r;e+=o,i+=h;const c=this.getItemRotation(t.orientation);if(this.ctx.save(),this.setRotation(c,{x:e,y:i}),this.ctx.lineWidth=a,this.ctx.fillStyle=n,this.ctx.strokeStyle=n,this.ctx.ellipse)this.ctx.beginPath(),this.ctx.ellipse(e,i,o,h,0,0,2*Math.PI);else {const t=.5*o,s=.6*h;this.ctx.translate(e,i),this.ctx.beginPath(),this.ctx.moveTo(0,h),this.ctx.bezierCurveTo(t,h,o,s,o,0),this.ctx.bezierCurveTo(o,-s,t,-h,0,-h),this.ctx.bezierCurveTo(-t,-h,-o,-s,-o,0),this.ctx.bezierCurveTo(-o,s,-t,h,0,h),this.ctx.closePath();}return t.fill?this.ctx.fill():this.ctx.stroke(),this.ctx.restore(),!0}drawCircle(t){let e=t.x||0,i=t.y||0,s=t.radius||0;if(s<=0){const r=t.width||0,n=t.height||0;if(r>0&&n>0)s=.5*Math.min(r,n),e+=.5*r,i+=.5*n;else if(r>0)s=.5*r,e+=s;else {if(!(n>0))return !1;s=.5*n,i+=s;}}const r=g.validateColorStr(t.color||this.Foreground),n=this.getLineWidth(t.lineWidth);return s-=.5*n,this.ctx.lineWidth=n,this.ctx.fillStyle=r,this.ctx.strokeStyle=r,this.ctx.beginPath(),this.ctx.arc(e,i,s,0,2*Math.PI),this.ctx.closePath(),t.fill?this.ctx.fill():this.ctx.stroke(),!0}drawText(t){this.processPadding(t);const e=this.getItemRotation(t.orientation);if(e>0){const i=t.x||0,s=t.y||0;let r=t.width||0,n=t.height||0;if((r<=0||n<=0)&&void 0!==this.ctx.measureText){const e=this.measureTextExt(t);r<=0&&(r=e.width),n<=0&&(n=e.height);}if(r<=0||n<=0)return !1;const a=i+.5*r,o=s+.5*n;this._apiMode&&g.isPortrait(e)&&("boolean"!=typeof t.fixedSize||t.fixedSize)&&(t.width=n,t.height=r,t.x=a-.5*n,t.y=o-.5*r),this.ctx.save(),this.setRotation(e,{x:a,y:o});const h=this._drawText(t);return this.ctx.restore(),h}return this._drawText(t)}_drawText(t){if(null==t.text||null==t.text){if(void 0===t.content)return !1;t.text=t.content;}const e=this.getReturnMode(t.autoReturn),i="boolean"!=typeof t.autoShrink||t.autoShrink,s=t.x||0;let r=t.y||0;const n=t.width||0;let o=t.height||0;(!t.texts||t.texts.length<=0)&&(t.texts=Array.isArray(t.text)?t.text:[String(t.text)]);const c=t.texts||[],l=t.fontHeight||o||this.fontHeight;let d=this.getHorizontalAlignment(t.horizontalAlignment),u=this.getVerticalAlignment(t.verticalAlignment);if(l<=0)return !1;(d>a.Stretch||d<a.Start)&&(d=a.Start),(u>a.Stretch||u<a.Start)&&(u=a.Start),"number"!=typeof t.charSpace&&(t.charSpace=this.CharSpace);const p=t.charSpace>0?t.charSpace:0;this.ctx.fillStyle=g.validateColorStr(t.color||this.Foreground),this.setFont(l,t.fontStyle,t.fontName),this.ctx.textBaseline=g.TEXT_BASELINE_DEFAULT;let m=[];for(let t of c)"string"!=typeof t?m.push(String(t)):(t=t.replace("\t",""),m.push(...t.split("\n")));e!==h.None&&n>0&&(m=this.splitText(Object.assign(Object.assign({},t),{text:m,width:n,fontHeight:l,autoReturn:e})));let f=this.getLineSpace(t.lineSpaceMode,l,t.lineSpace);if(m.length>0){const e=l*m.length,h=e+(m.length-1)*f;o<=0&&(o=h),h<=o||!i||l<7?(u===a.Stretch?f=(o-e)/(m.length-1):u===a.End?r+=o-h:u===a.Center&&(r+=.5*(o-h)),this.drawTextList1({texts:m,x:s,y:r,width:n,fontHeight:l,lineSpace:f,charSpace:p,horizontalAlignment:d,fontStyle:t.fontStyle||this.fontStyle,color:t.color})):this._drawText(Object.assign(t,{text:c,width:n,height:o,fontHeight:.95*l}));}return !0}drawTextList1(t){const e=t.lineSpace>0?t.lineSpace:0;let i=0;for(const s of t.texts)this._drawSingleLineText(s,t.x,t.y+i,t.width,t.fontHeight,t.horizontalAlignment,t.charSpace,t.fontStyle,t.color),i+=t.fontHeight+e;}_drawSingleLineText(t,e,i,s,r,o,h,c,l){t=String(t);const d=.14*r,u=r-d,g=void 0!==this.ctx.measureText?this.ctx.measureText(t):{width:0},p="number"==typeof g.actualBoundingBoxAscent?g.actualBoundingBoxAscent:u,m="number"==typeof g.actualBoundingBoxDescent?g.actualBoundingBoxDescent:d,f=t.length>1&&h>0?(t.length-1)*h:0,P=o||a.Start;let C=(null==g?void 0:g.width)||0,b=.05*r;b<1&&(b=1);const y=i+u,A=p+m;if(g&&P===a.Stretch&&s>g.width)h=(s-g.width)/(t.length-1),1===t.length?this.ctx.fillText(t,e+.5*(s-g.width),y):this.fillCharSpaceText(t,e,y,h),C=s;else {const i=g?g.width+f:0;(s=g?s:0)>i&&(P===a.End?e=e+s-i:P===a.Center&&(e+=.5*(s-i))),s>0&&s<i?(this.fillCharSpaceText(t,e,y,h,s),C=s):(this.fillCharSpaceText(t,e,y,h),C=i);}c&n.STRIKEOUT&&this._drawRect({x:e,y:y-p+.5*(A-b),width:C,height:b,color:l,fill:!0}),c&n.UNDERLINE&&this._drawRect({x:e,y:i+r-.5*b,width:C,height:b,color:l,fill:!0});}fillCharSpaceText(t,e,i,s,r){if(t.length<=0)return;const n=void 0!==this.ctx.measureText?this.ctx.measureText(t):void 0,a=t.length>1?(t.length-1)*s:0;if(n&&s>0){const o=n.width+a,h=r&&r<o?r/o:1;let c=e;for(const e of t){const t=this.ctx.measureText(e).width;this.ctx.fillText(e,c,i,t*h),c+=(t+s)*h;}}else r&&r>0?this.ctx.fillText(t,e,i,r):this.ctx.fillText(t,e,i);}drawArcText(t){let e=t.x||0,i=t.y||0;const s=t.width||0,r=t.height||0,n=t.lineWidth||0,a="number"==typeof t.padding?t.padding:0;let o=t.radius||0;if(o<=0){if(!(s>0||r>0))return !1;{const n=s>0&&r>0?Math.min(s,r):s>0?s:r;t.radius=o=.5*n,s>0&&(t.x=e+=.5*s),r>0&&(t.y=i+=.5*r);}}n>0&&(this.drawCircle(t),o-=n);const h=String(null===t.text||void 0===t.text?t.content||"":t.text),c=t.fontHeight;o-=c,a>0&&a<o&&(o-=a);const l=void 0!==this.ctx.measureText,d=2*Math.PI*o,u=(l?this.measureText({text:h,fontHeight:c}).width:0)/d*Math.PI*2;this.setFont(c),this.ctx.fillStyle=g.validateColorStr(t.color||this.Foreground),this.ctx.save();const p=this.getItemRotation(t.orientation);this.setRotation(p,{x:e,y:i}),this.ctx.translate(e,i),this.ctx.rotate(.5*-Math.PI);const m=this.ctx.textBaseline;return this.ctx.textBaseline="bottom",h.split("").forEach(((t,e)=>{const i=l?this.ctx.measureText(t).width:c,s=i/d*Math.PI*2;0===e?this.ctx.rotate(.5*-u+.5*s):this.ctx.rotate(s),this.ctx.save(),this.ctx.rotate(Math.PI/2),this.ctx.translate(.5*-i,-o),this.ctx.fillText(t,0,0),this.ctx.restore();})),this.ctx.textBaseline=m,this.ctx.restore(),!0}getTextWidths(t){const e=[];if(!t||void 0===this.ctx.measureText)return e;for(const i of t)e.push(this.ctx.measureText(i).width);return e}draw1DBarcode(t){const e=t.datas,i=t.x||0,s=t.y||0;let r=t.width||0,n=t.height||0,c="number"==typeof t.textHeight&&t.textHeight>0?t.textHeight:0,l=this.getHorizontalAlignment(t.horizontalAlignment);const d="number"==typeof t.autoScaleLevel?t.autoScaleLevel:g.AUTO_SCALE_LEVEL,u="number"!=typeof t.textFlag||t.topText?2:t.textFlag;c=u?c:0;let p=t.topText?c:0;const m=t.datas.map((t=>t.data||"")).join(""),f=m.length*this.PixPerUnit;r=r<f?f:r,(l>a.Stretch||l<a.Start)&&(l=a.Center);let P=r,C=0,b=P/m.length;if(d>0&&b/this.PixPerUnit<d&&l<=a.End)switch(b=1*this.PixPerUnit,P=m.length*b,l){case a.Start:break;case a.End:C=r-P;break;default:C=.5*(r-P);}const y=c>0?g.BarTextMargin*b:0;let A=g.MinBarHeight;c>0&&t.topText?A=2*(c+y)+g.MinBarHeight:c&&(A=c+y+g.MinBarHeight),n<=0?(c<=0&&(c=25),n=3*c):n<A&&(n=A);const R=this.getItemRotation(t.orientation);this.ctx.save(),this.setRotation(R,{x:i,y:s},{width:r,height:n});const E=c+y,I=.5*c+y+1,x="number"==typeof t.textAlign?t.textAlign:t.textAlignment,D=b;let v=i+C,_=s+p+y,S=_,w=s;if(t.topText&&e.length>=7){const r=e.slice(1,6).map((t=>t.data)).join("").length*D;p+=y,this._drawText({text:t.topText,x:i+e[0].data.length*D,y:s,width:r,height:c,fontHeight:c,fontStyle:t.fontStyle,fontName:t.fontName,color:t.color,autoReturn:h.None,horizontalAlignment:"number"==typeof x?x:a.Center,charSpace:t.charSpace});}for(const i of e){if(n>E){const e=i.text?E:E-I,r=n-e-p;1===u?(S=s,_=S+e):(_=s+p,S=_+r,w=S+y),this.BorderAlign=o.None;for(let a=0;a<i.data.length;a++,v+=D)"1"===i.data[a]?(t.bgColor&&this._drawRect({x:v,y:S,width:D,height:e,color:t.bgColor,fill:!0}),this._drawRect({x:v,y:_,width:D,height:r,color:t.color,fill:!0})):t.bgColor&&this._drawRect({x:v,y:s,width:D,height:n,color:t.bgColor,fill:!0});}if(i.text){const s=e.length>2&&i.text.length>1?g.DockCharMargin*D:0,r=i.data.length*D;this._drawText({text:i.text,x:v-r+s,y:w,width:r-2*s,height:c,fontHeight:c,fontStyle:t.fontStyle,fontName:t.fontName,color:t.color,autoReturn:h.None,horizontalAlignment:"number"==typeof x?x:a.Center,charSpace:t.charSpace});}}return this.ctx.restore(),!0}drawQrcode(t){const i=t.data;let s=t.x||0,r=t.y||0,n=t.width||0,h=t.height||n;const c=t.zoneSize||0,l="number"==typeof t.autoScaleLevel?t.autoScaleLevel:g.AUTO_SCALE_LEVEL,d=t.data.cols||0,u=d+2*c,p=u*this.PixPerUnit;n<=0?n=d*this.ModulePixels:n<p&&(n=p),h<=0?h=n:h<p&&(h=p);const m=this.getItemRotation(t.orientation);this.ctx.save(),this.setRotation(m,{x:s,y:r},{width:n,height:h});let f=Math.min(n,h),P=Math.floor(f/u*.4);P=P<1?1:P,c<=0&&(s+=P,r+=P,n-=2*P,h-=2*P),f=Math.min(n,h);let C=f/(u*this.PixPerUnit),b=f/u;l>0&&C<l&&(C=C<1?1:Math.floor(C),b=C*this.PixPerUnit,f=b*u);let y=this.getHorizontalAlignment(t.horizontalAlignment),A=this.getVerticalAlignment(t.verticalAlignment);(y>a.Stretch||y<a.Start)&&(y=a.Center),(A>a.Stretch||A<a.Start)&&(A=a.Center);let R=0,E=0;switch(y){case a.Start:break;case a.End:R=Math.round(n-f);break;default:R=Math.round(.5*(n-f));}switch(A){case a.Start:break;case a.End:E=Math.round(h-f);break;default:E=Math.round(.5*(h-f));}let I=c*b;const x=b,D=e.createRect(Math.floor(s+R),Math.floor(r+E),Math.ceil(f),Math.ceil(f));I<=0&&(I=P,D.x+=P,D.y+=P,D.width-=2*P,D.height-=2*P),this.BorderAlign=o.None,t.bgColor&&this._drawRect({x:D.x,y:D.y,width:D.width,height:D.height,color:t.bgColor,fill:!0});const v=Math.floor(I);D.x-=v,D.y-=v,D.width+=2*v,D.height+=2*v;for(let e=0,s=D.y;e<d;e++,s+=x)for(let r=0,n=D.x;r<d;r++,n+=x)i.data[e*d+r]?this._drawRect({x:n,y:s,width:x,height:x,color:t.color,fill:!0}):t.bgColor&&this._drawRect({x:n,y:s,width:x,height:x,color:t.bgColor,fill:!0});this.ctx.restore();}draw2DBarcode(t){const e=t.data,i=t.x||0,s=t.y||0;let r=t.width||0,n=t.height||r;const h=t.zoneSize||0,c=t.barPixels||this.ModulePixels,l="number"==typeof t.autoScaleLevel?t.autoScaleLevel:g.AUTO_SCALE_LEVEL,d=e.rows||0,u=e.cols||0;if(d<=0||u<=0)return !1;const p=d+2*h,m=u+2*h,f=m*this.PixPerUnit,P=p*this.PixPerUnit;let C=this.getHorizontalAlignment(t.horizontalAlignment),b=this.getVerticalAlignment(t.verticalAlignment),y=0,A=0;(C>a.Stretch||C<a.Start)&&(C=a.Center),(b>a.Stretch||b<a.Start)&&(b=a.Center),r<=0?(y=c*this.PixPerUnit,r=y*m):r<=f?(y=this.PixPerUnit,r=f):y=r/m,n<=0?(A=c*this.PixPerUnit,n=A*p):n<=P?(A=this.PixPerUnit,n=P):A=n/p;const R=this.getItemRotation(t.orientation);this.ctx.save(),this.setRotation(R,{x:i,y:s},{width:r,height:n}),C<a.Stretch&&(y=Math.min(y,A),y<l*this.PixPerUnit&&(y=Math.floor(y/this.PixPerUnit)*this.PixPerUnit)),b<a.Stretch&&(A=Math.min(y,A),A<l*this.PixPerUnit&&(A=Math.floor(A/this.PixPerUnit)*this.PixPerUnit));const E=m*y,I=p*A;let x=0,D=0;switch(C){case a.Start:break;case a.End:x=Math.round(r-E);break;default:x=Math.round(.5*(r-E));}switch(b){case a.Start:break;case a.End:D=Math.round(n-I);break;default:D=Math.round(.5*(n-I));}const v=Math.floor(i+x),_=Math.floor(s+D);this.BorderAlign=o.None,t.bgColor&&h>0&&(this._drawRect({x:v,y:_,width:Math.round(E),height:Math.round(A*h),color:t.bgColor,fill:!0}),this._drawRect({x:v,y:Math.round(_+(d+h)*A),width:Math.round(E),height:Math.round(h*A),color:t.bgColor,fill:!0}),this._drawRect({x:v,y:_,width:Math.round(y*h),height:Math.round(I),color:t.bgColor,fill:!0}),this._drawRect({x:Math.round(v+(u+h)*y),y:_,width:Math.round(h*y),height:Math.round(I),color:t.bgColor,fill:!0}));for(let i=0,s=_+A*h;i<d;i++,s+=A)for(let r=0,n=v+y*h;r<u;r++,n+=y)e.data[i*(e.cols||0)+r]?this._drawRect({x:n,y:s,width:y,height:A,color:t.color,fill:!0}):t.bgColor&&this._drawRect({x:n,y:s,width:y,height:A,color:t.bgColor,fill:!0});return this.ctx.restore(),!0}drawImage(t){const e=t.image||t.img,i=e?e.dzSrc||e:void 0;if(!i)return !1;const s=Math.ceil(t.x||0),r=Math.ceil(t.y||0),n=Math.floor(t.width||0)||i.width,a=Math.floor(t.height||0)||i.height;this.ctx.save();const o=this.getItemRotation(t.orientation);return this.setRotation(o,{x:s,y:r},{width:n,height:a}),t.swidth&&t.sheight?this.ctx.drawImage(i,t.sx||0,t.sy||0,t.swidth,t.sheight,s,r,n,a):t.width||t.height?this.ctx.drawImage(i,s||0,r||0,n,a):this.ctx.drawImage(i,s,r),this.ctx.restore(),!0}drawImageResizeLabel(t,e){if(!t.img||this.width<=0||this.height<=0)return;const i=t.img,s=i.width||t.imageWidth||0,r=i.height||t.imageHeight||0;let n=0,a=0,o=0;if(s<=0||r<=0)return void d.warn("---- drawImageResizeLabel: 无法获取 img 对象的像素大小，所以无法对目标图片进行分割绘制！");s/r<this.width/this.height?(o=this.height,a=s*this.height/s,n=this.height/r):(a=this.width,o=this.width*r/s,n=this.width/s);let h=n;t.fullOfLabel?h=n:t.relativeScale&&t.relativeScale>0?h=t.relativeScale*n:e&&(h=e);const c=Math.floor(t.left),l=Math.floor(t.top),u=Math.ceil(t.right),g=Math.ceil(t.bottom),p=u-c,m=g-l,f=s-u,P=r-g,C=a/(c+f+1),b=o/(l+P+1),y=Math.min(C,b);h>y&&(h=t.relativeScale&&t.relativeScale>0?y:n);const A=Math.floor(c*h),R=Math.floor(l*h),E=Math.floor(f*h),I=Math.floor(P*h),x=this.width-E,D=this.height-I;if(this.ctx.drawImage(i,0,0,c,l,0,0,A,R),this.ctx.drawImage(i,u,0,f,l,x,0,E,R),this.ctx.drawImage(i,u,g,f,P,x,D,E,I),this.ctx.drawImage(i,0,g,c,P,0,D,A,I),t.tileMode){const t=a-A-E,e=o-R-I;let s=t,r=e,n=p,h=m;if(t>0)for(let e=A;e<x;e+=t)x-e<t?(s=x-e,n=p*s/t):(s=t,n=p),this.ctx.drawImage(i,c,0,n,l,e,0,s,R),this.ctx.drawImage(i,c,g,n,P,e,D,s,I);if(e>0)for(let t=R;t<D;t+=e)D-t<e?(r=D-t,h=m*r/e):(r=e,h=m),this.ctx.drawImage(i,0,l,c,h,0,t,A,r),this.ctx.drawImage(i,u,l,f,h,x,t,E,r);}else {const t=x-A,e=D-R;this.ctx.drawImage(i,c,0,p,l,A,0,t,R),this.ctx.drawImage(i,u,l,f,m,x,R,E,e),this.ctx.drawImage(i,c,g,p,P,A,D,t,I),this.ctx.drawImage(i,0,l,c,m,0,R,A,e);}}measureText(t){return (t.fontHeight||t.fontStyle||t.fontName)&&this.setFont(t.fontHeight,t.fontStyle,t.fontName),void 0!==this.ctx.measureText?this.ctx.measureText(t.text||""):{width:0}}measureTextExt(t){const e=t.fontHeight||this.fontHeight;let i=t.width||0;const s=this.splitText(Object.assign(t,{text:t.text||""})),r=t.lineSpace||0,n=t.charSpace||0,a=s.length>1?(s.length-1)*r:0;if(i<=0&&void 0!==this.ctx.measureText)for(let t=0;t<s.length;t++)if(s[t].length>0){const e=this.ctx.measureText(s[t]).width+(s[t].length-1)*n;e>i&&(i=e);}return {width:i,height:e*s.length+a}}measureFontSize(t){const e=t.text||"",i=t.width||0,s=t.minFontSize||16;if(i<=0||e.length<=0||void 0===this.ctx.measureText)return t.fontHeight||0;let r,n=t.fontHeight||this.fontHeight;do{if(r=this.measureText({text:e,fontHeight:n,fontStyle:t.fontStyle,fontName:t.fontName}),r.width<=i)return n;n*=.95;}while(n<=s);return s}findSplitPosition(t,e,i,s){if(t.length<=1)return t.length;const r=s||0;let n=1,a=this.ctx.measureText(t.substring(0,n)).width;if(a>=e)return n;let o=0,h=0;if(r>0)for(;h<e&&o<t.length;)o+r>t.length?o=t.length:(h>a&&(n=o,a=h),o+=r),h=this.ctx.measureText(t.substring(0,o)).width+(o-1)*i;else o=t.length,h=this.ctx.measureText(t).width+(o-1)*i;if(h<=e)return o;for(;n<o&&o!==n+1;){const s=n+Math.floor((o-n)/2),r=this.ctx.measureText(t.substring(0,s)).width+(s-1)*i;if(r>e)o=s,h=r;else if(n=s,a=r,r>=e)break}return n}findWordSplitPos(t,e){let i=0;if(e>=t.length||/\W/.exec(t.charAt(e)))return e;for(i=e-1;i>=0&&!/\W/.exec(t.charAt(i));i--);return i+1}splitText(t){if(g.isNull(t.text))return [];"number"!=typeof t.charSpace&&(t.charSpace=this.CharSpace);const e=t.charSpace>0?t.charSpace:0,i=Array.isArray(t.text)?t.text:[String(t.text)],s=[],r=void 0!==this.ctx.measureText;for(const t of i)s.push(...t.split("\n"));let n=0,a=0;const o=[];this.setFont(t.fontHeight,t.fontStyle,t.fontName);for(const i of s)if(t.autoReturn&&t.width&&t.width>0&&r){let s=i;for(;s.length>0;)n=this.findSplitPosition(s,t.width,e,t.measureOptimizeStep),t.autoReturn===h.Word&&(a=this.findWordSplitPos(s,n),a>0&&a<n&&(n=a)),o.push(s.substring(0,n)),s=n<s.length?s.substring(n):"";}else o.push(i);return o}inverseColors(){const t=this.ctx,e=this.getImageData();if(e){const i=e.data;for(let t=0;t<i.length;t+=4)i[t]=255-i[t],i[t+1]=255-i[t+1],i[t+2]=255-i[t+2];return t.putImageData(e,0,0),!0}return !1}horizontalFlip(){const t=this.ctx,e=this.getImageData(),i=t.createImageData(this.Canvas.width,this.Canvas.height);if(e&&i){const s=e.width,r=e.height;for(let t=0;t<r;t++)for(let r=0;r<s;r++)i.data[t*s*4+4*r+0]=e.data[t*s*4+4*(s-r)+0],i.data[t*s*4+4*r+1]=e.data[t*s*4+4*(s-r)+1],i.data[t*s*4+4*r+2]=e.data[t*s*4+4*(s-r)+2],i.data[t*s*4+4*r+3]=e.data[t*s*4+4*(s-r)+3];return t.putImageData(i,0,0),!0}return !1}getImageData(){return "function"==typeof this.ctx.getImageData?this.ctx.getImageData(0,0,this.Canvas.width,this.Canvas.height):void d.info("---- 当前绘制环境不支持函数：getImageData")}processCanvasPixels(t){if(this.ctx){const e=this.ctx.createImageData(this.Canvas.width,this.Canvas.height),i=e.data,s=this.ctx.getImageData(0,0,this.Canvas.width,this.Canvas.height).data;let r=0;for(let e=0;e<s.length;e+=4)r=t(s[e],s[e+1],s[e+2],s[0]),i[e]=i[e+1]=i[e+2]=r,i[e+3]=s[e+3];this.ctx.putImageData(e,0,0);}}toGray256(){this.processCanvasPixels(((t,e,i,s)=>Math.round(.3*t+.59*e+.11*i)));}toBlackWhite(t){const e=t||128;this.processCanvasPixels(((t,i,s,r)=>Math.round(.3*t+.59*i+.11*s)<=e?0:255));}}g.NO_START_STOP=4,g.MinBarHeight=2,g.BarTextMargin=1,g.DockHorizMargin=7,g.DockCharMargin=1,g.BarIsbnMargin=0,g.AUTO_SCALE_LEVEL=2,g.COLOR_FG_DEFAULT="#000",g.COLOR_BG_DEFAULT="#fff",g.LINE_WIDTH=28,g.FONT_NAME="黑体",g.TEXT_BASELINE_DEFAULT="alphabetic";class p{constructor(t){this._dpi=203,this._dpm=203/25.4,this._offsetX=0,this._offsetY=0,this.cvs=new g(t);}get Base(){return this.cvs}get ScaleUnit(){return this._scaleUnit||c.Auto}get Dpi(){return this._dpi}set Dpi(t){t&&t>0&&(this._dpi=t,this._dpm=t/25.4);}get DPM(){return this._dpm}set DPM(t){t>0&&(this._dpm=t,this._dpi=25.4*t);}get OffsetX(){return this._offsetX}set OffsetX(t){this._offsetX=t;}get OffsetY(){return this._offsetY}set OffsetY(t){this._offsetY=t;}get Width(){return this.cvs.Width/this.DPM}get Height(){return this.cvs.Height/this.DPM}get CanvasWidth(){return this.cvs.Canvas.width}get CanvasHeight(){return this.cvs.Canvas.height}get Foreground(){return this.cvs.Foreground}set Foreground(t){this.cvs.Foreground=t;}setFontName(t){this.cvs.FontName=t;}getFontHeight(){return this.invertCvt(this.cvs.FontHeight)}setFontHeight(t){this.cvs.FontHeight=this.cvt(t);}setLineSpace(t){this.cvs.LineSpace=this.cvt(t);}setCharSpace(t){this.cvs.CharSpace=this.cvt(t);}getLineWidth(){return this.invertCvt(this.cvs.LineWidth)}setLineWidth(t){this.cvs.LineWidth=this.cvt(t);}setRotation(t,e,i){return e&&(e.x=this.cvt(e.x),e.y=this.cvt(e.y)),i&&(i.width=this.cvt(i.width),i.height=this.cvt(i.height)),this.cvs.setRotation(t,e,i)}supports(t){return this.cvs.supports(t)}startJob(t){return this._scaleUnit=t.scaleUnit,t.dpi&&(this.Dpi=t.dpi),this.cvs.startJob(this.cvtDrawOptions(t))?this.cvs:void 0}commitJob(){return this.cvs.commitJob()?this.cvs:void 0}drawLine(t){return this.cvs.drawLine(this.cvtDrawOptions(t))}drawRect(t){return this.cvs.drawRect(this.cvtDrawOptions(t))}drawRoundRect(t){return this.cvs.drawRoundRect(this.cvtDrawOptions(t))}drawEllipse(t){return this.cvs.drawEllipse(this.cvtDrawOptions(t))}drawCircle(t){return this.cvs.drawCircle(this.cvtDrawOptions(t))}drawText(t){return this.cvs.drawText(this.cvtDrawOptions(t))}drawArcText(t){return this.cvs.drawArcText(this.cvtDrawOptions(t))}draw1DBarcode(t){return (t=this.cvtDrawOptions(t)).textHeight=this.cvt(t.textHeight),this.cvs.draw1DBarcode(t)}drawQrcode(t){return this.cvs.drawQrcode(this.cvtDrawOptions(t))}draw2DBarcode(t){return this.cvs.draw2DBarcode(this.cvtDrawOptions(t))}drawImage(t){return this.cvs.drawImage(this.cvtDrawOptions(t))}drawImageResizeLabel(t){return this.cvs.drawImageResizeLabel(t,this.DPM/20)}splitText(t){return this.cvs.splitText(this.cvtDrawOptions(t))}measureText(t){return t.fontHeight=this.cvt(t.fontHeight),this.cvs.measureText(t)}measureFontSize(t){(t=this.cvtDrawOptions(t)).minFontSize=this.cvt(t.minFontSize);const e=this.cvs.measureFontSize(t);return this.invertCvt(e)}cvt(t){return "number"==typeof t?t*this._dpm:t}invertCvt(t){return "number"==typeof t?t/this._dpm:t}cvtArray(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]=this.cvt(t[e]);return t}cvtDrawOptions(t){if(this.ScaleUnit===c.Pix)return t;(t=Object.assign({},t)).x&&(t.x=this.cvt(t.x+this.OffsetX)),t.y&&(t.y=this.cvt(t.y+this.OffsetY)),t.width&&(t.width=this.cvt(t.width)),t.height&&(t.height=this.cvt(t.height)),"number"==typeof t.margin?t.margin=this.cvt(t.margin):this.cvtArray(t.margin),"number"==typeof t.padding?t.padding=this.cvt(t.padding):this.cvtArray(t.padding);const e=t;e.lineWidth&&(e.lineWidth=this.cvt(e.lineWidth)),e.radius&&(e.radius=this.cvt(e.radius));const i=t;i.cornerWidth&&(i.cornerWidth=this.cvt(i.cornerWidth)),i.cornerHeight&&(i.cornerHeight=this.cvt(i.cornerHeight));const s=t;s.x1&&(s.x1=this.cvt(s.x1+this.OffsetX)),s.y1&&(s.y1=this.cvt(s.y1+this.OffsetY)),s.x2&&(s.x2=this.cvt(s.x2+this.OffsetX)),s.y2&&(s.y2=this.cvt(s.y2+this.OffsetY)),s.dashLens&&(s.dashLens=s.dashLens.map((t=>this.cvt(t)))),s.dashLen&&(s.dashLen=s.dashLen.split(",").map((t=>this.cvt(+t))).join(","));const r=t;return r.fontHeight&&(r.fontHeight=this.cvt(r.fontHeight)),r.lineSpace&&"number"==typeof r.lineSpace&&(r.lineSpace=this.cvt(r.lineSpace)),r.charSpace&&(r.charSpace=this.cvt(r.charSpace)),t}inverseColors(){return this.cvs.inverseColors()}horizontalFlip(){return this.cvs.horizontalFlip()}getImageData(){return this.cvs.getImageData()}}function m(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{h(s.next(t));}catch(t){n(t);}}function o(t){try{h(s.throw(t));}catch(t){n(t);}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e);}))).then(a,o);}h((s=s.apply(t,e||[])).next());}))}p.BORDER_DPM_DEFAULT=8,"function"==typeof SuppressedError&&SuppressedError;class f{constructor(t,e){this.cols=t||0,this.rows=e||0,this.data=new Uint8Array(this.rows*this.cols);}get reservedBit(){return this._reservedBit||(this._reservedBit=new Uint8Array(this.data.length)),this._reservedBit}set(t,e,i,s){const r=t*this.cols+e;this.data[r]="number"==typeof i?i:i?1:0,s&&(this.reservedBit[r]=1);}get(t,e){return this.data[t*this.cols+e]}getRowData(t){const e=(t||0)*this.cols;return this.data.slice(e,e+this.cols)}getColData(t){return this.data.filter(((e,i)=>i%this.cols===t))}xor(t,e,i){this.data[t*this.cols+e]^=i?1:0;}fill(t,e,i,s){const r=(e||0)*this.cols+(i||0);let n=0;n="number"==typeof s?s>0?r+s:this.data.length+s:this.data.length,this.data.fill(t,r,n);}setArray(t,e,i){const s=(e||0)*this.cols+(i||0);this.data.set(t,s);}addRow(t,e,i){e>=this.data.length?console.error(`offset: ${e} 越界`):(i&&i<t.length&&(t=t.slice(0,i)),this.data.set(t,e));}isReserved(t,e){return this._reservedBit?this._reservedBit[t*this.cols+e]:0}}const P=Object.freeze({nullCharacter:0,maxAsciiCharacter:127,lineFeed:10,LF:10,carriageReturn:13,CR:13,lineSeparator:8232,paragraphSeparator:8233,nextLine:133,space:32,nonBreakingSpace:160,enQuad:8192,emQuad:8193,enSpace:8194,emSpace:8195,threePerEmSpace:8196,fourPerEmSpace:8197,sixPerEmSpace:8198,figureSpace:8199,punctuationSpace:8200,thinSpace:8201,hairSpace:8202,zeroWidthSpace:8203,narrowNoBreakSpace:8239,ideographicSpace:12288,mathematicalSpace:8287,ogham:5760,_:95,$:36,num_0:48,num_9:57,a:97,z:122,A:65,Z:90,ampersand:38,asterisk:42,at:64,backslash:92,backtick:96,bar:124,caret:94,closeBrace:125,closeBracket:93,closeParen:41,colon:58,comma:44,dot:46,doubleQuote:34,equals:61,exclamation:33,greaterThan:62,hash:35,lessThan:60,minus:45,openBrace:123,openBracket:91,openParen:40,percent:37,plus:43,question:63,semicolon:59,singleQuote:39,slash:47,tilde:126,backspace:8,formFeed:12,byteOrderMark:65279,tab:9,verticalTab:11});class C{static isDigit(t){return "number"==typeof t?t>=P.num_0&&t<=P.num_9:t>="0"&&t<="9"}static isDigits(t,e,i){const s=e||0,r=i?s+i:t.length;return !(r>t.length)&&t.substring(s,r).match(/^[0-9]+$/)}static isUpper(t){return "number"==typeof t?t>=P.A&&t<=P.Z:t>="A"&&t<="Z"}static isLower(t){return "number"==typeof t?t>=P.a&&t<=P.z:t>="a"&&t<="z"}static ctoi(t){const e="string"==typeof t?t.charCodeAt(0):t;return e>=P.num_0&&e<=P.num_9?e-P.num_0:e>=P.A&&e<=P.Z?e-P.A+10:e>=P.a&&e<=P.z?e-P.a+10:-1}static itoc(t){return t>=0&&t<=9?`${t}`:String.fromCharCode(t-10+P.A)}static repeatChar(t,e){const i=[];for(let s=0;s<e;s++)i.push(t);return i.join("")}static preFillChar(t,e,i){return t.length<e?Array(e-t.length+1).join(i)+t:t}}class b{static isISO_8859_1(t){if(!t)return !1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)>255)return !1;return !0}static getCharCodes(t){t=t||"";const e=[];for(let i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e}static getCharCodeArrayString(t){return t.map((t=>String.fromCharCode(t))).join("")}static encodeUtf8(t){const e=[];for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);if(s>=55296&&s<=56319&&t.length>i+1){const e=t.charCodeAt(i+1);e>=56320&&e<=57343&&(s=1024*(s-55296)+e-56320+65536,i+=1);}s<128?e.push(s):s<2048?(e.push(s>>6|192),e.push(63&s|128)):s<55296||s>=57344&&s<65536?(e.push(224|s>>12),e.push(128|s>>6&63),e.push(128|63&s)):s>=65536&&s<=1114111?(e.push(240|s>>18),e.push(128|s>>12&63),e.push(128|s>>6&63),e.push(128|63&s)):e.push(239,191,189);}return new Uint8Array(e)}static getBytes_Utf8(t){try{return (new TextEncoder).encode(t)}catch(e){return console.log("DzTextEncoder.encode: TextEncoder is not defined"),this.encodeUtf8(t)}}static getBytes_ISO8859_1(t){return t=unescape(encodeURIComponent(t)),Uint8Array.from(this.getCharCodes(t))}static getBytes_Unicode(t){return Uint8Array.from(this.getCharCodes(t))}static getBytes(t,e){return t=t||"",e?b.getBytes_Utf8(t):b.getBytes_Unicode(t)}static hasBase256Chars(t){const e="string"==typeof t?t.split("").map((t=>t.charCodeAt(0))):t;if((null==e?void 0:e.length)>0)for(const t of e)if(t>=128)return !0;return !1}static encodeUnicodeFromUtf8(t){let e=0,i=0,s=0;const r=[];do{if(t[i]<=127)r[s]=t[i],e=i+1,s++;else {if(t[i]>=128&&t[i]<=191)return;if(t[i]>=192&&t[i]<=193)return;if(t[i]>=194&&t[i]<=223)r[s]=((31&t[i])<<6)+(63&t[i+1]),e=i+2,s++;else if(t[i]>=224&&t[i]<=239)r[s]=((15&t[i])<<12)+((63&t[i+1])<<6)+(63&t[i+2]),e=i+3,s++;else if(t[i]>=240)return}i=e;}while(i<t.length);return r}}var y;!function(t){t[t.UPC_A=20]="UPC_A",t[t.UPC_E=21]="UPC_E",t[t.EAN13=22]="EAN13",t[t.EAN8=23]="EAN8",t[t.CODE39=24]="CODE39",t[t.ITF25=25]="ITF25",t[t.CODABAR=26]="CODABAR",t[t.CODE93=27]="CODE93",t[t.CODE128=28]="CODE128",t[t.ISBN=29]="ISBN",t[t.ECODE39=30]="ECODE39",t[t.ITF14=31]="ITF14",t[t.ChinaPost=32]="ChinaPost",t[t.Matrix25=33]="Matrix25",t[t.Industrial25=34]="Industrial25",t[t.GS1_128=35]="GS1_128",t[t.EAN128=35]="EAN128",t[t.AUTO=60]="AUTO";}(y||(y={}));class A{constructor(t,e){this.data=t||"",this.text=e.text||t||"",this.options=e;}encode(t,e){return {}}}const R=103,E=104,I=105,x={[R]:0,[E]:1,[I]:2},D={101:0,100:1,99:2},v=String.fromCharCode(208),_=String.fromCharCode(209),S=String.fromCharCode(210),w="[\0-_È-Ï]",T="[ -È-Ï]",O=[11011001100,11001101100,11001100110,10010011e3,10010001100,10001001100,10011001e3,10011000100,10001100100,11001001e3,11001000100,11000100100,10110011100,10011011100,10011001110,10111001100,10011101100,10011100110,11001110010,11001011100,11001001110,11011100100,11001110100,11101101110,11101001100,11100101100,11100100110,11101100100,11100110100,11100110010,11011011e3,11011000110,11000110110,10100011e3,10001011e3,10001000110,10110001e3,10001101e3,10001100010,11010001e3,11000101e3,11000100010,10110111e3,10110001110,10001101110,10111011e3,10111000110,10001110110,11101110110,11010001110,11000101110,11011101e3,11011100010,11011101110,11101011e3,11101000110,11100010110,11101101e3,11101100010,11100011010,11101111010,11001000010,11110001010,1010011e4,10100001100,1001011e4,10010000110,10000101100,10000100110,1011001e4,10110000100,1001101e4,10011000010,10000110100,10000110010,11000010010,1100101e4,11110111010,11000010100,10001111010,10100111100,10010111100,10010011110,10111100100,10011110100,10011110010,11110100100,11110010100,11110010010,11011011110,11011110110,11110110110,10101111e3,10100011110,10001011110,10111101e3,10111100010,11110101e3,11110100010,10111011110,10111101110,11101011110,11110101110,11010000100,1101001e4,11010011100,1100011101011];class M extends A{constructor(t,e){super(t.substring(1),e),this.bytes=t.split("").map((t=>t.charCodeAt(0)));}valid(){return /^[\x00-\x7F\xC8-\xD3]+$/.test(this.data)}encode(){const t=this.bytes,e=(t.shift()||0)-105,i=x[e];if(void 0===i)throw new RangeError("The encoding does not start with a start character.");this.shouldEncodeAsEan128()&&t.unshift(207);const s=M.next(t,1,i);return {items:[{text:this.text===this.data?this.text.replace(/[^\x20-\x7E]/g,""):this.text,data:M.getBar(e)+s.result+M.getBar((s.checksum+e)%103)+M.getBar(106)}],text:this.text,options:this.options}}shouldEncodeAsEan128(){return this.options.ean128}static getBar(t){return O[t]?O[t].toString():""}static correctIndex(t,e){if(0===e){const e=t.shift()||0;return e<32?e+64:e-32}return 1===e?(t.shift()||0)-32:10*((t.shift()||0)-48)+(t.shift()||0)-48}static next(t,e,i){if(!t.length)return {result:"",checksum:0};let s,r;if(t[0]>=200){r=(t.shift()||0)-105;const n=D[r]||0;void 0!==n?s=M.next(t,e+1,n):(0!==i&&1!==i||98!==r||(t[0]=0===i?t[0]>95?t[0]-96:t[0]:t[0]<32?t[0]+96:t[0]),s=M.next(t,e+1,i));}else r=M.correctIndex(t,i),s=M.next(t,e+1,i);const n=r*e;return {result:M.getBar(r)+s.result,checksum:n+s.checksum}}}const B=t=>{const e=t.match(new RegExp(`^${w}*`));return e?e[0].length:0},L=t=>{const e=t.match(new RegExp(`^${T}*`));return e?e[0].length:0},N=t=>{const e=t.match(new RegExp("^(Ï*[0-9]{2}Ï*)*"));return e?e[0]:""};function F(t,e){const i=e?w:T,s=t.match(new RegExp(`^(${i}+?)(([0-9]{2}){2,})([^0-9]|$)`));if(s)return s[1]+String.fromCharCode(204)+j(t.substring(s[1].length));const r=t.match(new RegExp(`^${i}+`)),n=r?r[0]:"";return n.length===t.length?t:n+String.fromCharCode(e?205:206)+F(t.substring(n.length),!e)}function j(t){const e=N(t),i=e.length;if(i===t.length)return t;t=t.substring(i);const s=B(t)>=L(t);return e+String.fromCharCode(s?206:205)+F(t,s)}class U extends M{constructor(t,e){if(/^[\x00-\x7F\xC8-\xD3]+$/.test(t)){let i;if(N(t).length>=2)i=S+j(t);else {const e=B(t)>L(t);i=(e?v:_)+F(t,e);}super(i.replace(/[\xCD\xCE]([^])[\xCD\xCE]/,((t,e)=>String.fromCharCode(203)+e)),e);}else super(t,e);}}const W={L:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],G:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],R:["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],O:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],E:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"]},k=(t,e,i)=>{let s=t.split("").map(((t,i)=>W[e[i]])).map(((e,i)=>e?e[t[i]]:""));if(i){const e=t.length-1;s=s.map(((t,s)=>s<e?t+i:t));}return s.join("")};let $=class t extends A{constructor(t,e){super(t,e),this.quietZones=0,this.guardWhitespace=!1,this.quietZones=e.quietZones||0,this.guardWhitespace=e.guardWhitespace||!1;}encode(){const t=this.options.flat?this.encodeFlat():this.encodeGuarded();return {options:this.options,items:t,text:this.text}}leftText(t,e){return this.text.substr(t,e)}leftEncode(t,e){return k(t||"",e||"")}rightText(t,e){return this.text.substr(t,e)}rightEncode(t,e){return k(t||"",e||"")}encodeGuarded(){const e=[{data:t.SIDE_BIN,text:""},{data:this.leftEncode(),text:this.leftText(0)},{data:t.MIDDLE_BIN,text:""},{data:this.rightEncode(),text:this.rightText()},{data:t.SIDE_BIN,text:""}];if(this.quietZones>0){const t=Array(this.quietZones).fill("0").join("");e.unshift({data:t,text:this.guardWhitespace?"< ":""}),e.push({data:t,text:this.guardWhitespace?" >":""});}return e}encodeFlat(){return [{data:[t.SIDE_BIN,this.leftEncode(),t.MIDDLE_BIN,this.rightEncode(),t.SIDE_BIN].join(""),text:this.text}]}};$.SIDE_BIN="101",$.MIDDLE_BIN="01010";class H extends A{constructor(t,e){super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{2}$/)}encode(){const t=H.EAN2_STRUCTURE[parseInt(this.data)%4],e={data:"1011"+k(this.data,t,"01"),text:this.text};return {options:this.options,items:[e],text:this.text}}}H.EAN2_STRUCTURE=["LL","LG","GL","GG"];class J extends A{static checksum(t){return t.split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+9*e:t+3*e),0)%10}constructor(t,e){super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{5}$/)}encode(){const t=J.EAN5_STRUCTURE[J.checksum(this.data)];return {items:[{data:"1011"+k(this.data,t,"01"),text:this.text}],text:this.text,options:this.options}}}J.EAN5_STRUCTURE=["GGLLL","GLGLL","GLLGL","GLLLG","LGGLL","LLGGL","LLLGG","LGLGL","LGLLG","LLGLG"];class G extends ${static checksum(t){return (10-t.substring(0,7).split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+e:t+3*e),0)%10)%10}constructor(t,e){-1!==t.search(/^[0-9]{7}$/)&&(t+=G.checksum(t)),super(t,e);}valid(){return -1!==this.data.search(/^[0-9]{8}$/)&&+this.data[7]===G.checksum(this.data)}leftText(){return super.leftText(0,4)}leftEncode(){const t=this.data.substring(0,4);return super.leftEncode(t,"LLLL")}rightText(){return super.rightText(4,4)}rightEncode(){const t=this.data.substring(4,8);return super.rightEncode(t,"RRRR")}}let K=class t extends ${static checksum(t){return (10-t.substring(0,12).split("").map((t=>+t)).reduce(((t,e,i)=>i%2?t+3*e:t+e),0)%10)%10}constructor(e,i){-1!==e.search(/^[0-9]{12}$/)&&(e+=t.checksum(e)),super(e,i);}valid(){return -1!==this.data.search(/^[0-9]{13}$/)&&+this.data[12]===t.checksum(this.data)}leftText(){return super.leftText(1,6)}leftEncode(){const e=this.data.substring(1,7),i=t.EAN13_STRUCTURE[Number(this.data[0])];return super.leftEncode(e,i)}rightText(){return super.rightText(7,6)}rightEncode(){const t=this.data.substring(7,13);return super.rightEncode(t,"RRRRRR")}encodeGuarded(){const t=super.encodeGuarded();return this.quietZones>0?t[0].text=this.text[0]:t.unshift({data:"00000",text:this.text[0]}),t}};K.EAN13_STRUCTURE=["LLLLLL","LLGLGG","LLGGLG","LLGGGL","LGLLGG","LGGLLG","LGGGLL","LGLGLG","LGLGGL","LGGLGL"];class V extends A{static checksum(t){let e,i=0;for(e=1;e<11;e+=2)i+=parseInt(t[e]);for(e=0;e<11;e+=2)i+=3*parseInt(t[e]);return (10-i%10)%10}constructor(t,e){-1!==t.search(/^[0-9]{11}$/)&&(t+=V.checksum(t)),super(t,e),this.displayValue=e.displayValue;}valid(){return -1!==this.data.search(/^[0-9]{12}$/)&&parseInt(this.data[11])===V.checksum(this.data)}encode(){return {items:this.options.flat?this.flatEncoding():this.guardedEncoding(),text:this.text,options:this.options}}flatEncoding(){let t="";return t+="101",t+=k(this.data.substring(0,6),"LLLLLL"),t+="01010",t+=k(this.data.substring(6,6),"RRRRRR"),t+="101",[{data:t,text:this.text}]}guardedEncoding(){const t=[],e="number"==typeof this.options.quietZones&&this.options.quietZones>2?this.options.quietZones:2,i=Array(e).fill("0").join("");return t.push({data:i,text:this.text.substring(0,1)}),t.push({data:"101"+k(this.data[0],"L")}),t.push({data:k(this.data.substring(1,6),"LLLLL"),text:this.text.substring(1,6)}),t.push({data:"01010"}),t.push({data:k(this.data.substring(6,11),"RRRRR"),text:this.text.substring(6,11)}),t.push({data:k(this.data[11],"R")+"101"}),t.push({data:i,text:this.text.substring(11,12)}),t}}const z=["XX00000XXX","XX10000XXX","XX20000XXX","XXX00000XX","XXXX00000X","XXXXX00005","XXXXX00006","XXXXX00007","XXXXX00008","XXXXX00009"],X=[["EEEOOO","OOOEEE"],["EEOEOO","OOEOEE"],["EEOOEO","OOEEOE"],["EEOOOE","OOEEEO"],["EOEEOO","OEOOEE"],["EOOEEO","OEEOOE"],["EOOOEE","OEEEOO"],["EOEOEO","OEOEOE"],["EOEOOE","OEOEEO"],["EOOEOE","OEEOEO"]];class Z extends A{static expandToUPCA(t,e){const i=parseInt(t[t.length-1]),s=z[i];let r="",n=0;for(let e=0;e<s.length;e++){const i=s[e];r+="X"===i?t[n++]:i;}return r=`${e}${r}`,`${r}${V.checksum(r)}`}constructor(t,e){if(super(t,e),this.middleDigits="",this.upcA="",this.isValid=!1,-1!==t.search(/^[0-9]{6}$/))this.middleDigits=t,this.upcA=Z.expandToUPCA(t,"0"),this.text=e.text||`${this.upcA[0]}${t}${this.upcA[this.upcA.length-1]}`,this.isValid=!0;else {if(-1===t.search(/^[01][0-9]{7}$/))return;if(this.middleDigits=t.substring(1,t.length-1),this.upcA=Z.expandToUPCA(this.middleDigits,t[0]),this.upcA[this.upcA.length-1]!==t[t.length-1])return;this.isValid=!0;}this.displayValue=e.displayValue;}valid(){return this.isValid}encode(){return {items:this.options.flat?this.flatEncoding():this.guardedEncoding(),text:this.text,options:this.options}}flatEncoding(){let t="";return t+="101",t+=this.encodeMiddleDigits(),t+="010101",[{data:t,text:this.text}]}guardedEncoding(){const t=[],e="number"==typeof this.options.quietZones&&this.options.quietZones>2?this.options.quietZones:2,i=Array(e).fill("0").join("");return t.push({data:i,text:this.text[0]}),t.push({data:"101",text:""}),t.push({data:this.encodeMiddleDigits(),text:this.text.substring(1,7)}),t.push({data:"010101",text:""}),t.push({data:i,text:this.text[7]}),t}encodeMiddleDigits(){const t=this.upcA[0],e=this.upcA[this.upcA.length-1],i=X[parseInt(e)][parseInt(t)];return k(this.middleDigits,i)}}class q{constructor(){this.latch=!0,this.allEncodes="";}static getDigitText(t){return (t||"").replace(/\D/g,"")}static getInstance(){return this.instance||(this.instance=new q)}static encode(t){return this.getInstance().init().expand(t)}static checkDigit(t,e){const i=e||t.length;let s=0,r=1&i?3:1;for(let e=0;e<i;e++)s+=r*parseInt(t[e]),r^=2;return String((10-s%10)%10)}init(){return this.latch=!0,this.allEncodes="",this}expand(t){let e="";for(let i=0,s=0;i<t.length;i++)s=parseInt(t[i]),e+=Array(s).fill(this.latch?"1":"0").join(""),this.latch=!this.latch;return this.allEncodes+=e,e}}const Y=["BBBAAA","BBABAA","BBAABA","BBAAAB","BABBAA","BAABBA","BAAABB","BABABA","BABAAB","BAABAB"],Q=["AAABBB","AABABB","AABBAB","AABBBA","ABAABB","ABBAAB","ABBBAA","ABABAB","ABABBA","ABBABA"],tt$1=["AA","AB","BA","BB"],et=["BBAAA","BABAA","BAABA","BAAAB","ABBAA","AABBA","AAABB","ABABA","ABAAB","AABAB"],it=["AAAAA","ABABB","ABBAB","ABBBA","BAABB","BBAAB","BBBAA","BABAB","BABBA","BBABA"],st=["3211","2221","2122","1411","1132","1231","1114","1312","1213","3112"],rt=["1123","1222","2212","1141","2311","1321","4111","2131","3121","2113"],nt=["112211","211121","121121","221111","112121","212111","122111","111221","211211","121211"],at=["1111212111","2111111121","1121111121","2121111111","1111211121","2111211111","1121211111","1111112121","2111112111","1121112111"],ot=["11221","21112","12112","22111","11212","21211","12211","11122","21121","12121"],ht=["1111","211"],ct=["411111","41111"],lt=["212111","21112"],dt=["1111","211"];class ut extends A{constructor(t,e){super(t=q.getDigitText(t),e);}static gs1_check_digit(t,e){"number"==typeof e&&(e>t.length?t=t.padStart(e,"0"):e<t.length&&(t=t.substring(0,e)));let i=1&t.length?3:1,s=0;for(let e=0;e<t.length;e++)s+=i*parseInt(t[e]),i^=2;return ""+(10*Math.ceil(s/10)-s)}static c25_common(t,e,i,s,r){t=q.getDigitText(t),s&&s>0&&t.length>s&&(t=t.substring(0,s)),r.checkDigit&&(t+=ut.gs1_check_digit(t));const n=[];if(i)for(let e=0;e<t.length;e++)n.push(nt[t.charCodeAt(e)-P.num_0]);else for(let e=0;e<t.length;e++)n.push(at[t.charCodeAt(e)-P.num_0]);return {options:r,items:[{text:t,data:q.encode([e[0],...n,e[1]].join(""))}],text:t}}static c25_inter_common(t,e){(t=q.getDigitText(t)).length>125&&(t=t.substring(0,125)),(t.length%2==1&&!e.checkDigit||t.length%2==1&&e.checkDigit)&&(t="0"+t),e.checkDigit&&(t+=ut.gs1_check_digit(t));const i=[];for(let e=0;e<t.length;e+=2){const s=ot[parseInt(t[e])],r=ot[parseInt(t[e+1])];for(let t=0;t<5;t++)i.push(`${s[t]}${r[t]}`);}return {options:e,items:[{text:t,data:q.encode([ht[0],...i,ht[1]].join(""))}],text:t}}encode(){return ut.c25_inter_common(this.data,this.options)}}class gt extends ut{encode(){return ut.c25_common(this.data,ct,!0,80,this.options)}}class pt extends ut{encode(){return ut.c25_common(this.data,lt,!1,45,this.options)}}class mt extends ut{encode(){return ut.c25_common(this.data,dt,!0,80,this.options)}}class ft extends ut{encode(){let t=this.data;return t.length>13?t=t.substring(0,13):t.length<13&&(t=t.padStart(13,"0")),t+=ut.gs1_check_digit(t),this.data=this.text=t,ut.c25_inter_common(t,this.options)}}class Pt extends A{constructor(t,e){0===t.search(/^[0-9\-\$\:\.\+\/]+$/)&&(t="A"+t+"A"),super(t.toUpperCase(),e),this.text=this.options.text||this.text.replace(/[A-D]/g,"");}valid(){return -1!==this.data.search(/^[A-D][0-9\-\$\:\.\+\/]+[A-D]$/)}encode(){const t=[],e=this.getEncodings();for(let i=0;i<this.data.length;i++)t.push(e[this.data.charAt(i)]),i!==this.data.length-1&&t.push("0");return {items:[{text:this.text,data:t.join("")}],text:this.text,options:this.options}}getEncodings(){return {0:"101010011",1:"101011001",2:"101001011",3:"110010101",4:"101101001",5:"110101001",6:"100101011",7:"100101101",8:"100110101",9:"110100101","-":"101001101",$:"101100101",":":"1101011011","/":"1101101011",".":"1101101101","+":"1011011011",A:"1011001001",B:"1001001011",C:"1010010011",D:"1010011001"}}}const Ct="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%abcd",bt=["1112212111","2112111121","1122111121","2122111111","1112211121","2112211111","1122211111","1112112121","2112112111","1122112111","2111121121","1121121121","2121121111","1111221121","2111221111","1121221111","1111122121","2111122111","1121122111","1111222111","2111111221","1121111221","2121111211","1111211221","2111211211","1121211211","1111112221","2111112211","1121112211","1111212211","2211111121","1221111121","2221111111","1211211121","2211211111","1221211111","1211112121","2211112111","1221112111","1212121111","1212111211","1211121211","1112121211"],yt=["%U","$A","$B","$C","$D","$E","$F","$G","$H","$I","$J","$K","$L","$M","$N","$O","$P","$Q","$R","$S","$T","$U","$V","$W","$X","$Y","$Z","%A","%B","%C","%D","%E"," ","/A","/B","/C","/D","/E","/F","/G","/H","/I","/J","/K","/L","-",".","/O","0","1","2","3","4","5","6","7","8","9","/Z","%F","%G","%H","%I","%J","%V","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","%K","%L","%M","%N","%O","%W","+A","+B","+C","+D","+E","+F","+G","+H","+I","+J","+K","+L","+M","+N","+O","+P","+Q","+R","+S","+T","+U","+V","+W","+X","+Y","+Z","%P","%Q","%R","%S","%T"],At=["bU","aA","aB","aC","aD","aE","aF","aG","aH","aI","aJ","aK","aL","aM","aN","aO","aP","aQ","aR","aS","aT","aU","aV","aW","aX","aY","aZ","bA","bB","bC","bD","bE"," ","cA","cB","cC","$","%","cF","cG","cH","cI","cJ","+","cL","-",".","/","0","1","2","3","4","5","6","7","8","9","cZ","bF","bG","bH","bI","bJ","bV","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bK","bL","bM","bN","bO","bW","dA","dB","dC","dD","dE","dF","dG","dH","dI","dJ","dK","dL","dM","dN","dO","dP","dQ","dR","dS","dT","dU","dV","dW","dX","dY","dZ","bP","bQ","bR","bS","bT"],Rt=["131112","111213","111312","111411","121113","121212","121311","111114","131211","141111","211113","211212","211311","221112","221211","231111","112113","112212","112311","122112","132111","111123","111222","111321","121122","131121","212112","212211","211122","211221","221121","222111","112122","112221","122121","123111","121131","311112","311211","321111","112131","113121","211131","121221","312111","311121","122211"];class Et extends A{constructor(t,e){const i=function(t){const e=[],i=[];let s=0,r=0;for(let n=0,a="",o="";n<t.length;n++)if(a=t[n],r=t.charCodeAt(n),o=At[r],r>127)d.warn(`---- [encode with code93] invalid char: '${a}'[${r}]`);else {if(s+o.length>107){d.warn(`---- content too long, discarded content[${n} --\x3e ${t.length}]: "${t.substring(n)}"`);break}e.push(o),i.push(a>" "&&127!==r?a:" "),s+=o.length;}return {data:e.join(""),text:i.join("")}}(t);e.text=i.text,super(i.data,e);}encode(){const t=[],e=[];for(let e=0;e<this.data.length;e++)t.push(Ct.indexOf(this.data[e]));let i=0,s=1;for(let e=this.data.length-1;e>=0;e--)i+=t[e]*s,s++,21==s&&(s=1);i%=47,t.push(i);let r=0;s=1;for(let e=this.data.length;e>=0;e--)r+=t[e]*s,s++,16==s&&(s=1);r%=47,t.push(r),e.push("111141");for(let i=0;i<t.length;i++)e.push(Rt[t[i]]);return e.push("1111411"),{items:[{data:q.encode(e.join("")),text:this.options.mod43?`${this.text}${Ct[i]}${Ct[r]}`:this.text}],text:this.text,options:this.options}}valid(){return -1!==this.data.search(/^[0-9A-Z\-\.\ \$\/\+\%]+$/)}}function It(t){const e=t.charCodeAt(0);return yt[e]}class xt extends A{constructor(t,e){if(t=t.toUpperCase(),e.mod43){const i=e.text||t,s=function(t){const e=t.length%43;return Ct[e]}(t);t+=s,e.text=i+s;}super(t,e);}encode(){const t=[],e=[],i=this.data;for(let e=0;e<i.length;e++){const s=Ct.indexOf(i[e]);s>=0?t.push(s):d.warn(`---- 检测到无效字符[encode with code39]: '${i[e]}'`);}e.push("1211212111");for(let s=0;s<i.length;s++)e.push(bt[t[s]]);e.push("121121211");const s={data:q.encode(e.join("")),text:this.options.showStartEndChar?`*${this.text}*`:this.text};return {options:this.options,items:[s],text:this.text}}}class Dt extends xt{constructor(t,e){const i=function(t){const e=[],i=[];let s=0,r=0;for(let n=0,a="",o="";n<t.length;n++)if(a=t[n],r=t.charCodeAt(n),o=It(a),r>127)d.warn(`---- [ECode39] invalidate char: '${a}'[${r}]`);else {if(s+o.length>85){d.warn(`---- discarded content[${n} --\x3e ${t.length}]: "${t.slice(n)}"`);break}i.push(a),e.push(o),s+=o.length;}return {data:e.join(""),text:i.join("")}}(t);e.text=i.text,super(i.data,e);}valid(){return -1!==this.data.search(/^[0-9A-Z\-\.\ \$\/\+\%]+$/)}}class vt extends A{static convertUPCE2UPCA(t){(t=q.getDigitText(t)).length>7?t=t.substring(0,7):t.length<7&&(t=t.padStart(7,"0"));const e=t.substring(1),i=e[5],s=Array(11).fill("0");switch("1"==t[0]&&(s[0]="1"),s[1]=e[0],s[2]=e[1],i){case"0":case"1":case"2":s[3]=i,s[8]=e[2],s[9]=e[3],s[10]=e[4];break;case"3":s[3]=e[2],s[9]=e[3],s[10]=e[4],"0"!=e[2]&&"1"!=e[2]&&"2"!=e[2]||d.warn("271: Invalid UPC-E data, X3 shall not be equal to 0, 1 or ");break;case"4":s[3]=e[2],s[4]=e[3],s[10]=e[4],"0"==e[3]&&d.warn("272: Invalid UPC-E data, X4 shall not be equal to 0");break;case"5":case"6":case"7":case"8":case"9":s[3]=e[2],s[4]=e[3],s[5]=e[4],s[10]=i,"0"==e[4]&&d.warn("273: Invalid UPC-E data X5 shall not be equal to 0");}return s.join("")}static getUPCECheckCode(t){const e=vt.convertUPCE2UPCA(t);return q.checkDigit(e,11)}constructor(t,e){(t=q.getDigitText(t)).length>7?t=t.substring(0,7):t.length<7&&(t=t.padStart(7,"0")),super(t,e);}encode(){let t=this.text;const e=vt.convertUPCE2UPCA(this.text),i=q.checkDigit(e,11);t+=i;let s="";s="1"==e[0]?Q[C.ctoi(i)]:Y[C.ctoi(i)];const r=[];for(let e=0;e<length;e++)switch(s[e]){case"A":r.push(st[t.charCodeAt(e)-P.num_0]);break;case"B":r.push(rt[t.charCodeAt(e)-P.num_0]);}const n=[],a=new q;return n.push({text:"",data:a.expand("111")}),n.push({text:"",data:a.expand(r.join(""))}),n.push({text:"",data:a.expand("111111")}),{options:this.options,items:n,text:t}}}class _t extends A{constructor(t,e){super(t=q.getDigitText(t),e);}encode(){let t=this.text,e="";if(t.length<2&&(t=t.padStart(2,"0")),t.length<=2){const i=10*C.ctoi(t[0])+C.ctoi(t[1]);e=tt$1[i%4];}else {t.length<5&&(t=t.padStart(5,"0"));const i=[];for(let e=0;e<5;e++)i[e]=C.ctoi(t[e]);let s=3*(i[0]+i[2]+i[4]);s+=9*(i[1]+i[3]),e=et[s%10];}const i=[];i.push("112");for(let s=0;s<t.length;s++){switch(e[s]){case"A":i.push(st[t.charCodeAt(s)-P.num_0]);break;case"B":i.push(rt[t.charCodeAt(s)-P.num_0]);}s!=length-1&&i.push("11");}const s=[{text:t,data:q.encode(i.join(""))}];return {options:this.options,items:s,text:t}}}class St extends _t{constructor(t,e){super(t=q.getDigitText(t),e);}encode(){let t=this.text;t.length>13?t=t.substring(0,13):t.length<12&&(t=t.padStart(12,"0"));const e=q.checkDigit(t,12);12==t.length?t+=e:e!==t[12]&&(t=t.substring(0,12)+e);const i=it[t.charCodeAt(0)-P.num_0],s=[],r=[];for(let e=1;e<t.length;e++)e>1&&e<7&&"B"==i[e-2]?e<7?s.push(rt[t.charCodeAt(e)-P.num_0]):r.push(rt[t.charCodeAt(e)-P.num_0]):e<7?s.push(st[t.charCodeAt(e)-P.num_0]):r.push(st[t.charCodeAt(e)-P.num_0]);const n=this.options.quietZones||0,a=[],o=new q,h=Array(n>2?n:2).fill("0").join("");return a.push({text:t[0],data:h}),a.push({text:"",data:o.expand("111")}),a.push({text:t.substring(1,7),data:o.expand(s.join(""))}),a.push({text:"",data:o.expand("11111")}),a.push({text:t.substring(7),data:o.expand(r.join(""))}),a.push({text:"",data:o.expand("111")}),a.push({text:this.options.guardWhitespace?" >":"",data:h}),{items:a,text:t,options:this.options}}}class wt extends St{static getCheckCode(t,e){let i=0,s=1;const r=e||t.length;for(let e=0;e<r;e++)i+=C.ctoi(t[e])*s,s++;const n=i%11;let a=C.itoc(n);return 10==n&&(a="X"),a}static filterText(t){const e=[];t=t.toUpperCase();for(let i=0;i<t.length&&!(e.length>13);i++)if(C.isDigit(t.charCodeAt(i)))e.push(t[i]);else if("X"===t[i]&&9===e.length&&i===t.length-1){e.push(t[i]);break}return e.join("")}constructor(t,e){if(super(t,e),(t=wt.filterText(t)).length>13&&(t=t.substring(0,13)),13==t.length){const e=t.substring(0,3);"978"!==e&&"979"!==e&&(t="978"+t.substring(3));const i=q.checkDigit(t,12);t[12]!=i&&(t=t.substring(0,12)+i);}else t.length>10&&(t=t.substring(0,10)),t.length<9&&(t=t.padStart(9,"0")),t=`978${t.substring(0,9)}`;this.data=this.text=t;}}class Tt{static registerEncoder(t,e){this.registedEncoderMap.set(t,e);}static getEncoder(t){const e=t.type||y.AUTO,i=t.text||"",s=this.registedEncoderMap.get(e);if(s&&"function"==typeof s.encode)return s;switch(e){case y.UPC_A:return new V(i,t);case y.UPC_E:return new Z(i,t);case y.EAN13:return new K(i,t);case y.EAN8:return new G(i,t);case y.CODE39:return new xt(i,t);case y.ITF25:return new ut(i,t);case y.CODABAR:return new Pt(i,t);case y.CODE93:return new Et(i,t);case y.ISBN:return new wt(i,t);case y.ECODE39:return new Dt(i,t);case y.ITF14:return new ft(i,t);case y.ChinaPost:return new mt(i,t);case y.Matrix25:return new gt(i,t);case y.Industrial25:return new pt(i,t);case y.CODE128:default:return new U(i,t)}}static encode(t){"boolean"!=typeof t.displayValue&&(t.displayValue=!0);const e=this.getEncoder(t),i=e.encode(t.text||"",t);return i.data||(i.data=i.items.map((t=>t.data)).join("")),i.options||(i.options=e.options),i}}Tt.registedEncoderMap=new Map;class Ot{static registerBarcodeCreator(t,e){Tt.registerEncoder(t,e);}static IsProductType(t){switch(t){case y.EAN13:case y.EAN8:case y.UPC_A:case y.UPC_E:case y.ISBN:return !0;default:return !1}}static create1DBarcode(t){const e=t;let i=y.AUTO;"number"==typeof t.barcodeType?i=t.barcodeType:"number"==typeof e.type&&(i=e.type);let s="number"==typeof t.text?`${t.text}`:(t.text||"").trim();if(s||(s=void 0===t.content||null===t.content?"":String(t.content)),s){s=this.normalize(s,i);try{let e=0;switch(i){case y.EAN13:case y.UPC_A:case y.UPC_E:case y.ISBN:e=Ot.DockHorMargin;}return Tt.encode({text:s,type:i,quietZones:e,showStartEndChar:t.showStartEnd})}catch(t){return void d.warn(t)}}}static normalize(t,e){if(e===y.CODE39||e===y.CODE93)t=this.normalizeLength(t,107,(t=>t>=0&&t<128),"?");else {if(e===y.CODABAR){const e="0123456789-$:/.+ABCD";let i,s;if(t.length>=2){const e="ABCD",r="TN*E";i=t.charAt(0).toUpperCase(),s=t.charAt(t.length-1).toUpperCase();const n=e.indexOf(i)>=0&&e.indexOf(s)>=0,a=r.indexOf(i)>=0&&r.indexOf(s)>=0;n||a?t=t.substring(1,t.length-1):i=s="A";}else i=s="A";return i+(t=this.normalizeLength(t,0,(t=>e.indexOf(String.fromCharCode(t))>=0),"0"))+s}if(e===y.EAN13)t=this.normalizeDigitLength(t,12),t+=this.getEAN13CheckCode(t);else if(e===y.EAN8)t=this.normalizeDigitLength(t,7),t+=this.getEAN8CheckCode(t);else if(e===y.UPC_A)t=this.normalizeDigitLength(t,11),t+=q.checkDigit(t);else if(e===y.UPC_E){const e=(t=this.normalizeDigitLength(t,7)).charAt(0);"0"!==e&&"1"!==e&&(t="0"+t.substring(1)),t+=vt.getUPCECheckCode(t);}else if(e===y.ITF14)t=this.normalizeDigitLength(t,13),t+=this.getITD14CheckCode(t);else {if(e===y.ITF25)return (t=this.normalizeLength(t,80,(t=>C.isDigit(t)),"0")).length%2!=0?"0"+t:t;if(e===y.GS1_128)if("("===t[0]){if(t.indexOf(")")<0){const e=t.indexOf("]");e>0&&(t=t.substring(0,e)+")"+t.substring(e+1));}}else if("["===t[0]){if(t.indexOf("]")<0){const e=t.indexOf(")");e>0&&(t=t.substring(0,e)+"]"+t.substring(e+1));}}else t.length<2&&(t="0"+t),t=t.length<=20?"(10)"+t:t.length<=30?"(90)"+t:"(91)"+t;else t=this.normalizeLength(t,80,(t=>t>=32&&t<=126),"?");}}return t}static normalizeDigitLength(t,e){return (t=this.normalizeLength(t,e,(t=>C.isDigit(t)),"0")).length<e&&(t=C.preFillChar(t,e,"0")),t}static normalizeLength(t,e,i,s){if(e>0&&t.length>e&&(t=t.substring(0,e)),i&&s){const e=[];for(let r=0;r<t.length;r++)i(t.charCodeAt(r))?e.push(t.charAt(r)):e.push(s);t=e.join("");}return t}static getEAN13CheckCode(t){let e=0,i=0;for(i=0;i<t.length;++i){const s=t.charCodeAt(i)-P.num_0;if(s<0||s>9)throw "检测到非发字符";e+=(1&i?3:1)*s;}return e=10-e%10,10==e&&(e=0),String(e)}static getEAN8CheckCode(t){return q.checkDigit(t)}static getITD14CheckCode(t){return q.checkDigit(t)}}var Mt;Ot.DockHorMargin=7,function(t){t[t.Low=0]="Low",t[t.Middle=1]="Middle",t[t.Quality=2]="Quality",t[t.High=3]="High";}(Mt||(Mt={}));const Bt=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];class Lt{static getSymbolSize(t){if(!t)throw new Error('"version" cannot be null or undefined');if(t<1||t>40)throw new Error('"version" should be in range from 1 to 40');return 4*t+17}static getSymbolTotalCodewords(t){return Bt[t]}static getBCHDigit(t){let e=0;for(;0!==t;)e++,t>>>=1;return e}static calcWaterMarkSeed(t){if("number"==typeof t)return t;if("string"==typeof t){if(!t)return 1024;let e=4660;const i=b.getBytes_Utf8(t);for(let t=0;t<i.length;++t)e+=e>>>5,e+=(255&i[t])*(2&t?5:3),e+=1&t?13:11;return 1025+(1048575&e)}return 0}static hasWaterMarkSeed(t,e,i){if(!e||e.length<3)return !1;let s,r;if((255&e[0])>>>4==5)if(9==(15&e[0])){if(e.length<4)return !1;if((255&e[1])>>>4!=3)return !1;if(13!=(15&e[1]))return !1;s=(255&e[2])>>>6&3,r=(63&e[2])<<4|(255&e[3])>>>4;}else {if(3!=(15&e[0]))return !1;if((255&e[1])>>>4!=13)return !1;s=(255&e[1])>>>2&3,r=(3&e[1])<<8|255&e[2];}else {if((255&e[0])>>>4!=3)return !1;if(13!=(15&e[0]))return !1;s=(255&e[1])>>>6&3,r=(63&e[1])<<4|(255&e[2])>>>4;}return 1022==r||r==this.calcDtCheckSum(s,i,t)}static calcDtCheckSum(t,e,i){"string"==typeof e&&(e=this.calcWaterMarkSeed(e));let s=this.sDtWaterMarkCheckSums[3&t];if(s=s+e&1048575,i&&i.length>0){const t=b.getBytes_Utf8(i);for(let e=0;e<t.length;++e)s+=s>>>5,s+=(255&t[e])*(2&e?5:3),s+=1&e?13:11;}return s%1019+3}}Lt.sDtWaterMarkCheckSums=[197,257,571,991];class Nt{static getRowColCoords(t){if(1===t)return [];const e=Math.floor(t/7)+2,i=Lt.getSymbolSize(t),s=145===i?26:2*Math.ceil((i-13)/(2*e-2)),r=[i-7];for(let t=1;t<e-1;t++)r[t]=r[t-1]-s;return r.push(6),r.reverse()}static getPositions(t){const e=[],i=Nt.getRowColCoords(t),s=i.length;for(let t=0;t<s;t++)for(let r=0;r<s;r++)0===t&&0===r||0===t&&r===s-1||t===s-1&&0===r||e.push([i[t],i[r]]);return e}}class Ft{constructor(){this.mBuffer=[],this.mLength=0;}get buffer(){return this.mBuffer}get length(){return this.mLength}get(t){const e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)}put(t,e){for(let i=0;i<e;i++)this.putBit(1==(t>>>e-i-1&1));}getLengthInBits(){return this.length}putBit(t){const e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.mLength++;}}const jt=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],Ut=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];class Wt{static getBlocksCount(t,e){switch(e){case Mt.Low:return jt[4*(t-1)+0];case Mt.Middle:return jt[4*(t-1)+1];case Mt.Quality:return jt[4*(t-1)+2];case Mt.High:return jt[4*(t-1)+3];default:return}}static getTotalCodewordsCount(t,e){switch(e){case Mt.Low:return Ut[4*(t-1)+0];case Mt.Middle:return Ut[4*(t-1)+1];case Mt.Quality:return Ut[4*(t-1)+2];case Mt.High:return Ut[4*(t-1)+3];default:return}}}const kt=Lt.getBCHDigit(1335);class $t{static getEccBit(t){switch(t){case Mt.Low:return 1;default:case Mt.Middle:return 0;case Mt.Quality:return 3;case Mt.High:return 2}}static getEncodedBits(t,e){const i=$t.getEccBit(t)<<3|e;let s=i<<10;for(;Lt.getBCHDigit(s)-kt>=0;)s^=1335<<Lt.getBCHDigit(s)-kt;return 21522^(i<<10|s)}}class Ht{static isValid(t){return t&&!isNaN(t)&&t>=0&&t<=7}static getPenaltyN1(t){const e=t.cols;let i=0,s=0,r=0,n=null,a=null;for(let o=0;o<e;o++){s=r=0,n=a=null;for(let h=0;h<e;h++){let e=t.get(o,h);e===n?s++:(s>=5&&(i+=s-5+3),n=e,s=1),e=t.get(h,o),e===a?r++:(r>=5&&(i+=r-5+3),a=e,r=1);}s>=5&&(i+=s-5+3),r>=5&&(i+=r-5+3);}return i}static getPenaltyN2(t){const e=t.cols;let i=0;for(let s=0;s<e-1;s++)for(let r=0;r<e-1;r++){const e=t.get(s,r)+t.get(s,r+1)+t.get(s+1,r)+t.get(s+1,r+1);4!==e&&0!==e||i++;}return 3*i}static getPenaltyN3(t){const e=t.cols;let i=0,s=0,r=0;for(let n=0;n<e;n++){s=r=0;for(let a=0;a<e;a++)s=s<<1&2047|t.get(n,a),a>=10&&(1488===s||93===s)&&i++,r=r<<1&2047|t.get(a,n),a>=10&&(1488===r||93===r)&&i++;}return 40*i}static getPenaltyN4(t){let e=0;const i=t.data.length;for(let s=0;s<i;s++)e+=t.data[s];return 10*Math.abs(Math.ceil(100*e/i/5)-10)}static getMaskAt(t,e,i){switch(t){case this.Patterns.PATTERN000:return (e+i)%2==0;case this.Patterns.PATTERN001:return e%2==0;case this.Patterns.PATTERN010:return i%3==0;case this.Patterns.PATTERN011:return (e+i)%3==0;case this.Patterns.PATTERN100:return (Math.floor(e/2)+Math.floor(i/3))%2==0;case this.Patterns.PATTERN101:return e*i%2+e*i%3==0;case this.Patterns.PATTERN110:return (e*i%2+e*i%3)%2==0;case this.Patterns.PATTERN111:return (e*i%3+(e+i)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}}static applyMask(t,e){const i=e.cols;for(let s=0;s<i;s++)for(let r=0;r<i;r++)e.isReserved(r,s)||e.xor(r,s,this.getMaskAt(t,r,s));}static getBestMask(t,e){const i=Object.keys(this.Patterns).length;let s=0,r=1/0;for(let n=0;n<i;n++){e(n),this.applyMask(n,t);const i=this.getPenaltyN1(t)+this.getPenaltyN2(t)+this.getPenaltyN3(t)+this.getPenaltyN4(t);this.applyMask(n,t),i<r&&(r=i,s=n);}return s}}Ht.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const Jt="[0-9]+";let Gt="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";Gt=Gt.replace(/u/g,"\\u");const Kt="(?:(?![A-Z0-9 $%*+\\-./:]|"+Gt+")(?:.|[\r\n]))+",Vt=new RegExp("^"+Gt+"$"),zt=new RegExp("^"+Jt+"$"),Xt=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");class Zt{static testKanji(t){return Vt.test(t)}static testNumeric(t){return zt.test(t)}static testAlphanumeric(t){return Xt.test(t)}}Zt.KANJI=new RegExp(Gt,"g"),Zt.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),Zt.BYTE=new RegExp(Kt,"g"),Zt.NUMERIC=new RegExp(Jt,"g"),Zt.ALPHANUMERIC=new RegExp("[A-Z $%*+\\-./:]+","g");class qt{static isValid(t){return !isNaN(t)&&t>=1&&t<=40}}class Yt{static getCharCountIndicator(t,e){if(!t.ccBits)throw new Error("Invalid mode: "+t);if(!qt.isValid(e))throw new Error("Invalid version: "+e);return e>=1&&e<10?t.ccBits[0]:e<27?t.ccBits[1]:t.ccBits[2]}static getBestModeForData(t){return Zt.testNumeric(t)?this.NUMERIC:Zt.testAlphanumeric(t)?this.ALPHANUMERIC:Zt.testKanji(t)?this.KANJI:this.BYTE}static toString(t){if(t&&t.id)return t.id;throw new Error("Invalid mode")}static isValid(t){return "string"!=typeof t&&t&&t.bit&&t.ccBits}static fromString(t){if("string"!=typeof t)throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return this.NUMERIC;case"alphanumeric":return this.ALPHANUMERIC;case"kanji":return this.KANJI;case"byte":return this.BYTE;default:throw new Error("Unknown mode: "+t)}}static from(t,e){if(this.isValid(t))return t;try{return this.fromString(t)}catch(t){return e}}}Yt.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},Yt.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},Yt.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},Yt.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},Yt.MIXED={id:"",bit:-1,ccBits:[]},Yt.STRUCTURED={id:"Structured",bit:3,ccBits:[0,0,0]};const Qt=new Uint8Array(512),te=new Uint8Array(256);!function(){let t=1;for(let e=0;e<255;e++)Qt[e]=t,te[t]=e,t<<=1,256&t&&(t^=285);for(let t=255;t<512;t++)Qt[t]=Qt[t-255];}();class ee{static log(t){if(t<1)throw new Error("log("+t+")");return te[t]}static exp(t){return Qt[t]}static mul(t,e){return 0===t||0===e?0:Qt[te[t]+te[e]]}}class ie{static mul(t,e){const i=new Uint8Array(t.length+e.length-1);for(let s=0;s<t.length;s++)for(let r=0;r<e.length;r++)i[s+r]^=ee.mul(t[s],e[r]);return i}static mod(t,e){let i=new Uint8Array(t);for(;i.length-e.length>=0;){const t=i[0];for(let s=0;s<e.length;s++)i[s]^=ee.mul(e[s],t);let s=0;for(;s<i.length&&0===i[s];)s++;i=i.slice(s);}return i}static generateECPolynomial(t){let e=new Uint8Array([1]);for(let i=0;i<t;i++)e=this.mul(e,new Uint8Array([1,ee.exp(i)]));return e}}class se{constructor(t){this.degree=t,this.degree&&this.initialize(this.degree);}initialize(t){this.degree=t,this.genPoly=ie.generateECPolynomial(this.degree);}encode(t){if(!this.genPoly)throw new Error("Encoder not initialized");const e=new Uint8Array(t.length+this.degree);e.set(t);const i=ie.mod(e,this.genPoly),s=this.degree-i.length;if(s>0){const t=new Uint8Array(this.degree);return t.set(i,s),t}return i}}const re="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:".split("");class ne{get mode(){return this.mMode}get data(){return this.mData}constructor(t,e){this.mMode=t,this.mData=e||"";}getLength(){return this.mData.length}getBitsLength(){return 0}write(t){}}class ae extends ne{constructor(t){super(Yt.ALPHANUMERIC,t);}static getBitsLength(t){return 11*Math.floor(t/2)+t%2*6}getBitsLength(){return ae.getBitsLength(this.mData.length)}write(t){let e;for(e=0;e+2<=this.mData.length;e+=2){let i=45*re.indexOf(this.mData[e]);i+=re.indexOf(this.mData[e+1]),t.put(i,11);}this.mData.length%2&&t.put(re.indexOf(this.mData[e]),6);}}class oe extends ne{constructor(t){super(Yt.NUMERIC,t);}static getBitsLength(t){return 10*Math.floor(t/3)+(t%3?t%3*3+1:0)}getBitsLength(){return oe.getBitsLength(this.getLength())}write(t){let e,i,s;for(e=0;e+3<=this.mData.length;e+=3)i=this.mData.substr(e,3),s=parseInt(i,10),t.put(s,10);const r=this.mData.length-e;r>0&&(i=this.mData.substr(e),s=parseInt(i,10),t.put(s,3*r+1));}}class he extends ne{constructor(t){super(Yt.BYTE,t),this.bytes=b.getBytes_Utf8(t);}static getBitsLength(t){return 8*t}getLength(){return this.bytes.length}getBitsLength(){return 8*this.bytes.length}write(t){for(let e=0,i=this.bytes.length;e<i;e++)t.put(this.bytes[e],8);}}class ce extends ne{constructor(t){super(Yt.KANJI,t);}static getBitsLength(t){return 13*t}getBitsLength(){return ce.getBitsLength(this.getLength())}write(t){let e;for(e=0;e<this.mData.length;e++){let i=Lt.toSJISFunction?Lt.toSJISFunction(this.mData[e]):this.mData.charCodeAt(e);if(i>=33088&&i<=40956)i-=33088;else {if(!(i>=57408&&i<=60351))throw new Error("Invalid SJIS character: "+this.mData[e]+"\nMake sure your charset is UTF-8");i-=49472;}i=192*(i>>>8&255)+(255&i),t.put(i,13);}}}const le={queue:[],sorter:null,make:function(t){const e=le,i={};t=t||{};for(const t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i.queue=[],i.sorter=t.sorter||e.default_sorter,i},default_sorter:(t,e)=>t.cost-e.cost,push(t,e){this.queue.push({value:t,cost:e}),this.queue.sort(this.sorter);},pop(){return this.queue.shift()},empty(){return 0===this.queue.length}},de={single_source_shortest_paths:function(t,e,i){const s={},r={};r[e]=0;const n=de.PriorityQueue.make();let a,o,h,c,l,d,u,g,p;for(n.push(e,0);!n.empty();)for(h in a=n.pop(),o=null==a?void 0:a.value,c=null==a?void 0:a.cost,l=t[o]||{},l)l.hasOwnProperty(h)&&(d=l[h],u=c+d,g=r[h],p=void 0===r[h],(p||g>u)&&(r[h]=u,n.push(h,u),s[h]=o));if(void 0!==i&&void 0===r[i]){const t=["Could not find a path from ",e," to ",i,"."].join("");throw new Error(t)}return s},extract_shortest_path_from_predecessor_list:function(t,e){const i=[];let s=e;for(;s;)i.push(s),t[s],s=t[s];return i.reverse(),i},find_path:function(t,e,i){const s=de.single_source_shortest_paths(t,e,i);return de.extract_shortest_path_from_predecessor_list(s,i)},PriorityQueue:le};class ue{static getStringByteLength(t){return unescape(encodeURIComponent(t)).length}static getSegments(t,e,i){const s=[];let r;for(;r=t.exec(i);)s.push({data:r[0],index:r.index,mode:e,length:r[0].length});return s}static getSegmentsFromString(t){const e=this.getSegments(Zt.NUMERIC,Yt.NUMERIC,t),i=this.getSegments(Zt.ALPHANUMERIC,Yt.ALPHANUMERIC,t);let s,r;return "function"==typeof Lt.toSJISFunction?(s=this.getSegments(Zt.BYTE,Yt.BYTE,t),r=this.getSegments(Zt.KANJI,Yt.KANJI,t)):(s=this.getSegments(Zt.BYTE_KANJI,Yt.BYTE,t),r=[]),e.concat(i,s,r).sort((function(t,e){return t.index-e.index})).map((function(t){return {data:t.data,mode:t.mode,length:t.length,index:0}}))}static getSegmentBitsLength(t,e){switch(e){case Yt.NUMERIC:return oe.getBitsLength(t);case Yt.ALPHANUMERIC:return ae.getBitsLength(t);case Yt.KANJI:return ce.getBitsLength(t);case Yt.BYTE:default:return he.getBitsLength(t)}}static mergeSegments(t){return t.reduce((function(t,e){const i=t.length-1>=0?t[t.length-1]:null;return i&&i.mode===e.mode?(t[t.length-1].data+=e.data,t):(t.push(e),t)}),[])}static buildNodes(t){const e=[];for(let i=0;i<t.length;i++){const s=t[i];switch(s.mode){case Yt.NUMERIC:e.push([s,{data:s.data,mode:Yt.ALPHANUMERIC,length:s.length},{data:s.data,mode:Yt.BYTE,length:s.length}]);break;case Yt.ALPHANUMERIC:e.push([s,{data:s.data,mode:Yt.BYTE,length:s.length}]);break;case Yt.KANJI:e.push([s,{data:s.data,mode:Yt.BYTE,length:this.getStringByteLength(s.data)}]);break;case Yt.BYTE:e.push([{data:s.data,mode:Yt.BYTE,length:this.getStringByteLength(s.data)}]);}}return e}static buildGraph(t,e){const i={},s={start:{}};let r=["start"];for(let n=0;n<t.length;n++){const a=t[n],o=[];for(let t=0;t<a.length;t++){const h=a[t],c=""+n+t;o.push(c),i[c]={node:h,lastCount:0},s[c]={};for(let t=0;t<r.length;t++){const n=r[t];i[n]&&i[n].node.mode===h.mode?(s[n][c]=this.getSegmentBitsLength(i[n].lastCount+h.length,h.mode)-this.getSegmentBitsLength(i[n].lastCount,h.mode),i[n].lastCount+=h.length):(i[n]&&(i[n].lastCount=h.length),s[n][c]=this.getSegmentBitsLength(h.length,h.mode)+4+Yt.getCharCountIndicator(h.mode,e));}}r=o;}for(let t=0;t<r.length;t++)s[r[t]].end=0;return {map:s,table:i}}static buildSingleSegment(t,e){let i;const s=Yt.getBestModeForData(t);if(i=Yt.from(e||"",s),!i||i!==Yt.BYTE&&(null==i?void 0:i.bit)<s.bit)throw new Error('"'+t+'" cannot be encoded with mode '+Yt.toString(i)+".\n Suggested mode is: "+Yt.toString(s));switch(i===Yt.KANJI&&"function"!=typeof Lt.toSJISFunction&&(i=Yt.BYTE),i){case Yt.NUMERIC:return new oe(t);case Yt.ALPHANUMERIC:return new ae(t);case Yt.KANJI:return new ce(t);case Yt.BYTE:return new he(t)}}static fromArray(t){return t.reduce(((t,e)=>{if("string"==typeof e){const i=ue.buildSingleSegment(e);i&&t.push(i);}else if(e.data){const i=ue.buildSingleSegment(e.data,e.mode);i&&t.push(i);}return t}),[])}static fromString(t,e){const i=this.getSegmentsFromString(t),s=this.buildNodes(i),r=this.buildGraph(s,e),n=de.find_path(r.map,"start","end"),a=[];for(let t=1;t<n.length-1;t++)a.push(r.table[n[t]].node);return this.fromArray(this.mergeSegments(a))}static rawSplit(t){return this.fromArray(this.getSegmentsFromString(t))}}const ge=Lt.getBCHDigit(7973);class pe{static getBestVersionForDataLength(t,e,i){for(let s=1;s<=40;s++)if(e<=this.getCapacity(s,i,t))return s}static getReservedBitsCount(t,e){return Yt.getCharCountIndicator(t,e)+4}static getTotalBitsFromDataArray(t,e){let i=0;return t.forEach((function(t){const s=pe.getReservedBitsCount(t.mode,e);i+=s+t.getBitsLength();})),i}static getBestVersionForMixedData(t,e,i){const s=t&&t.length>0?t.length:0;for(let t=1;t<=40;t++)if(this.getTotalBitsFromDataArray(e,t)+s<=this.getCapacity(t,i,Yt.MIXED))return t}static isValid(t){return !isNaN(t)&&t>=1&&t<=40}static getCapacity(t,e,i){if(!pe.isValid(t))throw new Error("Invalid QR Code version");void 0===i&&(i=Yt.BYTE);const s=8*(Lt.getSymbolTotalCodewords(t)-(Wt.getTotalCodewordsCount(t,e)||0));if(i===Yt.MIXED)return s;const r=s-this.getReservedBitsCount(i,t);switch(i){case Yt.NUMERIC:return Math.floor(r/10*3);case Yt.ALPHANUMERIC:return Math.floor(r/11*2);case Yt.KANJI:return Math.floor(r/13);case Yt.BYTE:default:return Math.floor(r/8)}}static getBestVersionForData(t,e,i){let s;if(Array.isArray(e)){if(e.length>1)return this.getBestVersionForMixedData(t,e,i);if(0===e.length)return 1;s=e[0];}else s=e;const r=t?Math.ceil(t.length/8):0;return this.getBestVersionForDataLength(s.mode,s.getLength()+r,i)}static getEncodedBits(t){if(!pe.isValid(t)||t<7)throw new Error("Invalid QR Code version");let e=t<<12;for(;Lt.getBCHDigit(e)-ge>=0;)e^=7973<<Lt.getBCHDigit(e)-ge;return t<<12|e}}class me{static getPositions(t){const e=Lt.getSymbolSize(t);return [[0,0],[e-7,0],[0,e-7]]}}class fe{static setupFinderPattern(t,e){const i=t.cols,s=me.getPositions(e);for(let e=0;e<s.length;e++){const r=s[e][0],n=s[e][1];for(let e=-1;e<=7;e++)if(!(r+e<=-1||i<=r+e))for(let s=-1;s<=7;s++)n+s<=-1||i<=n+s||(e>=0&&e<=6&&(0===s||6===s)||s>=0&&s<=6&&(0===e||6===e)||e>=2&&e<=4&&s>=2&&s<=4?t.set(r+e,n+s,!0,!0):t.set(r+e,n+s,!1,!0));}}static setupTimingPattern(t){const e=t.cols;for(let i=8;i<e-8;i++){const e=i%2==0;t.set(i,6,e,!0),t.set(6,i,e,!0);}}static setupAlignmentPattern(t,e){const i=Nt.getPositions(e);for(let e=0;e<i.length;e++){const s=i[e][0],r=i[e][1];for(let e=-2;e<=2;e++)for(let i=-2;i<=2;i++)-2===e||2===e||-2===i||2===i||0===e&&0===i?t.set(s+e,r+i,!0,!0):t.set(s+e,r+i,!1,!0);}}static setupVersionInfo(t,e){const i=t.cols,s=pe.getEncodedBits(e);let r,n,a;for(let e=0;e<18;e++)r=Math.floor(e/3),n=e%3+i-8-3,a=1==(s>>e&1),t.set(r,n,a,!0),t.set(n,r,a,!0);}static setupFormatInfo(t,e,i){const s=t.cols,r=$t.getEncodedBits(e,i);let n=!1;for(let e=0;e<15;e++)n=1==(r>>e&1),e<6?t.set(e,8,n,!0):e<8?t.set(e+1,8,n,!0):t.set(s-15+e,8,n,!0),e<8?t.set(8,s-e-1,n,!0):e<9?t.set(8,15-e-1+1,n,!0):t.set(8,15-e-1,n,!0);t.set(s-8,8,1,!0);}static setupData(t,e){const i=t.cols;let s=-1,r=i-1,n=7,a=0;for(let o=i-1;o>0;o-=2)for(6===o&&o--;;){for(let i=0;i<2;i++)if(!t.isReserved(r,o-i)){let s=!1;a<e.length&&(s=1==(e[a]>>>n&1)),t.set(r,o-i,s),n--,-1===n&&(a++,n=7);}if(r+=s,r<0||i<=r){r-=s,s=-s;break}}}static createData(t,e,i,s){i||(i=new Ft),s.forEach((function(e){i.put(e.mode.bit,4),i.put(e.getLength(),Yt.getCharCountIndicator(e.mode,t)),e.write(i);}));const r=8*(Lt.getSymbolTotalCodewords(t)-(Wt.getTotalCodewordsCount(t,e)||0));for(i.getLengthInBits()+4<=r&&i.put(0,4);i.getLengthInBits()%8!=0;)i.putBit(0);const n=(r-i.getLengthInBits())/8;for(let t=0;t<n;t++)i.put(t%2?17:236,8);return this.createCodewords(i,t,e)}static createCodewords(t,e,i){const s=Lt.getSymbolTotalCodewords(e),r=Wt.getTotalCodewordsCount(e,i);if(!r)return;const n=s-r,a=Wt.getBlocksCount(e,i);if(!a)return;const o=a-s%a,h=Math.floor(s/a),c=Math.floor(n/a),l=c+1,d=h-c,u=new se(d);let g=0;const p=new Array(a),m=new Array(a);let f=0;const P=new Uint8Array(t.buffer);for(let t=0;t<a;t++){const e=t<o?c:l;p[t]=P.slice(g,g+e),m[t]=u.encode(p[t]),g+=e,f=Math.max(f,e);}const C=new Uint8Array(s);let b,y,A=0;for(b=0;b<f;b++)for(y=0;y<a;y++)b<p[y].length&&(C[A++]=p[y][b]);for(b=0;b<d;b++)for(y=0;y<a;y++)C[A++]=m[y][b];return C}static create(t){let e=null===t.text||void 0===t.text?t.content:t.text;if(null==e||""===e)return;e=String(e);const i="number"==typeof t.eccLevel?t.eccLevel:Mt.Middle;let s="number"==typeof t.version?t.version:0,r="number"==typeof t.qrMask?t.qrMask:0;"function"==typeof t.toSJISFunc&&(Lt.toSJISFunction=t.toSJISFunc);const n=new Ft;let a="number"==typeof t.waterMarkMode?t.waterMarkMode:-1;const o=t.waterMarkSeed||0;if(a>=0){a=a>3?3&Date.now():a;const t=this.getWaterSeedCheckSum(e,a,o);this.appendDtWaterMark(a,t,n);}let h=s;if(s<=0){const t=ue.rawSplit(e);h=pe.getBestVersionForData(n,t,i)||0;}const c=ue.fromString(e,h||40),l=pe.getBestVersionForData(n,c,i);if(!l)throw new Error("The amount of data is too big to be stored in a QR Code");if(s<=0)s=l;else if(s<l)throw new Error("\nThe chosen QR Code version cannot contain this amount of data.\nMinimum version required to store current data is: "+l+".\n");const d=this.createData(s,i,n,c);if(!d)return;const u=Lt.getSymbolSize(s),g=new f(u,u);return this.setupFinderPattern(g,s),this.setupTimingPattern(g),this.setupAlignmentPattern(g,s),this.setupFormatInfo(g,i,0),s>=7&&this.setupVersionInfo(g,s),this.setupData(g,d),r<=0&&(r=Ht.getBestMask(g,this.setupFormatInfo.bind(null,g,i))),Ht.applyMask(r,g),this.setupFormatInfo(g,i,r),g}static getWaterSeedCheckSum(t,e,i){const s=3&e;let r=this.sDtWaterMarkCheckSums[s];r=r+(i=Lt.calcWaterMarkSeed(i))&1048575;const n=b.getBytes_Utf8(t);for(let t=0;t<n.length;++t)r+=r>>>5,r+=(255&n[t])*(2&t?5:3),r+=1&t?13:11;return r=r%1019+3,r}static appendDtWaterMark(t,e,i){e=53248|(3&t)<<10|1023&e,this.appendStructuredAppend(e>>>8,255&e,i);}static appendStructuredAppend(t,e,i){this.appendModeInfo(Yt.STRUCTURED,i),i.put(t,8),i.put(e,8);}static appendModeInfo(t,e){e.put(t.bit,4);}}fe.sDtWaterMarkCheckSums=[197,257,571,991];const Pe=Object.freeze({Auto:"auto",QRCode:"qrcode",PDF417:"pdf417",DMCode:"dataMatrix",GMCode:"gridMatrix"});class Ce{static getEncoder(t){if(!t)return;t=t.toUpperCase();const e=this.barcodeCreatorMap[t];return d.log(`---- getBarcode2DEncoder[${t}]: ${!!e}`),e}static setEncoder(t,e){return !(!t||!e||"function"!=typeof e.encode||(t=t.toUpperCase(),d.log(`---- setBarcode2DEncoder[${t}]:`),this.barcodeCreatorMap[t]=e,0))}static checkAndRegisterEncodeModule(t){if(!t||!window)return;const e=window;let i;if((t=t.toUpperCase())===Pe.PDF417.toUpperCase()?i=e.DzPdf417:t===Pe.DMCode.toUpperCase()?i=e.DzDataMatrix:t===Pe.GMCode.toUpperCase()&&(i=e.DzGridMatrix),i){if("function"==typeof i.getInstance){const e=i.getInstance();return this.setEncoder(t,e),e}return "function"==typeof i.register?(i.register(this.getInstance()),this.getEncoder(t)):void 0}}static getInstance(){return this._instance||(this._instance=new Ce)}static createQRCode(t){return fe.create(t)}static create2DBarcode(t){const e=t.barcodeType||t.type;let i;return e&&(i=this.getEncoder(e),i||(i=this.checkAndRegisterEncodeModule(e))),null!==t.text&&void 0!==t.text||(t.text=t.content),i?i.encode(t):fe.create(t)}static createPDF417(t){return t.barcodeType||(t.barcodeType=Pe.PDF417),this.create2DBarcode(t)}static createDataMatrix(t){return t.barcodeType||(t.barcodeType=Pe.DMCode),this.create2DBarcode(t)}static createGridMatrix(t){return t.barcodeType||(t.barcodeType=Pe.GMCode),this.create2DBarcode(t)}static drawQrcode(t,e){const i=fe.create(Object.assign(Object.assign({},e),{eccLevel:Mt.Middle})),s=e.width||t.width;if(i){const e=new g({canvas:t});e.startJob({width:s}),e.drawQrcode({data:i,width:s});}}register(t){return !!t&&Ce.setEncoder(t.barcodeType,t)}}Ce.barcodeCreatorMap={};class be{constructor(t,e,i){if(this.contentLeft="",this._currValue=0,this.currLength=0,this.contentRight="",this.degreeOffset=0,this.maxDegreeValue=0,!t)return;e=e||1,i=i||0;let s=-1,r=-1;for(r=t.length-1;r>=0&&!C.isDigit(t.charCodeAt(r));r--);if(!(r<0)){for(s=r-1;s>=0&&C.isDigit(t.charCodeAt(s))&&!(r-s>=be.MaxDegreeLength);s--);s++,this._currValue=parseInt(t.substring(s,r+1)),this.maxDegreeValue=Number.MAX_VALUE,this.contentLeft=t.substring(0,s),this.contentRight=t.substring(r+1),this.currLength=i>0?i:r-s+1,this.degreeOffset=e||0;}}get IsValid(){return 0!=this.degreeOffset}get CurrValue(){return this._currValue}set CurrValue(t){t>be.MaxDegreeValue?this._currValue=be.MaxDegreeValue:this._currValue=t<0?0:t;}step(t){return this.CurrValue+=this.degreeOffset*t,this.toString()}get ShownDegree(){if(this.IsValid){let t=this.CurrValue||0;const e=t<0?"-":"";t=Math.abs(t);const i=t.toFixed();return `${e}${i.length<this.currLength?C.repeatChar("0",this.currLength-i.length):""}${i}`}return ""}toString(){return this.IsValid?this.contentLeft+this.ShownDegree+this.contentRight:""}}be.MaxDegreeLength=15,be.MaxDegreeValue=Math.pow(10,be.MaxDegreeLength)-1,be.MaxDegreeOffset=Math.pow(10,be.MaxDegreeLength-1);class ye{get Text(){return this.text}constructor(){this.keyGroup=[],this.text="";}setKeyWordAction(t){this.keyWordAction=t;}setKeys(t){if(!t)return;t=t.replace(/\\n/g,"\n"),this.text=t;const e=[];let i=0;for(let s=0,r=0,n=!1;s<t.length;s++){const a=t.charAt(s);"["===a?(n=!0,r=s):"]"===a&&n&&(n=!1,e.push({text:t.substring(i,r)}),e.push({text:t.substring(r+1,s),isKey:!0}),i=s+1);}i<t.length&&e.push({text:t.substr(i),isKey:e.length<1}),this.keyGroup=e;}hasKeyWord(){return !!this.keyGroup.find((t=>t.isKey))}toString(t){const e=[];let i=!1;if(!this.keyWordAction)return t||this.text;for(const t of this.keyGroup)if(t.isKey){const s=this.keyWordAction(t.text);void 0!==s&&(e.push(s||""),i=!0);}else e.push(t.text);return !i&&t?t:e.join("")}}const Ae=Object.freeze({text:"text",barcode:"barcode",qrcode:"qrcode",pdf417:"pdf417",dataMatrix:"dataMatrix",data_matrix:"datamatrix",gridMatrix:"gridMatrix",grid_matrix:"gridmatrix",image:"image",rect:"rect",rectangle:"rectangle",ellipse:"ellipse",circle:"circle",line:"line",table:"table",arcText:"arcText",arc_text:"arctext",html:"html"});class Re{static Pix2MM(t,e){return 25.4*t/e}static MM2Pix(t,e){return t*e/25.4}static isPreviewJobName(t){return !!t&&((t=t.toLowerCase()).startsWith(this.JOB_NAME_PREV.substring(0,7))||t.startsWith(this.JOB_NAME_TRANS.substring(0,8)))}static isTransPrevJob(t){return !!t&&t.toLowerCase().startsWith(this.JOB_NAME_TRANS.substring(0,8))}static isWhitePrevJob(t){return !!t&&t.toLowerCase().startsWith(this.JOB_NAME_PREV.substring(0,7))}static calcPageHeight(t,e){return ("number"!=typeof e||e<=0)&&(e=0),t.reduce(((t,e)=>{const i=(e.y||0)+(e.height||e.fontHeight||0);return i>t?i:t}),0)+(e>0?e:2)}static getJobStartOptions(t,i){const s=i||{};let r="number"==typeof s.printerDPI?s.printerDPI:t.printerDpi;"number"!=typeof r&&("number"==typeof t.dpi&&t.dpi>0?r=t.dpi:"number"==typeof t.printerDPI&&t.printerDPI>0&&(r=t.printerDPI));const n="number"==typeof s.printerWidth?s.printerWidth:t.printerWidth;return Object.assign(Object.assign({},t),{backgroundImage:t.background,borderImage:t.border,dpi:r,printerDpi:r,printerWidth:n,svgViewBox:"string"==typeof t.svgViewBox?e.parseRect(t.svgViewBox):t.svgViewBox,color:t.drawColor})}static loadImageSrc(t){d.log("#### 【DrawContext.loadImage】src:");const e="string"==typeof t?t:t.src;return d.log(e.length>100?e.substring(0,100)+"...":e),new Promise((t=>{try{if(e){const i=new Image;i.crossOrigin="anonymous",i.src=e,i.onload=()=>{t(i);},i.onerror=e=>{d.warn(e),t(null);};}else d.warn("【DrawContext.CreateImage: src不能为空!"),t(null);}catch(e){d.warn(e,"#### 【【DrawContext.loadImage.catch】 图片加载异常，error:"),t(null);}}))}static html2ImageSrc(t){return t?`data:image/svg+xml,\n<svg xmlns='http://www.w3.org/2000/svg'>\n<foreignObject width='100%' height='100%'>\n<div xmlns='http://www.w3.org/1999/xhtml' style='font-size:16px;font-family:Helvetica'>${t}</div>\n</foreignObject>\n</svg>`:t}static html2Image(t){const e=Re.html2ImageSrc(t);return Re.loadImageSrc(e)}static loadSvgContent(t){const e=new Blob([t],{type:"image/svg+xml"});return new Promise((i=>{const s=new FileReader;s.onload=t=>{var e;i(null===(e=t.target)||void 0===e?void 0:e.result);},s.onerror=e=>{d.warn(e,`---- failed to load svg: '${t.substring(0,50)}...'`),i(void 0);},s.readAsDataURL(e);}))}static getMargins(t){const e="number"==typeof t.margin&&t.margin>=0?t.margin:0,i="number"==typeof t.marginH&&t.marginH>=0?t.marginH:e,s="number"==typeof t.marginV&&t.marginV>=0?t.marginV:e,r=[];return r[0]="number"==typeof t.marginTop?t.marginTop:s,r[1]="number"==typeof t.marginRight?t.marginRight:i,r[2]="number"==typeof t.marginBottom?t.marginBottom:s,r[3]="number"==typeof t.marginLeft?t.marginLeft:i,r}get Context(){return this.cvs.Base.Context}get CanvasElement(){return this.cvs.Base.Canvas}get Canvas(){return this.cvs}get Dpi(){return this.cvs.Dpi}set Dpi(t){this.cvs.Dpi=t;}get IsPreviewMode(){return this.previewMode}get JobInfo(){return this.jobOptions}get Width(){return this.jobWidth}get Height(){return this.jobHeight}get Orientation(){return this.jobOrientation||0}get JobName(){var t;return null===(t=this.jobOptions)||void 0===t?void 0:t.jobName}get ZoomRate(){return this.Canvas.DPM}set ZoomRate(t){t<this.mMinZoomRate&&(t=this.mMinZoomRate),t>this.mMaxZoomRate&&(t=this.mMaxZoomRate);const e=this.Canvas.DPM;t!==e&&(this.Canvas.DPM=t,this.CanvasElement.style&&(this.CanvasElement.style.borderRadius=.5*t+"px"),this.onZoomRateChanged(t,e));}get PixWidth(){return this.Canvas.DPM*this.Width}get PixHeight(){return this.Canvas.DPM*this.Height}get Foreground(){return this.Canvas.Foreground}set Foreground(t){(t||"").match(/^([A-Fa-f0-9]{3}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/)&&(t=`#${t}`),this.Canvas.Foreground=t;}get Background(){return this.cvs.Base.Background}get IsApiMode(){return this.Canvas.Base.IsApiMode}set IsApiMode(t){this.Canvas.Base.IsApiMode=t;}constructor(t){this.previewMode=!0,this.jobWidth=0,this.jobHeight=0,this.jobOrientation=0,this.mMinZoomRate=.5,this.mMaxZoomRate=40;const e="boolean"==typeof t?{previewMode:t}:t||{};e.creator||(e.creator=()=>this.createCanvas()),"function"!=typeof e.onCanvasClear&&(e.onCanvasClear=(t,e)=>{this.onCanvasClear(t,e);}),this.cvs=new p(e),this.mKeyWordParser=new ye,"boolean"==typeof e.previewMode&&(this.previewMode=e.previewMode);}onZoomRateChanged(t,e){}createCanvas(){return d.log("---- DrawContext.createCanvas:"),null===document||void 0===document?void 0:document.createElement("canvas")}onCanvasClear(t,e){d.log("---- onCanvasClear:");}loadImage(t){return Re.loadImageSrc(t)}loadHtml(t){const e=Re.html2ImageSrc(t);return this.loadImage(e)}setMaxZoomRate(t){t>0&&(this.mMaxZoomRate=t);}setMinZoomRate(t){t>0&&(this.mMinZoomRate=t);}setOffset(t,e){switch(this.Orientation){case 1:case 90:this.Canvas.OffsetX=e,this.Canvas.OffsetY=-t;break;case 2:case 180:this.Canvas.OffsetX=-t,this.Canvas.OffsetY=-e;break;case 3:case 270:this.Canvas.OffsetX=-e,this.Canvas.OffsetY=t;break;default:this.Canvas.OffsetX=t,this.Canvas.OffsetY=e;}}save(){this.Canvas.Base.Context.save();}restore(){this.Canvas.Base.Context.restore();}setItemOrientation(t){return this.Canvas.Base.ItemOrientation=t,!0}setItemHorizontalAlignment(t){return this.Canvas.Base.HorizontalAlign=t,!0}setItemVerticalAlignment(t){return this.Canvas.Base.VerticalAlign=t,!0}setFontName(t){this.Canvas.setFontName(t);}setFontHeight(t){this.Canvas.setFontHeight(t);}setLineWidth(t){this.Canvas.setLineWidth(t);}setLineSpace(t){return this.Canvas.setLineSpace(t),!0}setCharSpace(t){return this.Canvas.setCharSpace(t),!0}setAutoTextLine(t){this.Canvas.Base.AutoReturn=t;}setRotation(t,e,i){return this.Canvas.setRotation(t>3?t:90*t,e,i),!0}setBorderAlign(t){this.Canvas.Base.BorderAlign=t;}resetJobInfo(t){"number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.dpi&&(t.dpi=t.printerDpi),"number"!=typeof t.dpi&&(t.dpi=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),this.jobOptions=t,this.jobWidth=t.width>0?t.width:0,this.jobWidth<=0&&t.dpi>0&&t.printerWidth>0&&(this.jobWidth=t.printerWidth/t.dpi*25.4),this.jobHeight=t.height>0?t.height:t.width,this.jobOrientation=t.orientation||0,this.Canvas.Base.ItemOrientation=0,this.Canvas.Base.HorizontalAlign=0,this.Canvas.Base.VerticalAlign=0;}poundToMm(t){return 25.4*t/72}mmToPound(t){return 72*t/25.4}isPrintJob(){return this.jobOptions&&this.jobOptions.printMode||!1}startJob(t){if((t=t||{}).width||(t.width=t.jobWidth||t.labelWidth),t.height||(t.height=t.jobHeight||t.labelHeight),"number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),"number"!=typeof t.printerWidth&&(t.printerWidth=0),t.width<=0&&t.printerWidth<=0)return;this.IsApiMode?("boolean"!=typeof t.printMode&&(t.printMode=!Re.isPreviewJobName(t.jobName)),t.printMode||(t.backgroundColor||(Re.isTransPrevJob(t.jobName)?t.backgroundColor=Re.JOB_COLOR_TRANS:t.backgroundColor=Re.JOB_COLOR_WHITE),t.color||(t.color=g.COLOR_FG_DEFAULT))):"boolean"!=typeof t.printMode&&(t.printMode=!this.previewMode),this.resetJobInfo(Object.assign({},t));const e=this.Canvas.startJob(t);return e?(t.borderImage&&("string"==typeof t.borderImage?this.drawImage({image:t.borderImage,width:t.width,height:t.height}):this.drawBorderImage({image:t.borderImage,svgElement:t.svgElement,borderScale:t.borderScale,tileMode:!t.svgElement,svgWidth:t.svgWidth,svgHeight:t.svgHeight,svgViewBox:t.svgViewBox})),Object.assign({},t,{canvas:e.Canvas,context:e.Context,isPreview:!t.printMode})):void 0}endJob(){const t=this.jobOptions;if(!t)return;const e=this.Canvas.commitJob();if(!e)return;const i=this.IsApiMode,s=Object.assign({},t,{canvas:e.Canvas,context:e.Context,isPreview:!t.printMode,apiMode:i});return i&&(t.printMode?(t.antiColor&&this.Canvas.inverseColors(),t.horizontalFlip&&this.Canvas.horizontalFlip(),s.imageData=e.getImageData(),s.dataUrl=t.withDataUrl?e.Canvas.toDataURL():""):(s.dataUrl=e.Canvas.toDataURL(),s.imageData=t.withImageData?e.getImageData():void 0)),s}commitJob(){return Promise.resolve(this.endJob())}drawLine(t){return "number"!=typeof t.lineWidth&&(t.lineWidth=Re.LINE_WIDTH_MM),this.Canvas.drawLine(t)}drawLines(t,e,i,s,r,n,a){n=n||[],a=a||[];let o=0;this.drawLine({x1:t,y1:e,x2:i,y2:s,lineWidth:r});for(let a=0;a<n.length;a++)o+=n[a],this.drawLine({x1:t,y1:e+o,x2:i,y2:s+o,lineWidth:r});o=0;for(let n=0;n<a.length;n++)o+=a[n],this.drawLine({x1:t+o,y1:e,x2:i+o,y2:s,lineWidth:r});}drawRect(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Re.LINE_WIDTH_MM),this.Canvas.drawRect(t)}drawRectangle(t){return this.drawRect(t)}fillRect(t){return this.Canvas.drawRect(Object.assign(Object.assign({},t),{fill:!0}))}drawRoundRect(t){t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Re.LINE_WIDTH_MM),this.Canvas.drawRoundRect(t);}drawEllipse(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Re.LINE_WIDTH_MM),this.Canvas.drawEllipse(t)}drawCircle(t){return t.fill||"number"==typeof t.lineWidth||(t.lineWidth=Re.LINE_WIDTH_MM),this.Canvas.drawCircle(t)}drawText(t){return !t.fontHeight&&t.fontSize&&(t.fontHeight=this.poundToMm(t.fontSize)),t.fontHeight||(t.fontHeight=this.Canvas.getFontHeight()),t.fontHeight<2&&(t.fontHeight=2),this.Canvas.drawText(t)}drawArcText(t){return !t.fontHeight&&t.fontSize&&(t.fontHeight=this.poundToMm(t.fontSize)),this.Canvas.drawArcText(t)}splitText(t){return this.Canvas.splitText(t)}measureText(t){return this.Canvas.measureText(t)}measureFontSize(t){return this.Canvas.measureFontSize(t)}draw1DMatrix(t){return !!t.datas&&this.Canvas.draw1DBarcode(t)}drawBarcode(t){return "string"==typeof t.barcodeType&&t.barcodeType?this.draw2DBarcode(t):this.draw1DBarcode(t)}draw1DBarcode(t){const e=Ot.create1DBarcode(t);return t.barcodeType===y.ISBN&&(t.textFlag=2),!!e&&this.draw1DMatrix(Object.assign(t,{datas:e.items}))}draw2DBarcode(t){const e=Ce.create2DBarcode(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e}))}draw2DMatrix(t){return !!t.data&&this.Canvas.draw2DBarcode(t)}drawQRCode(t){const e=Ce.create2DBarcode(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DQRCode(t){return this.drawQRCode(t)}drawPDF417(t){const e=Ce.createPDF417(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DPdf417(t){return this.drawPDF417(t)}drawDataMatrix(t){const e=Ce.createDataMatrix(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DDataMatrix(t){return this.drawDataMatrix(t)}drawGridMatrix(t){const e=Ce.createGridMatrix(t);return !!e&&this.draw2DMatrix(Object.assign(Object.assign({},t),{data:e,margin:"number"==typeof t.margin?t.margin:void 0}))}draw2DGridMatrix(t){return this.drawGridMatrix(t)}drawImage(t){if(t.image){const e=t.image;return e.dzSrc&&(t.image=e.dzSrc),this.Canvas.drawImage(t)}return !1}drawImageResizeLabel(t){return this.Canvas.drawImageResizeLabel(t)}drawBorderImage(t){const e=t.image;if(!e||"string"==typeof e)return;const i=t.svgElement,s="boolean"==typeof t.svgMode?t.svgMode:!!i;let r=e.width||t.imageWidth||0,n=e.height||t.imageHeight||0;if(i){d.log("---- SVG 图片适配:");const i=t.svgViewBox,s=t.svgWidth,a=t.svgHeight,o=this.Canvas.CanvasWidth,h=this.Canvas.CanvasHeight;if(s&&s>0||a&&a>0)r||(r=s||a||0),n||(n=a||s||0);else {let t=r,s=n;i&&(t=i.width,s=i.height),t&&s?t/s>o/h?(r=o,n=o*s/t):(n=h,r=t*h/s):r=n=Math.min(o,h),"string"!=typeof e&&(e.width=r,e.height=n);}}if(!r||!n)return void d.warn("---- drawBorderImage.fail: [无法获取图片大小]！");const a=r/3,o=n/3;this.Canvas.drawImageResizeLabel({img:e.dzSrc||e,left:a,top:o,right:e.width-a,bottom:e.height-o,tileMode:!s&&t.tileMode,relativeScale:s?t.borderScale||1:void 0,imageWidth:r,imageHeight:n});}drawItem(t,e,i){const s=t;if(t.color){const e=this.JobInfo;this.IsApiMode&&(null==e?void 0:e.printMode)?t.color=void 0:this.IsPreviewMode||(t.color=void 0);}const r=t.type&&"string"==typeof t.type?t.type.toLowerCase():Ae.text,n="number"==typeof s.contentType?s.contentType:e?2:0;if(2===n&&e){let t;!s.columnName&&s.dataColumnName&&(s.columnName=s.dataColumnName),s.columnName?(this.mKeyWordParser.setKeys(s.columnName),t=this.mKeyWordParser.hasKeyWord()?this.mKeyWordParser.toString(s.text):e[s.columnName]):s.text&&s.text.indexOf("[")>=0&&(this.mKeyWordParser.setKeys(s.text),this.mKeyWordParser.hasKeyWord()&&(t=this.mKeyWordParser.toString(s.text))),void 0!==t&&(s.text=t);}else if(1===n&&i&&i>0){const e=t;e.rawText||(e.rawText=e.text);const s=e.rawText||"",r=new be(s,e.degreeOffset,e.degreeLength);r.IsValid&&(e.text=r.step(i));}switch("number"==typeof t.horAlignment&&"number"!=typeof t.horizontalAlignment&&(t.horizontalAlignment=t.horAlignment),"number"==typeof t.verAlignment&&"number"!=typeof t.verticalAlignment&&(t.verticalAlignment=t.verAlignment),"boolean"==typeof t.filled&&"boolean"!=typeof t.fill&&(t.fill=t.filled),r){case Ae.text:return this.drawText(t);case Ae.barcode:return this.draw1DBarcode(t);case Ae.qrcode:return this.drawQRCode(t);case Ae.pdf417:return this.drawPDF417(t);case Ae.data_matrix:return this.drawDataMatrix(t);case Ae.grid_matrix:return this.drawGridMatrix(t);case Ae.image:return this.drawImage(t);case Ae.rect:case Ae.rectangle:return this.drawRect(t);case Ae.ellipse:return this.drawEllipse(t);case Ae.circle:return this.drawCircle(t);case Ae.arc_text:return this.drawArcText(t);case Ae.line:return this.drawLine(t);case Ae.table:return this.drawTable(t,e,i);default:return d.warn(`---- 不支持的 DrawType: ${t.type}`),!1}}static getUnionRectOfRelateRect(t,i,s){for(const r of i)r!==t?e.hasIntersection(t,r)&&(s&&s.push(r),t=e.getUnionRect(t,r)):s&&s.push(r);return t}static shrinkCellContent(t,e){return {x:t.x+e,y:t.y+e,width:t.width-2*e,height:t.height-2*e}}drawTableWithoutRotation(t,i,s){!t.tableRows&&Array.isArray(t.rows)&&(t.tableRows=t.rows);const r=t.width||0,n=t.height||0,a=t.tableRows||[];if(r<=0||n<=0||a.length<=0)return !1;"number"!=typeof t.lineWidth&&(t.lineWidth=Re.LINE_WIDTH_MM);const o=t.lineWidth>0?t.lineWidth:0,h=t.cellPadding||0,c=.5*o,l="number"==typeof t.horizontalAlignment?t.horizontalAlignment:1,d="number"==typeof t.verticalAlignment?t.verticalAlignment:1,u=t.x||0,g=t.y||0;let p="number"==typeof t.rowCount&&t.rowCount>0?t.rowCount:0,m="number"==typeof t.columnCount&&t.columnCount>0?t.columnCount:0;p<=0&&(p="number"==typeof t.rows&&t.rows>0?t.rows:a.length),m<=0&&(m="number"==typeof t.columns&&t.columns>0?t.columns:a.reduce(((t,e)=>e&&e.length>t?e.length:t),0));let f=Array(m).fill(.5);t.columnWidths&&t.columnWidths.length>1?f=t.columnWidths:("string"==typeof t.colWidth&&t.colWidth&&(t.colWidth=t.colWidth.split(",")),Array.isArray(t.colWidth)&&t.colWidth.length>1&&(f=t.colWidth.map((t=>t?Number(t):0)))),f.length>m?f=f.slice(0,m):f.length<m&&(f=f.concat(Array(m-f.length).fill(f[f.length-1]))),f=f.map((t=>t>0?t:.5));const P=f.filter((t=>t>1)).reduce(((t,e)=>t+e),0),C=f.filter((t=>t<=1)).reduce(((t,e)=>t+e),0);C>0?f=f.map((t=>t>1?t:(r-P)/C*t)):P!==r&&(f=f.map((t=>t/P*r)));let b=Array(p).fill(.5);t.rowHeights&&t.rowHeights.length>1?b=t.rowHeights:("string"==typeof t.rowHeight&&t.rowHeight&&(t.rowHeight=t.rowHeight.split(",")),Array.isArray(t.rowHeight)&&t.rowHeight.length>1&&(b=t.rowHeight.map((t=>t?Number(t):0)))),b.length>p?b=b.slice(0,p):b.length<p&&(b=b.concat(Array(p-b.length).fill(b[b.length-1]))),b=b.map((t=>t>0?t:.5));const y=b.filter((t=>t>1)).reduce(((t,e)=>t+e),0),A=b.filter((t=>t<=1)).reduce(((t,e)=>t+e),0);A>0?b=b.map((t=>t>1?t:(n-y)/A*t)):y!==n&&(b=b.map((t=>t/y*n)));let R=t.groups||[];if("string"==typeof t.group&&(R=t.group.split(";").map((t=>{const e=t.split(",").map((t=>t[0]>="0"&&t[0]<="9"?Number(t):0));return e.length>3?{x:e.length>1?e[1]-1:0,y:e.length>0?e[0]-1:0,width:e.length>3?e[3]-e[1]+1:0,height:e.length>2?e[2]-e[0]+1:0}:void 0})).filter((t=>!!t))),a.forEach(((t,e)=>{for(let i=0;i<m;i++){const s=t[i];if("object"==typeof s){const t=s.rowSpan||0,r=s.columnSpan||s.colSpan||0;(t>1||r>1)&&R.push({x:i,y:e,width:r>1?r:1,height:t>1?t:1});}}})),R.length>1){const t=R.slice(0);R.splice(0);const e=[];for(const i of t){if(e.indexOf(i)>=0)continue;const s=Re.getUnionRectOfRelateRect(i,t,e);R.push(s);}}o>0&&this.drawRect({x:t.x,y:t.y,width:t.width,height:t.height,lineWidth:o});for(let r=0,n=0;r<p;n+=b[r],r++){const P=a[r]||[];for(let a=0,C=0;a<m;C+=f[a],a++){const y={x:a,y:r,width:1,height:1},A=R.filter((t=>e.isInnerRect(y,t))).shift();if(A){if(y.x!==A.x||y.y!==A.y)continue;y.width=A.width,y.height=A.height;}const E=(t,e)=>(t||0)+e,I={x:u+C,y:g+n,width:y.width>0?f.slice(y.x,y.x+y.width).reduce(E,0):f[y.x],height:y.height>0?b.slice(y.y,y.y+y.height).reduce(E,0):b[y.y]};y.x>0&&o>0&&this.drawLine({x1:I.x,x2:I.x,y1:I.y+(y.y<=0?c:0),y2:I.y+I.height-(y.y+y.height>=p?c:0),lineWidth:o}),y.y>0&&o>0&&this.drawLine({x1:I.x+(y.x<1?c:0),x2:I.x+I.width-(y.x+y.width>=m?c:0),y1:I.y,y2:I.y,lineWidth:o});const x=P[a];if(void 0!==x){let e=x;"object"!=typeof x&&(e={type:Ae.text,text:x}),e.type||(e.type=Ae.text);const r=e;"number"!=typeof r.horizontalAlignment&&(r.horizontalAlignment="number"==typeof r.horAlignment?r.horAlignment:l),"number"!=typeof r.verticalAlignment&&(r.verticalAlignment="number"==typeof r.verAlignment?r.verAlignment:d);let n=c+h;if(e.type===Ae.text){const i=e;i.fontHeight||(i.fontHeight=t.fontHeight||.3*I.height),!i.fontName&&t.fontName&&(i.fontName=t.fontName),"number"!=typeof i.fontStyle&&"number"==typeof t.fontStyle&&(i.fontStyle=t.fontStyle),h<=0&&(n=c+1);}else e.type===Ae.qrcode&&h<=0&&(n=c+1);this.drawItem(Object.assign(e,Re.shrinkCellContent(I,n)),i,s);}}}return !0}drawTable(t,e,i){let s=t.x||0,r=t.y||0,n=t.width||0,a=t.height||0;if(!this.jobOptions)return !1;let o=Array.isArray(t.margin)?t.margin[0]:t.margin,h=Array.isArray(t.margin)?t.margin[1]:o;if(n<=0){const e=this.jobWidth;o="number"==typeof o&&o>=0?o:.05*e,s=t.x="number"==typeof t.x?t.x:o,n=t.width=e-s-o;}if(a<=0){const e=this.jobHeight;h="number"==typeof h&&h>=0?h:.05*e,r=t.y="number"==typeof t.y?t.y:h,a=t.height=e-r-h;}const c=t.columnCount||t.columns||t.cols||0;if(t.Cells&&Array.isArray(t.Cells)&&!t.cells&&(t.cells=t.Cells,delete t.Cells),!t.tableRows)if(Array.isArray(t.rows))t.tableRows=t.rows;else if(t.cells&&c>0){t.tableRows=[];for(let e=0;e<t.cells.length;e+=c)t.tableRows.push(t.cells.slice(e,e+c));}if(!t.tableRows||t.tableRows.length<=0)return !1;t.fontSize&&!t.fontHeight&&(t.fontHeight=this.poundToMm(t.fontSize)),this.save(),this.setRotation(t.orientation||0,{x:s,y:r},{width:n,height:a});const l=this.drawTableWithoutRotation(t,e,i);return this.restore(),l}printPageGroup(t,e){const i=t.jobPages||[],s=t.jobArguments||[],r={printCopies:1,copyIndex:0,printPages:1,pageIndex:0},n=t.jobInfo||{},a=t.printerInfo||{},o=Re.getJobStartOptions(n,a),h=n.jobHeight||0,c=Re.getMargins(n);let l=0;const d=n.startPage&&n.startPage>0?n.startPage:0,u=n.printPages||0;if(s.length>0||u>1&&i.length<=1){const t=s.length>0?s.length:d+u;let n=t;u>0&&(n=d+u>t?t:d+u),h<=0&&(o.height=Re.calcPageHeight(i[0],c[2]));for(let t=d;t<n;t++){const a=s[t];if(r.printPages=n,r.pageIndex=t,!this.startJob(Object.assign({},o)))break;this.mKeyWordParser.setKeyWordAction((t=>a[t]));for(const e of i[0])this.drawItem(e,a,t);const h=this.endJob();if(!h)break;const c=e(Object.assign(h,r));if("number"==typeof c&&(l=c),l>0)break;l<0&&t--;}}else {let t=i.length;u>0&&(t=d+u>i.length?i.length:d+u);for(let s=d;s<t;s++){r.printPages=t,r.pageIndex=s,h<=0&&(o.height=Re.calcPageHeight(i[s],c[2]));const n=i[s];if(!this.startJob(Object.assign({},o)))break;for(const t of n)this.drawItem(t);const a=this.endJob();if(!a)break;const d=e(Object.assign(a,r));if("number"==typeof d&&(l=d),l>0)break;l<0&&s--;}}return l}printAsyncPageGroup(t,e){return m(this,void 0,void 0,(function*(){const i=t.jobPages||[],s=t.jobArguments||[],r={printCopies:1,copyIndex:0,printPages:1,pageIndex:0},n=t.jobInfo||{},a=t.printerInfo||{},o=Re.getJobStartOptions(n,a),h=n.jobHeight||0,c=Re.getMargins(n);let l=0,d=n.startPage&&n.startPage>0?n.startPage:0;const u=n.printPages||0;if(s.length>0||u>1&&i.length<=1){const t=s.length>0?s.length:d+u;let n=t;u>0&&(n=d+u>t?t:d+u),d>=n&&(d=n-1),h<=0&&(o.height=Re.calcPageHeight(i[0],c[2]));for(let t=d;t<n;t++){const a=s[t];if(r.printPages=n,r.pageIndex=t,r.isEndPage=t+1>=n,!this.startJob(Object.assign({},o)))break;this.mKeyWordParser.setKeyWordAction((t=>a[t]));for(const e of i[0])this.drawItem(e,a,t);const h=yield this.commitJob();if(!h)break;const c=yield e(Object.assign(h,r));if("number"==typeof c&&(l=c),l>0)break;l<0&&t--;}}else {let t=i.length;u>0?t=d+u>i.length?i.length:d+u:i.length<=1&&d>0&&(d=0);for(let s=d;s<t;s++){r.printPages=i.length,r.pageIndex=s,r.isEndPage=s+1>=i.length,h<=0&&(o.height=Re.calcPageHeight(i[s],c[2]));const t=i[s];if(!this.startJob(Object.assign({},o)))break;for(const e of t)this.drawItem(e);const n=yield this.commitJob();if(!n)break;const a=yield e(Object.assign(n,r));if("number"==typeof a&&(l=a),l>0)break;l<0&&s--;}}return l}))}drawJob(t){d.log("#### drawJob:"),t.jobPages||(t.jobPages=[]);const e=t.jobInfo||{},i=e.startCopy||0,s=e.remainCopies||0;let r=0;if(t.jobPages.length<=0&&t.jobPage&&t.jobPages.push(t.jobPage),t.jobPages.length<=0)return r=1,r;const n=e.printCopies&&e.printCopies>0?e.printCopies:1;if(n>1&&e.autoPage){for(let e=0;e<n&&(r=this.printPageGroup(t,(r=>t.onPageComplete?(r.printCopies=n+i+s,r.copyIndex=e+i,r.isEndCopy=e+1>=n,t.onPageComplete(r)||0):0)),0===r);e++);return r}return this.printPageGroup(t,(e=>(t.onPageComplete&&(r=t.onPageComplete(Object.assign(Object.assign({},e),{printCopies:n+i+s,copyIndex:i,isEndCopy:!0}))||0),r)))}drawAsyncJob(t){return m(this,void 0,void 0,(function*(){d.info("#### drawAsyncJob:"),t.jobPages||(t.jobPages=[]);const e=t.jobInfo||{},i=e.startCopy||0,s=e.remainCopies||0;let r=0;if(t.jobPages.length<=0&&t.jobPage&&t.jobPages.push(t.jobPage),t.jobPages.length<=0)return r=1,r;const n=e.printCopies&&e.printCopies>0?e.printCopies:1;if(n>1&&e.autoPage){for(let e=0;e<n&&(r=yield this.printAsyncPageGroup(t,(r=>{var a;return t.onPageComplete?(r.printCopies=n+i+s,r.copyIndex=e+i,r.isEndCopy=e+1>=n,Promise.resolve(null!==(a=t.onPageComplete(r))&&void 0!==a?a:0)):Promise.resolve(0)})),0===r);e++);return r}return yield this.printAsyncPageGroup(t,(e=>t.onPageComplete?Promise.resolve(t.onPageComplete(Object.assign(Object.assign({},e),{printCopies:n+i+s,copyIndex:i,isEndCopy:!0}))||0):Promise.resolve(0)))}))}autoLoadDrawItemImage(t){return m(this,void 0,void 0,(function*(){if(t.type===Ae.image){const e=t;e&&"string"==typeof e.image&&(e.image=yield this.loadImage(e.image));}else if(t.type===Ae.html){const e=t;"string"!=typeof e.html&&e.html&&(e.html=e.html.innerHTML),e.image=yield this.loadHtml(e.html);}else if(t.type===Ae.table){const e=t;if(e.tableRows)for(const t of e.tableRows)for(const e of t||[])e&&"string"!=typeof e&&e.type&&(yield this.autoLoadDrawItemImage(e));else if(e.cells)for(const t of e.cells)t&&"string"!=typeof t&&t.type&&(yield this.autoLoadDrawItemImage(t));}return !0}))}autoLoadImage(t){return m(this,void 0,void 0,(function*(){const e=t.jobInfo;e&&((this.IsApiMode?Re.isPreviewJobName(e.jobName):this.IsPreviewMode)?e.background&&"string"==typeof e.background&&(e.background=yield this.loadImage(e.background)):e.background=void 0,e.border&&"string"==typeof e.border&&(e.border=yield this.loadImage({src:e.border,withSize:!0}))),t.jobPage&&(!t.jobPages||t.jobPages.length<=0)&&(t.jobPages=[t.jobPage]);const i=t.jobPages||[];for(const t of i)for(const e of t)yield this.autoLoadDrawItemImage(e);return t}))}}Re.JOB_NAME_TRANS="#!#transparent#!#",Re.JOB_NAME_PREV="#!#preview#!#",Re.JOB_COLOR_WHITE="#fff",Re.JOB_COLOR_TRANS="transparent",Re.LINE_WIDTH_MM=.35;class Ee{constructor(t){this._margin=[],this._radius=0,this.data=t.data,this.init(t);}get MarginTop(){return this._margin.length>0?this._margin[0]:0}get MarginRight(){return this._margin.length>1?this._margin[1]:0}get MarginLeft(){return this._margin.length>3?this._margin[3]:this.MarginRight}get MarginBottom(){return this._margin.length>2?this._margin[2]:this.MarginTop}get CornerRadius(){return this._radius}init(t){this._radius=t.radius||0,this._margin=t.margin||[],this._jobStartAction=t.onJobStart,1===this._margin.length&&this._margin.push(this._margin[0]),t.element&&this.attachTo({element:t.element});}createDrawContext(t){return new Re(Object.assign(Object.assign({},t),{apiMode:!1,previewMode:!0,position:"relative"}))}attachTo(t){return m(this,void 0,void 0,(function*(){if(!t.element&&!t.canvas)return !1;if(!this.drawContext){const e=this.createDrawContext(t);if(!e)return !1;this.drawContext=e;}const e=t.element,i=t.canvas;if(e)return this.drawContext.Canvas.Base.appendTo(e),this.raiseViewChanged(e.offsetWidth,e.offsetHeight);{const e=t.viewWidth||i.width||0,s=t.viewHeight||i.height||0;return this.raiseViewChanged(e,s)}}))}raiseViewChanged(t,e){return m(this,void 0,void 0,(function*(){const i=this.data?this.data.jobInfo:void 0,s=(null==i?void 0:i.jobWidth)||0,r=(null==i?void 0:i.jobHeight)||0,n=this.drawContext;if(!i)return d.warn("---- 未检测到 jobInfo 相关信息！"),!1;if(s<=0||r<=0)return d.warn(`---- 纸张大小错误：{jobWidth: ${s}, jobHeight: ${r}}`),!1;if(!n)return d.warn("---- 未检测到绘制上下文！"),!1;if(t<=0||e<=0)return d.warn(`---- 参数错误：viewWidth = ${t}, viewHeight = ${e}`),!1;const a=e-2,o=t-2-this.MarginLeft-this.MarginRight,h=a-this.MarginTop-this.MarginBottom,c=o>0?o/s:0,l=h>0?h/r:0;return n.ZoomRate=Math.min(c,l),this.updateCanvasPosition(n),this.refreshView()}))}updateCanvasPosition(t){var e;if("absolute"!==(null===(e=t.CanvasElement.style)||void 0===e?void 0:e.position))return;const i=t.CanvasElement.parentElement;if(i){if(i.parentElement){const e=i.parentElement,s=e.offsetWidth-2,r=e.offsetHeight-2,n=this.MarginLeft+this.MarginRight+t.PixWidth,a=this.MarginTop+this.MarginBottom+t.PixHeight;i.style.width=`${n>s?n:s}px`,i.style.height=`${a>r?a:r}px`;}const e=i.offsetWidth,s=i.offsetHeight,r=.5*(e-t.PixWidth),n=this.MarginTop+.5*(s-this.MarginTop-this.MarginBottom-t.PixHeight);t.CanvasElement.style&&(t.CanvasElement.style.left=`${r}px`,t.CanvasElement.style.top=`${n}px`,t.CanvasElement.style.borderRadius=t.ZoomRate*this._radius+"px");}}refreshView(){return m(this,void 0,void 0,(function*(){const t=this.drawContext,e=this.data.jobInfo;if(!t||!e)return !1;const i=Re.getJobStartOptions(e,this.data.printerInfo),s=t.startJob(i);return !!s&&(this._jobStartAction&&(yield Promise.resolve(this._jobStartAction(s))),yield t.autoLoadImage(this.data),t.drawAsyncJob(this.data).then((t=>0===t)))}))}}class Ie{static innerDecode(t){const e=new Uint16Array(32),i=t.length,s=i-32;let r="",n="",a=0,o=0,h=0,c=-1;for(let l=0,d=0,u=0,g=0;g<i;){for(a=g<=s?32:i-g|0;l<a;g=g+1|0,l=l+1|0){switch(d=255&t[g],d>>4){case 15:if(u=255&t[g=g+1|0],u>>6!=2||247<d){g=g-1|0;break}o=(7&d)<<6|63&u,h=5,d=256;case 14:u=255&t[g=g+1|0],o<<=6,o|=(15&d)<<6|63&u,h=u>>6==2?h+4|0:24,d=d+256&768;case 13:case 12:u=255&t[g=g+1|0],o<<=6,o|=(31&d)<<6|63&u,h=h+7|0,g<i&&u>>6==2&&o>>h&&o<1114112?(d=o,o=o-65536|0,0<=o?(c=55296+(o>>10)|0,d=56320+(1023&o)|0,l<31?(e[l]=c,l=l+1|0,c=-1):(u=c,c=d,d=u)):a=a+1|0):(d>>=8,g=g-d-1|0,d=65533),h=0,o=0,a=g<=s?32:i-g|0;default:e[l]=d;continue;case 11:case 10:case 9:case 8:}e[l]=65533;}if(n+=String.fromCharCode(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17],e[18],e[19],e[20],e[21],e[22],e[23],e[24],e[25],e[26],e[27],e[28],e[29],e[30],e[31]),l<32&&(n=n.slice(0,l-32|0)),g<i){if(e[0]=c,l=~c>>>31,c=-1,n.length<r.length)continue}else -1!==c&&(n+=String.fromCharCode(c));r+=n,n="";}return r}static decode(t,e){try{return new TextDecoder(e).decode(Uint8Array.from(t))}catch(e){return d.log("DzTextDecoder.decode: TextDecoder is not defined"),this.innerDecode(t)}}}class xe{static decode(t){try{let e="";return e="function"==typeof xe.decodeAction?xe.decodeAction(t):new TextDecoder("gbk").decode(t),e}catch(t){return console.warn(t),""}}static initEncodeTable(){if(!this._table){d.log("---- start to initEncodeTable:");const t=[[161,169,161,254],[176,247,161,254],[129,160,64,254],[170,254,64,160],[168,169,64,160],[170,175,161,254],[248,254,161,254],[161,167,64,160]],e=new Uint16Array(23940);let i=0;for(const[s,r,n,a]of t)for(let t=n;t<=a;t++)if(127!==t)for(let n=s;n<=r;n++)e[i++]=t<<8|n;this._table=new Uint16Array(65536),this._table.fill(65535);const s=xe.decode(e);if(!s)return this._table=new Uint16Array(0),this._table;for(let t=0;t<s.length;t++)this._table[s.charCodeAt(t)]=e[t];d.log("---- end to initEncodeTable:");}return this._table}static encode(t,e){t=t||"";const i=this.initEncodeTable();if(i.length<=0)return void console.warn("---- 当前系统不支持该操作。");const s=new Uint16Array(t.length);for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);if(n<128){s[r]=n;continue}const a=i[n];if(65535!==a)s[r]=a;else if(8364===n)s[r]=128;else {const t=e?e(r):63;if(-1===t)return s.subarray(0,r);s[r]=t;}}return s}static encodeToUint8Array(t,e){t=t||"";const i=this.initEncodeTable();if(i.length<=0)return void console.warn("---- 当前系统不支持该操作。");const s=new Uint8Array(2*t.length);let r=0;for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);if(a<128){s[r++]=a;continue}const o=i[a];if(65535!==o)s[r++]=o,s[r++]=o>>8;else if(8364===a)s[r++]=128;else {const t=e?e(n):63;if(-1===t)return s.subarray(0,r);t>255?(s[r++]=t,s[r++]=t>>8):s[r++]=t;}}return s.subarray(0,r)}static uint8ArrayToUint16Array(t,e){const i=[];for(let s=0,r=0,n=0;s<t.length;s++)t[s]<128?i.push(t[s]):(r=255&t[s++],n=s<t.length?255&t[s]:0,e?i.push(r<<8|n):i.push(n<<8|r));return Uint16Array.from(i)}}var De,ve,_e,Se;!function(t){t[t.ASYNC_WAIT=-1]="ASYNC_WAIT",t[t.OK=0]="OK",t[t.ERROR_PARAM=1]="ERROR_PARAM",t[t.ERROR_NO_PRINTER=2]="ERROR_NO_PRINTER",t[t.ERROR_DISCONNECTED=3]="ERROR_DISCONNECTED",t[t.ERROR_CONNECT_FAILED=4]="ERROR_CONNECT_FAILED",t[t.ERROR_START_NOTIFICATION=5]="ERROR_START_NOTIFICATION",t[t.ERROR_DATA_SEND_ERROR=6]="ERROR_DATA_SEND_ERROR",t[t.ERROR_DATA_RECEIVE_ERROR=7]="ERROR_DATA_RECEIVE_ERROR",t[t.ERROR_IS_PRINTING=8]="ERROR_IS_PRINTING",t[t.ERROR_RESPONSE_TIMEOUT=9]="ERROR_RESPONSE_TIMEOUT",t[t.ERROR_PRINTER_CANCELED=10]="ERROR_PRINTER_CANCELED",t[t.ERROR_JOB_CREATE=16]="ERROR_JOB_CREATE",t[t.ERROR_JOB_CANCELED=17]="ERROR_JOB_CANCELED",t[t.ERROR_GET_IMAGE_DATA=18]="ERROR_GET_IMAGE_DATA",t[t.ERROR_PRINTER_NOT_AVAILABLE=19]="ERROR_PRINTER_NOT_AVAILABLE",t[t.ERROR_DATA_PARSE=20]="ERROR_DATA_PARSE",t[t.ERROR_OTHER=32]="ERROR_OTHER";}(De||(De={})),function(t){t[t.Unset=255]="Unset",t[t.None=0]="None",t[t.Hole=1]="Hole",t[t.Gap=2]="Gap",t[t.Black=3]="Black",t[t.Trans=4]="Trans";}(ve||(ve={})),function(t){t[t.Unset=255]="Unset",t[t.Min=1]="Min",t[t.Low=2]="Low",t[t.Normal=3]="Normal",t[t.High=4]="High",t[t.Max=5]="Max";}(_e||(_e={})),function(t){t[t.Unset=255]="Unset",t[t.Min=1]="Min",t[t.Low=4]="Low",t[t.Normal=6]="Normal",t[t.High=10]="High",t[t.Max=15]="Max";}(Se||(Se={}));class we{static decodeBase64(t){if(t){if(we.decodeBase64)return we.decodeBase64(t);if("function"==typeof atob){const e=we.atob(t);let i=e.length;const s=new Uint8Array(i);for(;i--;)s[i]=e.charCodeAt(i);return s.buffer}}}static arrayBuffer2Base64(t){let e=0,i=0,s=0;const r=t.length;let n="";for(let a=0;a<r;){if(e=t[a++],a==r){n+=we.base64EncodeChars.charAt(e>>2),n+=we.base64EncodeChars.charAt((3&e)<<4),n+="==";break}if(i=t[a++],a==r){n+=we.base64EncodeChars.charAt(e>>2),n+=we.base64EncodeChars.charAt((3&e)<<4|(240&i)>>4),n+=we.base64EncodeChars.charAt((15&i)<<2),n+="=";break}s=t[a++],n+=we.base64EncodeChars.charAt(e>>2),n+=we.base64EncodeChars.charAt((3&e)<<4|(240&i)>>4),n+=we.base64EncodeChars.charAt((15&i)<<2|(192&s)>>6),n+=we.base64EncodeChars.charAt(63&s);}return n}static base64ToArrayBuffer(t){const e=t.length,i=[],s=new Uint8Array(4);let r=0;for(let n=0;n<e;){for(r=0;r<s.length&&n<e;n++)s[r]=we.base64DecodeChars[255&t.charCodeAt(n)],s[r]>=0&&s[r]<=64?r++:10!==s[r]||d.warn(`---- 检测到无效的字符：data[${n}] = '${t.charAt(n)}', charCode = 0x${t.charCodeAt(n).toString(16)}`);if(r>0&&r<s.length)return d.warn(`---- base64字符串解析失败，pos = ${r}, i = ${n}, data.length = ${e}`),Uint8Array.from([]);if(i.push(s[0]<<2|(48&s[1])>>4),s[2]>=64)break;s[3]>=64?i.push((15&s[1])<<4|(60&s[2])>>2):(i.push((15&s[1])<<4|(60&s[2])>>2),i.push((3&s[2])<<6|s[3]));}return Uint8Array.from(i)}static atob(t){try{if(window&&"function"==typeof window.atob)return atob(t);{const e=we.base64ToArrayBuffer(t);return Ie.decode(new Uint8Array(e),"utf-8")}}catch(t){return d.warn(t),""}}static sleep(t,e){return new Promise((i=>{setTimeout((()=>{i(e);}),t);}))}static execAsync(t,e,i){return new Promise((s=>{setTimeout((()=>{t(e).then((t=>{s(t);}));}),i||0);}))}static processSuccessResult(t,e,i){return e&&(e.success&&e.success(t),e.complete&&e.complete(t)),i&&i(t),t}static processFailResult(t,e,i){return e&&(e.fail&&e.fail(t),e.complete&&e.complete(t)),i&&i(t),t}static getBytes(t){const e=[];let i="";for(let s=0;s<t.length;s+=2)i=t.substring(s,s+2),e.push(parseInt(i,16));return Uint8Array.from(e)}static toHexByteString(t,e){return (e||"")+`00${t.toString(16)}`.slice(-2)}static toHexShortString(t,e){return (e||"")+`0000${t.toString(16)}`.slice(-4)}static toHexString(t,e){return (e||"")+`00000000${t.toString(16)}`.slice(-8)}static getHexStringOfBytes(t,e,i){return Array.from(t).map((t=>we.toHexByteString(t,i))).join(e)}static isAndroid(){return !!navigator&&/android/i.test(navigator.userAgent||"")}static isIOS(){return !!navigator&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent||"")}static getRequestData(t,e){if(null==e?e=[]:"object"!=typeof e&&(e=[e]),e.length&&"object"==typeof e[0])return e[0];const i={};if("string"==typeof t&&(t=[t]),t.length<1||!t[0])return i;for(let s=0;s<t.length;s++)i[t[s]]=e[s];return i}static filter(t,e){return Object.keys(t).filter((i=>!!e&&e(i,t[i]))).reduce(((e,i)=>(e[i]=t[i],e)),{})}static filter_NoFunc(t){return we.filter(t,((t,e)=>"function"!=typeof e))}static filter_NoNone(t){return we.filter(t,((t,e)=>null!=e))}static filter_NoFuncAndNone(t){return we.filter(t,((t,e)=>null!=e&&"function"!=typeof e))}static filterAndAssign(t,e,i){const s=i||((t,e)=>null!=e&&"function"!=typeof e),r=we.filter(t,s);return Object.assign(r,e)}static combineUint8Array(t){const e=t.reduce(((t,e)=>t+e.length),0),i=new Uint8Array(e);let s=0;return t.forEach((t=>{i.set(t,s),s+=t.length;})),i}static lowByte(t){return 255&t}static highByte(t){return t>>>8&255}}we.base64EncodeChars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",we.base64DecodeChars=Uint8Array.from([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,64,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,255,255,255,255,255]);class Te{static createEmitter(t){return new Te(t||"")}constructor(t){this.listeners=new Map,this.tagName=t;}on(t,e){const i=e||Te.EVENT_NAME;let s=this.listeners.get(i);return s?s.push(t):(s=[t],this.listeners.set(i,s)),t}off(t,e){const i=e||Te.EVENT_NAME,s=this.listeners.get(i);if(s){const e=s.indexOf(t);if(e>=0)return s.splice(e,1),t}}clear(t){const e=this.listeners.get(t||Te.EVENT_NAME);return e?e.splice(0):[]}emit(t,e,i){var s;const r=e||Te.EVENT_NAME,n=(null===(s=this.listeners.get(r))||void 0===s?void 0:s.slice(0))||[];i?n.forEach((e=>e(t))):setTimeout((()=>{n.forEach((e=>e(t)));}));}invoke(t,e){this.emit(t,e,!0);}beginInvoke(t,e){this.emit(t,e,!1);}}Te.EVENT_NAME="_";class Oe{static getPackBytes(t){return t+(t>=192?5:4)}static toShort(t,e){return this.toNumber(t,e)}static toEBV(t,e){return e&&e>=192?this.toNumber(t,-193&e):255&t}static fromEBV(t){const e=[];return t>=192?(e.push(t>>>8|192),e.push(255&t)):e.push(t),e}static toNumber(t,e,i,s){let r=0;return t&&(r|=255&t),e&&(r|=(255&e)<<8),i&&(r|=(255&i)<<16),s&&(r|=(255&s)<<24),r}static getBytesFromNumber(t,e){const i=new Uint8Array(e);for(let s=0;s<e;s++)i[s]=t>>>8*(e-1-s)&255;return i}static getBytesFromShort(t,e){let i=[t>>>8&255,255&t];return e&&(i=t>=192?[t>>>8|192,255&t]:[255&t]),new Uint8Array(i)}static getBytesFromInt32(t){return this.getBytesFromNumber(t,4)}static calcCRC(t,e,i){let s=0;for(;e<i;++e)s+=255&t[e];return 255&~s}static parse(t){if(t.length<4||t[0]!=Oe.DEVICE_TO_HOST_DATA_START)return;const e=t[1];let i=0,s=0;if(t[2]>=192){if(t.length<5)return;i=Oe.toShort(t[3],t[2]),s=t[i+4];const r=Oe.calcCRC(t,1,i+4);return s!==Oe.FIXED_PACKAGE_CRC_RESULT&&s!==r&&d.warn(`---- CRC检验失败：receiveCRC = ${s}, calcCRC = ${r}`),i>0?new Oe(e,t.slice(4,i+4)):new Oe(e)}{if(i=t[2],t.length<i+4)return;s=t[i+3];const r=Oe.calcCRC(t,1,i+3);if(s===Oe.FIXED_PACKAGE_CRC_RESULT||s===r)return i>0?new Oe(e,t.slice(3,i+3)):new Oe(e);d.warn(`---- CRC校验失败：receiveCrc = ${s}, calcCrc = ${r}`);}}constructor(t,e){this.mOffset=0,this.mCmd=t,this.mData=e||[];}get Cmd(){return this.mCmd}get Data(){return this.mData}get Remains(){return this.mData.length-this.mOffset}pushByte(t){this.mData.push(255&t);}popByte(t){let e=t||0;return this.mOffset<this.mData.length&&(e=this.mData[this.mOffset++]),e}pushShort(t,e){e?t>=192?(this.mData.push(t>>>8|192),this.mData.push(255&t)):this.mData.push(255&t):(this.mData.push(t>>>8&255),this.mData.push(t>>>0&255));}popShort(t){let e=t||0;const i=this.mOffset;return i<=this.mData.length-2?(e=Oe.toShort(this.mData[i+1],this.mData[i]),this.mOffset+=2):e=Oe.toShort(this.mData[this.mOffset++]),e}pushEBV(t){return t>=192?(this.mData.push(t>>>8|192),this.mData.push(255&t),this.mOffset+=2,this.mOffset):(this.mData.push(t),this.mOffset++,this.mOffset)}popEBV(t){const e=this.mOffset;let i=t||0;return e<this.mData.length&&(this.mData[e]>=192&&this.mData.length>=e+2?(i=Oe.toEBV(this.mData[e+1],this.mData[e]),this.mOffset+=2):i=this.mData[this.mOffset++]),i}pushInt(t){this.mData.push(t>>>24&255),this.mData.push(t>>>16&255),this.mData.push(t>>>8&255),this.mData.push(t>>>0&255);}popInt(t){let e=t||0;const i=this.mOffset;return i+4<=this.mData.length&&(e=Oe.toNumber(this.mData[i+3],this.mData[i+2],this.mData[i+1],this.mData[i]),this.mOffset+=4),e}popInteger(t){return this.popInt(t)}popString(){const t=this.mOffset;if(t>=this.mData.length)return "";let e=t;for(;e<this.mData.length&&0!==this.mData[e];e++);this.mOffset=e;const i=this.mData.slice(t,e);return Ie.decode(Uint8Array.from(i),"gbk")}popByteArray(){const t=this.mOffset;return t>=this.mData.length?new Uint8Array(0):(this.mOffset=this.mData.length,Uint8Array.from(this.Data.slice(t)))}getBufferLength(){return Oe.getPackBytes(this.mData.length)}getBytes(){const t=this.mData||[],e=t.length,i=new Uint8Array(e+(e>=192?5:4));if(i[0]=Oe.DEVICE_TO_HOST_DATA_START,i[1]=this.mCmd,e>=192){i[2]=e>>>8|192,i[3]=255&e;for(let s=0;s<e;s++)i[s+4]=t[s];i[e+4]=Oe.FIXED_PACKAGE_CRC_RESULT;}else {i[2]=e;for(let s=0;s<e;s++)i[s+3]=t[s];i[e+3]=Oe.FIXED_PACKAGE_CRC_RESULT;}return i}}Oe.HOST_TO_DEVICE_DATA_START=31,Oe.DEVICE_TO_HOST_DATA_START=31,Oe.FIXED_PACKAGE_CRC_RESULT=136;class Me{get FreeSpace(){return this.mBuffer.length-this.mBufLen}get Length(){return this.mBufLen}constructor(t){this.mBufLen=0;const e=t&&t>Me.BUFFER_LENGTH_DEFAULT?t:Me.BUFFER_LENGTH_DEFAULT;this.mBuffer=new Uint8Array(e);}static getBytes(t,e){return new Oe(t,e).getBytes()}pushPackage(t,e){const i=Me.getBytes(t,e);return this.push(i)}pushByte(t,e){const i=Me.getBytes(t,[255&e]);return this.push(i)}pushShort(t,e,i){const s=Oe.getBytesFromShort(e,i);return this.push(Me.getBytes(t,Array.from(s)))}pushInt(t,e){const i=Oe.getBytesFromInt32(e);return this.push(Me.getBytes(t,Array.from(i)))}push(t,e,i){const s=e||0,r=i||t.length;if(r-s>this.mBuffer.length-this.mBufLen)return d.warn("---- PackageBuffer缓存不够！"),!1;for(let e=s;e<r;e++)this.mBuffer[this.mBufLen++]=t[e];return !0}getAllBytes(){return this.mBuffer.slice(0,this.mBufLen)}clearBuffer(){this.mBufLen=0,this.mBuffer.fill(0);}toString(){return `{size: ${this.mBuffer.length}, mBufLen: ${this.mBufLen}, buffer: [${we.getHexStringOfBytes(this.mBuffer)}]}`}}Me.BUFFER_LENGTH_DEFAULT=1e3;class Be{constructor(){this.mBufferList=[];}get BufferList(){return this.mBufferList}get Length(){return this.mBufferList.length}reset(){this.mBufferList.splice(0);}toList(){return this.mBufferList.slice(0)}push(t,e,i){const s=e||0,r=i||t.length,n=r-s;let a=this.mBufferList[this.mBufferList.length-1];(!a||a.FreeSpace<n)&&(a=new Me(n),this.mBufferList.push(a)),a.push(t,s,r);}push2(t,e,i,s,r,n){const a=new Me;a.push(t,e,i),a.push(s,r,n),this.push(a.getAllBytes());}pushPackage(t,e){const i=Me.getBytes(t,e);return this.push(i)}}const Le=[1,2,3,4,5,6,7,8,9,10,11,12,24,36,48,120],Ne=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,41,62,83,104,125,146,167,188,209,230,461,923];class Fe{static appendRLEC(t,e,i,s,r){for(;s>=63;s-=63){if(e.value+2>r)return !1;t[e.value]=255,++e.value,t[e.value]=i,++e.value;}switch(s){case 1:if(i>192){if(e.value+2>r)return !1;t[e.value]=193,++e.value,t[e.value]=i,++e.value;}else {if(e.value+1>r)return !1;t[e.value]=i,++e.value;}break;case 2:if(e.value+2>r)return !1;i>192?(t[e.value]=194,++e.value,t[e.value]=i,++e.value):(t[e.value]=i,++e.value,t[e.value]=i,++e.value);break;default:if(s>0){if(e.value+2>r)return !1;t[e.value]=192|s,++e.value,t[e.value]=i,++e.value;}}return !0}static calcRLEC(t,e,i,s){if(e<=0)return 0;const r={value:0};let n=t[0],a=1;for(let o=1;o<e;++o)if(t[o]===n)++a;else {if(!this.appendRLEC(i,r,n,a,s))return 0;n=t[o],a=1;}return this.appendRLEC(i,r,n,a,s)?r.value:0}static appendRLE5(t,e,i,s,r){if(s<=0)return !0;let n=Math.floor(5*e.value/8),a=15;for(;s>0;)if(s>=Le[a]){s-=Le[a];const o=a|(i?16:0);if(e.value=e.value+1,5*e.value>8*r)return !1;switch(7&e.value){case 0:t[n]=t[n]|o,++n;break;case 1:t[n]=t[n]|o<<3;break;case 2:t[n]=t[n]|o>>>2,++n,t[n]=t[n]|(3&o)<<6;break;case 3:t[n]=t[n]|o<<1;break;case 4:t[n]=t[n]|o>>>4,++n,t[n]=t[n]|(15&o)<<4;break;case 5:t[n]=t[n]|o>>>1,++n,t[n]=t[n]|(1&o)<<7;break;case 6:t[n]=t[n]|o<<2;break;case 7:t[n]=t[n]|o>>>3,++n,t[n]=t[n]|(7&o)<<5;}}else s<=12?a=s-1:--a;return !0}static calcRLE5X(t,e,i,s){if(e<=0)return 0;let r=0,n=0,a=!1,o=128;const h={value:0};for(;;){if(t[n]&o)if(a)++r;else {if(!this.appendRLE5(i,h,!1,r,s))return 0;a=!0,r=1;}else if(a){if(!this.appendRLE5(i,h,!0,r,s))return 0;a=!1,r=1;}else ++r;if(1===o){if(++n,n>=e)break;o=128;}else o>>>=1;}return a&&!this.appendRLE5(i,h,!0,r,s)?0:h.value}static calcRLE5D(t,e,i,s,r,n){let a=0,o=0,h=!1,c=128;const l={value:0},d=Math.min(e,s);if(d>0)for(;;){if((i[o]&c)!=(t[o]&c))if(h)++a;else {if(!this.appendRLE5(r,l,!1,a,n))return 0;h=!0,a=1;}else if(h){if(!this.appendRLE5(r,l,!0,a,n))return 0;h=!1,a=1;}else ++a;if(1===c){if(++o,o>=d)break;c=128;}else c>>>=1;}if(e!==s)for(e<s&&(t=i,e=s),c=128;;){if(t[o]&c)if(h)++a;else {if(!this.appendRLE5(r,l,!1,a,n))return 0;h=!0,a=1;}else if(h){if(!this.appendRLE5(r,l,!0,a,n))return 0;h=!1,a=1;}else ++a;if(1===c){if(++o,o>=e)break;c=128;}else c>>>=1;}return h&&!this.appendRLE5(r,l,!0,a,n)?0:l.value}static appendRLE6(t,e,i,s,r){if(s<=0)return !0;let n=Math.floor(6*e.value/8),a=31;for(;s>0;)if(s>=Ne[a]){s-=Ne[a];const o=a|(i?32:0);if(e.value=e.value+1,6*e.value>8*r)return !1;switch(3&e.value){case 0:t[n]=t[n]|o,++n;break;case 1:t[n]=t[n]|o<<2;break;case 2:t[n]=t[n]|o>>>4,++n,t[n]=t[n]|(15&o)<<4;break;case 3:t[n]=t[n]|o>>>2,++n,t[n]=t[n]|(3&o)<<6;}}else s<=20?a=s-1:--a;return !0}static calcRLE6X(t,e,i,s){if(e<=0)return 0;let r=0,n=0,a=!1,o=128;const h={value:0};for(;;){if(t[n]&o)if(a)++r;else {if(!this.appendRLE6(i,h,!1,r,s))return 0;a=!0,r=1;}else if(a){if(!this.appendRLE6(i,h,!0,r,s))return 0;a=!1,r=1;}else ++r;if(1===o){if(++n,n>=e)break;o=128;}else o>>>=1;}return a&&!this.appendRLE6(i,h,!0,r,s)?0:h.value}static calcRLE6D(t,e,i,s,r,n){let a=0,o=0,h=!1,c=128;const l={value:0},d=Math.min(e,s);if(d>0)for(;;){if((i[o]&c)!=(t[o]&c))if(h)++a;else {if(!this.appendRLE6(r,l,!1,a,n))return 0;h=!0,a=1;}else if(h){if(!this.appendRLE6(r,l,!0,a,n))return 0;h=!1,a=1;}else ++a;if(1===c){if(++o,o>=d)break;c=128;}else c>>>=1;}if(e!==s)for(e<s&&(t=i,e=s),c=128;;){if(t[o]&c)if(h)++a;else {if(!this.appendRLE6(r,l,!1,a,n))return 0;h=!0,a=1;}else if(h){if(!this.appendRLE6(r,l,!0,a,n))return 0;h=!1,a=1;}else ++a;if(1===c){if(++o,o>=e)break;c=128;}else c>>>=1;}return h&&!this.appendRLE6(r,l,!0,a,n)?0:l.value}}const je=1536,Ue=[12];class We{}We.CMD_NULL=0,We.CMD_IS_PRINTABLE=112,We.DZIP_PRINTABLE=0,We.DZIP_ISPRINTING=1,We.DZIP_ISROTATING=2,We.DZIP_NOJOB=10,We.DZIP_PAGENOTREADY=11,We.DZIP_JOBCANCELED=12,We.DZIP_ENVNOTREADY=20,We.DZIP_VOLTOOLOW=30,We.DZIP_VOLTOOHIGH=31,We.DZIP_TPHNOTFOUND=32,We.DZIP_TPHTOOHOT=33,We.DZIP_COVEROPENED=34,We.DZIP_NO_PAPER=35,We.DZIP_RIBBONCANOPENED=36,We.DZIP_NO_RIBBON=37,We.DZIP_UNMATCHED_RIBBON=38,We.DZIP_TPHTOOCOLD=39,We.DZIP_USEDUP_RIBBON=40,We.DZIP_USEDUP_RIBBON2=41,We.DZIP_NO_LABEL=42,We.DZIP_UNMATCHED_LABEL=43,We.DZIP_USEDUP_LABEL=44,We.DZIP_NO_RIBBON2=45,We.DZIP_UNMATCHED_RIBBON2=46,We.DZIP_LABELCANOPENED=50,We.DZCT_ANDROID_APP=0,We.DZCT_ANDROID_BLE=6,We.DZCT_ANDIOS_DJGW=12,We.DZCT_ANDROID_USB=16,We.CMD_ENABLE_SETTING=128,We.CMD_DEVICE_TYPE=120,We.CMD_DEVICE_NAME=121,We.CMD_DEVICE_VERSION=122,We.CMD_SOFTWARE_VERSION=124,We.CMD_PRINTER_DPI=113,We.CMD_PRINTER_WIDTH=114,We.CMD_MANUFACTURER=117,We.CMD_BUFFER_STATE=118,We.CMD_BUFFER_SIZE=119,We.CMD_PAGE_START=32,We.CMD_PAGE_PRINT=33,We.CMD_PAGE_LINE=34,We.CMD_PAGE_PARAM=37,We.CMD_PAGE_HEIGHT=38,We.CMD_PAGE_WIDTH=39,We.CMD_PAGE_END=40,We.CMD_PAGE_CONTROL=35,We.CMD_DARKNESS=67,We.CMD_SPEED=68,We.CMD_GAP_TYPE=66,We.CMD_GAP_LEN=69,We.CMD_MOTORMODE=71,We.CMD_AUTOPOWEROFF=72,We.CMD_LANGUAGE=73,We.CMD_CAP_GAPTYPE=82,We.CMD_CAP_MOTORMODE=87,We.CMD_CAP_LANGUAGE=89,We.CMD_DEVICE_DMINFO=125,We.CMD_SET_GENFLAGS=77,We.CMD_COMMIT_PARAM=79,We.CMD_DEV_DISCOVERY=90,We.CMD_ADDRESS_READ=97,We.CMD_PERIPHERALFLAGS=131,We.CMD_PERIPHERALTYPE_FLAGS=1,We.CMD_PERIPHERALTYPE_SPISPEED=2,We.CMD_HARDWARE_FLAGS=132,We.CMD_REQ_ADCVALUE=136,We.CMD_DEV_HANDSHAKE=158,We.CMD_MANU_TOOLKIT=159,We.CMD_MCU_GETID=10,We.CMD_DEBUG_BUFFER=127,We.CMD_PRINT_COUNTER=115,We.CMD_MANUSHIPTIME=17,We.CMD_SUB_ROM_UPGRADE=41,We.CMD_BITMAP_P_RLEC=41,We.CMD_BITMAP_PRINT=43,We.CMD_BITMAP_P_RLEX=44,We.CMD_BITMAP_P_RLED=45,We.CMD_BITMAP_P_RLE6X=60,We.CMD_BITMAP_P_RLE6D=61,We.CMD_BITMAP_REPEAT=46,We.PCPDHF_UHFRFID_WRITOR=2,We.PCPDHF_HFRFID_WRITOR=4,We.PCPDHF_NFCRFID_WRITOR=6,We.PCPDHF_MSKRFID_WRITOR=6,We.PCPDHF_HAS_BEEP=16384,We.PCPDHF_SUPER_BITMAP=16,We.PCPDHF_GRAY_BITMAP=32,We.PCPDHF_BLUETOOTH_2=131072,We.PCPDSF_NO_AUTO_OUT=268435456,We.PCPDSF_MOTOR_ANTIDIR=1,We.PCPDSF_RLE5_BITMAP=16,We.PCPDSF_RLE6_BITMAP=32,We.PCPDSF_RLEC_BITMAP=128,We.PCPDSF_MASK_BITMAP=240,We.PCPDSF_BT_HARD_FC=256,We.PCPDSF_PRTA_RIGHT=0,We.PCPDSF_PRTA_CENTER=512,We.PCPDSF_PRTA_LEFT=1024,We.PCPDSF_PRTA_MASK=1536,We.PCPDSF_ROTATE_180=16384,We.PCPDAF_BT_HARD_FC=1,We.PCPDAF_STRING_GBK=2,We.PCPDAF_HAS_WIFI=4096,We.PCPDAF_RLEC_BITMAP=128;class ke{constructor(){this.mThreshold=ke.THRESHOLD_DEFAULT,this.mOrientation=0,this.mLineAction=0,this.mSoftwareFlags=16,this.mHardwareFlags=0,this.mSupportSuperBitmap=!0,this.mPrinterWidth=0,this.mLineCount=0,this.mLineBytes=0,this.mBufferList=new Be,this.mByteWidth=0,this.mPrevBytes=0,this.mSumLines=0,this.mSumPrints=0,this.mSumRLE5Xs=0,this.mSumRLE5Ds=0,this.mSumRLE6Xs=0,this.mSumRLE6Ds=0,this.mSumRLE_Cs=0,this.mSumRepeats=0,this.mRLE5XSaved=0,this.mRLE5DSaved=0,this.mRLE6XSaved=0,this.mRLE6DSaved=0,this.mRLECSaved=0;}static encodeImageData(t,e,i){this.instance||(this.instance=new ke);const s=i||{},r=Object.assign(Object.assign(Object.assign({},s),t),{gapType:"number"==typeof t.gapType?t.gapType:s.gapType,gapLength:t.gapLength||0,printerDPI:s.printerDPI||t.printerDPI,printerWidth:s.printerWidth||t.printerWidth,softwareFlags:s.softwareFlags||t.softwareFlags,hardwareFlags:s.hardwareFlags||t.hardwareFlags}),n=this.instance.print(r,e);return n?n.map((t=>t.getAllBytes())):[]}static updatePageKey(t,e){const i=t[0];if(i&&!(i.length<=0)&&31===i[0]&&i[1]===We.CMD_PAGE_START&&2===i[2]){const t=Oe.toShort(i[4],i[3]);if(t!==e){const s=Oe.getBytesFromShort(e||0,!1);i[3]=s[0],i[4]=s[1],d.log(`---- updatePageKey: from -> to [0x${t.toString(16)}] => [0x${e.toString(16)}]`);}}}get IsLandscape(){return 0===this.mOrientation||2===this.mOrientation}print(t,e){return this.start(t,e)?(d.info("---- start to image encode:"),this.encode(t),d.info("---- stop to image encode:"),this.end(t)):null}reset(t){const e=t||{},i=e;"number"!=typeof e.printSpeed&&"number"==typeof i.speed&&(e.printSpeed=i.speed),e.orientation="number"==typeof e.orientation?e.orientation:0,e.orientation>=360&&(e.orientation=e.orientation%360),e.orientation>3&&(e.orientation=Math.floor(e.orientation/90)),this.mOrientation=e.orientation,this.mPrinterWidth=e.printerWidth&&e.printerWidth>0?e.printerWidth:ke.PRINTER_WIDTH_DEFAULT,"number"==typeof e.darkness&&(e.printDarkness=e.darkness),"number"==typeof e.speed&&(e.printSpeed=e.speed),e.threshold&&e.threshold>0&&e.threshold<255?this.mThreshold=e.threshold:this.mThreshold=ke.THRESHOLD_DEFAULT,this.mBufferList.reset(),this.mSoftwareFlags="number"==typeof e.softwareFlags?e.softwareFlags:16,this.mHardwareFlags=e.hardwareFlags||0,this.mSupportSuperBitmap="boolean"!=typeof e.enableSuperBitmap||e.enableSuperBitmap,this.mLineAction=1,this.mByteWidth=Math.floor((this.mPrinterWidth+7)/8),this.mLineCount=e.marginTop&&e.marginTop>0?e.marginTop:0,this.mLineBytes=0,this.mLineData=new Uint8Array(0),this.mPrevBytes=0,this.mPrevData=new Uint8Array(0),this.mSumLines=0,this.mSumPrints=0,this.mSumRLE5Xs=0,this.mSumRLE5Ds=0,this.mSumRLE6Xs=0,this.mSumRLE6Ds=0,this.mSumRLE_Cs=0,this.mSumRepeats=0,this.mRLE5XSaved=0,this.mRLE5DSaved=0,this.mRLE6XSaved=0,this.mRLE6DSaved=0,this.mRLECSaved=0;}start(t,e){const i=new Me,s=t.imageData;if(!(s&&s.width&&s.height&&s.data))return !1;this.reset(t),d.info(`========== startPage pageKey: ${e}[0x${null==e?void 0:e.toString(16)}] ==========`),d.info(`---- width             : ${s.width}`),d.info(`---- height            : ${s.height}`),d.info(`---- orientation       : ${this.mOrientation}`),d.info(`---- printerDPI        : ${t.printerDPI}`),d.info(`---- printerWidth      : ${t.printerWidth}`),d.info(`---- gapType           : ${t.gapType}`),d.info(`---- printDarkness     : ${t.printDarkness}`),d.info(`---- printSpeed        : ${t.printSpeed}`),d.info(`---- gapLength         : ${t.gapLength}`),d.info(`---- printAlignment    : ${t.printAlignment}`),d.info(`---- threshold         : ${t.threshold}`),d.info(`---- mSoftwareFlags    : ${we.toHexString(this.mSoftwareFlags,"0x")}`),d.info(`---- mHardwareFlags    : ${we.toHexString(this.mHardwareFlags,"0x")}`),d.info(`---- supportSuperBitmap: ${this.mSupportSuperBitmap}`),d.info("=================================================");const r=this.IsLandscape?s.width:s.height,n=Oe.getBytesFromShort(e||0,!1);i.pushPackage(We.CMD_PAGE_START,Array.from(n));const a=Oe.fromEBV(Math.floor((r+7)/8));i.pushPackage(We.CMD_PAGE_WIDTH,a);const o="number"==typeof t.gapType?t.gapType:-1;o>=ve.None&&o<=ve.Trans&&i.pushPackage(We.CMD_GAP_TYPE,[o]);const h="number"==typeof t.gapLength?t.gapLength:0;if(h>0&&o>0&&o<=4){let t=Math.floor(100*h);t>ke.MAX_EBV_VALUE&&(t=ke.MAX_EBV_VALUE),i.pushPackage(We.CMD_GAP_LEN,Oe.fromEBV(t));}const c="number"==typeof t.printDarkness?t.printDarkness:-1;c>=Se.Min&&c<=Se.Max&&i.pushPackage(We.CMD_DARKNESS,[c-1]);const l="number"==typeof t.printSpeed?t.printSpeed:-1;return l>=_e.Min&&l<=_e.Max&&i.pushPackage(We.CMD_SPEED,[l-1]),this.mBufferList.push(i.getAllBytes()),!0}static getImageGrayValue(t,e){return e+3<t.length&&t[e+3]>0?.3*t[e]+.59*t[e+1]+.11*t[e+2]:255}getPrintAlignment(){return this.mSoftwareFlags&We.PCPDSF_PRTA_MASK}encode(t){const e=t.imageData,i=e.width,s=e.height,r=this.IsLandscape?Math.min(i,this.mPrinterWidth):Math.min(s,this.mPrinterWidth);this.mByteWidth=Math.floor((r+7)/8);const n=this.mThreshold;let a=0,o=0;const h=t.printAlignment||this.getPrintAlignment();let c=0;if(1===this.mOrientation||3===this.mOrientation?s>r&&(c=512==(h&je)?Math.floor(.5*(s-r)):1024==(h&je)?0:s-r):i>r&&(c=512==(h&je)?Math.floor(.5*(i-r)):1024==(h&je)?0:i-r),1===this.mOrientation)for(let t=0;t<i;++t){const h=new Uint8Array(this.mByteWidth);let l=128,d=0;for(let u=0;u<r;++u)a=4*((s-u-c-1)*i+t),o=ke.getImageGrayValue(e.data,a),o<=n&&(h[d]=h[d]|l),1===l?(l=128,++d):l>>>=1;this.printRow(h);}else if(2===this.mOrientation)for(let t=0;t<s;++t){const h=new Uint8Array(this.mByteWidth);let l=128,d=0;a=4*((s-t)*i-c-1);for(let t=0;t<r;++t,a-=4)o=ke.getImageGrayValue(e.data,a),o<=n&&(h[d]=h[d]|l),1===l?(l=128,++d):l>>>=1;this.printRow(h);}else if(3===this.mOrientation)for(let t=0;t<i;++t){const s=new Uint8Array(this.mByteWidth);let h=128,l=0;for(let d=0;d<r;++d)a=4*((d+c)*i+(i-t-1)),o=ke.getImageGrayValue(e.data,a),o<=n&&(s[l]=s[l]|h),1===h?(h=128,++l):h>>>=1;this.printRow(s);}else for(let t=0;t<s;++t){const s=new Uint8Array(this.mByteWidth);a=4*(i*t+c);let h=128,l=0;for(let t=0;t<r;++t,a+=4)o=ke.getImageGrayValue(e.data,a),o<=n&&(s[l]=s[l]|h),1===h?(h=128,++l):h>>>=1;this.printRow(s);}}end(t){const e=t.marginBottom||0;switch(this.mLineAction){case 1:this.pushLine(this.mLineCount+e);break;case 2:this.pushPrint(),this.pushLine(e);break;default:return null}return this.mLineAction=0,this.mBufferList.push(Ue),this.mBufferList.toList()}printRow(t){let e=t.length-1;for(;e>=0&&0===t[e];--e);if(e<0)return this.printLine(1);switch(++e,this.mLineAction){case 1:this.pushLine(this.mLineCount);break;case 2:if(this.mLineBytes===e&&this.checkArrayEquals(this.mLineData,t,e))return this.mLineCount+=1,!0;this.pushPrint();break;default:return !1}return this.mLineData=t,this.mLineBytes=e,this.mLineCount=1,this.mLineAction=2,!0}printLine(t){switch(this.mLineAction){case 1:return this.mLineCount+=t,!0;case 2:this.pushPrint();break;default:return !1}return this.mLineData=new Uint8Array,this.mLineBytes=0,this.mLineCount=t,this.mLineAction=1,!0}pushLine(t){if(t<=0)return;this.mSumLines+=t,this.mPrevData=Uint8Array.from([]),this.mPrevBytes=0;const e=[27,74,255];for(;t>=255;t-=255)this.mBufferList.push(e);t>0&&this.mBufferList.push([27,74,t]);}pushPrint(){if(this.mLineCount<=0)return;let t=0;for(;t<this.mLineBytes&&0===this.mLineData[t];++t);const e=this.mLineBytes-t;let i=new Uint8Array(0),s=new Uint8Array(0),r=new Uint8Array(0),n=new Uint8Array(0),a=new Uint8Array(0),o=0,h=0,c=0,l=0,d=0;this.mSupportSuperBitmap&&(128&this.mSoftwareFlags&&(i=new Uint8Array(this.mByteWidth+4),o=Fe.calcRLEC(this.mLineData,this.mLineBytes,i,this.mByteWidth)),16&this.mSoftwareFlags&&(s=new Uint8Array(this.mByteWidth+4),h=Fe.calcRLE5X(this.mLineData,this.mLineBytes,s,this.mByteWidth)),16&this.mSoftwareFlags&&this.mPrevData.length>0&&(r=new Uint8Array(this.mByteWidth+4),c=Fe.calcRLE5D(this.mPrevData,this.mPrevBytes,this.mLineData,this.mLineBytes,r,this.mByteWidth)),32&this.mSoftwareFlags&&(n=new Uint8Array(this.mByteWidth+4),l=Fe.calcRLE6X(this.mLineData,this.mLineBytes,n,this.mByteWidth)),32&this.mSoftwareFlags&&this.mPrevData.length>0&&(a=new Uint8Array(this.mByteWidth+4),d=Fe.calcRLE6D(this.mPrevData,this.mPrevBytes,this.mLineData,this.mLineBytes,a,this.mByteWidth)));const u=(t>=192?4:3)+(e>=192?2:1)+e,g=o<=0?this.mByteWidth+100:o+(o>=192?4:3),p=h<=0?this.mByteWidth+100:Math.ceil(5*h/8)+(h>=192?4:3),m=c<=0?this.mByteWidth+100:Math.ceil(5*c/8)+(c>=192?4:3),f=l<=0?this.mByteWidth+100:Math.ceil(6*l/8)+(l>=192?4:3),P=d<=0?this.mByteWidth+100:Math.ceil(6*d/8)+(d>=192?4:3);if(m<u&&m<g&&m<p&&m<f&&m<=P)this.mSumRLE5Ds+=1,this.mRLE5DSaved+=u-m,this.pushRLE5(45,r,c);else if(P<u&&P<g&&P<p&&P<f)this.mSumRLE6Ds+=1,this.mRLE6DSaved+=u-P,this.pushRLE6(61,a,d);else if(p<u&&p<g&&p<=f)this.mSumRLE5Xs+=1,this.mRLE5XSaved+=u-p,this.pushRLE5(44,s,h);else if(f<u&&f<g)this.mSumRLE6Xs+=1,this.mRLE6XSaved+=u-f,this.pushRLE6(60,n,l);else if(g<u)this.mSumRLE_Cs+=1,this.mRLECSaved+=u-g,this.pushRLEC(41,i,o);else {this.mSumPrints+=1;const i=[Oe.HOST_TO_DEVICE_DATA_START,We.CMD_BITMAP_PRINT,0,0];let s=this.pushEBV(i,2,t);s=this.pushEBV(i,s,e),this.mBufferList.push2(i,0,s,this.mLineData,t,this.mLineBytes);}this.mLineCount>1&&this.pushRepeat(this.mLineCount-1),this.mPrevData=this.mLineData,this.mPrevBytes=this.mLineBytes;}pushRepeat(t){if(t<=0)return;this.mSumRepeats+=t;const e=16383;let i=[Oe.HOST_TO_DEVICE_DATA_START,46,0];for(this.pushEBV(i,2,e);t>e;t-=16384)this.mBufferList.push(i);t>0&&(i=[Oe.HOST_TO_DEVICE_DATA_START,46,0],this.pushEBV(i,2,t-1),this.mBufferList.push(i));}pushEBV(t,e,i){return i>=192?(t[e+0]=i>>>8|192,t[e+1]=255&i,e+2):(t[e+0]=i,e+1)}pushRLEC(t,e,i){if(i<=0)return;const s=[Oe.HOST_TO_DEVICE_DATA_START,t,0],r=this.pushEBV(s,2,i);this.mBufferList.push2(s,0,r,e,0,i);}pushRLE5(t,e,i){if(i<=0)return;const s=[Oe.HOST_TO_DEVICE_DATA_START,t,0],r=this.pushEBV(s,2,i),n=Math.ceil(5*i/8);this.mBufferList.push2(s,0,r,e,0,n);}pushRLE6(t,e,i){if(i<=0)return;const s=[Oe.HOST_TO_DEVICE_DATA_START,t,0],r=this.pushEBV(s,2,i),n=Math.ceil(6*i/8);this.mBufferList.push2(s,0,r,e,0,n);}checkArrayEquals(t,e,i){for(let s=0;s<i;++s)if(t[s]!==e[s])return !1;return !0}}ke.MAX_EBV_VALUE=16383,ke.THRESHOLD_DEFAULT=128,ke.PRINTER_DPI_DEFAULT=203,ke.PRINTER_WIDTH_DEFAULT=384;class $e{static createInstance(t){const e=t?new Uint8Array(t):void 0;if(e&&!(e.length<14))return 53===e[0]&&51===e[1]?new $e(e):void 0}static uuidToString(t,e){if(!t)return "";const i=[];e&&i.push("0x");for(let e=t.length-1;e>=0;--e)i.push(we.toHexByteString(t[e]));return i.join("")}get deviceMainType(){return this.data[2]}get suggestedMtuI(){return 20*this.data[3]}get suggestedWaitI(){return this.data[4]}get suggestedMtuA(){return 20*this.data[5]}get suggestedWaitA(){return this.data[6]}get suggestedUUID(){return $e.uuidToString(this.data.slice(7,11))}get locateArea(){const t=this.data[11];return t>=P.A&&t<=P.Z?String.fromCharCode(t):""}get deviceFlags(){return Oe.toShort(this.data[12],this.data[13])}constructor(t){this.data=new Uint8Array(t);}toString(){return `[${we.getHexStringOfBytes(this.data,",")}]`}}class He{constructor(t,e){this.mCmd=t,this.mTimeout=e||2e3;}stop(){this.mTimer&&(clearTimeout(this.mTimer),this.mTimer=void 0);}start(t){this.mResponseAction=t,this.mTimer=setTimeout((()=>{this.invoke(void 0);}),this.mTimeout),d.log(`start request command, [TM: ${this.mTimer}, cmd: 0x${we.toHexByteString(this.mCmd)}]`);}invoke(t){d.log(`invoke request command, [TM: ${this.mTimer}, cmd: 0x${we.toHexByteString(this.mCmd)}], value = ${t?t.Data.join(","):"timeout"}`),this.stop(),this.mResponseAction&&this.mResponseAction(t);}}var Je,Ge,Ke;!function(t){t[t.None=0]="None",t[t.Connecting=1]="Connecting",t[t.Connected=2]="Connected",t[t.Checking=3]="Checking",t[t.ReadyPrint=4]="ReadyPrint",t[t.Sending=5]="Sending",t[t.Printing=6]="Printing",t[t.Paused=7]="Paused",t[t.Stopped=8]="Stopped",t[t.Abort=9]="Abort";}(Je||(Je={}));class Ve{static isSupportedService(t){if(!t)return !1;if(0===(t=this.getFullUUID(t)).indexOf("F000FFC0"))return !1;const e=/^0000([0-9A-F]{4})-0000-1000-8000-00805F9B34FB$/i.exec(t);if(e){const t=e[1];if(t>="0000"&&t<="2AFF")return !1;if("FF10"===t)return !1;if("FFC0"===t)return !1}else if(this.isMatchedUUID(t,"E7810A71-73AE-499D-8C15-FAA9AEF0C3F2"))return !1;return !0}static getFullUUID(t){return 4===t.length?`0000${t}-0000-1000-8000-00805F9B34FB`.toUpperCase():8===t.length?`${t}-0000-1000-8000-00805F9B34FB`.toUpperCase():t.toUpperCase()}static isMatchedUUID(t,e){return !(!t||!e)&&(t.length===e.length?t.toUpperCase()===e.toUpperCase():this.getFullUUID(t)===this.getFullUUID(e))}static isDeviceInfoService(t){return 0===this.getFullUUID(t).indexOf("0000180A")}static isDeviceInfoCharacteristic(t){return 0===this.getFullUUID(t).indexOf("00002A24")}static nextPageKey(t){return ++t>=65535&&(t=1),t}static test(){}constructor(t){this.mRequestQueue=new Map,this.mPrinterInfo={printerDPI:0,printerWidth:0,hardwareFlags:0,softwareFlags:We.PCPDSF_RLE5_BITMAP,softwareVersion:"",deviceName:"",deviceVersion:""},this.mRequestMTUs=0,this.mWriteWaitMSs=0,this.mExtraWriteMSs=0,this.mDFType="",this.mInitMTUs=0,this.mInitWriteWaits=0,this.mReadBuffer=[],this.mPackageStartRecords=[],this.mPrintJobList=[],this.mPausedPageList=[],this.mPrintingMap=new Map,this.mTempPageMap=new Map,this.mPrintPageKeyCheckTimer=0,this.mJobId=0,this.mIsPrPageKey=-1,this.mPageKey=Math.floor(255*Math.random()),this.mBufferSize=0,this.mPrintable=0,this.mIsCheckingPrintable=!1,this.mMcuId="",this.mClientType=0,this.mEnableMcuId=!1,this.mPageKeyEnable=!1,this.mDeviceNameStage=0,this.mPrintStatus=Je.None,this.mPrintStatusChanged=Te.createEmitter("PrintStatusChanged"),this.checkIndex=0,this.Adapter=t;}get Adapter(){return this.mBleAdapter}set Adapter(t){t&&t!==this.mBleAdapter&&(this.mBleAdapter=t);}get PrinterDPI(){return this.mPrinterInfo.printerDPI&&this.mPrinterInfo.printerDPI>0?this.mPrinterInfo.printerDPI:ke.PRINTER_DPI_DEFAULT}get PrinterWidth(){return this.mPrinterInfo.printerWidth&&this.mPrinterInfo.printerWidth>0?this.mPrinterInfo.printerWidth:ke.PRINTER_WIDTH_DEFAULT}get Printable(){return this.mPrintable}get ConnectStatus(){return this.mPrintStatus}get IsConnected(){return this.mPrintStatus>Je.Checking}get ClientType(){return this.mClientType}set ClientType(t){this.mClientType=t;}get InitMTUs(){return this.mInitMTUs}set InitMTUs(t){this.mInitMTUs=t;}get InitWriteWaits(){return this.mInitWriteWaits}set InitWriteWaits(t){this.mInitWriteWaits=t;}get ExtraWriteTimes(){return this.mExtraWriteMSs}set ExtraWriteTimes(t){t>=-30&&t<=30&&(this.mExtraWriteMSs=t);}get CurrentDevice(){return this.mDevice}get isPrinterAvailable(){return this.mPrintable>=0&&this.mPrintable<=We.DZIP_PAGENOTREADY}get EnableMcuId(){return this.mEnableMcuId}set EnableMcuId(t){this.mEnableMcuId=t;}get isPageKeyEnable(){return this.mPageKeyEnable}set isPageKeyEnable(t){this.mPageKeyEnable=t;}get isPageKeyValid(){return this.mPageKeyEnable&&this.mIsPrPageKey>=0}quit(){return this.Adapter.closeBleAdapter()}parseMTUInfo(t,e){const i=we.isIOS();if(this.mRequestMTUs=123,this.mWriteWaitMSs=i?20:10,this.mDFType="",e){const t=new Uint8Array(e),s=new Oe(We.CMD_NULL,Array.from(t)).popString().toUpperCase();d.info(`---- prepareRequestMTU: ${s}, isIOS = ${i}`);const r=s.lastIndexOf("-");this.mDFType=r>=0?s.substring(r+1):"";}if(t)return d.info("---- get mtu info from factory info!"),we.isIOS()?(this.mRequestMTUs=t.suggestedMtuI+3,this.mWriteWaitMSs=t.suggestedWaitI):(this.mRequestMTUs=t.suggestedMtuA+3,this.mWriteWaitMSs=t.suggestedWaitA),!0;if(this.mDFType){if("MT_DF1"===this.mDFType)this.mRequestMTUs=123,this.mWriteWaitMSs=i?18:15;else {const t=/^DF(\d+)$/.exec(this.mDFType);if(t){const e=parseInt(t[1]);5&~e?4&e?(this.mRequestMTUs=183,this.mWriteWaitMSs=i?10:3):2&e?(this.mRequestMTUs=123,this.mWriteWaitMSs=i?20:10):1&e&&(this.mRequestMTUs=183,this.mWriteWaitMSs=i?18:15):(this.mRequestMTUs=503,this.mWriteWaitMSs=i?5:3);}}return !0}return this.mInitMTUs>0&&(this.mRequestMTUs=this.mInitMTUs),this.mInitWriteWaits>0&&(this.mWriteWaitMSs=this.mInitWriteWaits),d.info("---- prepareRequestMTU: 未读取到DF信息。"),!1}dispatcherRequest(t){const e=t.Cmd,i=this.mRequestQueue.get(e);i&&(this.mRequestQueue.delete(e),i.invoke(t));}enqueueRequest(t,e,i){const s=new He(t,i);this.mRequestQueue.set(t,s),s.start((t=>{e&&e(t);}));}raisePrintStatusChanged(t){d.info(`◆◆◆ PrintStatusChanged: ${Je[this.mPrintStatus]} --\x3e ${Je[t]} ◆◆◆`),this.mPrintStatus=t,this.mPrintStatusChanged.emit(t);}parseManuToolkit(t,e){switch(e){case We.CMD_SUB_ROM_UPGRADE:break;case We.CMD_MANUSHIPTIME:{const e=t.popByteArray(),i=Ie.decode(e);d.info(`★★★★★★ CMD_MANU_TOOLKIT.manuShipTime: ${i} ★★★★★★`);break}case We.CMD_MCU_GETID:{const e=t.popByteArray();this.mMcuId=we.getHexStringOfBytes(e,"").toUpperCase(),d.info(`★★★★★★ CMD_MANU_TOOLKIT.McuId: ${this.mMcuId} ★★★★★★`);break}case We.CMD_ADDRESS_READ:{const e=t.popByteArray();d.info(`★★★★★★ CMD_MANU_TOOLKIT.addressRead: [${we.getHexStringOfBytes(e)}] ★★★★★★`);}}}onReadPackage(t){switch(d.info(`========== DataPackage.onReadPackage: cmd = 【0x${we.toHexByteString(t.Cmd)}】`),d.info(`data: [${we.getHexStringOfBytes(t.Data)}]`),t.Cmd){case We.CMD_DEVICE_TYPE:break;case We.CMD_BUFFER_SIZE:this.mBufferSize=500*t.popEBV(),d.info(`★★★ bufferSize: ${this.mBufferSize}[0x${this.mBufferSize.toString(16)}]`);break;case We.CMD_PRINTER_DPI:this.mPrinterInfo.printerDPI=t.popShort(),d.info(`★★★ printerDPI: ${this.mPrinterInfo.printerDPI}`);break;case We.CMD_PRINTER_WIDTH:if(t.Remains>=5){const e=t.popByteArray(),i=255&e[0],s=255&e[1];this.mPrinterInfo.printerWidth=(i<<8)+s;const r=255&e[2],n=255&e[3];this.mPrinterInfo.paperWidth=Math.round(.1*((r<<8)+n)),this.mPrinterInfo.printerLocateArea=255&e[4],d.info(`---- pagerWidth: ${this.mPrinterInfo.paperWidth}, printerLocateArea: ${this.mPrinterInfo.printerLocateArea}`);}else this.mPrinterInfo.printerWidth=t.popShort();d.info(`★★★ printerWidth: ${this.mPrinterInfo.printerWidth}`);break;case We.CMD_MANUFACTURER:this.mPrinterInfo.manufacturer=t.popString(),d.info(`★★★ manufacturer: ${this.mPrinterInfo.manufacturer}`);break;case We.CMD_DARKNESS:this.mPrinterInfo.printDarkness=t.popByte(),d.info(`★★★ printDarkness: ${this.mPrinterInfo.printDarkness}`);break;case We.CMD_SPEED:this.mPrinterInfo.printSpeed=t.popByte(),d.info(`★★★ printSpeed: ${this.mPrinterInfo.printSpeed}`);break;case We.CMD_GAP_TYPE:this.mPrinterInfo.gapType=t.popByte(),d.info(`★★★ gapType: ${this.mPrinterInfo.gapType}`);break;case We.CMD_GAP_LEN:this.mPrinterInfo.gapLength=t.popEBV(),d.info(`★★★ gapLength: ${this.mPrinterInfo.gapLength}`);break;case We.CMD_HARDWARE_FLAGS:{const e=t.Data;e.length>20?this.mPrinterInfo.batteryCount=255&e[20]:this.mPrinterInfo.batteryCount=2;const i=t.popInteger();this.mPrinterInfo.hardwareFlags=i,d.info(`mHardwareFlags: [${we.toHexString(this.mPrinterInfo.hardwareFlags,"0x")}]`),t.Remains>=4?this.mPrinterInfo.softwareFlags=t.popInteger():this.mPrinterInfo.softwareFlags=We.PCPDSF_MOTOR_ANTIDIR|We.PCPDSF_PRTA_RIGHT|i&We.PCPDSF_RLE5_BITMAP,d.info(`★★★ mSoftwareFlags: [${we.toHexString(this.mPrinterInfo.softwareFlags,"0x")}]`);break}case We.CMD_IS_PRINTABLE:this.mPrintable=t.popByte(),t.Remains>=5?t.popByte()==t.popByte()?this.mIsPrPageKey=t.popShort():this.mIsPrPageKey=0:this.mIsPrPageKey=-1,d.info(`★★★ printable  : 0x${this.mPrintable}, isPrPageKey: 0x${this.mIsPrPageKey.toString(16)}`);break;case We.CMD_DEVICE_NAME:{const e=t.popString();1===this.mDeviceNameStage?(this.mPrinterInfo.deviceName=e,d.info(`★★★ nameStage[${this.mDeviceNameStage}]: deviceName: ${e}`)):2===this.mDeviceNameStage?(this.mPrinterInfo.seriesName=e,d.info(`★★★ nameStage[${this.mDeviceNameStage}]: seriesName: ${e}`)):3===this.mDeviceNameStage?(this.mPrinterInfo.devIntName=e,d.info(`★★★ nameStage[${this.mDeviceNameStage}]: devIntName: ${e}`)):d.warn(`----  nameStage[${this.mDeviceNameStage}]: 未处理的设备信息 deviceName: ${e}`),this.mDeviceNameStage++;break}case We.CMD_DEVICE_VERSION:{const e=`${we.toHexByteString(t.popByte())}`;this.mPrinterInfo.deviceVersion=e.substring(0,1)+"."+e.substring(1),d.info(`★★★ deviceVersion: ${this.mPrinterInfo.deviceVersion}`);break}case We.CMD_SOFTWARE_VERSION:this.mPrinterInfo.softwareVersion=t.popString(),d.info(`★★★ softwareVersion: ${this.mPrinterInfo.softwareVersion}`);break;case We.CMD_MOTORMODE:this.mPrinterInfo.motorMode=t.popByte();break;case We.CMD_AUTOPOWEROFF:this.mPrinterInfo.autoPowerOffMins=t.popEBV();break;case We.CMD_REQ_ADCVALUE:case We.CMD_LANGUAGE:case We.CMD_CAP_GAPTYPE:case We.CMD_CAP_MOTORMODE:case We.CMD_CAP_LANGUAGE:break;case We.CMD_ENABLE_SETTING:129===t.popByte()&&d.info(`---- This printer supported command package start char is ${we.toHexByteString(Oe.HOST_TO_DEVICE_DATA_START,"0x")}`);break;case We.CMD_PERIPHERALFLAGS:if(1==t.Remains)this.mPrinterInfo.peripheralFlags=t.popByte();else if(t.popByte()===We.CMD_PERIPHERALTYPE_FLAGS)this.mPrinterInfo.peripheralFlags=t.popShort();break;case We.CMD_DEV_HANDSHAKE:break;case We.CMD_MANU_TOOLKIT:{const e=t.popByte();d.info(`★★★ CMD_MANU_TOOLKIT.childCmd: 【0x${we.toHexByteString(e)}】`),this.parseManuToolkit(t,e);break}case We.CMD_DEBUG_BUFFER:{const e=t.popByteArray();d.info(`★★★ CMD_MANU_TOOLKIT.debugBuffer: [${we.getHexStringOfBytes(e)}]`);}break;case We.CMD_PRINT_COUNTER:{const e=t.popByteArray();d.info(`★★★ CMD_MANU_TOOLKIT.printCounter: [${we.getHexStringOfBytes(e)}]`);for(let t=0;t<4;++t){const i=((255&e[4*t])<<24)+((255&e[4*t+1])<<16)+((255&e[4*t+2])<<8)+(255&e[4*t+3]);d.info(`---- printCounter.line${t} = ${i}`);}}}this.dispatcherRequest(t);}onDataReceived(t){const e=new Uint8Array(t),i=[];d.log(`#### 【onDataReceived】 [${we.getHexStringOfBytes(e)}]`);for(const t of e)if(this.mReadBuffer.length<=0)t===Oe.DEVICE_TO_HOST_DATA_START?this.mReadBuffer.push(t):i.push(t);else if(t===Oe.DEVICE_TO_HOST_DATA_START&&this.mPackageStartRecords.push(this.mReadBuffer.length),this.mReadBuffer.push(t),this.mReadBuffer.length>=4){let t=Oe.parse(this.mReadBuffer);if(!t&&this.mPackageStartRecords.length>0)for(let e=0;e<this.mPackageStartRecords.length;e++){const s=this.mPackageStartRecords[e];if(this.mReadBuffer.length-s>=4&&(t=Oe.parse(this.mReadBuffer.slice(s)),t)){i.push(...this.mReadBuffer.slice(0,s));break}}t&&(this.onReadPackage(t),this.mReadBuffer.splice(0),this.mPackageStartRecords.splice(0));}i.length>0&&d.warn(`#### 【丢弃无效的指令】：${we.getHexStringOfBytes(i)}`),this.mReadBuffer.length>0&&d.info(`---- 待处理数据：[${we.getHexStringOfBytes(this.mReadBuffer)}]`);}setBleMtu(t){const e="MT_DF1"===this.mDFType||"DF1"===this.mDFType||"DF2"===this.mDFType;return this.Adapter.setBleMtu({deviceId:t,mtu:this.mRequestMTUs,waits:this.mWriteWaitMSs,chipType:this.mDFType,required:e}).then((t=>("number"==typeof t.waits&&t.waits>0&&(this.mWriteWaitMSs=t.waits),t.status>0?this.mDFType?e&&(this.mRequestMTUs=23):(this.mRequestMTUs=this.mInitMTUs>=23?this.mInitMTUs:23,this.mInitWriteWaits>0&&(this.mWriteWaitMSs=this.mInitWriteWaits)):"number"==typeof t.mtu&&(this.mRequestMTUs=t.mtu>23?t.mtu:23),d.info(`---- setBleMtu.resp.status    : ${t.status}`),d.info(`---- requestMTU.mDFType       : ${this.mDFType}`),d.info(`---- requestMTU.mRequestMTUs  : ${this.mRequestMTUs}`),d.info(`---- requestMTU.mWriteWaitMSs : ${this.mWriteWaitMSs}`),d.info(`---- requestMTU.mExtraWriteMSs: ${this.mExtraWriteMSs}`),0!==t.status||we.sleep(100,!0))))}readMTUInfo(t,e){const i=e.find((t=>Ve.isMatchedUUID(t,"180A")));return i?this.Adapter.getGATTCharacteristics({deviceId:t,serviceId:i}).then((e=>{var s;const r=null===(s=e.find((t=>Ve.isMatchedUUID(t.uuid,"2A24"))))||void 0===s?void 0:s.uuid;if(r)return we.sleep(20).then((()=>this.Adapter.readCharacteristic({deviceId:t,serviceId:i,characteristicId:r}).then((t=>("string"==typeof t&&(t=we.getBytes(t)),t)))))})):Promise.resolve(void 0)}getValidateCharacteristic(e,i){return t(this,void 0,void 0,(function*(){const t=yield this.Adapter.getGATTCharacteristics({deviceId:e,serviceId:i}),s=[];for(const e of t)if(16&e.properties&&!(32&e.properties)&&(s[0]||Ve.isMatchedUUID(e.uuid,"FF03")||(s[0]=e,d.log(`---- 检测到 notify 通道： {uuid: ${e.uuid}, properties:${e.properties}}`))),(8&e.properties||4&e.properties)&&(s[1]||(Ve.isMatchedUUID(i,"FFE0")?Ve.isMatchedUUID(e.uuid,"FFE1")&&(s[1]=e):s[1]=e,s[1]&&d.log(`---- 检测到 write 通道： {uuid: ${e.uuid}, properties:${e.properties}}`))),s[0]&&s[1])break;return s[0]&&!s[0].serviceId&&(s[0].serviceId=i),s[1]&&!s[1].serviceId&&(s[1].serviceId=i),s}))}getPrintCharacteristics(e,i,s){return t(this,void 0,void 0,(function*(){let t,r;if(d.log(`---- suggestedService = ${s}`),s&&i.length>0&&(s=s.toUpperCase(),s=i.find((t=>Ve.getFullUUID(t).startsWith(s)))||""),s){const t=yield this.getValidateCharacteristic(e,s);if(t[0]&&t[1])return d.info(`---- 通过推荐的服务[${s}] 检测到了有效的读写通道！`),{notifyId:t[0],writeId:t[1]};d.warn(`---- 通过推荐的服务[${s}] 未检测到有效的读写通道！`);}for(const s of i)if(Ve.isSupportedService(s)){d.log(`---- 检测到可用 service: ${s}`);const i=yield this.getValidateCharacteristic(e,s);if(!t&&i[0]&&(t=i[0]),!r&&i[1]&&(r=i[1]),t&&r)return {notifyId:t,writeId:r};d.log(`---- service ${s} 读写特征值不全！`);}else d.log(`---- 不可用 serviceId: ${s}`);return d.warn("---- 未检测到有效的打印通道！"),{}}))}getGATTServices(e){return t(this,void 0,void 0,(function*(){const t=[];if(!this.mConnected)return d.warn("---- 打印机链接已断开！"),t;for(let i=0;i<5;i++){const s=yield this.Adapter.getGATTServices({deviceId:e});if(s&&s.length>0){d.info(`---- 【getGATTServices】: 第 [${i+1} / 5] 获取成功！`),t.push(...s);break}d.warn(`---- 【getGATTServices】: 第 [${i+1} / 5] 获取失败！`),yield we.sleep(300);}return t}))}startNotification(t,e,i){return this.getGATTServices(t).then((t=>{const e=t.map((t=>"string"==typeof t?t:(null==t?void 0:t.uuid)||""));return we.sleep(20,e)})).then((i=>(d.info(`---- serviceList.length: ${null==i?void 0:i.length}`),this.getPrintCharacteristics(t,i||[],e).then((e=>{const s=e.notifyId,r=e.writeId;return s&&r?(d.info(`---- notifyId [${s.serviceId}]: ${s.uuid}`),d.info(`---- writeId  [${r.serviceId}]: ${r.uuid}`),this.readMTUInfo(t,i||[]).then((e=>(this.parseMTUInfo(this.mFactoryInfo,e),d.info(`---- ---- requestMtu: ${this.mRequestMTUs} (byte)`),d.info(`---- ---- writeWaits: ${this.mWriteWaitMSs} (ms)`),this.setBleMtu(t).then((()=>(this.mWriteCharacteristic=r,this.mNotifyCharacteristic=s,this.mReadBuffer.splice(0),this.Adapter.notifyCharacteristic({deviceId:t,serviceId:s.serviceId,characteristicId:s.uuid,state:!0,dataReceived:t=>{"string"==typeof t&&(t=we.getBytes(t)),this.onDataReceived(t);}}).then((t=>we.sleep(50,t)))))))))):(d.warn("---- 未检测到有效的服务！"),!1)})))))}getPrinterInfo(){var t,e;return this.ConnectStatus>Je.Checking?Object.assign({},this.mPrinterInfo,{name:this.mDeviceName||"",deviceId:this.mDeviceId||"",writeCharacteristicId:null===(t=this.mWriteCharacteristic)||void 0===t?void 0:t.uuid,notifyCharacteristicId:null===(e=this.mNotifyCharacteristic)||void 0===e?void 0:e.uuid}):Object.assign({},this.mPrinterInfo)}createBleConnection(e){return t(this,void 0,void 0,(function*(){const t=e.device||{};this.mDeviceId=t.deviceId,this.mDeviceName=t.name,this.raisePrintStatusChanged(Je.Connecting);const i="number"==typeof e.tryTimes&&e.tryTimes>0?e.tryTimes:5;let s=0;const r={value:!1},n=e.timeout||5e3;setTimeout((()=>{r.value=!0;}),n);for(let a=0;a<i;a++){if(a>0&&(yield we.sleep(100)),s=yield this.Adapter.createBleConnection({deviceId:t.deviceId,timeout:n,connectionStateChange:t=>{t.deviceId!==this.mDeviceId||t.connected||(this.mConnected=!1,this.disconnect(),e.connectionStateChange&&e.connectionStateChange(t));}}),s<=0){d.info(`---- 【createBleConnection】: 第 [${a+1} / ${i}] 次链接成功！`);break}{const t=r.value?"超时":"失败";if(d.warn(`---- 【createBleConnection】: 第 [${a+1} / ${i}] 次链接${t}！`),r.value)break}}if(s>0)return this.raisePrintStatusChanged(Je.None),we.processFailResult({statusCode:s>De.ERROR_OTHER?s:De.ERROR_CONNECT_FAILED,resultInfo:"打印机链接失败！"});this.mConnected=!0,this.raisePrintStatusChanged(Je.Connected),this.mDevice=t,this.mDeviceId=t.deviceId,this.mDeviceName=t.name,this.mFactoryInfo=$e.createInstance(t.advertisData),d.info(`---- factoryInfo: ${this.mFactoryInfo?this.mFactoryInfo.toString():"[-]"}`),yield we.sleep(100);const a=this.mFactoryInfo?this.mFactoryInfo.suggestedUUID:"";if(!(yield this.startNotification(t.deviceId,a,e.delayTime)))return d.warn("---- 数据检测启动失败！"),yield this.disconnect(t),we.processFailResult({statusCode:De.ERROR_START_NOTIFICATION,resultInfo:"notify 特征值启动失败！"});this.raisePrintStatusChanged(Je.Checking),yield we.sleep(30);const o=yield this.checkPrinter();return o.statusCode!==De.OK?(d.error(`---- 打印机相关参数获取失败(statusCode: ${o.statusCode})！`),this.raisePrintStatusChanged(Je.None),yield this.disconnect(t),we.processFailResult(o)):(this.mDeviceId=t.deviceId,this.raisePrintStatusChanged(Je.ReadyPrint),we.processSuccessResult({statusCode:De.OK,resultInfo:this.getPrinterInfo()}))}))}isDeviceConnected(t){return this.mPrintStatus>=Je.ReadyPrint&&this.mDeviceId===t}connect(e){return t(this,void 0,void 0,(function*(){const t=(e.device||{}).deviceId;if(!t)return {statusCode:De.ERROR_PARAM,resultInfo:"未指定设备ID！"};if(this.mPrintStatus>Je.None){if(t===this.mDeviceId)return this.IsConnected?(d.info(`---- 打印机已连接：${t}`),{statusCode:De.OK,resultInfo:"设备已连接！"}):(d.info("---- 正在链接，请稍后..."),new Promise((t=>{const e=this.mPrintStatusChanged.on((i=>{i===Je.ReadyPrint?(this.mPrintStatusChanged.off(e),t({statusCode:De.OK})):i===Je.None&&(this.mPrintStatusChanged.off(e),t({statusCode:De.ERROR_CONNECT_FAILED}));}));})));yield this.disconnect();}return yield this.createBleConnection(e)}))}disconnect(e,i){return t(this,void 0,void 0,(function*(){const t=e?e.name:this.mDeviceName,s=e?e.deviceId:this.mDeviceId||"";return d.info(`---- disconnect(${t}[${s}])`),d.info(`---- ---- mPrintStatus: ${this.mPrintStatus}`),(!s||this.mDeviceId===s)&&(this.mConnected&&this.mPrintStatus===Je.Printing&&!i&&(yield new Promise((t=>{const e=this.mPrintStatusChanged.on((i=>{(i===Je.ReadyPrint||i>Je.Printing)&&(this.mPrintStatusChanged.off(e),t(e));}));}))),this.mPrintStatus>Je.Connected&&this.mDeviceId&&this.mNotifyCharacteristic&&(yield this.Adapter.notifyCharacteristic({deviceId:this.mDeviceId,serviceId:this.mNotifyCharacteristic.serviceId,characteristicId:this.mNotifyCharacteristic.uuid,state:!1})),this.mConnected=!1,this.mWriteCharacteristic=void 0,this.mNotifyCharacteristic=void 0,yield this.Adapter.closeBleConnection({name:t,deviceId:s||""}),this.raisePrintStatusChanged(Je.None),d.info("---- 打印机断开成功！"),!0)}))}setPrinterParam(t){this.mPrintStatus<Je.ReadyPrint||this.mPrintStatus===Je.Sending||this.checkAndSendPrintParams(t);}pushPrintJob(t){const e=t.jobOptions;if(e.onlyGetRawData){const i=e.imageDatas||[];for(let s=0;s<i.length;s++){const r=ke.encodeImageData(Object.assign(Object.assign({},e),{imageData:i[s]})),n={statusCode:De.OK,pageKey:0,printCopies:1,copyIndex:0,printPages:i.length,pageIndex:s,printData:r.length>0?we.combineUint8Array(r):void 0};r.length<=0&&(n.statusCode=De.ERROR_PARAM),t.onPageSendComplete&&t.onPageSendComplete(n);}t.onJobSendComplete&&t.onJobSendComplete(De.OK);}else this.mPrintJobList.push(t),t.jobPushed&&t.jobPushed(),(this.mPrintStatus===Je.ReadyPrint||this.mPrintStatus>Je.Sending)&&(this.mPausedPageList.splice(0),this.popAndSendPrintJob());}onPrinterNotAvailable(t){if(this.mPrintStatus===Je.Sending||this.mPrintStatus===Je.Printing){this.mPausedPageList.splice(0),this.mPausedPageList.push(...Array.from(this.mPrintingMap.values())),this.mPrintingMap.clear(),this.raisePrintStatusChanged(Je.Paused);const e=this.mPausedPageList.map((t=>we.toHexShortString(t.pageKey,"0x"))).join(",");if(d.warn(`#### #### 检测到打印机异常: printable = ${this.mPrintable}`),d.info(`---- 打印任务已暂停，并已暂存未完成的打印任务：[${e}]`),this.mPausedPageList.length>0&&(t=this.mPausedPageList[0]),t){const e=t.job,i=Object.assign(Object.assign({},t),{printable:this.mPrintable,statusCode:De.ERROR_PRINTER_NOT_AVAILABLE});e.onPagePrintComplete&&e.onPagePrintComplete(i,e);}}}stopCheckPrintPageKeyTimer(){this.mPrintPageKeyCheckTimer>0&&(clearInterval(this.mPrintPageKeyCheckTimer),this.mPrintPageKeyCheckTimer=0);}checkPrintPageKey(){this.isPageKeyValid&&(this.mPrintPageKeyCheckTimer>0||(this.checkIndex=0,this.mPrintPageKeyCheckTimer=setInterval((()=>{if(this.mPrintable===We.DZIP_PRINTABLE&&(this.checkIndex++,this.checkIndex>10)){const t=Array.from(this.mPrintingMap.keys()).map((t=>`0x${t.toString(16)}`)).join(";"),e=Array.from(this.mTempPageMap.keys()).map((t=>`0x${t.toString(16)}`)).join(";");d.warn(`---- 检测到未处理的打印任务：pageKey1 = [${t}}], pageKey2 = [${e}]`),this.mTempPageMap.clear(),this.stopCheckPrintPageKeyTimer();}this.mIsCheckingPrintable||this.mPrintStatus!==Je.Printing||(d.log("---- checkPrintPageKey：检查打印页面的 pageKey!"),this.tryCheckPrintable(2,2e3));}),300)));}onPrintProgress(t,e){if(d.log(`---- onPrintProgress: printStatus = ${this.mPrintStatus}`),this.mPrintingMap.size<=0&&this.mTempPageMap.size<=0)this.stopCheckPrintPageKeyTimer();else if(this.mPrintStatus===Je.Sending||this.mPrintStatus===Je.Printing)if(t>=We.DZIP_PAGENOTREADY&&t<255)this.onPrinterNotAvailable();else if(t>=0){let i;if(e<=0){d.warn(`---- 检测到无效的 pageKey[${e}]，首张未处理的打印信息已转存到临时缓存！`);const t=Array.from(this.mPrintingMap.keys());i=this.mPrintingMap.get(t[0]),i&&(this.mTempPageMap.set(i.pageKey,i),this.mPrintingMap.delete(i.pageKey));}else this.mPrintingMap.has(e)?(i=this.mPrintingMap.get(e),this.mPrintingMap.delete(e)):this.mTempPageMap.has(e)&&(i=this.mTempPageMap.get(e),this.mTempPageMap.delete(e));if(i){const s=i.job;s.onPagePrintComplete&&s.onPagePrintComplete({statusCode:De.OK,printable:t,pageKey:i.pageKey,pageKey2:e,pageIndex:i.pageIndex,printPages:i.printPages,copyIndex:i.copyIndex,printCopies:i.printCopies},s);const r=Array.from(this.mPrintingMap.keys()).map((t=>`0x${t.toString(16)}`)),n=Array.from(this.mTempPageMap.keys()).map((t=>`0x${t.toString(16)}`));d.info(`---- 剩余打印页面：[${r.join(",")}]`),d.info(`---- 无效打印页面：[${n.join(",")}]`);}this.mPrintingMap.size<=0&&this.mTempPageMap.size<=0&&this.mPrintJobList.length<=0&&this.mPausedPageList.length<=0&&(this.raisePrintStatusChanged(Je.ReadyPrint),this.stopCheckPrintPageKeyTimer());}}sendPausedPages(){return t(this,void 0,void 0,(function*(){if(this.mPausedPageList.length<=0)return De.OK;let t=De.OK;for(d.info(`#### #### sendPausedPages: 继续打印暂存的打印任务: [${this.mPausedPageList.map((t=>we.toHexShortString(t.pageKey,"0x"))).join(",")}]`),this.stopCheckPrintPageKeyTimer();this.mPausedPageList.length>0;){const e=this.mPausedPageList.shift();if(e){if(this.mPrintStatus>=Je.Stopped){d.log("---- 取消打印正在进行的暂存任务！"),t=De.ERROR_JOB_CANCELED;break}const i=`J${e.job.jobId}-P${e.pageIndex}-C${e.copyIndex}`;if(this.isPageKeyValid&&ke.updatePageKey(e.dataList,e.pageKey),t=yield this.sendPrintPage(e.dataList,e.pageKey,e.job,!0,i),t===De.ERROR_PRINTER_NOT_AVAILABLE){this.mPausedPageList.unshift(e),e.job.onPageSendComplete&&e.job.onPageSendComplete(Object.assign(Object.assign({},e),{statusCode:t,printable:this.mPrintable}));break}if(t!==De.OK){const i=e.job;this.raisePrintStatusChanged(Je.Stopped),i.onPageSendComplete&&i.onPageSendComplete(Object.assign(Object.assign({},e),{statusCode:t})),i.onPagePrintComplete&&i.onPagePrintComplete(Object.assign(Object.assign({},e),{statusCode:t}),i);break}e.job.onPageSendComplete&&e.job.onPageSendComplete(Object.assign(Object.assign({},e),{statusCode:t})),e.copyIndex+1>=e.printCopies&&e.job.onJobSendComplete&&e.job.onJobSendComplete(t),this.raisePrintStatusChanged(Je.Printing),this.mPrintingMap.set(e.pageKey,e);}}if(t!==De.OK&&t!==De.ERROR_PRINTER_NOT_AVAILABLE){let e=-1;for(const i of this.mPausedPageList)i.job.jobId!==e&&(i.job.onPagePrintComplete&&i.job.onPagePrintComplete(Object.assign(Object.assign({},i),{statusCode:t}),i.job),e=i.job.jobId);this.mPausedPageList.splice(0);}return this.checkPrintPageKey(),t}))}popAndSendPrintJob(){return t(this,void 0,void 0,(function*(){let t=De.OK;const e=this.mPrintJobList.shift();if(!e)return this.isPageKeyValid?this.raisePrintStatusChanged(Je.Printing):this.raisePrintStatusChanged(Je.ReadyPrint),this.checkPrintPageKey(),De.OK;const i=e.jobOptions.imageDatas||[];let s=e.jobOptions.printCopies||e.jobOptions.copies;s="number"==typeof s&&s>1?s:1,this.stopCheckPrintPageKeyTimer(),this.mPrintStatus>=Je.Paused&&this.raisePrintStatusChanged(Je.ReadyPrint);for(let r=0;r<i.length;r++){const n={pageKey:this.mPageKey,statusCode:t,printable:this.mPrintable,pageIndex:r,printPages:i.length,copyIndex:0,printCopies:s};(yield this.tryCheckPrintable(3,2e3))?this.isPrinterAvailable||(t=this.mPrintable===We.DZIP_JOBCANCELED?De.ERROR_PRINTER_CANCELED:De.ERROR_PRINTER_NOT_AVAILABLE):t=De.ERROR_DATA_SEND_ERROR,d.info(`【${e.jobId}】 - 开始生成打印数据 page: [${r+1} - ${i.length}]!`);const a=ke.encodeImageData(Object.assign(Object.assign({},e.jobOptions),{imageData:i[r]}),this.isPageKeyValid?this.mPageKey:0,this.mPrinterInfo);if(a.length<=0){t=De.ERROR_PARAM,e.onPageSendComplete&&e.onPageSendComplete(n);break}for(let o=0;o<s;o++){n.copyIndex=o,n.pageKey=this.mPageKey,n.printable=this.mPrintable,this.mPrintStatus>=Je.Stopped&&(t=De.ERROR_JOB_CANCELED);const h=`J${e.jobId}-P${r}-C${o}`;if(t===De.OK&&(this.isPageKeyValid&&o>0&&ke.updatePageKey(a,this.mPageKey),t=yield this.sendPrintPage(a,this.mPageKey,e,o>0,h)),t===De.OK)this.raisePrintStatusChanged(Je.Printing);else if(t!==De.ERROR_PRINTER_NOT_AVAILABLE){e.onPageSendComplete&&e.onPageSendComplete(Object.assign(Object.assign({},n),{printable:this.mPrintable,statusCode:t})),this.raisePrintStatusChanged(Je.Stopped);break}n.printable=this.mPrintable;const c=Object.assign(Object.assign({},n),{pageKey:this.mPageKey,job:e,dataList:a});if(t===De.ERROR_PRINTER_NOT_AVAILABLE?(this.mPrintStatus!==Je.Paused&&this.onPrinterNotAvailable(c),this.mPausedPageList.push(c),d.info(`---------- 暂存打印数据：${h}, pageKey: 0x${this.mPageKey.toString(16)}`)):t===De.OK&&this.isPageKeyValid&&this.mPrintingMap.set(this.mPageKey,c),e.onPageSendComplete&&e.onPageSendComplete(Object.assign(Object.assign({},n),{printable:this.mPrintable,statusCode:t})),o+1>=s&&r+1>=i.length&&(e.endKey=this.mPageKey),this.mPageKey=Ve.nextPageKey(this.mPageKey),t!==De.OK&&t!==De.ERROR_PRINTER_NOT_AVAILABLE)break}if(t!==De.OK)break}return d.info(`【${e.jobId}】 - 当前打印任务处理完毕, statusCode = ${t}！`),e.onJobSendComplete&&e.onJobSendComplete(t),t!==De.OK?(this.mPrintJobList.splice(0),this.raisePrintStatusChanged(Je.ReadyPrint),t):this.popAndSendPrintJob()}))}sendPrintPage(e,i,s,r,n){return t(this,void 0,void 0,(function*(){const t=e;let a=this.mBufferSize,o=0;const h=`0x${i.toString(16)}`;if(r){if(!(yield this.tryCheckPrintable(3,2e3)))return De.ERROR_DATA_SEND_ERROR;if(!this.isPrinterAvailable)return this.mPrintable===We.DZIP_JOBCANCELED?De.ERROR_PRINTER_CANCELED:De.ERROR_PRINTER_NOT_AVAILABLE}for(d.info(`=====>【${n||s.jobId} - ${i}(${h})】 - 开始发送打印任务!`),this.raisePrintStatusChanged(Je.Sending);o<t.length;){const e=t[o];if(this.mPrintStatus>=Je.Stopped)return d.warn(`    [${h}] - 打印任务已取消，当前打印进度：[${o+1} / ${t.length}]！`),De.ERROR_JOB_CANCELED;if(a<3e3){if(d.log(`    [${h}] - 检查缓存大小`),!(yield this.tryCheckPrintable(5)))return d.warn(`    [${h}] - 缓存检查失败，bufferSize: ${a}`),d.warn(`    [${h}] - 数据接收异常，停止发送！`),De.ERROR_DATA_SEND_ERROR;if(this.isPrinterAvailable)a=this.mBufferSize,d.log(`    [${h}] - bufferSize: ${a}`);else {if(this.mPrintable!==We.DZIP_TPHTOOHOT)return d.warn(`    [${h}] - 打印机异常，printable: ${this.mPrintable}`),De.ERROR_PRINTER_NOT_AVAILABLE;d.warn(`    [${h}] - 打印头温度过高！`),yield we.sleep(1e3);}}else d.log(`    **** [${h}] - 数据发送进度: [${o+1} / ${t.length}]`),d.log(`    ---- [${h}] - dataLen[mtu,waits,extraWaits]: ${e.length} [${this.mRequestMTUs-3}, ${this.mWriteWaitMSs}, ${this.mExtraWriteMSs}]`),yield this.sendPackage(e,o),o++,a-=e.length;}return yield we.sleep(50),De.OK}))}sendPackage(e,i){return t(this,void 0,void 0,(function*(){return yield this.write(e,i)}))}trySendPackage(e,i,s){return t(this,void 0,void 0,(function*(){if(s&&s>0){let t={statusCode:De.OK};for(let r=0;r<s;r++){if(t=yield this.sendPackage(e,i),t.statusCode===De.OK)return t;d.warn(`第 [${r+1} - ${s}] 次发送数据包失败！`);}return t}return this.sendPackage(e,i)}))}write(e,i){return t(this,void 0,void 0,(function*(){var t,s;const r=this.mRequestMTUs-3,n=e.length,a=this.mWriteWaitMSs+this.mExtraWriteMSs;let o,h={statusCode:De.OK};for(let c=0,l=0,u=0;c<n;)if(h={statusCode:De.ASYNC_WAIT},o=c+r<e.length?e.slice(c,c+r):e.slice(c),this.Adapter.writeCharacteristic({deviceId:this.mDeviceId||"",serviceId:(null===(t=this.mWriteCharacteristic)||void 0===t?void 0:t.serviceId)||"",characteristicId:(null===(s=this.mWriteCharacteristic)||void 0===s?void 0:s.uuid)||"",data:o,pkgIndex:i,subPkgIndex:u,complete:t=>{h=t;}}),yield we.sleep(a>0?a:1),h.statusCode>De.OK){if(l++,d.warn(`---- 打印数据发送失败，正在重新发送打印数据, tryTimes = [${l} / 5], waitTimes = ${a}`),l>=5)break}else h.statusCode,De.OK,l=0,c+=r,u++;return h}))}stopPrint(){if(d.info(`---- stopPrint: ${this.mPrintPageKeyCheckTimer}`),this.mPrintPageKeyCheckTimer>0&&this.stopCheckPrintPageKeyTimer(),this.mPrintStatus===Je.Paused){if(this.mPausedPageList.length>0){const t=this.mPausedPageList.map((t=>we.toHexShortString(t.pageKey,"0x"))).join(",");d.log(`---- 清空暂存打印任务：${t}`),this.mPausedPageList.splice(0);}this.mPrintingMap.size>0&&this.mPrintingMap.clear(),this.mTempPageMap.size>0&&this.mTempPageMap.clear(),this.raisePrintStatusChanged(Je.ReadyPrint);}else this.mPrintStatus>Je.ReadyPrint&&(this.raisePrintStatusChanged(Je.Stopped),this.mPrintingMap.size>0&&this.mPrintingMap.clear());}continuePrint(){return this.mPausedPageList.length<=0?Promise.resolve(De.OK):this.sendPausedPages()}pushImageData(t){const e={statusCode:De.OK};this.mPrintStatus===Je.Paused&&this.stopPrint(),t.data&&t.width&&t.height&&("string"==typeof t.data&&(t.data=we.getBytes(t.data)),t.imageData={width:t.width,height:t.height,data:t.data,colorSpace:"srgb"});const i=t.imageDatas||[];if(i.length<=0&&t.imageData&&i.push(t.imageData),!i||i.length<=0)return e.statusCode=De.ERROR_PARAM,e.status=e.statusCode,t.onJobComplete&&t.onJobComplete(e),e;if(!t.onlyGetRawData&&this.mPrintStatus<Je.ReadyPrint)return e.statusCode=De.ERROR_DISCONNECTED,e.status=e.statusCode,t.onJobComplete&&t.onJobComplete(e),e;{const s=this.mJobId++;t.imageDatas=i;const r=[];return t.onlyGetRawData&&(e.printData=r),this.pushPrintJob({jobId:s,startKey:this.mPageKey,jobOptions:t,jobPushed:()=>{d.info(`======== 打印任务 [${s}] 添加成功!`),t.jobPushed&&t.jobPushed(s);},onPageSendComplete:e=>{const i=e.pageKey||0;d.log(`---- 打印页面 [${s} - ${i}(0x${i.toString(16)})] 数据发送结束: { result: ${e.statusCode}, page: [${e.pageIndex+1} / ${e.printPages}], copy: [${e.copyIndex+1} / ${e.printCopies}]}`),e.printData&&e.printData.length>0&&r.push(e.printData),e.status=e.statusCode,t.onPageComplete&&t.onPageComplete(e);},onPagePrintComplete:(i,r)=>{const n=i.pageKey||0;d.log(`---- 打印页面 [${s} - ${n}(0x${n.toString(16)})] 打印结束: { result: ${i.statusCode}, page: [${i.pageIndex+1} / ${i.printPages}], copy: [${i.copyIndex+1} / ${i.printCopies}]}`),t.onPagePrintComplete&&t.onPagePrintComplete(i),e.statusCode=i.statusCode,e.printable=i.printable,i.statusCode!==De.OK?t.onJobPrintComplete&&t.onJobPrintComplete(e):i.pageIndex+1===i.printPages&&i.copyIndex+1===i.printCopies&&(d.info(`★★★★★ 打印任务【${r.jobId}】 打印完毕全部打印完毕！ ★★★★★`),t.onJobPrintComplete&&t.onJobPrintComplete(e));},onJobSendComplete:i=>{d.info(`======== 打印任务 [${s}] 处理完毕!`),Object.assign(e,{statusCode:i,status:i,printable:this.mPrintable}),t.onJobComplete&&t.onJobComplete(e);}}),e}}printImageData(t){return new Promise((e=>{this.pushImageData(Object.assign(Object.assign({},t),{onJobComplete:i=>{t.onJobComplete&&t.onJobComplete(i),e(i);}}));}))}checkPrinter(){return t(this,void 0,void 0,(function*(){let t=yield this.writeCommandAsync(We.CMD_PRINTER_DPI);if(t.statusCode!==De.OK)return t;const e=new Me;if(e.pushPackage(We.CMD_PRINTER_WIDTH),e.pushPackage(We.CMD_IS_PRINTABLE),t=yield this.write(e.getAllBytes()),t.statusCode>De.OK)return t;if(this.mDeviceNameStage=1,e.clearBuffer(),e.pushPackage(We.CMD_SOFTWARE_VERSION),e.pushPackage(We.CMD_DEVICE_NAME),e.pushPackage(We.CMD_DEVICE_VERSION),e.pushPackage(We.CMD_MANUFACTURER),yield this.write(e.getAllBytes()),e.clearBuffer(),e.pushPackage(We.CMD_ENABLE_SETTING,[~We.CMD_ENABLE_SETTING]),e.pushPackage(We.CMD_HARDWARE_FLAGS,[1]),this.mEnableMcuId&&(e.pushPackage(We.CMD_MANU_TOOLKIT,[We.CMD_MCU_GETID]),e.pushPackage(We.CMD_PERIPHERALFLAGS,[We.CMD_PERIPHERALTYPE_FLAGS,0]),e.pushPackage(We.CMD_MANU_TOOLKIT,[We.CMD_MANUSHIPTIME])),e.pushPackage(We.CMD_ENABLE_SETTING,[128]),t=yield this.write(e.getAllBytes()),t.statusCode>De.OK)return t;e.clearBuffer(),e.pushPackage(We.CMD_DEVICE_NAME,["S".charCodeAt(0)]),e.pushPackage(We.CMD_DEVICE_NAME,["D".charCodeAt(0)]),yield this.write(e.getAllBytes()),e.clearBuffer(),e.pushPackage(We.CMD_GAP_TYPE),e.pushPackage(We.CMD_GAP_LEN),yield this.write(e.getAllBytes());let i=[13];return this.mClientType>0&&(i=this.mClientType>255?Oe.getBytesFromShort(this.mClientType):[this.mClientType]),this.writeCommandAsync(We.CMD_DEVICE_TYPE,Array.from(i))}))}waitPrintable(t){const e=t||3e3;return new Promise((t=>{let i=0;const s=setInterval((()=>{i++,(!this.mIsCheckingPrintable||10*i>=e)&&(clearInterval(s),t(!0));}),10);}))}checkPrintable(e){return t(this,void 0,void 0,(function*(){this.mIsCheckingPrintable&&(yield this.waitPrintable()),this.mIsCheckingPrintable=!0,this.mPrintable=255,d.info("▶▶▶▶▶ checkPrintable: 0xFF ◀◀◀◀◀");const t=new Me;return t.pushPackage(We.CMD_ENABLE_SETTING,[~We.CMD_ENABLE_SETTING]),t.pushPackage(We.CMD_HARDWARE_FLAGS,[1]),t.pushPackage(We.CMD_ENABLE_SETTING,[0]),yield this.write(t.getAllBytes()),new Promise((i=>{t.clearBuffer(),t.pushPackage(We.CMD_IS_PRINTABLE),t.pushPackage(We.CMD_BUFFER_SIZE),this.write(t.getAllBytes()),this.enqueueRequest(We.CMD_BUFFER_SIZE,(t=>{t||(this.mPrintable=-1,d.warn("---- checkPrintable timeout!"));const e=this.mPrintable,s=this.mIsPrPageKey.toString(16);d.info(`▶▶▶▶▶ printable: 0x${e}, pageKey: ${this.mIsPrPageKey}[0x${s}] ◀◀◀◀◀`),this.onPrintProgress(this.mPrintable,this.mIsPrPageKey),this.mIsCheckingPrintable=!1,i(t);}),e||2e3);}))}))}tryCheckPrintable(e,i){return t(this,void 0,void 0,(function*(){if(!(e&&e>0))return this.checkPrintable(i);for(let t=0;t<e;t++){const s=yield this.checkPrintable(i);if(s)return s;d.warn(`---- tryCheckPrintable failed of tryTimes: [${t+1} - ${e}]`);}}))}checkAndSendPrintParams(e,i){return t(this,void 0,void 0,(function*(){if(!this.IsConnected)return;this.mPrintStatus,Je.Sending,this.mIsCheckingPrintable&&(yield this.waitPrintable()),this.mIsCheckingPrintable=!0,this.mPrintable=255,d.info("▶▶▶▶▶ checkAndSendPrintParams: printable = 0xFF ◀◀◀◀◀");const t=new Me;let s=e.printDarkness;return "number"==typeof s&&s>=Se.Min&&s<=Se.High&&t.pushPackage(We.CMD_DARKNESS,[s-1]),s=e.printSpeed,"number"==typeof s&&s>=_e.Min&&s<=_e.Max&&t.pushPackage(We.CMD_SPEED,[s-1]),s=e.gapType,"number"==typeof s&&s>=ve.None&&s<=ve.Trans&&t.pushPackage(We.CMD_GAP_TYPE,[s]),s=e.gapLength,"number"==typeof s&&s>0&&s<=ke.MAX_EBV_VALUE&&t.pushPackage(We.CMD_GAP_LEN,Oe.fromEBV(s)),s=e.motorMode,"number"==typeof s&&s>=0&&t.pushPackage(We.CMD_MOTORMODE,[s]),s=e.autoPowerOffMins,"number"==typeof s&&s>0&&t.pushPackage(We.CMD_AUTOPOWEROFF,Oe.fromEBV(s)),t.pushPackage(We.CMD_BUFFER_SIZE),yield this.write(t.getAllBytes()),new Promise((e=>{t.clearBuffer(),t.pushPackage(We.CMD_IS_PRINTABLE),t.pushPackage(We.CMD_BUFFER_SIZE),this.write(t.getAllBytes()),this.enqueueRequest(We.CMD_BUFFER_SIZE,(t=>{t||(this.mPrintable=-1,d.warn("---- checkAndSendPrintParams timeout!")),this.mIsCheckingPrintable=!1,e(t);}),i||2e3);}))}))}writeCommandAsync(e,i){return t(this,void 0,void 0,(function*(){return new Promise((t=>{d.log(`---- writeCommand: cmd = ${we.toHexByteString(e)}`),this.write(Me.getBytes(e,i)).then((e=>{e.statusCode>De.OK&&t(e);})),this.enqueueRequest(e,(e=>{t(e?{statusCode:De.OK,resultInfo:e}:{statusCode:De.ERROR_RESPONSE_TIMEOUT,resultInfo:"指令发送响应超时！"});}));}))}))}}!function(t){t[t.BROADCAST=1]="BROADCAST",t[t.READ=2]="READ",t[t.WRITE_NO_RESPONSE=4]="WRITE_NO_RESPONSE",t[t.WRITE=8]="WRITE",t[t.NOTIFY=16]="NOTIFY",t[t.INDICATE=32]="INDICATE";}(Ge||(Ge={}));class ze{static getInstance(){return this._instance||(this._instance=new ze),this._instance}static isSupported(){return navigator&&"bluetooth"in navigator}constructor(){this.mShowWriteLog=!1,navigator&&"bluetooth"in navigator?this.mBluetooth=navigator.bluetooth:d.warn("---- 当前环境不支持 WebBluetooth API 接口！");}closeBleAdapter(){return Promise.resolve(!0)}startBleDiscovery(t){const e=t||{};return new Promise((t=>{if(this.mBluetooth){const i=(e.models||"").split(/[;]/).filter((t=>!!t));i.find((t=>t.startsWith("DT")))||i.push("DT"),i.find((t=>t.startsWith("DP")))||i.push("DP"),i.find((t=>t.startsWith("P")))||i.push("P"),this.mBluetooth.requestDevice({optionalServices:["49535343-fe7d-4ae5-8fa9-9fafd205e455","0000180a-0000-1000-8000-00805f9b34fb","0000ff00-0000-1000-8000-00805f9b34fb","0000ff10-0000-1000-8000-00805f9b34fb"],filters:i.map((t=>({namePrefix:t})))}).then((i=>{d.info(i),this.mDevice=i;const s=[{name:i.name,deviceId:i.id}];e.deviceFound&&e.deviceFound(s);const r={statusCode:0,resultInfo:i};e.complete&&e.complete(r),t(r);})).catch((i=>{d.warn(i);const s={statusCode:1,resultInfo:i};e.complete&&e.complete(s),t(s);}));}else {const i="当前环境不支持 WebBluetooth 功能！";d.warn(`---- ${i}`),we.processFailResult({statusCode:-1,resultInfo:i},e,t);}}))}stopBleDiscovery(){return Promise.resolve(!0)}createBleConnection(t){var e,i;const s="string"==typeof t?{deviceId:t}:t||{};if(!s.deviceId)return new Promise((t=>{var e;(null===(e=this.mGattServer)||void 0===e?void 0:e.connected)?we.processSuccessResult(De.OK,s,t):we.processFailResult(De.ERROR_PARAM,s,t);}));if(null===(e=this.mGattServer)||void 0===e?void 0:e.connected)return this.mGattServer.device.id===s.deviceId?(d.info("---- 打印机已连接 ----"),Promise.resolve(we.processSuccessResult(0,s))):this.closeBleConnection(s).then((()=>De.OK));const r=this.mDevice||(null===(i=this.mGattServer)||void 0===i?void 0:i.device);if(d.info(r),!r||s.deviceId!==r.id)return Promise.resolve(we.processFailResult(De.ERROR_CONNECT_FAILED,s));try{return d.info("### 【Request】 device.gatt.connect()"),r.gatt.connect().then((t=>(d.info(t),(null==t?void 0:t.connected)?(this.mGattServer=t,this.mConnectionStateChange=s.connectionStateChange,r.addEventListener("gattserverdisconnected",(t=>{d.info("---- gattDevice.gattserverdisconnected: 打印机断开成功！"),d.info(t),this.mConnectionStateChange&&this.mConnectionStateChange({deviceId:r.id,connected:!1});})),we.sleep(100).then((()=>we.processSuccessResult(0,s)))):we.processFailResult(De.ERROR_CONNECT_FAILED,s)))).catch((t=>(d.warn("---- 【Response】 device.gatt.connect.catch:"),d.warn(t),we.processFailResult(De.ERROR_CONNECT_FAILED,s))))}catch(t){return d.warn("----- try catch: device.gatt.connect:"),d.warn(t),Promise.resolve(we.processFailResult(De.ERROR_CONNECT_FAILED,s))}}closeBleConnection(e){return t(this,void 0,void 0,(function*(){var t;const i="string"==typeof e?{deviceId:e}:e||{};return this.mGattServer?i.deviceId&&i.deviceId!==(null===(t=this.mGattServer.device)||void 0===t?void 0:t.id)?(d.info(`#### WebBleAdapter.disconnect Failed! {current: ${this.mGattServer.device.id}, target: ${i.deviceId}}`),we.processFailResult(De.ERROR_PARAM,i)):this.mGattServer.connected?(this.mNotifyCharacter&&(d.info("---- 关闭通知功能"),this.mNotifyCharacter.stopNotifications(),this.mNotifyCharacter=void 0,this.mWriteCharacter=void 0),this.mGattServer.connected&&(this.mGattServer.disconnect(),this.mGattServer=void 0),d.info("#### WebBleAdapter.disconnect success!"),we.processSuccessResult(0,i)):we.processSuccessResult(0,i):we.processSuccessResult(De.ERROR_PARAM,i)}))}getConnectedBleDevices(){return Promise.resolve([])}setBleMtu(e){return t(this,void 0,void 0,(function*(){return e.mtu,we.isIOS(),{status:-1}}))}isDeviceConnected(t){return !(!this.mGattServer||!this.mGattServer.connected)&&this.mGattServer.device.id===t}getGATTServices(e){return t(this,void 0,void 0,(function*(){const t=[];return d.info(`---- 【Request】getPrimaryServices(server: ${this.mGattServer?this.mGattServer.device.name:"undefined"})`),new Promise((i=>{this.mGattServer&&this.mGattServer.connected?this.mGattServer.getPrimaryServices().then((s=>{for(const e of s)d.log(`---- service uuid: ${e.uuid}`),t.push(e);we.processSuccessResult(t,e,i);})).catch((t=>{d.warn("---- 【Response】 gattServer.getPrimaryServices.catch:"),d.warn(t),we.processFailResult([],e,i);})):(d.warn("---- 打印机未链接！"),d.warn(this.mGattServer),we.processFailResult([],e,i));}))}))}getGATTCharacteristics(e){return t(this,void 0,void 0,(function*(){const t=e||{},i=[];return d.info("---- 【Request】getBleGATTCharacteristics"),new Promise((s=>this.mGattServer?t.serviceId?void this.mGattServer.getPrimaryService(t.serviceId).then((r=>{r?r.getCharacteristics().then((e=>{if(!e||e.length<=0)d.warn("---- 未检测到任何特征值！"),t.complete&&t.complete(i),s(i);else {for(const s of e){let e=0;d.log(`---- characteristic uuid: ${s.uuid}`),s.properties.read&&(e|=Ge.READ),s.properties.writeWithoutResponse&&(e|=Ge.WRITE_NO_RESPONSE),s.properties.write&&(e|=Ge.WRITE),s.properties.notify&&(e|=Ge.NOTIFY),i.push({serviceId:t.serviceId,uuid:s.uuid,properties:e});}t.complete&&t.complete(i),s(i);}})):(d.warn(`---- 服务实例[${t.serviceId}] 获取失败！`),e.complete&&e.complete(i),s(i));})):(d.warn("---- 参数错误，未指定 serviceId 或者 characteristicId！"),e.complete&&e.complete(i),s(i),i):(d.warn("---- 打印机未链接！"),e.complete&&e.complete(i),void s(i))))}))}readCharacteristic(e){return t(this,void 0,void 0,(function*(){if(!this.mGattServer||!e.serviceId||!e.characteristicId)return we.processFailResult("",e);const t=Ve.getFullUUID(e.serviceId),i=Ve.getFullUUID(e.characteristicId),s=yield this.mGattServer.getPrimaryService(t.toLowerCase());if(!s)return we.processFailResult("",e);const r=yield s.getCharacteristic(i.toLowerCase());if(!r)return we.processFailResult("",e);d.info("---- readCharacteristicValue:");const n=yield r.readValue();return d.info(n),we.processSuccessResult(null==n?void 0:n.buffer,e)}))}notifyCharacteristic(e){return t(this,void 0,void 0,(function*(){if(d.info("---- 【Request】startNotifications"),!this.mGattServer)return d.warn("---- 打印机未链接！"),e.complete&&e.complete(!1),!1;if(!e.serviceId||!e.characteristicId)return d.warn("---- 参数错误！"),e.complete&&e.complete(!1),!1;const t=yield this.mGattServer.getPrimaryService(e.serviceId);if(!t)return d.warn(`---- 服务实例[${e.serviceId}] 获取失败！`),e.complete&&e.complete(!1),!1;const i=yield t.getCharacteristic(e.characteristicId);if(!i)return d.warn(`---- notify特征值实例 [${e.characteristicId}] 获取失败！`),e.complete&&e.complete(!1),!1;i.oncharacteristicvaluechanged=t=>{var i;const s=t.target;s.value&&e.dataReceived&&e.dataReceived(null===(i=s.value)||void 0===i?void 0:i.buffer);};return (yield i.startNotifications())?(this.mNotifyCharacter=i,e.complete&&e.complete(!0),!0):(d.warn("---- #### startNotifications 失败！"),e.complete&&e.complete(!1),!1)}))}writeCharacteristic(e){return t(this,void 0,void 0,(function*(){if(!this.mGattServer)return we.processFailResult({statusCode:1,resultInfo:"打印机未连接"},e);if(!this.mWriteCharacter){const t=yield this.mGattServer.getPrimaryService(e.serviceId);if(!t)return d.warn(`---- 服务实例[${e.serviceId}] 获取失败！`),we.processFailResult({statusCode:2,resultInfo:"获取服务失败！"},e);const i=yield t.getCharacteristic(e.characteristicId);if(!i)return d.warn(`---- write特征值实例 [${e.characteristicId}] 获取失败！`),we.processFailResult({statusCode:3,resultInfo:"特征值获取失败"},e);this.mWriteCharacter=i;}if(this.mWriteCharacter&&e.data){const t=`[P ${e.pkgIndex} - SUP ${e.subPkgIndex}]`;return this.mShowWriteLog&&d.log(`#### 【Request】writeBLECharacteristicValue[${e.data.length}]: ${t}`),this.mWriteCharacter.writeValueWithoutResponse(e.data).then((e=>{this.mShowWriteLog&&d.log(e,`#### 【Response.success】uni.writeBLECharacteristicValue: ${t}`),this.mShowWriteLog=!1;})).catch((t=>{d.warn(t),this.mShowWriteLog=!0;})),we.processSuccessResult({statusCode:0,resultInfo:void 0},e)}return we.processFailResult({statusCode:4,resultInfo:"参数错误"},e)}))}}ze.MTU_MAX=512,function(t){t.text="text";}(Ke||(Ke={}));class Xe{static createDomParser(){try{return window.DOMParser?new DOMParser:void 0}catch(t){return void d.warn(t)}}static parseXmlDocument(t,e){if(t)try{const i=e||new DOMParser;return t?i.parseFromString(t,"text/xml"):void 0}catch(t){d.warn("xml parse error:"),d.warn(t);}}static splitEqual(t,e){const i=(t||"").split(";");for(const t of i)if(t===e)return !0;return !1}static getElementsByTagName(t,e,i,s){if(!t||!e||t.childElementCount<=0)return [];if(i){const i=[],r=t.children||t.childNodes;let n="";for(let t=0;t<r.length&&(n=r[t].tagName||r[t].nodeName,n.toLowerCase()!==e.toLocaleLowerCase()||(i.push(r[t]),!s));t++);return i}return t.getElementsByTagName(e)}static getElementByTagName(t,e,i){return this.getElementsByTagName(t,e,i,!0)[0]}static getElementValue(t){try{return t.childNodes[0].nodeValue||""}catch(t){return ""}}static getElementValueByTagName(t,e){if(!e)return "";const i=e.split(";");for(let e=0;e<i.length;e++){const s=i[e];if(!s)continue;const r=this.getElementsByTagName(t,s,!0,!0);if(r.length>0)return this.getElementValue(r[0])}return ""}static isNumberString(t){return !!t&&(!!(t=t.trim()).match(/^[-+]?[0-9]*\.?[0-9]+$/)||!!t.match(/^(0x)?[0-9a-f]+$/i))}static optNumber(t,e){return "number"==typeof t?t:(t=(t||"").trim(),this.isNumberString(t)?Number(t):e||0)}static isBooleanString(t){return !!t&&!!(t=t.trim()).match(/^(yes)|(no)|(true)|(false)$/i)}static optBoolean(t,e){return !!(t=(t||"").trim()).match(/^(yes)|(true)$/i)||!t.match(/^(no)|(false)$/i)&&("boolean"==typeof e&&e)}static decodeBase64File(t,e){const i=we.decodeBase64(t);if(i){try{return new File([i],e)}catch(t){d.warn(t);}try{return new Blob([i])}catch(t){d.warn(t);}}}static parseEmbeddedImg(t,e){if(!t)return t;const i=t.indexOf(Xe.EmbeddedSeparator);if(i<0)return t;let s=t.substring(0,i).trim().toLowerCase();return "."===s[0]&&(s=s.substring(1)),"svg"===s&&(s="svg+xml"),t=t.substring(i+Xe.EmbeddedSeparator.length),e&&e(s,t),`data:image/${s};base64,${t}`}static parseEmbeddedFile(t){if(!(t=(t||"").trim()))return;const e=t.indexOf(Xe.EmbeddedSeparator);let i;if(e>=0){const s=t.substring(0,e),r=t.substring(e+Xe.EmbeddedSeparator.length);i=Xe.decodeBase64File(r,s);}else i=Xe.decodeBase64File(t,"");return i}}Xe.EmbeddedSeparator="*****";class Ze{static isWdfxJob(t){const e=t||{};return !(!e.layerClass||!e.templateID)&&("LPAPI"===e.layerClass.toUpperCase()&&(e.Page||e.page||[]).length>0)}static getDefaultBarcodeText(t){return t===y.EAN13?"690123456789":t===y.EAN8?"6901234":t===y.UPC_A?"69012345678":t===y.UPC_E?"0123456":t===y.ISBN?"978012345678":"12345678"}static getDefaultQrcodeText(){return "http://detonger.com/wdbq"}static getContentText(t,e){const i="number"==typeof e.contentType?e.contentType:0,s=e.content||e.text;if(t=t.toLowerCase(),2===i){if(!s){if(t===Ae.barcode){const t=Xe.optNumber(e.barcodeType);return Ze.getDefaultBarcodeText(t)}if(t===Ae.qrcode)return Ze.getDefaultQrcodeText()}return s}if(i>0||s)return s;if(t===Ae.text)return s||"双击输入内容";if(t===Ae.qrcode)return s||Ze.getDefaultQrcodeText();if(t===Ae.barcode){const t=Xe.optNumber(e.barcodeType);return Ze.getDefaultBarcodeText(t)}return s}static rotateRect(t,e){(e=(e+360)%360)>3&&(e=Math.floor(e/90));const i=t.x||0,s=t.y||0,r=t.width||0,n=t.height||0,a=i+.5*r,o=s+.5*n;return 1!==e&&3!==e||(t.x=a-.5*n,t.y=o-.5*r,t.width=n,t.height=r),t}static getDateTime(t){const i=t.dateFormat||"",s=t.timeFormat||"",r=t.dateOffset||t.dateDiff||0,n=t.hourOffset||t.hourDiff||0,a=t.minuteOffset||t.minuteDiff||0,o=t.secondOffset||t.secondDiff||0,h=new Date;if(r||n||a||o){let t=h.getTime();r&&(t+=864e5*r),n&&(t+=36e5*n),a&&(t+=6e4*a),o&&(t+=1e3*o),h.setTime(t);}return i&&s?e.formatDate(`${i} ${s}`):i||s?e.formatDate(i||s,h):e.formatDate("yyyy年MM月dd日")}static parseWdxNode(t,e,i){if(t.children&&t.children.length>0){const s={},r=[];for(let n=0;n<t.children.length;n++){const a=t.children[n],o="function"==typeof e&&e(a,t),h=this.parseWdxNode(a,e,o);i?("object"!=typeof h||Array.isArray(h)||(h.layerClass=a.tagName),r.push(h)):s[a.tagName]=h;}return i?r:s}if(t.childNodes&&t.childNodes.length>1){const s={},r=[];for(let n=0;n<t.childNodes.length;n++){const a=t.childNodes[n];if(a.nodeName===Ze.NODE_NAME_TEXT)continue;const o="function"==typeof e&&e(a,t),h=this.parseWdxNode(a,e,o);i?("object"!=typeof h||Array.isArray(h)||(h.layerClass=a.nodeName),r.push(h)):s[a.nodeName]=h;}return i?r:s}return t.childNodes&&t.childNodes.length>0&&t.childNodes[0].nodeValue||""}static getAutoValue(t){const e=t?t.toLowerCase():"";return "true"===e||"yes"===e||"false"!==e&&"no"!==e&&(Xe.isNumberString(e)?Number(e):t)}static loadWdfxContent(t,e){const i=Xe.parseXmlDocument(t||"",e),s=i?i.getElementsByTagName("LPAPI"):void 0,r=s&&s.length>0?s[0]:void 0;if(!r)return;const n=this.parseWdxNode(r,((t,e)=>{const i=(t.tagName||t.nodeName||"").toLowerCase(),s=(e.tagName||e.nodeName||"").toLowerCase();return e===r&&"page"===i||"table"===s&&"cells"===i}));return "string"==typeof n||Array.isArray(n)?void 0:(n.layerClass=r.tagName,n)}static updateWdfOptions(t,i){const s=t,r=t;for(const t of Object.keys(r)){let e=r[t];"string"==typeof e&&(r[t]=e=Ze.getAutoValue(e)),"labelWidth"===t?(s.jobWidth=e,delete r[t]):"labelHeight"===t?(s.jobHeight=e,delete r[t]):"printOrientation"===t&&(s.orientation=e,delete r[t]);}"string"==typeof s.background&&(s.background=Xe.parseEmbeddedImg(s.background));let n=[];if(t.Page?(n=t.Page,delete t.Page):t.page&&(n=t.page,delete t.page),s.border&&"string"==typeof s.border)try{const t=Xe.parseEmbeddedImg(s.border,((t,r)=>{if(s.borderType=t,i||"undefined"==typeof DOMParser||(i=new DOMParser),"svg+xml"===t&&i){"number"!=typeof s.borderScale&&(s.borderScale=1);try{const t=i.parseFromString(we.atob(r),"image/svg+xml"),n=t?t.getElementsByTagName("svg"):void 0,a=n&&n.length>0?n[0]:void 0;if(a&&(s.svgElement=a,a.width&&(s.svgWidth=a.width.baseVal.value),a.height&&(s.svgHeight=a.height.baseVal.value),a.viewBox&&(s.svgViewBox=a.viewBox.baseVal),!s.svgViewBox&&a.attributes&&a.attributes.length>0))for(let t=0;t<a.attributes.length;t++){const i=a.attributes[t],r=i.name||i.nodeName||i.localName;if("width"===r){const t=i.value||i.nodeValue||"";!s.svgWidth&&Xe.isNumberString(t)&&(s.svgWidth=Xe.optNumber(t));}else if("height"===r){const t=i.value||i.nodeValue||"";!s.svgHeight&&Xe.isNumberString(t)&&(s.svgHeight=Xe.optNumber(t));}else if("viewBox"===r){const t=i.value||i.nodeValue||"";!s.svgViewBox&&t&&(s.svgViewBox=e.parseRect(t));}}}catch(t){d.warn(t);}}}));s.border=t;}catch(t){d.warn(t);}const a=[];if(n&&n.length>0)for(const t of n){const e=t,i=e.layerClass?e.layerClass.toLowerCase():"";for(const t of Object.keys(e)){const i=e[t];"content"!==t&&"lineSpace"!==t&&"dataColumnName"!==t&&"columnName"!==t&&("string"==typeof i&&(e[t]=Ze.getAutoValue(i)));}if(void 0===e.horizontalAlignment&&"number"==typeof e.horAlignment&&(e.horizontalAlignment=e.horAlignment),void 0===e.verticalAlignment&&"number"==typeof e.verAlignment&&(e.verticalAlignment=e.verAlignment),i===Ae.line){const t=e.x1||0,i=e.y1||0,s=e.x2||0,r=e.y2||0;"number"==typeof e.x1&&delete e.x1,"number"==typeof e.y1&&delete e.y1,"number"==typeof e.x2&&delete e.x2,"number"==typeof e.y2&&delete e.y2,e.x=Math.min(t,s),e.y=Math.min(i,r),e.width=Math.abs(t-s),e.height=Math.abs(i-r);}if(e.width&&e.height&&e.orientation&&Ze.rotateRect(e,-e.orientation),i===Ae.text)e.text=Ze.getContentText(i,e),a.push(Object.assign(Object.assign({},e),{lineSpaceMode:u.getLineMode(e.lineSpace),lineSpace:u.valueOf(e.lineSpace,e.fontHeight||2.5),type:Ae.text}));else if("time"===i||"date"===i)e.text=Ze.getDateTime(e),a.push(Object.assign(Object.assign({},e),{type:Ae.text}));else if("arctext"===i)e.text||(e.text=Ze.getContentText(Ae.text,e)),a.push(Object.assign(Object.assign({},e),{lineWidth:"number"==typeof e.lineWidth?e.lineWidth:.5,type:Ae.arcText}));else if(i===Ae.barcode){e.text=Ze.getContentText(i,e),"number"!=typeof e.horizontalAlignment&&(e.horizontalAlignment=1);const t="number"==typeof e.flags?e.flags:2,s="number"==typeof e.fontHeight&&e.fontHeight>0?e.fontHeight:0,r="number"==typeof e.textHeight?e.textHeight:s;a.push(Object.assign(Object.assign({},e),{textHeight:0===t?0:r,barcodeType:"number"==typeof e.type?e.type:e.barcodeType,type:Ae.barcode}));}else if(i===Ae.qrcode){e.text=Ze.getContentText(i,e),"number"!=typeof e.horizontalAlignment&&(e.horizontalAlignment=1),"number"!=typeof e.verticalAlignment&&(e.verticalAlignment=1);let t=Ae.qrcode;1===e.type?(t=Ae.pdf417,"number"==typeof e.pdf417EccLevel&&(e.eccLevel=e.pdf417EccLevel),"number"==typeof e.pdf417Cols&&(e.cols=e.pdf417Cols)):2===e.type?(t=Ae.dataMatrix,"number"==typeof e.dmCodeShape&&(e.codeShape=e.dmCodeShape)):3===e.type?t="gridMatrix":("number"==typeof e.mask&&(e.qrMask=e.mask),"number"==typeof e.mode&&(e.qrMode=e.mode)),a.push(Object.assign(Object.assign({},e),{type:t}));}else if("image"===i||"logo"===i){const t=e.content||e.text;e.content&&delete e.content,e.text&&delete e.text,a.push(Object.assign(Object.assign({},e),{image:Xe.parseEmbeddedImg(t),type:Ae.image}));}else if("rectangle"===i||"rect"===i){let t=Ae.rect;"boolean"==typeof e.filled&&e.filled&&(e.fill=!0,delete e.filled),("number"!=typeof e.lineWidth||e.lineWidth<=0)&&(e.lineWidth=.5),1===e.type?("number"!=typeof e.cornerWidth||e.cornerWidth<=0)&&(e.cornerWidth=1):2===e.type?t=Ae.ellipse:3===e.type?t=Ae.circle:e.cornerWidth&&delete e.cornerWidth,a.push(Object.assign(Object.assign({},e),{type:t}));}else if(i===Ae.line){const t="number"==typeof e.type?e.type:0,i="number"==typeof e.dashGap&&e.dashGap>0?e.dashGap:1;1===t&&(e.dashLens=[i]),e.dashGap&&delete e.dashGap,a.push(Object.assign(Object.assign({},e),{type:Ae.line}));}else if(i===Ae.table){const t=e.Cells||e.cells||[];if(e.Cells&&delete e.Cells,Array.isArray(t)&&t.length>0)for(const e of t)for(const t of Object.keys(e)){const i=e[t];"content"!==t&&"lineSpace"!==t&&"dataColumnName"!==t&&"columnName"!==t&&("string"==typeof i&&(e[t]=Ze.getAutoValue(e[t])));}a.push(Object.assign(Object.assign({},e),{rowCount:e.rows,columnCount:e.cols,cells:t,type:Ae.table}));}else i?a.push(Object.assign(Object.assign({},e),{type:i})):"string"==typeof e.type&&a.push(e);}return {jobInfo:t,jobPage:a}}static parseWdfx(t,e){let i;i="object"==typeof t?t:{content:t,domParser:e};const s=Ze.loadWdfxContent(i.content,i.domParser);return s&&Ze.isWdfxJob(s)?Ze.updateWdfOptions(s,i.domParser):void 0}}Ze.NODE_NAME_TEXT="#text";class qe{get Models(){return this.models}constructor(t){this.includeModels=new Set,this.excludeModels=new Set,this.models=t||"";const e=this.models.split(";");let i="";for(const t of e)switch(t[0]){case"+":i=t.substring(1),i&&this.includeModels.add(i.toUpperCase());break;case"-":i=t.substring(1),i&&this.excludeModels.add(i.toUpperCase());break;default:t&&this.includeModels.add(t.toUpperCase());}}isSupport(t){if(!t)return !1;if(this.includeModels.size<=0&&this.excludeModels.size<=0)return !0;if(qe.patternSuperD.exec(t))return !0;if(qe.patternSuperO.exec(t))return !0;const e=Qe.getModelName(t),i=e[0]?e[0].toUpperCase():"";if(this.excludeModels.has(i))return !1;if(this.includeModels.size>0){if(this.includeModels.has(i))return !0;return void 0!==Array.from(this.includeModels).find((e=>t===e||t.match(new RegExp(e))))}return !0}}qe.patternSuperD=/^(.*)-(D[0-9]{4,5}[0-9A-Z]{2,5}[0-9]{2})$/,qe.patternSuperO=/^(.*)-(O[0-9]{4,5}[0-9A-Z]{2,5}[0-9]{2})$/;const Ye={cancelCloseTimer(){this.closeTimer&&this.closeTimer>0&&(clearTimeout(this.closeTimer),this.closeTimer=0,this.closeAction&&this.closeAction(!1));}};class Qe{static getInstance(t){const e=t||{};return this.sInstance?t&&this.sInstance.setOptions(t):this.sInstance=new Qe(e),e.adapter&&(this.sInstance.BleAdapter=e.adapter),e.context&&(this.sInstance.mContext=e.context),e.models&&this.sInstance.setSupportPrefixes(e.models),this.sInstance}static create(t){return new Qe(t)}static isPreviewJobName(t){return !!t&&Re.isPreviewJobName(t)}static isTransPrevJob(t){return !!t&&Re.isTransPrevJob(t)}static isWhitePrevJob(t){return !!t&&Re.isWhitePrevJob(t)}static registerBarcode1DEncoder(t,e){Ot.registerBarcodeCreator(t,e);}static registerBarcode2DEncoder(t){Ce.getInstance().register(t);}static getModelName(t){const e=(t||"").lastIndexOf("-");return e>0?[t.substring(0,e),t.substring(e+1)]:[]}static isSupperTrade(t){return "D"===t||"O"===t}static isTradeSupported(t,e){if(!e)return !0;if(!t)return !1;if(Qe.isSupperTrade(t))return !0;return e.split(";").indexOf(t)>=0}static getPrinterNameInfo(t){t=t||"";const e=Qe.patternGeneral.exec(t);if(!e)return;let i=e[2];const s=/^\d+$/.exec(i);let r="",n=0;if(i[1]<"0"||i[1]>"9"?(r=i.substring(0,2),i=i.substring(2),n+=11*r.charCodeAt(0),n+=13*r.charCodeAt(1)):(i[0]<"0"||i[0]>"9")&&(r=i.substring(0,1),i=i.substring(1),n+=17*r.charCodeAt(0)),!(i.length<8)){if(!s||i.length>=9||i.charCodeAt(3)!=P.num_0){if(s){n+=2*parseInt(i.charAt(0)),n+=3*parseInt(i.charAt(1)),n+=5*parseInt(i.charAt(2));for(var a=4;a<i.length;++a)n+=parseInt(i.charAt(a))*(1&a?9:7);}else {n+=2*Number(i.charAt(0)),n+=3*Number(i.charAt(1)),n+=5*Number(i.charAt(2));for(a=4;a<i.length;++a)n+=i.charCodeAt(a)*(1&a?9:7);}if("5682904137".charAt(n%10)!=i.charAt(3))return}return {model:e[0],serials:i,trade:r,checkSum:n}}}static isSupportedDevice(t){const e=Qe.getPrinterNameInfo(t);return !!e&&(!!Qe.isSupperTrade(e.trade)||!(Qe.trades&&!Qe.isTradeSupported(e.trade,Qe.trades))&&!(Qe.matcher&&!Qe.matcher.isSupport(t)))}static trimDeviceName(t){return t.replace(/[\ufffd\u007f\u0000-\u001f]/g,"")}static loadImageSrc(t){return Re.loadImageSrc(t)}static loadHtmlImage(t){return Re.html2Image(t)}static getRawData(t){return ke.encodeImageData({imageData:t,printerDPI:203,printerWidth:384})}static test(){}constructor(t){this.mDeviceMap=new Map,this.mJsonMode=!1,this.mLineHeight=0,this.mCurrPosX=0,this.mCurrPosY=0,this.mJobPage=[],this.mTotalPages=1,this.mPageIndex=0,this.mPageList=[];const e=t||{};this.mInitInfo=e,this.BleAdapter=e.adapter||ze.getInstance(),this.setOptions(t);}setOptions(t){const e=t||{};this.mInitInfo=Object.assign(this.mInitInfo,e),e.adapter&&(this.BleAdapter=e.adapter),e.context&&this.setDrawContext(e.context),e.models&&this.setSupportPrefixes(e.models),e.clientType&&e.clientType>0&&(this.mPrinter.ClientType=e.clientType),"boolean"==typeof e.enablePageKey&&(this.mPrinter.isPageKeyEnable=e.enablePageKey),"boolean"==typeof e.enableMcuId&&(this.mPrinter.EnableMcuId=e.enableMcuId),"number"==typeof e.requestMTUs&&(this.mPrinter.InitMTUs=e.requestMTUs),"number"==typeof e.writeWaits&&(this.mPrinter.InitWriteWaits=e.writeWaits),"number"==typeof e.extraWriteTimes&&(this.mPrinter.ExtraWriteTimes=e.extraWriteTimes),"number"==typeof e.logLevel&&d.setLevel(e.logLevel);}getBarcode2DEncoder(t){return t?Ce.getEncoder(t):void 0}setBarcode2DEncoder(t){return "object"==typeof t&&Ce.setEncoder(t.barcodeType,t)}get BleAdapter(){return this.mPrinter.Adapter}set BleAdapter(t){this.mPrinter?this.mPrinter.Adapter=t:this.mPrinter=new Ve(t);}getContext(){if(!this.mContext){let t=this.mInitInfo.createContext?this.mInitInfo.createContext({}):void 0;t||(t=new Re({})),this.setDrawContext(t);}return this.mContext}get Context(){return this.getContext()}setDrawContext(t){t&&(this.abortJob(),t.IsApiMode=!0,this.mContext=t);}createDrawContext(t){return this.mInitInfo.createContext?this.mInitInfo.createContext(t):new Re({apiMode:!0})}getResultMessage(t){switch(t){case De.ASYNC_WAIT:return "异步等待中，请稍后";case De.OK:return "OK";case De.ERROR_PARAM:return "参数错误！";case De.ERROR_NO_PRINTER:return "未检测到打印机或者未指定打印机";case De.ERROR_DISCONNECTED:return "打印机未连接";case De.ERROR_CONNECT_FAILED:return "打印机链接失败";case De.ERROR_START_NOTIFICATION:return "数据Notify特征值启动失败";case De.ERROR_DATA_SEND_ERROR:return "数据发送失败";case De.ERROR_DATA_RECEIVE_ERROR:return "数据接收异常，打印机无响应";case De.ERROR_IS_PRINTING:return "打印机正在打印过程中不能打印其他标签";case De.ERROR_RESPONSE_TIMEOUT:return "指令发送响应超时";case De.ERROR_JOB_CREATE:return "打印任务创建失败";case De.ERROR_JOB_CANCELED:return "打印任务被取消";case De.ERROR_GET_IMAGE_DATA:return "打印数据获取失败";case De.ERROR_PRINTER_NOT_AVAILABLE:return "打印机状态异常";case De.ERROR_OTHER:return "其他未知异常";default:return "其他异常！"}}getPrinterStatus(t){const e=t||this.mPrinter.Printable;switch(e){case We.DZIP_PRINTABLE:return "OK";case We.DZIP_ISPRINTING:return "正在打印";case We.DZIP_ISROTATING:return "正在转动马达";case We.DZIP_NOJOB:return "没有打印任务";case We.DZIP_PAGENOTREADY:return "页面数据还没有接收完全";case We.DZIP_JOBCANCELED:return "当前打印任务被取消";case We.DZIP_VOLTOOLOW:return "打印电压太低了";case We.DZIP_VOLTOOHIGH:return "打印电压太高了";case We.DZIP_TPHNOTFOUND:return "没有检测到打印头";case We.DZIP_TPHTOOHOT:return "打印头温度太高了";case We.DZIP_COVEROPENED:return "打印机盖子打开了";case We.DZIP_NO_PAPER:return "未检测到纸张";case We.DZIP_RIBBONCANOPENED:return "碳带盒未锁紧";case We.DZIP_NO_RIBBON:return "未检测到碳带";case We.DZIP_UNMATCHED_RIBBON:return "不匹配的碳带";case We.DZIP_TPHTOOCOLD:return "环境温度过低";case We.DZIP_USEDUP_RIBBON:return "用完的碳带";case We.DZIP_USEDUP_RIBBON2:return "用完的色带";case We.DZIP_LABELCANOPENED:return "标签盒未锁紧";default:return "未知异常:"+e}}loadImage(t,e){return this.Context.loadImage(t).then((t=>(e&&e(t),t)))}loadHtml(t){return this.Context.loadHtml("string"==typeof t?t:t?t.innerHTML:"")}setSupportPrefixes(t){const e=Array.isArray(t)?t.join(";"):t||"";Qe.matcher=e?new qe(e):void 0;}setSupportTrades(t){Qe.trades=Array.isArray(t)?t.join(";"):t||"",Qe.trades&&(Qe.trades=Qe.trades.toUpperCase());}updateDeviceList(t,e,i){const s=[];if(t&&t.length>0)for(const r of t){if(!r.name||!r.deviceId)continue;r.name=Qe.trimDeviceName(r.name||r.localName||"");const t=Qe.getPrinterNameInfo(r.name);t?(r.advertisData&&"string"==typeof r.advertisData&&(r.advertisData=we.getBytes(r.advertisData)),Qe.isSupperTrade(t.trade)?(this.mDeviceMap.set(r.deviceId,r),s.push(r)):e&&!Qe.isTradeSupported(t.trade,e)?d.info(`---- ----: 受限的行业编码：${r.name}`):i&&!i.isSupport(r.name)?d.info(`---- ----: 受限的打印机型号：${r.name}`):(this.mDeviceMap.set(r.deviceId,r),s.push(r))):r.name;}return s}startBleDiscovery(e){return t(this,void 0,void 0,(function*(){const t=e||{};d.log("----- lpapi.startBleDiscovery:"),d.log(JSON.stringify(t));const i=t.models?new qe(t.models):Qe.matcher,s=t.trades||Qe.trades;return this.BleAdapter.getConnectedBleDevices().then((r=>{let n="",a="",o="",h=[];const c="number"==typeof t.timeout?t.timeout:void 0;return this.mDiscovering=!0,this.mDeviceMap.clear(),r&&r.length>0&&this.updateDeviceList(r,s,i),this.BleAdapter.startBleDiscovery({interval:t.interval,resetAdapter:t.resetAdapter,deviceFound:e=>{this.updateDeviceList(e,s,i),h=this.getPrinters(),a=h.map((t=>t.deviceId)).join(";"),o=h.map((t=>t.name)).join(";"),a!==n&&(d.info(`---- ---- 检测到新设备：【${o}】`),n=a,t.deviceFound&&t.deviceFound(h),"number"==typeof c&&c<=0&&(d.info(`---- 检测到打印机，自动停止搜索(timeout: ${c})！`),this.stopBleDiscovery()));},adapterStateChange:e=>{this.mDiscovering=e.discovering,t.adapterStateChange&&t.adapterStateChange(e);},complete:r=>{if(0===r.statusCode&&(c&&c>0&&(d.info("---- 启动蓝牙搜索定时器："),Ye.scanTimer=setTimeout((()=>{d.info(`---- 蓝牙搜索超时时间到：[timeout = ${c}]`),Ye.scanTimer=0,this.stopBleDiscovery();}),c)),this.mPrinter.IsConnected)){const e=this.mPrinter.CurrentDevice;e&&(d.info(`---- 检测到已连接设备：${e.name}`),this.updateDeviceList([e],s,i),h=this.getPrinters(),h.length>0&&t.deviceFound&&t.deviceFound(h));}0===r.statusCode?(d.log("---- 蓝牙搜索启动成功！"),we.processSuccessResult(r,e)):we.processFailResult(r,e);}})}))}))}stopBleDiscovery(){return t(this,void 0,void 0,(function*(){return Ye.scanTimer&&Ye.scanTimer>0&&(d.info("---- 停止扫描超时定时器："),clearTimeout(Ye.scanTimer),Ye.scanTimer=0),this.BleAdapter.stopBleDiscovery()}))}searchPrinter(e){return t(this,void 0,void 0,(function*(){const t=e||{};return new Promise((e=>{let i=!1;this.startBleDiscovery({timeout:t.timeout||0,models:t.models,deviceFound:s=>{if((null==s?void 0:s.length)>0){let r;for(const e of s){if(!t.name&&!t.deviceId){r=e;break}if(t.name&&t.name===e.name){r=e;break}if(t.deviceId&&t.deviceId===e.deviceId){r=e;break}}r&&(i=!0,e(r),this.stopBleDiscovery());}},adapterStateChange:t=>{t.discovering||i||(i=!0,e(void 0));}}).then((t=>{0!==t.statusCode&&e(void 0);}));}))}))}getPrinters(){return Array.from(this.mDeviceMap.values()).sort(((t,e)=>t.RSSI&&e.RSSI?e.RSSI-t.RSSI:e.RSSI?1:t.RSSI?-1:0))}getPrinterInfo(){return this.mPrinter.getPrinterInfo()}getPrinterWidthMM(){const t=this.mPrinter.getPrinterInfo();return t&&t.printerWidth>0&&t.printerDPI>0?t.printerWidth/t.printerDPI*25.4:48}isPrinterOpened(){return this.mPrinter.IsConnected}isJobPaused(){return this.mPrinter.ConnectStatus===Je.Paused}openPrinter(e){return t(this,void 0,void 0,(function*(){d.log(e,"#### 【openPrinter】options:"),Ye.cancelCloseTimer();const t="function"==typeof e?e:void 0,i="string"==typeof e?e:void 0,s=!!i&&Qe.isSupportedDevice(i),r="object"==typeof e?e:{name:s?i:"",deviceId:s?"":i,complete:t};!r.deviceId&&r.id&&(r.deviceId=r.id);const n=yield this.BleAdapter.getConnectedBleDevices(),a=this.updateDeviceList(n,Qe.trades,Qe.matcher),o=this.getPrinters();let h;if(r.name||r.deviceId)for(const t of o){if(t.deviceId===r.deviceId||t.name===r.name){h=t;break}if(r.name&&t.name.startsWith(r.name.toUpperCase())){h=t;break}}else if(this.isPrinterOpened())return we.processSuccessResult({statusCode:De.OK},r);if(h||(r.name&&r.deviceId&&Qe.isSupportedDevice(r.name)?h={name:r.name,deviceId:r.deviceId}:a.length>0&&(h=a[0])),!h){if("boolean"!=typeof r.autoScan&&(r.autoScan=!0),!r.autoScan)return we.processFailResult({statusCode:De.ERROR_NO_PRINTER,resultInfo:"未指定目标打印机"},r);if(d.info(`#### 未检测到缓存的蓝牙设备，正在进行重新搜索：{ name: ${r.name}, deviceId: ${r.deviceId} }`),h=yield this.searchPrinter({name:r.name,deviceId:r.deviceId,models:r.models,timeout:5e3}),!h)return d.warn("#### 未检测到匹配的蓝牙设备！"),we.processFailResult({statusCode:De.ERROR_NO_PRINTER,resultInfo:"未搜索到到打印机设备！"},r)}d.info(`#### 正在链接打印机设备：{ name: ${h.name}, deviceId: ${h.deviceId} }...`),this.mDiscovering&&(yield this.stopBleDiscovery()),r.clientType&&(this.mPrinter.ClientType=r.clientType);const c=yield this.mPrinter.connect({device:h,timeout:r.timeout,connectionStateChange:r.connectionStateChange,tryTimes:r.tryTimes,delayTime:r.delayTime});return c.statusCode===De.OK?(d.info("★★★★★★ 打印机链接成功！★★★★★★"),we.processSuccessResult(c,r)):(d.info(`★★★★★★ 打印机链接失败[${c.statusCode}]！★★★★★★`),we.processFailResult(c,r))}))}closePrinter(e,i){return t(this,void 0,void 0,(function*(){const t="number"==typeof e?{delay:e,callback:i}:e||{};return Ye.cancelCloseTimer(),t.force?this.mPrinter.disconnect(void 0,!0):new Promise((e=>{Ye.closeAction=t=>{i&&i(t),Ye.closeAction=void 0,e(t);},Ye.closeTimer=setTimeout((()=>{Ye.closeTimer=0,Ye.closeAction=void 0,this.mPrinter.disconnect().then((t=>{i&&i(t),e(t);}));}),t.delay);}))}))}stopPrint(){this.mPrinter.stopPrint(),this.mPausedPrintInfo&&(this.mPausedPrintInfo=void 0);}isPrintJob(){return this.Context.isPrintJob()}startJob(t){t||(t={}),"number"!=typeof t.width&&(t.width=0),"number"!=typeof t.height&&(t.height=0),d.log(t,"#### 【startJob】:");const e=t.jobName;if(t.context&&t.context!==this.mContext&&this.setDrawContext(t.context),!this.Context)return void d.warn("---- 未检测到绘制上下文！");if(this.mJobPrintOptions){if(!t.autoAbort)return void d.warn("---- 有未完成的打印任务！");this.abortJob();}t.height<=0&&"boolean"!=typeof t.jsonMode&&(t.jsonMode=!0);const i="boolean"==typeof t.jsonMode&&t.jsonMode;if(this.mJsonMode=i,this.isPrinterOpened()){const e=this.mPrinter.getPrinterInfo();t.dpi=e.printerDPI,t.printerDpi=e.printerDPI,t.printerWidth=e.printerWidth;}else t.dpi||(t.dpi=this.mPrinter.PrinterDPI),t.printerDpi||(t.printerDpi=this.mPrinter.PrinterDPI),t.printerWidth||(t.printerWidth=this.mPrinter.PrinterWidth);!t.backgroundColor&&Qe.isWhitePrevJob(e)&&(t.backgroundColor=Qe.COLOR_WHITE);const s=Re.getMargins(t);return this.mLineHeight="number"==typeof t.lineHeight?t.lineHeight:0,this.mLineHeight<0&&(this.mLineHeight=0),this.mJobPrintOptions={jobInfo:Object.assign(Object.assign({},t),{jobWidth:t.width,jobHeight:t.height}),jobPages:[],jobArguments:t.jobArguments,onJobCreated:t.onJobCreated},this.mJobPage.splice(0),i?this.mCurrPosY=s[0]>0?s[0]:0:(t.width<=0&&(t.width=this.getPrinterWidthMM()),this.mPageList.splice(0),this.mTotalPages=t.printPages||0,this.mPageIndex=0,this.mPageInfo=void 0),this.startPage()}startPrintJob(e,i){return t(this,void 0,void 0,(function*(){"function"==typeof e.callback&&(i=e.callback);if("boolean"==typeof e.printMode?e.printMode:!Re.isPreviewJobName(e.jobName)){const t=yield this.openPrinter({name:e.printerName||e.deviceName,deviceId:e.deviceId,autoScan:!1});if(t.statusCode!==De.OK)return i&&i(t),t}const t=this.startJob(e),s={statusCode:t?De.OK:De.ERROR_JOB_CREATE,resultInfo:t};return i&&i(s),s}))}abortJob(){this.mPageInfo=void 0,this.mJobPrintOptions=void 0;}toDataURL(){return this.Context.CanvasElement.toDataURL()}nextLine(t){"number"==typeof t&&(this.mLineHeight=t),this.mCurrPosY+=this.mLineHeight;}getPosY(){return this.mCurrPosY}getCommandDatas(){}commitJob(e){return t(this,void 0,void 0,(function*(){d.log(e,"#### 【commitJob - start】options:");const t=e||{};return this.endPage(Object.assign({},t)).then((i=>{const s=this.mJobPrintOptions;if(this.mJobPrintOptions=void 0,d.log(`$$$$ 【commitJob - end】 statusCode: ${i.statusCode}`),i.statusCode===De.OK){if(this.mJsonMode){if(s&&s.jobPages&&s.jobPages.length>0){const e=s.jobInfo||{};let i;const r=t;for(const t of Object.keys(r))i=r[t],"function"==typeof i?s[t]=i:null!=i&&(e[t]=i);const n=t.jobArguments?t.jobArguments:s.jobArguments;return this.print(Object.assign(Object.assign({},s),{jobArguments:n}))}return we.processFailResult({statusCode:De.ERROR_PARAM,resultInfo:"接口调用错误，未检测到有效的打印参数"})}const r=this.mPageList.map((t=>t.printData)).filter((t=>void 0!==t)),n=Qe.getJobPrintResult(i,this.mPageList,i,r.length>0?r:void 0);return we.processSuccessResult(n,e)}return we.processFailResult(i,e)}))}))}startPage(){var t;if(d.log("#### 【startPage】"),this.mJsonMode)return this.mJobPage.length>0&&this.endPage({}),{};const e=null===(t=this.mJobPrintOptions)||void 0===t?void 0:t.jobInfo;if(!e)return void d.warn("---- 未检测到打印任务相关信息！");if(this.mPageInfo)return this.mPageInfo;const i=this.Context,s=i.startJob(Object.assign({},e));return s?(this.mInitInfo.fontName&&i.setFontName(this.mInitInfo.fontName),this.mInitInfo.fontHeight&&i.setFontHeight(this.mInitInfo.fontHeight),this.mInitInfo.lineWidth&&i.setLineWidth(this.mInitInfo.lineWidth),this.mTotalPages<=this.mPageIndex&&(this.mTotalPages=this.mPageIndex+1),this.mPageResult=void 0,this.mPageInfo=s):(e.onJobComplete&&e.onJobComplete({statusCode:De.ERROR_JOB_CANCELED}),e.onPagePrintComplete&&e.onPagePrintComplete({statusCode:De.ERROR_PARAM}),void d.warn(`---- 打印任务创建失败: {width: ${e.width}, height: ${e.height}}`))}endPage(e){return t(this,void 0,void 0,(function*(){var t;const i=e||{},s=!this.isPrintJob(),r=this.mPageInfo,n=null===(t=this.mJobPrintOptions)||void 0===t?void 0:t.jobInfo,a={statusCode:De.OK,printPages:this.mTotalPages,pageIndex:this.mPageIndex};if(this.mJsonMode){const t=this.mJobPage||[];if(this.mJobPrintOptions&&t.length>0){const e=this.mJobPrintOptions.jobPages||[];this.mJobPrintOptions.jobPages||(this.mJobPrintOptions.jobPages=e),e.push([...t]),t.splice(0);}else a.statusCode=De.ERROR_PARAM;return a}if(!r)return this.mJobPrintOptions&&this.mPageResult?we.processSuccessResult(this.mPageResult):(a.statusCode=De.ERROR_OTHER,a);if(d.log("#### 【endPage】"),!n)return a.statusCode=De.ERROR_OTHER,a;i.orientation||(i.orientation=this.Context.Orientation);const o=this.Context.JobInfo;return o&&("boolean"==typeof i.antiColor&&(o.antiColor=i.antiColor),"boolean"==typeof i.horizontalFlip&&(o.horizontalFlip=i.horizontalFlip)),this.Context.commitJob().then((t=>{if(this.mPageInfo=void 0,this.mPageIndex++,!t)return a.statusCode=De.ERROR_OTHER,a;if(Object.assign(a,t),s)return d.info("---- 预览任务处理完毕！"),a.statusCode=De.OK,a;{const e=t.imageData;if(e){if(!this.mPrinter.IsConnected)return a.statusCode=De.ERROR_DISCONNECTED,a;d.info("---- 开始打印......");const t=we.filter(i,((t,e)=>"function"!=typeof e));return this.printImageData(Object.assign(Object.assign({},t),{imageData:e,onPageComplete:t=>{n.onPageComplete&&n.onPageComplete(t);},onPagePrintComplete:t=>{n.onPagePrintComplete&&n.onPagePrintComplete(t);}})).then((t=>(a.statusCode=t.statusCode,t.statusCode===De.OK&&t.printData&&(a.printData=t.printData[0]),a)))}return d.warn("---- imageData获取失败！"),a.statusCode=De.ERROR_GET_IMAGE_DATA,a}})).then((t=>(this.mPageInfo=void 0,this.mPageResult=t,this.mPageList.push(t),t)))}))}setItemHorizontalAlignment(t){this.Context.setItemHorizontalAlignment(t);}setItemVerticalAlignment(t){this.Context.setItemVerticalAlignment(t);}setItemOrientation(t){this.Context.setItemOrientation(t);}drawText(t){if(d.log(t,"#### 【drawText】options:"),void 0===t.y&&(t.y=this.mCurrPosY),!this.mJsonMode)return this.Context.drawText(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.text}));}drawBarcode(t){return "string"==typeof t.barcodeType?this.draw2DBarcode(t):this.draw1DBarcode(t)}draw1DBarcode(t){return d.log(t,`#### 【draw1DBarcode】type[${t.barcodeType}], options:`),void 0===t.y&&(t.y=this.mCurrPosY),this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.barcode})),!0):this.Context.draw1DBarcode(t)}draw2DBarcode(t){return d.log(t,`#### 【draw2DBarcode】type[${t.barcodeType}], options:`),void 0===t.y&&(t.y=this.mCurrPosY),this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.qrcode})),!0):this.Context.draw2DBarcode(t)}drawQRCode(t){if(d.log(t,"#### 【drawQRCode】options:"),void 0===t.y&&(t.y=this.mCurrPosY),!this.mJsonMode)return this.Context.drawQRCode(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.qrcode}));}draw2DQRCode(t){return this.drawQRCode(t)}drawPDF417(t){if(d.log(t,"#### 【drawPDF417】options:"),void 0===t.y&&(t.y=this.mCurrPosY),!this.mJsonMode)return this.Context.drawPDF417(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.pdf417}));}draw2DPdf417(t){return this.drawPDF417(t)}drawDataMatrix(t){return d.log(t,"#### 【drawDataMatrix】options:"),void 0===t.y&&(t.y=this.mCurrPosY),this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.dataMatrix})),!0):this.Context.drawDataMatrix(t)}draw2DDataMatrix(t){return this.drawDataMatrix(t)}drawRectangle(t){return d.log(t,"#### 【drawRectangle】options:"),void 0===t.y&&(t.y=this.mCurrPosY),this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.rect})),!0):t.cornerWidth||t.cornerHeight?this.Context.drawRoundRect(t):this.Context.drawRect(t)}drawRect(t){return this.drawRectangle(t)}drawEllipse(t){if(d.log(t,"#### 【drawEllipse】options:"),void 0===t.y&&(t.y=this.mCurrPosY),!this.mJsonMode)return this.Context.drawEllipse(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.ellipse}));}drawCircle(t){if(d.log(t,"#### 【drawCircle】options:"),void 0===t.y&&(t.y=this.mCurrPosY),!this.mJsonMode)return this.Context.drawCircle(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.circle}));}drawLine(t){if(d.log(t,"#### 【drawLine】options:"),"number"!=typeof t.y1&&"number"!=typeof t.y2&&(t.y1=t.y2=this.mCurrPosY),!this.mJsonMode)return this.Context.drawLine(t);this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.line}));}drawImage(t){return d.log(t,"#### 【drawImage】options:"),void 0===t.y&&(t.y=this.mCurrPosY),this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.image})),!0):this.Context.drawImage(t)}drawImageAsync(e){return t(this,void 0,void 0,(function*(){if(this.mJsonMode||"string"!=typeof e.image)return this.drawImage(e);{const t="number"==typeof e.y?e.y:this.mCurrPosY;return this.Context.loadImage(e.image).then((i=>this.drawImage(Object.assign(Object.assign({},e),{y:t,image:i}))))}}))}drawImagePath(t){const e=t;return "string"==typeof e.src&&(e.image=e.src),this.drawImageAsync(t)}drawTable(t){d.log(t,"#### 【drawTable】options:"),void 0===t.y&&(t.y=this.mCurrPosY);if(("number"==typeof t.height&&t.height>0?t.height:0)<=0){const e=t.columnCount||t.columns||t.cols||0;if(!t.tableRows)if(Array.isArray(t.rows))t.tableRows=t.rows;else if(t.cells&&e>0){t.tableRows=[];for(let i=0;i<t.cells.length;i+=e)t.tableRows.push(t.cells.slice(i,i+e));}if(t.tableRows){let e=t.rowCount||("number"==typeof t.rows?t.rows:0);if(("number"!=typeof e||e<=0)&&(e=t.tableRows.length),t.rowHeights&&Array.isArray(t.rowHeights)||("number"==typeof t.rowHeights&&t.rowHeights>0?t.rowHeights=[t.rowHeights]:"number"==typeof t.rowHeight&&t.rowHeight>0&&(t.rowHeights=[t.rowHeight])),t.rowHeights&&Array.isArray(t.rowHeights)&&t.rowHeights.length>0){const i=t.rowHeights.length;if(i<e){const s=t.rowHeights[i-1];t.rowHeights=t.rowHeights.concat(Array(e-i).fill(s));}t.height=t.rowHeights.reduce(((t,e)=>t+e),0);}}}return this.mJsonMode?(this.mJobPage.push(Object.assign(Object.assign({},t),{type:Ae.table})),!0):this.Context.drawTable(t)}printImage(t){return this.openPrinter({name:t.printerName||t.deviceName||t.name,deviceId:t.deviceId,autoScan:t.autoScan}).then((e=>e.statusCode!==De.OK?e:("string"==typeof t.image&&(t.src=t.image,t.image=void 0),Promise.resolve(t.image||this.Context.loadImage(t.src||"")).then((e=>{if(!e)return we.processFailResult({statusCode:De.ERROR_PARAM});const i=!(t.width&&t.height),s=i?e.width:t.width,r=i?e.height:t.height;if(!s&&!r)return we.processFailResult({statusCode:De.ERROR_PARAM});const n=this.startJob({width:s,height:r,orientation:t.orientation,scaleUnit:i?c.Pix:c.MM});return n?Promise.resolve("function"!=typeof t.onJobCreated||t.onJobCreated(n)).then((()=>(this.drawImage({image:e,width:s,height:r,sx:t.sx,sy:t.sy,swidth:t.swidth,sheight:t.sheight}),this.commitJob(we.filter_NoFuncAndNone(t))))):we.processFailResult({statusCode:De.ERROR_JOB_CREATE})}))))).then((e=>e.statusCode!==De.OK?we.processFailResult(e,t):we.processSuccessResult(e,t)))}pushImageData(t){const e=t||{};return t.imageData||t.data?("boolean"!=typeof e.enableSuperBitmap&&(this.mInitInfo.enableSuperBitmap,1)&&(e.enableSuperBitmap=this.mInitInfo.enableSuperBitmap),this.mPrinter.pushImageData(Object.assign(Object.assign({},e),{onJobComplete:e=>{e.statusCode===De.OK?we.processSuccessResult(e,t):we.processFailResult(e,t);}}))):{statusCode:De.ERROR_PARAM}}printImageData(t){d.log("#### 【printImageData】options:");const e=t||{};return "boolean"!=typeof e.enableSuperBitmap&&"boolean"==typeof this.mInitInfo.enableSuperBitmap&&(e.enableSuperBitmap=this.mInitInfo.enableSuperBitmap),this.mPrinter.printImageData(e).then((e=>e.statusCode===De.OK?(d.info("#### 【printImageData.resp】打印成功！ "),we.processSuccessResult(e,t)):(d.warn(`#### 【printImageData.resp】打印失败, statusCode: ${e.statusCode}, printable: ${this.mPrinter.Printable}`),we.processFailResult(e,t))))}static getJobPrintResult(t,e,i,s){const r=e.map((t=>t.dataUrl||"")),n=Object.assign(Object.assign({},i),{statusCode:t.statusCode,printable:t.printable,dataUrls:r,previewData:r,pages:e.slice(0),printData:s});return n.resultInfo=n,n}print(e){return t(this,void 0,void 0,(function*(){d.log(e,"#### 【print】options:");const t=e.printerInfo||{};if(this.mPausedPrintInfo)e.continueJob||this.mPrinter.ConnectStatus!==Je.Paused||this.mPrinter.stopPrint(),this.mPausedPrintInfo=void 0;else {let t;if(e.jobPages&&e.jobPages.length>0?Array.isArray(e.jobPages[0])||(e.jobPages=[e.jobPages]):e.jobPage&&e.jobPage.length>0&&Array.isArray(e.jobPage[0])&&(e.jobPages=e.jobPage,delete e.jobPage),e.content)try{const i=JSON.parse(e.content);Ze.isWdfxJob(i)?e.wdfData=i:"object"!=typeof i||Array.isArray(i)||(t=i),delete e.content;}catch(t){d.warn("---- content 格式异常，解析失败！"),d.warn(t);}e.wdfData&&(t=Ze.updateWdfOptions(e.wdfData,e.domParser),delete e.wdfData),t&&("object"==typeof t.jobInfo&&(e.jobInfo=Object.assign(Object.assign({},t.jobInfo),e.jobInfo||{})),t.jobPages&&t.jobPages.length>0?Array.isArray(t.jobPages[0])||(t.jobPages=[t.jobPages]):t.jobPage&&t.jobPage.length>0&&Array.isArray(t.jobPage[0])&&(t.jobPages=t.jobPage,delete t.jobPage),t.jobPages&&t.jobPages.length>0?e.jobPages&&e.jobPages.length>0?e.jobPages=[...t.jobPages,...e.jobPages]:e.jobPage&&e.jobPage.length>0?(e.jobPages=[...t.jobPages,e.jobPage],delete e.jobPage):e.jobPages=[...t.jobPages]:t.jobPage&&t.jobPage.length>0&&(e.jobPages&&e.jobPages.length>0?e.jobPages=[t.jobPage,...e.jobPages]:e.jobPage&&e.jobPage.length>0?(e.jobPages=[[...t.jobPage,...e.jobPage]],delete e.jobPage):e.jobPages=[t.jobPage]),!e.jobArguments&&t.jobArguments&&(e.jobArguments=t.jobArguments)),e.jobPage&&e.jobPage.length>0&&(!e.jobPages||e.jobPages.length<=0)&&(e.jobPages=[e.jobPage],delete e.jobPage);const i=e.jobPages||[];if(!e.jobInfo||i.length<=0){const t={statusCode:De.ERROR_PARAM};return e.onJobComplete&&e.onJobComplete(t),we.processFailResult(t)}yield this.Context.autoLoadImage(e);}const i=e.jobInfo,s=e.action||0;1&s||4096&s?i.printMode=!0:2===s?i.jobName=Qe.JOB_NAME_PREV:130===s&&(i.jobName=Qe.JOB_NAME_TRANS);const r=e.jobInfo;i.jobWidth||("number"==typeof r.width&&r.width>0?i.jobWidth=r.width:r.labelWidth&&(i.jobWidth=1*r.labelWidth)),i.jobHeight||("number"==typeof r.height&&r.height>0?i.jobHeight=r.height:r.labelHeight&&(i.jobHeight=1*r.labelHeight)),"number"!=typeof i.orientation&&("number"==typeof r.printOrientation?i.orientation=r.printOrientation:r.printOrientation&&(i.orientation=1*r.printOrientation));const n=1===s,a=i.printMode||!Re.isPreviewJobName(i.jobName);if(a&&!n){const i=yield this.openPrinter({name:t.printerName||t.name,deviceId:t.deviceId,autoScan:!1});if(i.statusCode!==De.OK)return e.onJobComplete&&e.onJobComplete(i),we.processFailResult(i);t.printerDPI=this.mPrinter.PrinterDPI;}const o=e.onJobCreated||e.jobStarted;if(o){if("number"!=typeof i.jobHeight||i.jobHeight<=0){const t=e.jobPages||[],s=Re.getMargins(i);i.jobHeight=Re.calcPageHeight(t[0],s[2]);}const t=this.startJob({width:i.jobWidth||0,height:i.jobHeight,orientation:i.orientation,jobName:i.jobName});if(this.abortJob(),!t){const t={statusCode:De.ERROR_JOB_CREATE};return e.onJobComplete&&e.onJobComplete(t),we.processFailResult(t)}yield Promise.resolve(o(t,e));}return new Promise((t=>{const s=[],r=[];e.syncMode?this.Context.drawJob(we.filterAndAssign(e,{onPageComplete:o=>{d.log(`#### drawJob.onPageComplete: pages = [${o.pageIndex+1} / ${o.printPages}], copies = [${o.copyIndex+1} / ${o.printCopies}]`);let h=o.copyIndex;if(a)return this.pushImageData(Object.assign(Object.assign({},i),{printCopies:i.autoPage?0:i.printCopies,onlyGetRawData:n,imageData:o.imageData,onPageComplete:t=>{h=i.autoPage?o.copyIndex:t.copyIndex,n&&t.printData&&r.push(t.printData);const a=Object.assign(Object.assign({},o),{pageKey:t.pageKey,statusCode:t.statusCode,printable:t.printable,copyIndex:h,isEndCopy:i.autoPage?o.isEndCopy:h+1>=o.printCopies});s.push(a),e.onPageComplete&&e.onPageComplete(a);},onPagePrintComplete:t=>{h=i.autoPage?o.copyIndex:t.copyIndex,e.onPagePrintComplete&&e.onPagePrintComplete(Object.assign(Object.assign({},o),{pageKey:t.pageKey,statusCode:t.statusCode,printable:t.printable,copyIndex:h,isEndCopy:i.autoPage?o.isEndCopy:h+1>=o.printCopies}));const s=o.isEndCopy&&o.isEndPage&&h+1>=o.printCopies;(t.statusCode!==De.OK||s)&&e.onJobPrintComplete&&e.onJobPrintComplete({statusCode:De.OK,printable:t.printable});},onJobComplete:i=>{if(i.statusCode!==De.OK){if(i.statusCode===De.ERROR_PRINTER_NOT_AVAILABLE){const t=e.jobInfo||{};this.mPausedPrintInfo={printInfo:e,autoPage:t.autoPage,printPages:o.printPages,printCopies:o.printCopies,pageIndex:o.pageIndex,copyIndex:o.copyIndex};}const r=Qe.getJobPrintResult(i,s,o);e.onJobComplete&&e.onJobComplete(r),t(r);}else {const n=Qe.getJobPrintResult(i,s,o,r);o.isEndCopy&&o.isEndPage&&(h+1>=o.printCopies&&e.onJobComplete&&e.onJobComplete(n),t(n));}}})).statusCode;if(s.push(o),e.onPageComplete&&e.onPageComplete(Object.assign(Object.assign({},o),{statusCode:De.OK,pageKey:0})),o.isEndCopy&&o.isEndPage){const i=Qe.getJobPrintResult({statusCode:De.OK},s,o);e.onJobComplete&&e.onJobComplete(i),t(i);}return De.OK}})):this.Context.drawAsyncJob(we.filterAndAssign(e,{onPageComplete:o=>{let h=o.copyIndex;if(d.log(`#### drawAsyncJob.onPageComplete: pages = [${o.pageIndex+1} / ${o.printPages}], copies = [${o.copyIndex+1} / ${o.printCopies}]`),e.onPageCreated&&e.onPageCreated(o),a){const a=o.imageData;return o.imageData=void 0,this.printImageData(Object.assign(Object.assign({},i),{printCopies:i.autoPage?0:o.printCopies,imageData:a,onlyGetRawData:n,onPageComplete:t=>{h=i.autoPage?o.copyIndex:t.copyIndex,n&&t.printData&&r.push(t.printData);const a=Object.assign(Object.assign({},o),{statusCode:t.statusCode,printable:t.printable,pageKey:t.pageKey,copyIndex:h,isEndCopy:i.autoPage?o.isEndCopy:h+1>=o.printCopies});s.push(a),e.onPageComplete&&e.onPageComplete(a);},onPagePrintComplete:t=>{h=i.autoPage?o.copyIndex:t.copyIndex,e.onPagePrintComplete&&e.onPagePrintComplete(Object.assign(Object.assign({},o),{statusCode:t.statusCode,printable:t.printable,pageKey:t.pageKey,copyIndex:h,isEndCopy:i.autoPage?o.isEndCopy:h+1>=o.printCopies}));const s=o.isEndCopy&&o.isEndPage&&h+1>=o.printCopies;(t.statusCode!==De.OK||s)&&e.onJobPrintComplete&&e.onJobPrintComplete({statusCode:t.statusCode,printable:t.printable});},onJobComplete:i=>{if(i.statusCode!==De.OK){if(i.statusCode===De.ERROR_PRINTER_NOT_AVAILABLE){const t=e.jobInfo||{};this.mPausedPrintInfo={printInfo:e,autoPage:t.autoPage,printPages:o.printPages,printCopies:o.printCopies,pageIndex:o.pageIndex,copyIndex:o.copyIndex};}const r=Qe.getJobPrintResult(i,s,o);e.onJobComplete&&e.onJobComplete(r),t(r);}else {const n=Qe.getJobPrintResult(i,s,o,r);o.isEndCopy&&o.isEndPage&&(h+1>=o.printCopies&&e.onJobComplete&&e.onJobComplete(n),t(n));}}})).then((t=>t.statusCode))}if(s.push(o),e.onPageComplete&&e.onPageComplete(Object.assign(Object.assign({},o),{statusCode:De.OK,pageKey:0})),o.isEndCopy&&o.isEndPage){const i=Qe.getJobPrintResult({statusCode:De.OK},s,o);e.onJobComplete&&e.onJobComplete(i),t(i);}return De.OK}}));}))}))}continuePrint(){return t(this,void 0,void 0,(function*(){const t=this.mPausedPrintInfo;if(yield this.mPrinter.continuePrint(),!t||!t.printInfo.jobInfo)return !0;const e=t.printInfo,i=e.jobInfo,s=t.pageIndex,r=t.copyIndex,n=t.printPages,a=t.printCopies,o=a-r-1;if(t.autoPage){const t=n-s-1;if(t>0&&t<n){if((yield this.print(Object.assign(Object.assign({},e),{continueJob:!0,jobInfo:Object.assign(Object.assign({},i),{autoPage:!0,startCopy:r,printCopies:1,remainCopies:o,startPage:s+1,printPages:t})}))).statusCode!==De.OK)return !1}if(a>r+1){return (yield this.print(Object.assign(Object.assign({},e),{continueJob:!0,jobInfo:Object.assign(Object.assign({},i),{autoPage:!0,startCopy:r+1,printCopies:o,remainCopies:0,startPage:0,printPages:n})}))).statusCode===De.OK}}else if(n>s+1){return (yield this.print(Object.assign(Object.assign({},e),{continueJob:!0,jobInfo:Object.assign(Object.assign({},i),{printCopies:a,startPage:s+1,printPages:n-s-1})}))).statusCode===De.OK}return !0}))}printWdfx(e){return t(this,void 0,void 0,(function*(){if(d.log("#### 【printWdfx】options:"),!e.content||"string"!=typeof e.content)return d.warn("---- 未检测到 wdfx 字符串！"),d.warn(e.content),we.processFailResult({statusCode:De.ERROR_PARAM});const t=Ze.loadWdfxContent(e.content,e.domParser);return t?this.print(Object.assign(Object.assign({},e),{wdfData:t,content:void 0})):(d.warn("---- wdfx内容解析错误, content:"),d.warn(e.content.length>200?`${e.content.substring(0,200)}...`:e.content),we.processFailResult({statusCode:De.ERROR_DATA_PARSE}))}))}quit(){return this.closePrinter().then((()=>(this.mInitInfo.onQuit&&this.mInitInfo.onQuit(),this.stopPrint(),this.abortJob(),this.mPausedPrintInfo=void 0,this.mContext=void 0,this.mPrinter.quit(),!0)))}}Qe.trades="",Qe.patternGeneral=/^(.*)-([A-Z]{0,2}[0-9]{4,5}[0-9A-Z]{2,5}[0-9]{2})$/,Qe.JOB_NAME_TRANS="#!#transparent#!#",Qe.JOB_NAME_PREV="#!#preview#!#",Qe.JOB_NAME_PRINT="LPAPI",Qe.COLOR_WHITE="#fff";

class UniCanvas {
    get width() {
        return this._width;
    }
    set width(v) {
        this._width = v;
    }
    get height() {
        return this._height;
    }
    set height(v) {
        this._height = v;
    }
    constructor(context) {
        this._width = 0;
        this._height = 0;
        this.mContext = context;
    }
    getContext(options) {
        if (!this.mDrawContext) {
            this.mDrawContext = uni.createCanvasContext(this.mContext.canvasId || "", this.mContext.componentInstance);
        }
        return this.mDrawContext;
    }
    toDataURL(type, quality) {
        return this.mDataUrl || "";
    }
    getImageData() {
        return new Promise((resolve) => {
            if (this.mContext.isAlipay && this.mDrawContext) {
                // 支付宝小程序旧版本，只能异步获取ImageData;
                // 备注：这个地方会报错，报 toJSON 错误，但是不影响打印，后期需要升级 context 获取方式；
                d.info(`---- drawContext.getImageData:`);
                if (this.mContext.canvas) {
                    // 新版本不需要特殊处理
                    resolve(undefined);
                }
                else {
                    // 旧版本需要异步处理；
                    if (typeof this.mDrawContext.getImageData === "function") {
                        this.mDrawContext.getImageData({
                            x: 0,
                            y: 0,
                            width: this.width,
                            height: this.height,
                            success: (res) => {
                                d.info(`---- drawContext.getImageData.success:`);
                                resolve(res);
                            },
                            fail: (resp) => {
                                d.warn(resp, `---- drawContext.getImageData.fail:`);
                                resolve(undefined);
                            },
                        });
                    }
                    else {
                        d.warn(`---- 不支持的方法：mDrawContext.getImageData:`);
                        resolve(undefined);
                    }
                }
            }
            else if (typeof uni.canvasGetImageData === "function") {
                // APP、微信小程序等，需要通过 canvasGetImageData 来获取imageData 对象；
                d.info(`#### 【Request】 uni.canvasGetImageData:`);
                uni.canvasGetImageData({
                    x: 0,
                    y: 0,
                    width: this.width,
                    height: this.height,
                    canvasId: this.mContext.canvasId || "",
                    success: (res) => {
                        d.info(`#### 【Response.success】 uni.canvasGetImageData:`);
                        resolve(res);
                    },
                    fail: (res) => {
                        d.error(`#### 【Response.fail】uni.canvasGetImageData:`);
                        d.error(JSON.stringify(res));
                        resolve(undefined);
                    },
                }, this.mContext.componentInstance);
            }
            else {
                resolve(undefined);
            }
        });
    }
    static getTempFilePath(options, callback) {
        d.info(`#### 【Request】uni.canvasToTempFilePath:`);
        uni.canvasToTempFilePath({
            // 保存canvas为图片
            canvasId: options.canvasId || "",
            canvas: options.canvas,
            quality: 1,
            success: (res) => {
                d.info(res, `#### 【Response.success】uni.canvasToTempFilePath:`);
                // 备注：钉钉小程序需要通过 filePath来获取
                // uni.setStorageSync('filePath',res.tempFilePath)  //保存临时文件路径到缓存
                callback(res.tempFilePath || res.filePath);
            },
            fail: (res) => {
                d.warn(res, `#### 【Response.fail】uni.canvasToTempFilePath:`);
                callback("");
            },
        }, options.componentInstance);
    }
    start(options) {
        this.mDataUrl = "";
    }
    draw(context, apiMode, reserve) {
        return new Promise((resolve) => {
            if (!context) {
                resolve("");
                return;
            }
            const getTempPathAction = () => {
                UniCanvas.getTempFilePath(this.mContext, (tempPath) => {
                    this.mDataUrl = tempPath;
                    resolve(tempPath);
                });
            };
            if (this.mContext.isAlipay) {
                // 支付宝小程序 draw函数没有回调。
                if (typeof context.draw === "function") {
                    context.draw(reserve);
                }
                //
                if (!apiMode) {
                    resolve("");
                }
                else {
                    setTimeout(() => {
                        getTempPathAction();
                    }, this.mContext.drawTimeout || 100);
                }
            }
            else if (typeof context.draw === "function") {
                let hasDraw = false;
                context.draw(reserve, () => {
                    hasDraw = true;
                    if (apiMode) {
                        // 微信小程序中为了避免生成预览图片黑块的问题
                        setTimeout(getTempPathAction, this.mContext.drawTimeout || 100);
                    }
                    else {
                        resolve("");
                    }
                });
                setTimeout(() => {
                    if (!hasDraw) {
                        d.warn(`---- Canvas.draw 函数长时间未响应，请检查目标 Canvas 是否已经销毁。`);
                        resolve("");
                    }
                }, 3000);
            }
            else if (this.mContext.canvas && apiMode) {
                // 为了避免出现黑块，暂时等待1秒，具体待测试。
                setTimeout(() => {
                    getTempPathAction();
                }, 10);
            }
            else {
                resolve("");
            }
        });
    }
    saveBase64Image(dataUrl, callback) {
        const groups = /^data:(\S+)\/(\S+);base64,.*/.exec(dataUrl || "");
        if (groups && plus && plus.nativeObj.Bitmap) {
            if (groups[2] === "svg+xml") {
                callback && callback(dataUrl);
            }
            else {
                const fileName = `border.${groups[2]}`;
                const bitmap = new plus.nativeObj.Bitmap(`bitmap${Date.now()}`);
                try {
                    bitmap.loadBase64Data(dataUrl, () => {
                        const filePath = `_doc/temp/${fileName}`;
                        bitmap.save(filePath, { overwrite: true }, (res) => {
                            bitmap.clear();
                            callback && callback(res);
                        }, (res) => {
                            bitmap.clear();
                            d.warn(`---- 图片保存失败！`);
                            d.warn(res);
                            callback && callback(dataUrl);
                        });
                    }, (res) => {
                        bitmap.clear();
                        d.warn(`---- base64 字符串加载失败：`);
                        d.warn(res);
                        callback && callback(dataUrl);
                    });
                }
                catch (error) {
                    d.warn(`---- base64 字符串load 异常！`);
                    d.warn(error);
                    bitmap.clear();
                    callback && callback(dataUrl);
                }
            }
        }
        else {
            callback && callback(dataUrl);
        }
    }
    loadImage(options) {
        const opts = typeof options === "string" ? { src: options } : options;
        d.log(`UniCanvas.loadImage: ${opts.src.length > 100 ? opts.src.substring(0, 100) : opts.src}`);
        return new Promise((resolve) => {
            if (opts.src.startsWith("http")) {
                uni.getImageInfo({
                    src: opts.src,
                    success: (res) => {
                        d.log(`res, 【Response.success】uni.getImageInfo:`);
                        resolve({
                            width: res.width,
                            height: res.height,
                            dzSrc: res.path,
                        });
                    },
                    fail: (res) => {
                        d.warn(res, `【Response.fail】uni.getImageInfo:`);
                        resolve("");
                    },
                });
            }
            else if (opts.src.startsWith("data:")) {
                if (opts.withSize) {
                    this.saveBase64Image(opts.src, (result) => {
                        if (result && typeof result !== "string" && result.width && result.height) {
                            resolve({
                                width: result.width,
                                height: result.height,
                                dzSrc: result.target,
                            });
                        }
                        else {
                            resolve(opts.src);
                        }
                    });
                }
                else {
                    resolve(opts.src);
                }
            }
            else {
                resolve(opts.src);
            }
        });
    }
}
class UniContext extends Ee$1 {
    static createInstance(options, prevContext) {
        const opts = options || {};
        if (options.canvas && prevContext && prevContext.CanvasElement === options.canvas) {
            return prevContext;
        }
        return opts.canvas || opts.canvasId ? new UniContext(opts) : undefined;
    }
    constructor(context) {
        super(Object.assign({ apiMode: true }, context || {}));
        //
        this.init(context || {});
    }
    init(options) {
        const opts = options || {};
        // #ifdef APP-PLUS
        opts.isAppPlus = true;
        // #endif
        // #ifdef H5
        opts.isH5 = true;
        // #endif
        // #ifdef MP-WEIXIN
        opts.isWeiXin = true;
        // #endif
        // #ifdef MP-ALIPAY
        opts.isAlipay = true;
        // #endif
        // #ifdef MP-LARK
        opts.isLark = true;
        // #endif
        this.mOptions = opts;
    }
    createCanvas() {
        const context = this.mOptions;
        //
        if (!this.mCanvas) {
            d.info(`#### UniContext.createCanvas():`);
            if (document && typeof document.createElement === "function") {
                // H5环境适配
                this.mCanvas = document.createElement("canvas");
            }
            else if (context.canvas && typeof context.canvas.getContext === "function") {
                // 新版在屏 canvas 适配，canvas必须支持获取绘制上下文才可以使用
                this.mCanvas = context.canvas;
            }
            else if (context.canvasId) {
                // 旧版在屏 canvas 适配
                this.mCanvas = new UniCanvas(this.mOptions);
            }
            else {
                // 离屏 canvas 适配
                if (typeof uni.createOffscreenCanvas === "function") {
                    this.mCanvas = uni.createOffscreenCanvas({ type: "2d" });
                }
                if (!this.mCanvas) {
                    if (context.isWeiXin) {
                        d.warn("================================");
                        d.warn("==== 真机调试请使用 2.0 模式 ====");
                        d.warn("================================");
                    }
                    else {
                        d.warn("=======================================");
                        d.warn("==== 当前环境不支持 OffscreenCanvas ====");
                        d.warn("=======================================");
                    }
                }
                else {
                    d.info("==================================");
                    d.info("==== OffscreenCanvas创建成功！ ====");
                    d.info("==================================");
                }
            }
        }
        //
        return this.mCanvas;
    }
    /**
     * 通过 canvas 来创建 Image 对象。
     */
    createImage(canvas, src, timeout) {
        // 注意：
        //      1. 不知道为什么，通过canvas.createImage创建的Image在小程序中第二次加载图片的时候不会触发 onload 方法；
        //      2. Image本身就可以加载网络图片，所以也不需要使用 getImageInfo来缓存；
        //      3. 网络图片可以通过添加随机参数来避免第二次无法加载的问题，本地图片该方法不可行；
        //      4. 加载完之后，不能立即将 image.src 设置为空，设置为空后图片显示黑块；
        return new Promise((resolve) => {
            const imgSrc = src.startsWith("http") ? `${src}?${new Date().getTime()}${Math.random()}` : src;
            // const canvas = uni.createOffscreenCanvas({ type: "2d" }) as any;
            const image = canvas.createImage();
            const subImagePath = imgSrc.length > 100 ? `${imgSrc.substring(0, 100)}...` : imgSrc;
            let processed = false;
            d.info(`---- canvas.createImage: ${subImagePath}`);
            image.onload = () => {
                d.info(`---- image.onload`);
                if (processed) {
                    d.warn(`图片加载时间太长了，已经进行超时处理了！`);
                }
                else {
                    processed = true;
                    resolve(image);
                }
            };
            image.onerror = (res) => {
                d.warn(res, `---- image.onerror：${subImagePath}`);
                processed = true;
                resolve(imgSrc);
            };
            //
            setTimeout(() => {
                if (!processed) {
                    d.warn(`---- 图片加载超时：`);
                    processed = true;
                    resolve(image);
                }
            }, timeout || 3000);
            image.src = imgSrc;
        });
    }
    loadImage(options) {
        d.log(`---- UniContext.loadImage:`);
        const opts = typeof options === "string" ? { src: options } : options;
        opts.src = (opts.src || "").trim();
        const canvas = this.createCanvas();
        if (canvas instanceof UniCanvas) {
            // 通过 canvasId 来创建上下文的情况；
            return canvas.loadImage(opts);
        }
        else if (document && typeof document.createElement === "function") {
            return super.loadImage(opts.src);
        }
        else if (canvas && canvas === this.mOptions.canvas) {
            // 新版的在屏 canvas 适配；
            return this.createImage(canvas, opts.src, 0);
        }
        else if (typeof uni.createOffscreenCanvas === "function") {
            // 兼容微信小程序离屏Canvas
            return this.createImage(canvas, opts.src, 0);
        }
        else {
            return super.loadImage(opts.src);
        }
    }
    startJob(options) {
        d.log(`#### UniContext.startJob:`);
        const res = super.startJob(options);
        if (!res)
            return res;
        //
        if (this.mCanvas && this.mCanvas instanceof UniCanvas) {
            this.mCanvas.start(res);
        }
        return res;
    }
    onCanvasClear(canvas, context) {
        // if (canvas && canvas instanceof UniCanvas) {
        //     canvas.draw(context as any, this.IsApiMode, true);
        // }
    }
    commitJob() {
        return super.commitJob().then((res) => {
            if (!res)
                return res;
            d.info(`---- [UniContext] DrawContext.commitJob.completed:`);
            //
            const canvas = this.mCanvas;
            const jobInfo = this.jobOptions || {};
            if (canvas && canvas instanceof UniCanvas) {
                return canvas.draw(res.context, res.apiMode).then((v) => {
                    if (!res.dataUrl)
                        res.dataUrl = v;
                    res.tempFilePath = v;
                    if (!res.isPreview || jobInfo.withImageData) {
                        return canvas.getImageData().then((data) => {
                            res.imageData = data;
                            return res;
                        });
                    }
                    else {
                        return res;
                    }
                });
            }
            //
            return res;
        });
    }
}
class UniBleAdapter {
    static getInstance() {
        return this._instance || (this._instance = new UniBleAdapter());
    }
    constructor(options) {
        this.mConnectStatusMap = new Map();
        this.mShowWriteLog = false;
        this.mBleCharacterValueChangedMap = new Map();
        this.mBleConnectionStateChangeMap = new Map();
        this.mContext = options || {};
        // #ifdef APP-PLUS
        this.mContext.isAppPlus = true;
        // #endif
        // #ifdef H5
        this.mContext.isH5 = true;
        // #endif
        // #ifdef MP-WEIXIN
        this.mContext.isWeiXin = true;
        // #endif
        // #ifdef MP-ALIPAY
        this.mContext.isAlipay = true;
        // #endif
        // #ifdef MP-LARK
        this.mContext.isLark = true;
        // #endif
        if (typeof uni.getSystemInfo === "function") {
            uni.getSystemInfo({
                complete: (res) => {
                    this.mSystemInfo = res;
                },
            });
        }
    }
    get isH5() {
        return this.mContext.isH5;
    }
    get Context() {
        return this.mContext;
    }
    isAndroid() {
        var _a, _b;
        const osName = ((_a = this.mSystemInfo) === null || _a === void 0 ? void 0 : _a.osName) || ((_b = this.mSystemInfo) === null || _b === void 0 ? void 0 : _b.platform) || "";
        return osName.toLowerCase() === "android";
    }
    androidAPILevel() {
        if (this.isAndroid() && this.mContext.isAppPlus) {
            const apiLevel = this.mSystemInfo ? this.mSystemInfo.osAndroidAPILevel : 0;
            if (typeof apiLevel === "number" && apiLevel > 0) {
                return apiLevel;
            }
            else {
                const Build = plus.android.importClass("android.os.Build");
                const version = Build ? Build.VERSION.SDK_INT : 0;
                return typeof version === "number" ? version : 0;
            }
        }
        else {
            return 0;
        }
    }
    requestPermissions() {
        return new Promise((resolve) => {
            const sdkVersion = this.androidAPILevel();
            if (sdkVersion >= 23) {
                const permissions = [];
                if (sdkVersion >= 31) {
                    permissions.push("android.permission.BLUETOOTH_SCAN");
                    permissions.push("android.permission.BLUETOOTH_CONNECT");
                }
                if (sdkVersion >= 29) {
                    permissions.push("android.permission.ACCESS_FINE_LOCATION");
                }
                else {
                    permissions.push("android.permission.ACCESS_COARSE_LOCATION");
                }
                d.log(`#### 【Request】plus.android.requestPermissions, sdkVersion = ${sdkVersion}`);
                plus.android.requestPermissions(permissions, (res) => {
                    d.log(res, `#### 【Response.success】plus.android.requestPermissions:`);
                    resolve(true);
                }, (res) => {
                    d.warn(res, `#### 【Response.error】plus.android.requestPermissions:`);
                    resolve(false);
                });
            }
            else {
                resolve(true);
            }
        });
    }
    openBleAdapter() {
        return new Promise((resolve) => {
            if (this.mIsBleAdapterOpened) {
                this.requestPermissions().then(() => {
                    resolve(true);
                });
            }
            else {
                uni.openBluetoothAdapter({
                    success: () => {
                        this.mIsBleAdapterOpened = true;
                        d.info(`#### 【Response.success】蓝牙适配器打开成功！`);
                        //
                        const adapterStateChangeCallback = (res) => {
                            d.info("==== onBluetoothAdapterStateChange: ====");
                            d.info(JSON.stringify(res));
                            if (typeof res.available === "string") {
                                res.available = res.available === "true";
                            }
                            if (res.available === false) {
                                this.mConnectionStateChange &&
                                    this.mConnectionStateChange({ deviceId: this.mDeviceId || "", connected: false });
                            }
                            this.mBleAdapterStateChange && this.mBleAdapterStateChange(res);
                        };
                        const adapter = this.Context.bleAdapter;
                        if (adapter && typeof adapter.onBluetoothAdapterStateChange === "function") {
                            adapter.onBluetoothAdapterStateChange(adapterStateChangeCallback);
                        }
                        else {
                            uni.onBluetoothAdapterStateChange(adapterStateChangeCallback);
                        }
                        //
                        resolve(true);
                    },
                    fail: (res) => {
                        const errCode = res.errCode || res.code || 0;
                        if (errCode <= 0) {
                            d.info(`#### 【Response.fail】蓝牙适配器已打开！`);
                            resolve(true);
                        }
                        else {
                            d.warn(`#### 【Response.fail】蓝牙适配器打开失败！`);
                            d.warn(JSON.stringify(res));
                            resolve(false);
                        }
                    },
                });
            }
        });
    }
    closeBleAdapter() {
        return new Promise((resolve) => {
            if (typeof uni.offBluetoothDeviceFound === "function") {
                d.info(`#### uni.offBluetoothDeviceFound:`);
                uni.offBluetoothDeviceFound();
            }
            if (typeof uni.offBluetoothAdapterStateChange === "function") {
                d.info(`#### uni.offBluetoothAdapterStateChange:`);
                uni.offBluetoothAdapterStateChange();
            }
            if (this.mBleCharacteristicValueChangeListener) {
                this.mBleCharacterValueChangedMap.clear();
                this.mBleCharacteristicValueChangeListener = undefined;
            }
            // 关闭蓝牙适配器前停止特征值监听事件
            if (typeof uni.offBLECharacteristicValueChange === "function") {
                uni.offBLECharacteristicValueChange();
            }
            //
            d.info(`#### uni.closeBluetoothAdapter:`);
            uni.closeBluetoothAdapter({
                fail: (res) => {
                    d.warn(res, `#### 【Response.fail】uni.closeBluetoothAdapter`);
                },
                complete: () => {
                    // 蓝牙适配器关闭后，打印机会断开链接，此时需要通知下LPAPI
                    this.mIsBleAdapterOpened = false;
                    this.mConnectionStateChange &&
                        this.mConnectionStateChange({
                            deviceId: this.mDeviceId || "",
                            connected: false,
                        });
                    resolve(true);
                },
            });
        });
    }
    resetBluetoothAdapter(callback) {
        return this.closeBleAdapter()
            .then(() => {
            // 重新打开蓝牙适配器。
            return this.openBleAdapter();
        })
            .then((res) => {
            callback && callback(res);
            return res;
        });
    }
    startBleDiscovery(options) {
        const opts = options || {};
        const onSuccessCallback = (result) => {
            if (result) {
                d.info("### 【Request】 uni.startBluetoothDevicesDiscovery: ");
                // 为了避免多设备调用的时候，其他接口调用了 onBluetoothDeviceFound 后无法获取到设备列表的问题，
                // 每次搜索蓝牙设备前都重新注册下回调函数
                const adapter = this.Context.bleAdapter;
                const deviceFoundCallback = (res) => {
                    const devices = res.devices || [];
                    // 过滤掉没有名称的设备
                    const filters = devices.filter((v) => v.name || v.localName);
                    if (filters.length > 0) {
                        // logger.log(`---- onBluetoothDeviceFound:`);
                        // logger.log(JSON.stringify(res));
                        this.mDeviceFoundAction && this.mDeviceFoundAction(filters);
                    }
                };
                if (adapter && typeof adapter.onBluetoothDeviceFound === "function") {
                    adapter.onBluetoothDeviceFound(deviceFoundCallback);
                }
                else {
                    uni.onBluetoothDeviceFound(deviceFoundCallback);
                }
                //
                return new Promise((resolve) => {
                    uni.startBluetoothDevicesDiscovery({
                        interval: opts.interval || 200,
                        allowDuplicatesKey: true,
                        success: (resp) => {
                            this.mDeviceFoundAction = opts.deviceFound;
                            this.mBleAdapterStateChange = opts.adapterStateChange;
                            d.info(`#### 【Response.success】: uni.startBluetoothDevicesDiscovery:`);
                            //
                            we.processSuccessResult({ statusCode: 0, resultInfo: resp }, opts, resolve);
                        },
                        fail: (resp) => {
                            d.warn(`#### 【Response.fail】: uni.startBluetoothDevicesDiscovery:`);
                            d.warn(JSON.stringify(resp));
                            we.processFailResult({ statusCode: resp.errCode || resp.code, resultInfo: resp }, opts, resolve);
                        },
                    });
                });
            }
            else {
                d.warn("========== 蓝牙适配器打开失败！ ==========");
                return we.processFailResult({ statusCode: 1, resultInfo: "蓝牙适配器打开失败！" }, opts);
            }
        };
        // 在Uni中重置蓝牙适配器后，倒是可以自动断开设备链接了，但是特征值的监听无法取消，重新监听特征值后，会接收到很多无效的数据。
        // 所以最好还是不要重置适配器了
        if (opts.resetAdapter) {
            return this.resetBluetoothAdapter().then(onSuccessCallback);
        }
        else {
            return this.openBleAdapter().then(onSuccessCallback);
        }
    }
    stopBleDiscovery() {
        return new Promise((resolve) => {
            // 停止蓝颜色搜索
            d.info(`###【Request】uni.stopBluetoothDevicesDiscovery:`);
            uni.stopBluetoothDevicesDiscovery({
                success: (resp) => {
                    d.info(`###【Response.success】stopBluetoothDevicesDiscovery:`);
                    resolve(resp);
                    // 停止设备检测；
                    this.mDeviceFoundAction = undefined;
                    // 停止搜索后，支付宝小程序不会触发该回调，所以手动触发下。
                    this.mBleAdapterStateChange && this.mBleAdapterStateChange({ discovering: false });
                    this.mBleAdapterStateChange = undefined;
                },
                fail: (resp) => {
                    d.warn(`###【Response.fail】stopBluetoothDevicesDiscovery:`);
                    d.warn(JSON.stringify(resp));
                    resolve(resp);
                },
            });
        });
    }
    createBleConnection(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        d.info(`###【Request】createBleConnection:`);
        return new Promise((resolve) => {
            const connectOptions = {
                deviceId: deviceId,
                success: () => {
                    d.info(`---- 【Response.success】 createBLEConnection:`);
                    this.mDeviceId = deviceId;
                    this.mConnectStatusMap.set(deviceId, true);
                    // this.mConnected = true;
                    this.mConnectionStateChange = options.connectionStateChange;
                    // 监控打印机链接状态
                    const connectStateChangeAction = (resp) => {
                        d.info(`========== onBLEConnectionStateChange ==========`);
                        d.info(JSON.stringify(resp));
                        this.mConnectStatusMap.set(resp.deviceId, resp.connected);
                        // if (resp.deviceId === this.mDeviceId) {
                        //     this.mConnected = resp.connected;
                        // }
                        if (resp.deviceId === deviceId) {
                            this.mConnectionStateChange && this.mConnectionStateChange(resp);
                        }
                    };
                    //
                    uni.onBLEConnectionStateChange(connectStateChangeAction);
                    this.mBleConnectionStateChangeMap.set(deviceId, connectStateChangeAction);
                    // 经测试：在APP环境下，打印机连接成功之后不能立马进行后续操作，否则无效；
                    let awaitTimes = 200;
                    if (this.mContext.isAppPlus) {
                        console.log("============== APP-PLUS ============");
                        if (this.isAndroid()) {
                            // 在安卓环境下，打印机链接成功后大概要等待800毫秒才可以进行后续操作，保险起见，此处设置1000毫秒的延时；
                            awaitTimes = 1000;
                        }
                        else {
                            // IOS环境下，DF2需要200毫秒延时，DF4 100毫秒足够了
                            awaitTimes = 300;
                        }
                    }
                    setTimeout(() => {
                        we.processSuccessResult(0, options, resolve);
                    }, awaitTimes);
                },
                fail: (resp) => {
                    d.warn(`---- 【Response.fail】 createBLEConnection:`);
                    d.warn(JSON.stringify(resp));
                    let errCode = resp.errCode || resp.code;
                    if (errCode === 10010) {
                        errCode = -1;
                    }
                    // 支付宝小程序中既没有errCode 也没有 code
                    if (typeof errCode === "number" && errCode <= 0) {
                        // this.mConnected = true;
                        this.mConnectStatusMap.set(deviceId, true);
                        we.processSuccessResult(errCode, options, resolve);
                    }
                    else {
                        we.processFailResult(errCode, options, resolve);
                    }
                },
            };
            if (!this.mContext.isAlipay && typeof options.timeout === "number") {
                // 支付宝小程序不能配置 timeout，否则可能会出现链接不上的问题。
                connectOptions.timeout = options.timeout;
            }
            //
            if (this.mContext.isLark) {
                tt.connectBLEDevice(connectOptions);
            }
            else {
                uni.createBLEConnection(connectOptions);
            }
        });
    }
    // isDeviceConnected(deviceId: string): boolean {
    //     return this.mConnectStatusMap.get(deviceId) || false;
    // }
    closeBleConnection(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        return new Promise((resolve) => {
            const api = uni;
            const stateChangeCallback = this.mBleConnectionStateChangeMap.get(deviceId);
            if (stateChangeCallback) {
                this.mBleConnectionStateChangeMap.delete(deviceId);
                if (typeof uni.offBLEConnectionStateChange === "function") {
                    // 微信小程序、飞书小程序适配；
                    d.info(`---- uni.offBLEConnectionStateChange:`);
                    uni.offBLEConnectionStateChange(stateChangeCallback);
                }
                else if (typeof api.offBLEConnectionStateChanged === "function") {
                    // 支付宝/钉钉小程序适配；
                    d.info(`---- uni.offBLEConnectionStateChanged:`);
                    api.offBLEConnectionStateChanged(stateChangeCallback);
                }
            }
            //
            d.info(`###【Request】closeBleConnection:`);
            if (deviceId) {
                const connected = this.mConnectStatusMap.get(deviceId);
                if (!this.mIsBleAdapterOpened || !connected) {
                    d.info(`#### 设备未连接！`);
                    we.processSuccessResult(0, options, resolve);
                }
                else {
                    const closeOptions = {
                        deviceId: deviceId,
                        success: () => {
                            d.log(`####【Response.success】- uni.closeBLEConnection:`);
                            we.processSuccessResult(0, options, resolve);
                        },
                        fail: (resp) => {
                            d.warn(`####【Response.fail】- uni.closeBLEConnection:`);
                            d.warn(JSON.stringify(resp));
                            we.processFailResult(resp.errCode || resp.code, options, resolve);
                        },
                    };
                    this.mConnectStatusMap.delete(deviceId);
                    if (this.mContext.isLark) {
                        tt.disconnectBLEDevice(closeOptions);
                    }
                    else {
                        uni.closeBLEConnection(closeOptions);
                    }
                }
            }
            else {
                d.warn(`---- 【参数错误】- closeBleConnection:`);
                d.warn(JSON.stringify(options));
                we.processFailResult(De.ERROR_PARAM, options, resolve);
            }
        });
    }
    getConnectedBleDevices() {
        return new Promise((resolve) => {
            if (typeof uni.getConnectedBluetoothDevices === "function") {
                this.openBleAdapter().then(() => {
                    let devices = undefined;
                    uni.getConnectedBluetoothDevices({
                        services: [],
                        success: (res) => {
                            d.info(res, `#### 【Response.success】: getConnectedBluetoothDevices`);
                            devices = res ? res.devices : [];
                            resolve(devices);
                        },
                        fail: (res) => {
                            d.info(res, `#### 【Response.fail】: getConnectedBluetoothDevices`);
                            devices = [];
                            resolve([]);
                        },
                    });
                    setTimeout(() => {
                        if (!devices) {
                            resolve([]);
                        }
                    }, 100);
                });
            }
            else {
                resolve([]);
            }
        });
    }
    setBleMtu(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        return new Promise((resolve) => {
            d.info(`#### 【Request: setMTU】: { deviceId: ${deviceId}, mtu: ${options.mtu}}`);
            if (this.isAndroid()) {
                const writeWaits = options.waits || 0;
                let delayTime = 0;
                if (this.mContext.isAppPlus) {
                    if (options.chipType === "DF5" || options.mtu >= 500) {
                        delayTime = 0;
                    }
                    else {
                        delayTime = 5;
                    }
                }
                let setMtu = true;
                if (this.mContext.isAlipay) {
                    // 支付宝小程序下的钉钉小程序不支持 setBLEMTU 设置。
                    if (my && typeof my.setBLEMTU === "function") {
                        setMtu = true;
                    }
                    else {
                        setMtu = false;
                    }
                }
                else {
                    setMtu = typeof uni.setBLEMTU === "function";
                }
                if (options.chipType && !options.required) {
                    // DF4及之后的蓝牙芯片不需要进行MTU的协商处理；
                    resolve({ status: -1, waits: writeWaits + delayTime });
                }
                else if (setMtu) {
                    uni.setBLEMTU({
                        deviceId: deviceId,
                        mtu: options.mtu,
                        success: (resp) => {
                            d.info(`#### 【Response.success】: setBleMTU`);
                            resolve({
                                status: 0,
                                mtu: resp.mtu || options.mtu,
                                waits: writeWaits + delayTime,
                            });
                        },
                        fail: (resp) => {
                            d.warn(`#### 【Response.fail】 setBLEMtu: MTU协商失败！`);
                            d.warn(JSON.stringify(resp));
                            resolve({ status: 2, waits: writeWaits + delayTime });
                        },
                    });
                }
                else {
                    d.warn(`不支持的方法： uni.setBLEMTU`);
                    resolve({ status: 1, waits: writeWaits + delayTime });
                }
            }
            else {
                // IOS 系统使用不做处理，使用默认的MTU大小；
                resolve({ status: -1 });
            }
        });
    }
    getGATTServices(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        return new Promise((resolve) => {
            d.info(`#### 【Request】getGattService: ${deviceId}`);
            uni.getBLEDeviceServices({
                deviceId: deviceId,
                success: (resp) => {
                    d.info(`#### 【Response.success】getGattService: ${deviceId}`);
                    // logger.info(JSON.stringify(resp));
                    const services = (resp.services || []).map((v) => {
                        return Object.assign(v, { uuid: v.uuid || v.serviceId || "" });
                    });
                    if (services.length <= 0) {
                        d.warn(`---- 服务列表为空：${JSON.stringify(resp)}`);
                    }
                    we.processSuccessResult(services, options, resolve);
                },
                fail: (resp) => {
                    d.warn(`#### 【Response.fail】getGattService: ${deviceId}`);
                    d.warn(JSON.stringify(resp));
                    we.processFailResult([], options, resolve);
                },
            });
        });
    }
    getGATTCharacteristics(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        return new Promise((resolve) => {
            d.info(`#### 【Request】getCharacteristicList(${options.serviceId})`);
            uni.getBLEDeviceCharacteristics({
                deviceId: deviceId,
                serviceId: options.serviceId || "",
                success: (resp) => {
                    d.info(`#### 【Response.success】getCharacteristicList(${options.serviceId})`);
                    // logger.log(JSON.stringify(resp));
                    const characterList = resp.characteristics || [];
                    if (characterList.length <= 0) {
                        d.warn(`---- 特征值列表为空：${JSON.stringify(resp)}`);
                    }
                    const list = characterList.map((v) => {
                        const prop = v.properties || {};
                        let propValue = 0;
                        if (prop.read)
                            propValue |= Ge.READ;
                        if (prop.write) {
                            if (prop.writeNoResponse)
                                propValue |= Ge.WRITE_NO_RESPONSE;
                            else
                                propValue |= Ge.WRITE;
                        }
                        if (prop.notify)
                            propValue |= Ge.NOTIFY;
                        if (prop.indicate)
                            propValue |= Ge.INDICATE;
                        return Object.assign(v, {
                            serviceId: options.serviceId,
                            uuid: v.uuid || v.characteristicId || "",
                            properties: propValue,
                        });
                    });
                    we.processSuccessResult(list, options, resolve);
                },
                fail: (resp) => {
                    d.warn(`#### 【Response.fail】getCharacteristicList(${options.serviceId})`);
                    d.warn(JSON.stringify(resp));
                    we.processFailResult([], options, resolve);
                },
            });
        });
    }
    onBLECharacteristicValueChange(characterId, callback) {
        this.mBleCharacterValueChangedMap.set(characterId, callback);
        const adapter = this.Context.bleAdapter;
        if (typeof uni.offBLECharacteristicValueChange === "undefined") {
            // 如果不支持关闭ble特征值变化通知的功能，则统一注册，并且之注册一次后，根据实际需要进行分发处理。
            d.log(`#### 【Register】mBleCharacterValueChangedMap.set(${characterId})`);
            if (!this.mBleCharacteristicValueChangeListener) {
                d.log(`#### ====== create characteristic value change listener!`);
                this.mBleCharacteristicValueChangeListener = (resp) => {
                    for (const item of this.mBleCharacterValueChangedMap) {
                        if (item[0] === resp.characteristicId) {
                            item[1](resp);
                            break;
                        }
                    }
                };
                //
                if (adapter && typeof adapter.onBLECharacteristicValueChange === "function") {
                    adapter.onBLECharacteristicValueChange(this.mBleCharacteristicValueChangeListener);
                }
                else {
                    uni.onBLECharacteristicValueChange(this.mBleCharacteristicValueChangeListener);
                }
            }
        }
        else {
            // 如果支持取消特征值变化监听回调函数的功能，则直接取消注册。
            d.log(`#### 【Register】uni.onBLECharacteristicValueChange: [${characterId}]`);
            if (adapter && typeof adapter.onBLECharacteristicValueChange === "function") {
                adapter.onBLECharacteristicValueChange(callback);
            }
            else {
                uni.onBLECharacteristicValueChange(callback);
            }
        }
    }
    offBLECharacteristicValueChange(cid) {
        if (!cid)
            return;
        //
        const listener = this.mBleCharacterValueChangedMap.get(cid);
        this.mBleCharacterValueChangedMap.delete(cid);
        if (typeof uni.offBLECharacteristicValueChange === "function") {
            d.log(`#### 【Unregister】uni.offBLECharacteristicValueChange: [${cid}]`);
            // 如果支持取消事件监听，则取消对应的事件监听回调函数
            uni.offBLECharacteristicValueChange(listener);
        }
        else {
            d.log(`#### 【Unregister】mBleCharacterValueChangedMap.delete(${cid}):`);
            // 如果不支持取消特征值监听回调函数，则只需要从移除监听回调函数即可
        }
    }
    readCharacteristic(options) {
        return new Promise((resolve) => {
            const deviceId = options.deviceId || this.mDeviceId || "";
            const cid = options.characteristicId || "";
            d.info(`#### 【Request】readCharacteristic(uuid: ${cid})`);
            if (deviceId && options.serviceId && cid) {
                // 监控特征值变化
                if (this.mContext.isAppPlus || this.mContext.isWeiXin) {
                    this.onBLECharacteristicValueChange(cid, (resp) => {
                        d.info(`#### 【Response】onReadCharacteristicValueChange: [${resp.value}]`);
                        // logger.log(JSON.stringify(resp));
                        // 执行回调。
                        if (resp.characteristicId == cid) {
                            we.processSuccessResult(resp.value, options, resolve);
                            // 取消监听
                            this.offBLECharacteristicValueChange(cid);
                        }
                    });
                }
                //
                uni.readBLECharacteristicValue({
                    deviceId: deviceId,
                    serviceId: options.serviceId,
                    characteristicId: cid,
                    success: (resp) => {
                        const res = resp;
                        d.log(`#### 【Response.success】uni.readBLECharacteristicValue: [${cid}]`);
                        d.log(JSON.stringify(res));
                        if (!(this.mContext.isAppPlus || this.mContext.isWeiXin)) {
                            // 支付宝、钉钉、飞书等小程序直接返回；
                            const result = res.characteristic || {};
                            we.processSuccessResult(result.value || "", options, resolve);
                        }
                    },
                    fail: (resp) => {
                        d.warn(`---- 【Response.fail】uni.readBLECharacteristicValue: [${cid}]`);
                        d.warn(JSON.stringify(resp));
                        we.processFailResult("", options, resolve);
                    },
                });
            }
            else {
                d.warn(`---- 【参数错误】: readCharacteristic`);
                d.warn(JSON.stringify(options));
                we.processFailResult("", options, resolve);
            }
        });
    }
    notifyCharacteristic(options) {
        const deviceId = options.deviceId || this.mDeviceId;
        return new Promise((resolve) => {
            const state = typeof options.state === "boolean" ? options.state : true;
            // 取消数据监听回调，避免二次链接的时候造成的数据干扰。
            if (state) {
                d.info(`#### 【Request.start】 - notifyCharacteristic:`);
            }
            else {
                this.offBLECharacteristicValueChange(options.characteristicId);
                d.info(`#### 【Request.stop 】 - notifyCharacteristic:`);
            }
            const connected = deviceId ? this.mConnectStatusMap.get(deviceId) : false;
            if (connected && deviceId && options.serviceId && options.characteristicId) {
                // 为了避免遗漏数据，监听之前先注册回调；
                uni.notifyBLECharacteristicValueChange({
                    deviceId: deviceId,
                    serviceId: options.serviceId,
                    characteristicId: options.characteristicId,
                    state: state,
                    success: () => {
                        if (state) {
                            d.info(`#### uni.onBLECharacteristicValueChange:`);
                            this.onBLECharacteristicValueChange(options.characteristicId, (resp) => {
                                d.log(`#### 【Response】onNotifyCharacteristicValueChange: [${resp.value}]`);
                                // logger.log(JSON.stringify(resp));
                                if (options.characteristicId === resp.characteristicId) {
                                    options.dataReceived && options.dataReceived(resp.value);
                                }
                            });
                        }
                        //
                        d.info(`#### 【Response.success】: uni.notifyBLECharacteristicValueChange:`);
                        we.processSuccessResult(true, options, resolve);
                    },
                    fail: (resp) => {
                        d.warn(resp, `#### 【Response.fail】: uni.notifyBLECharacteristicValueChange:`);
                        we.processFailResult(false, options, resolve);
                    },
                });
            }
            else {
                if (!connected) {
                    d.warn(`#### 【设备链接已断开】: notifyCharacteristic`);
                }
                else {
                    d.warn(`#### 【参数错误】: notifyCharacteristic`);
                    d.warn(options);
                }
                we.processFailResult(false, options, resolve);
            }
        });
    }
    writeCharacteristic(options) {
        const deviceId = options.deviceId || this.mDeviceId || "";
        const serviceId = options.serviceId || "";
        const characteristicId = options.characteristicId || "";
        const data = options.data;
        const writeValue = this.mContext.isLark || this.mContext.isAlipay ? we.getHexStringOfBytes(data, "") : data.buffer;
        const pkgName = `[P ${options.pkgIndex} - SUP ${options.subPkgIndex}]`;
        if (this.mShowWriteLog) {
            d.log(`#### 【Request】writeBLECharacteristicValue: ${pkgName}`);
        }
        return new Promise((resolve) => {
            if (deviceId && serviceId && characteristicId && data) {
                uni.writeBLECharacteristicValue({
                    deviceId: deviceId,
                    serviceId: serviceId,
                    characteristicId: characteristicId,
                    value: writeValue,
                    success: (resp) => {
                        if (this.mShowWriteLog) {
                            d.log(resp, `#### 【Response.success】uni.writeBLECharacteristicValue: ${pkgName}`);
                        }
                        we.processSuccessResult({ statusCode: 0, resultInfo: resp }, options, resolve);
                        // 关闭写入日志
                        this.mShowWriteLog = false;
                    },
                    fail: (resp) => {
                        d.warn(resp, `#### 【Response.fail】uni.writeBLECharacteristicValue: ${pkgName}`);
                        d.warn(options);
                        we.processFailResult({ statusCode: resp.errCode || resp.code, resultInfo: resp }, options, resolve);
                        // 如果数据写入失败，则打开写入日志信息，供参考；
                        this.mShowWriteLog = true;
                    },
                });
            }
            else {
                d.warn(`---- 【参数错误】:`);
                d.warn(`---- deviceId         : ${deviceId}`);
                d.warn(`---- serviceId        : ${options.serviceId}`);
                d.warn(`---- characteristicId : ${options.characteristicId}`);
                we.processFailResult({ statusCode: 1, resultInfo: "参数错误" }, options, resolve);
            }
        });
    }
}
//
class LPAPIFactory {
    /**
     * 获取LPAPI接口实例。
     */
    static getInstance(options) {
        if (!LPAPIFactory.api) {
            LPAPIFactory.api = LPAPIFactory.createInstance(options);
        }
        else if (options) {
            const prevContext = LPAPIFactory.api.Context;
            const context = UniContext.createInstance(options, prevContext);
            if (context) {
                LPAPIFactory.api.setDrawContext(context);
            }
        }
        //
        return LPAPIFactory.api;
    }
    static createInstance(options) {
        const opts = options || {};
        if (typeof opts.showLog === "boolean") {
            opts.showLog = opts.showLog ? e$1.INFO : e$1.NONE;
        }
        if (typeof opts.showLog === "number") {
            d.setLevel(opts.showLog);
        }
        d.info(opts, `======== LPAPIFactory.createInstance() ========`);
        //
        const adapter = new UniBleAdapter(options);
        return Qe.create(Object.assign(Object.assign({}, opts), { adapter: adapter, context: adapter.isH5 ? undefined : UniContext.createInstance(opts), createContext: (args) => {
                return adapter.isH5 ? undefined : new UniContext(args);
            }, onQuit: () => {
                LPAPIFactory.api = undefined;
            } }));
    }
}
class UniPreview extends Le$1 {
    constructor(options) {
        super(options);
    }
    createDrawContext(options) {
        return new UniContext(Object.assign(Object.assign({}, options), { previewMode: true, apiMode: false }));
    }
    attachTo(options) {
        if (!this.drawContext) {
            this.drawContext = this.createDrawContext(options);
        }
        // 如果未指定目标容器，则只是根据给定的容器大小来计算canvas的大小，并渲染 canvas 内容即可。
        const viewWidth = options.viewWidth || 0;
        const viewHeight = options.viewHeight || 0;
        return this.raiseViewChanged(viewWidth, viewHeight);
    }
}

export { a as Alignment, A as Barcode, Ot as Barcode1DEncoder, Ce as Barcode2DEncoder, Pe as Barcode2DType, s as BarcodeTextPos, y as BarcodeType, f as BitMatrix, o as BorderAlign, Ge as CharacteristicProperty, be as DegreeContent, Re as DrawContext, Ae as DrawType, g as DzCanvas, C as DzChar, P as DzCharCodes, Ve as DzPrinter, Ie as DzTextDecoder, b as DzTextEncoder, e as DzUtil, Mt as EccLevel, me as FinderPattern, n as FontStyle, xe as GBKUtils, i as LOG_LEVEL, Qe as LPAPI, LPAPIFactory, we as LPAUtils, De as LPA_Result, Ee as LabelContext, l as LineSpaceMode, u as LineSpaceParser, fe as QRCode, Lt as QRUtils, p as ScaleCanvas, c as ScaleUnit, r as TextDecoration, UniContext, UniPreview, Ze as WdfxParser, h as WrapMode, d as logger };
